

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>3.4. Computer Vision and CNN &#8212; Machine Learning book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '5_Deep_learning/learning_course/2_ComputerVision_CNN';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="3.5. Natural Language Processing" href="3_NLP_RNN.html" />
    <link rel="prev" title="3.1. Fundamentals" href="1_TF_Fundamentals_v2.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../../_jupyter_book_files/intro.html">
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../_jupyter_book_files/intro.html">
                    Welcome to Dat’s Notebook
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Process Modeling</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/0_toc_eda.html">1. Statistic and EDA</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/1_Statistics_and_EDA-0.html">1.1. Data Analyst Process</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/1_Statistics_and_EDA-1.html">1.2. Read datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/1_Statistics_and_EDA-2.html">1.3. Explore data analysis (EDA)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/1_Statistics_and_EDA-3.html">1.4. Description statistic</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/1_Statistics_and_EDA-4.html">1.5. Inferential statistic</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/1_Statistics_and_EDA-5.html">1.6. Kiểm định giả thuyết (Hypothesis testing)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/1_Statistics_and_EDA-6.html">1.7. ANOVA</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/0_toc_fe.html">2. Feature Engineering</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/2_Feature_engineering-1.html">2.1. Custom Transforms Function</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/2_Feature_engineering-2.html">2.2. Feature extraction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/2_Feature_engineering-3.html">2.3. Variable Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/2_Feature_engineering-4.html">2.4. Missing Imputation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/2_Feature_engineering-5.html">2.5. Categorical Encoding</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/2_Feature_engineering-6.html">2.6. Feature transformation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/2_Feature_engineering-7.html">2.7. Discretisation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/2_Feature_engineering-8.html">2.8. Outliers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/2_Feature_engineering-9.html">2.9. Feature scaling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/2_Feature_engineering-10.html">2.10. Feature selection</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/0_toc_imb.html">3. Imbalance Dataset Handling</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/3_Imbalance_data_handling-1.html">3.1. Data-level approaches</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/3_Imbalance_data_handling-2.html">3.2. Cost sensitive approaches</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/3_Imbalance_data_handling-3.html">3.3. Ensemble approaches</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/3_Imbalance_data_handling-4.html">3.4. Ensemble approaches</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/0_toc_fs.html">4. Feature Selection</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/3_Feature_selection_and_decomposition-1.html">4.1. Filter methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/3_Feature_selection_and_decomposition-2.html">4.2. Wrapped methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/3_Feature_selection_and_decomposition-3.html">4.3. Embedded methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/3_Feature_selection_and_decomposition-4.html">4.4. Hybrid methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/3_Feature_selection_and_decomposition-5.html">4.5. Feature decomposition</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/0_toc_eva.html">5. Evaluation Metrics</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/5_Evaluation_metrics-0.html">5.1. Define scorer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/5_Evaluation_metrics-1.html">5.2. Classification metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/5_Evaluation_metrics-2.html">5.3. Regression metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/5_Evaluation_metrics-3.html">5.4. Clustering metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/5_Evaluation_metrics-4.html">5.5. Pairwise metrics</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/6_Models_monitoring_production-0.html">6. Model Monitoring</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/6_Models_monitoring_production-1.html">6.7. Functional level monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/6_Models_monitoring_production-2.html">6.8. Operational level monitoring</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">ML/DL Algorithms</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/0_toc_ml_su.html">1. ML Supervised Learning</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/4_ML_Supervised_learning_Algorithms-0.html">1.1. Regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/4_ML_Supervised_learning_Algorithms-1.html">1.2. Naive Bayes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/4_ML_Supervised_learning_Algorithms-2.html">1.3. Discriminant Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/4_ML_Supervised_learning_Algorithms-3.html">1.4. Stochastic Gradient Descent</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/4_ML_Supervised_learning_Algorithms-4.html">1.5. Support Vector Machines (SVM)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/4_ML_Supervised_learning_Algorithms-5.html">1.6. Nearest neighbors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/4_ML_Supervised_learning_Algorithms-6.html">1.7. Tree-base model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/4_ML_Supervised_learning_Algorithms-7.html">1.8. Ensemble learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/4_ML_Supervised_learning_Algorithms-8.html">1.9. Multi-class and multi-output</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/4_ML_Supervised_learning_Algorithms-9.html">1.10. Neural network models</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/0_toc_ml_unsu.html">2. ML Unsupervised Learning</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-8"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/4_ML_Unsupervised_learning_Algorithms-0.html">2.1. Clustering</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/4_ML_Unsupervised_learning_Algorithms-1.html">2.2. Decomposing components</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/4_ML_Unsupervised_learning_Algorithms-2.html">2.3. Manifold learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/4_ML_Unsupervised_learning_Algorithms-3.html">2.4. Novelty and Outlier Detection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/4_ML_Unsupervised_learning_Algorithms-4.html">2.5. Neural network</a></li>
</ul>
</li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/0_toc_dl.html">3. Deep Learning</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-9"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="1_TF_Fundamentals_v2.html">3.1. Fundamentals</a></li>


<li class="toctree-l2 current active"><a class="current reference internal" href="#">3.4. Computer Vision and CNN</a></li>
<li class="toctree-l2"><a class="reference internal" href="3_NLP_RNN.html">3.5. Natural Language Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="4_Transfer_Learning.html">3.6. Transfer learning in CV</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">My Modules</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../3_Mathematics/0_toc.html">1. Mathematics</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-10"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../3_Mathematics/1_Linear_algebra.html">1.1. Linear algebra</a></li>



<li class="toctree-l2"><a class="reference internal" href="../../3_Mathematics/2_Calculus_and_optimization.html">1.5. Calculus and optimization</a></li>






<li class="toctree-l2"><a class="reference internal" href="../../3_Mathematics/3_Distribution_and_statistic.html">1.12. Distribution and statistics</a></li>

<li class="toctree-l2"><a class="reference internal" href="../../3_Mathematics/4_Information_theory.html">1.14. Information theory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../3_Mathematics/5_Graph_theory.html">1.15. Graph theory</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../4_Programming/0_toc.html">2. Programming</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-11"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../4_Programming/1_SQL.html">2.1. SQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../4_Programming/2_noSQL.html">2.2. noSQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../4_Programming/3_pySpark.html">2.3. pySpark</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../4_Programming/4_Python.html">2.4. Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../4_Programming/6_Git.html">2.5. Git</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../4_Programming/7_Docker.html">2.6. Docker</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../2_My_Modules/0_toc.html">3. My Functions</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-12"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../2_My_Modules/1_Data_Cleaning.html">3.1. Data Cleaning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2_My_Modules/2_Connection.html">3.2. Connection</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../6_Tools_and_Projects/0_toc.html">4. Tools and Projects</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-13"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../6_Tools_and_Projects/deploy_callAPI_model_in_GCP.html">4.1. Deploy model on GCP and call API streamlit</a></li>
</ul>
</li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/datkt1998/DS_learning_book" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/5_Deep_learning/learning_course/2_ComputerVision_CNN.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Computer Vision and CNN</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview-cv">3.4.1. Overview CV</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#usage">3.4.1.1. Usage</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#inputs-and-outputs">3.4.1.2. Inputs and outputs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview-cnn">3.4.2. Overview CNN</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#types-of-layer">3.4.2.1. Types of layer</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#input-layer">3.4.2.1.1. Input layer</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#convolutional-layer">3.4.2.1.2. Convolutional layer</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#filter-hyperparameters">3.4.2.1.2.1. Filter hyperparameters</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#hidden-activation-function">3.4.2.1.3. Hidden Activation Function</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#pooling-layer">3.4.2.1.4. Pooling layer</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#flatten-layer-fully-connected-dense">3.4.2.1.5. Flatten Layer (Fully Connected Dense)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#output-layer-and-activation">3.4.2.1.6. Output Layer and activation</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tunning-hyperparameters">3.4.2.2. Tunning hyperparameters</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#cau-truc-convolution-layer">3.4.2.2.1. Cấu trúc convolution layer</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#model-complexity">3.4.2.2.2. Model complexity</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ung-dung-cnn">3.4.2.3. Ứng dụng CNN</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#object-detection">3.4.2.3.1. Object detection</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#face-verification-and-recognition">3.4.2.3.2. Face verification and recognition</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extra-curriculum">3.4.3. Extra-curriculum</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#build-cnn-binary">3.4.4. Build CNN binary</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dataview">3.4.4.1. Dataview</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#thiet-ke-pipeline-end-to-end-model">3.4.4.2. Thiết kế pipeline end-to-end model</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#load-and-preprocess-images">3.4.4.2.1. Load and preprocess images</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#create-cnn-model">3.4.4.2.2. Create CNN model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#compile-model">3.4.4.2.3. Compile model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-model">3.4.4.2.4. Fit model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluate-model">3.4.4.2.5. Evaluate model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#improving-model">3.4.4.2.6. Improving model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">3.4.4.2.7. Tunning hyperparameters</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#prediction">3.4.4.2.8. Prediction</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#save-load-model">3.4.4.2.9. Save/load model</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#multi-class">3.4.5. Multi-class</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="computer-vision-and-cnn">
<h1><span class="section-number">3.4. </span>Computer Vision and CNN<a class="headerlink" href="#computer-vision-and-cnn" title="Permalink to this heading">#</a></h1>
<section id="overview-cv">
<h2><span class="section-number">3.4.1. </span>Overview CV<a class="headerlink" href="#overview-cv" title="Permalink to this heading">#</a></h2>
<section id="usage">
<h3><span class="section-number">3.4.1.1. </span>Usage<a class="headerlink" href="#usage" title="Permalink to this heading">#</a></h3>
<p>Bài toán CV là bài toán detecting patterns in visual data:</p>
<ul class="simple">
<li><p>Classify picture thuộc object gì (classification)</p></li>
<li><p>Detect xem có đối tượng X trong hình ảnh hay không? Nó ở vị trí nào trong bức ảnh ?
…</p></li>
</ul>
</section>
<section id="inputs-and-outputs">
<h3><span class="section-number">3.4.1.2. </span>Inputs and outputs<a class="headerlink" href="#inputs-and-outputs" title="Permalink to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>Input: image được encode ra numeric with shape [batch, height, width, channels]</p></li>
<li><p>Output: xác suất dự đoán các class tương ứng</p></li>
</ol>
<ul class="simple">
<li><p>Binary: output_shape = [1] hoặc scalar</p></li>
<li><p>Multiclass: output_shape = [n_class]</p></li>
</ul>
</section>
</section>
<section id="overview-cnn">
<h2><span class="section-number">3.4.2. </span>Overview CNN<a class="headerlink" href="#overview-cnn" title="Permalink to this heading">#</a></h2>
<p>(<a class="reference external" href="https://stanford.edu/~shervine/teaching/cs-230/cheatsheet-convolutional-neural-networks#ct-architectures">https://stanford.edu/~shervine/teaching/cs-230/cheatsheet-convolutional-neural-networks#ct-architectures</a>)</p>
<p><strong>CNN</strong> là một mạng neural nets chứa 1 số lớp layer đặc biệt , tên gọi là <strong>Convolutional layer + Pooling layer</strong>, các layer này có khả năng trích lọc ra các đặc trưng quan trọng của bức ảnh, thay vì sử dụng toàn bộ feature (chứa nhiều feature dư thùa gây nhiễu như mạng neural thông thường), từ đó mặc dù số lượng parameters ít hơn nhưng nó hỗ trợ tốt trong việc học image data.</p>
<p><img alt="" src="https://stanford.edu/~shervine/teaching/cs-230/illustrations/architecture-cnn-en.jpeg?3b7fccd728e29dc619e1bd8022bf71cf" /></p>
<p><strong>Feature</strong> chính là bất kỳ chi tiết gì được thể hiện trong bức ảnh, có ý nghĩa trong việc nhận điện object và classify ảnh. Feature không được định nghĩa bởi con người viết code, mà có thể là bất kỳ chi tiết nào mà model có thể nhìn và học được từ input images, và tự động nhận diện nó, và áp dụng vào các bộ filter khác nhau cho input image.</p>
<blockquote>
<div><p>Ví dụ: Để phân loại được ảnh con người, 1 feature có thể là nhận dạng được đầu người, hoặc cánh tay con người.</p>
</div></blockquote>
<p>CNN được sử dụng phổ biến trong computer vision: image processing, classification, segmentation, and object detection. <a class="reference external" href="http://ijcsit.com/docs/Volume%207/vol7issue5/ijcsit20160705014.pdf">Chi tiết CNN’s Application</a></p>
<p>Mặc dù nếu dùng mạng MLP thông thường với số lượng nodes và layers lớn có thể mang lại hiệu quả trong việc classification nhưng đổi lại, chúng có số lượng parameters lớn hơn rất nhiều so với CNN.</p>
<p>Để hiểu rõ CNN một cách đơn giản (thông qua kiến trúc nets TinyVGG), đọc chi tiết tại: <a class="reference external" href="https://poloclub.github.io/cnn-explainer/">CNN explainer website</a>. Hiện nay, cấu trúc mạng CNN hiện đại so với tinyVGG có vài điểm tương đồng về cách sắp xếp layers và operation, nhưng larger scale hơn so với tinyVGG.</p>
<section id="types-of-layer">
<h3><span class="section-number">3.4.2.1. </span>Types of layer<a class="headerlink" href="#types-of-layer" title="Permalink to this heading">#</a></h3>
<p><img alt="" src="../../_images/cnn_architecture.png" /></p>
<p>How they stack together:</p>
<p><img alt="" src="https://raw.githubusercontent.com/mrdbourke/tensorflow-deep-learning/main/images/03-simple-convnet.png" />
<em>Một ví dụ đơn giản để stack các layer trên vào mạng CNN, trên thực tế, có thể chúng sẽ được sắp xếp lại theo nhiều kiểu khác nhau</em></p>
<section id="input-layer">
<h4><span class="section-number">3.4.2.1.1. </span>Input layer<a class="headerlink" href="#input-layer" title="Permalink to this heading">#</a></h4>
<p>Input image(s) được sử dụng cho việc học có thể là photo hoặc video (list of photos).</p>
<p>Các input image(s) sau khi được preprocessing trước khi đưa vào input layer. Các preprocessing task bao gồm: encoding dưới dạng numeric, chuẩn hoá về cùng 1 kích thước ảnh, normalize (<code class="docutils literal notranslate"><span class="pre">/255</span></code>) và Flatten. Chúng sẽ được sử dụng cho các layer tiếp theo.</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">input_shape</span> <span class="pre">=</span> <span class="pre">[batch_size,</span> <span class="pre">height,</span> <span class="pre">width,</span> <span class="pre">channels]</span></code></p>
</div></blockquote>
</section>
<section id="convolutional-layer">
<h4><span class="section-number">3.4.2.1.2. </span>Convolutional layer<a class="headerlink" href="#convolutional-layer" title="Permalink to this heading">#</a></h4>
<p>(<a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/keras/layers/Conv2D">https://www.tensorflow.org/api_docs/python/tf/keras/layers/Conv2D</a>)</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">ConvXD</span> <span class="c1"># where X can be multiple values</span>
</pre></div>
</div>
<p><strong>Convolutional Layer</strong> là 1 lớp layers (đặc trưng của CNN) sử dụng các bộ filter , mỗi neurons/node trong CL có output là 1 matrix (thay vì là 1 scalar thông thường), mục đích là lấy ra các đặc trưng quan trọng của input image hoặc output từ các layer trước đó. Mỗi neurons/node chứa <strong>kernel weights</strong> và <strong>bias</strong>, phục vụ các công việc như chọn ra feature tốt nhất từ 1 nhóm các features.</p>
<blockquote>
<div><p><img alt="" src="https://stanford.edu/~shervine/teaching/cs-230/illustrations/convolution-layer-a.png?1c517e00cb8d709baf32fc3d39ebae67" /></p>
</div></blockquote>
<ul class="simple">
<li><p><strong>Kernel weights</strong>: là 1 vector chứa các weight, kết hợp với bộ features từ layer trước, sử dụng phép dot_product đó để tạo ra feature mới giúp phân biệt các hình ảnh với nhau</p></li>
<li><p><strong>bias</strong>: mỗi node chứa 1 bias trong phép biến đổi linear tạo ra 1 feature mới.</p></li>
</ul>
<blockquote>
<div><p>Ví dụ với first convolutional layer in TinyVGG bao gồm 10 neurons được tạo bởi 3 neurons từ input_layer, sử dụng kiến trúc full-connected, tức là mỗi neuron được kết nối tới mọi neuron từ layer trước đó. Kernel weights là vector có size = 9, tức lấy 9 điểm ảnh từ input neuron để tạo ra một điểm ảnh cho output convolutional layer.</p>
</div></blockquote>
<blockquote>
<div><p><img alt="" src="https://poloclub.github.io/cnn-explainer/assets/figures/convlayer_detailedview_demo.gif" /></p>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">Conv2D</span></code> thể hiện rằng inputs gồm 2 dimensional (height and width), mặc dù input đầu vào có shape là (height, width, color_channels), tuy nhiên convolutional layers sẽ xử lý từng color channel một cách độc lập và riêng biệt.</p>
<section id="filter-hyperparameters">
<h5><span class="section-number">3.4.2.1.2.1. </span>Filter hyperparameters<a class="headerlink" href="#filter-hyperparameters" title="Permalink to this heading">#</a></h5>
<p><img alt="" src="../../_images/cl_hyper_params.png" /></p>
<ol class="arabic simple">
<li><p><strong>filter</strong>: Số lượng bộ filter (feature_extrator) sẽ được pass over qua 1 input image. Filter càng lớn thì model càng complexity, model càng có khả năng bắt nhiều được các feature có thể mang lại hiệu quả trong việc phân loại, đương nhiên cũng có khả năng bắt các feature dư thừa.</p></li>
</ol>
<blockquote>
<div><p>Common value: 10, 32, 64, 128
<img alt="" src="https://stanford.edu/~shervine/teaching/cs-230/illustrations/dimensions-filter-en.png?7ce161e129a392a1804a231536b59f45" /></p>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p><strong>Padding</strong> (<code class="docutils literal notranslate"><span class="pre">valid</span></code>/<code class="docutils literal notranslate"><span class="pre">same</span></code>): thường được sử dụng khi muốn output được mở rộng từ input (tức input_shape &lt; output_shape). Nếu <code class="docutils literal notranslate"><span class="pre">padding</span> <span class="pre">=</span> <span class="pre">'valid'</span></code> , tức ko mở rông. Nếu <code class="docutils literal notranslate"><span class="pre">padding</span> <span class="pre">=</span> <span class="pre">'same'</span></code>, mở rộng input bằng x lớp giá trị 0 bên ngoài cho mỗi bên trên/dưới/trái/phải (input_shape từ <span class="math notranslate nohighlight">\(m.n\)</span> thành <span class="math notranslate nohighlight">\((m+2x).(n+2x)\)</span>). <em>(có nhiều phương pháp padding, nhưng phổ biến nhất là zero-padding do tính đơn giản, tính toán nhanh và hiệu quả đảm bảo)</em></p></li>
</ol>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Phương pháp</p></th>
<th class="head"><p>Valid</p></th>
<th class="head"><p>Same</p></th>
<th class="head"><p>Full</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Minh hoạ</p></td>
<td><p><img alt="" src="https://stanford.edu/~shervine/teaching/cs-230/illustrations/padding-valid-a.png?1f58d78612f6202ce201620919d71609" /></p></td>
<td><p><img alt="" src="https://stanford.edu/~shervine/teaching/cs-230/illustrations/padding-same-a.png?8b680283b10a6e131209b74e21a61213" /></p></td>
<td><p><img alt="" src="https://stanford.edu/~shervine/teaching/cs-230/illustrations/padding-full-a.png?b51e98467c8a77574c7e8f108654ad95" /></p></td>
</tr>
<tr class="row-odd"><td><p>Mục đích</p></td>
<td><p>• Không sử dụng padding<br>• Bỏ phép tích chập cuối nếu số chiều không khớp</p></td>
<td><p>• Kích thước đầu ra thuận lợi về mặt toán học<br>• Còn được gọi là ‘half’ padding</p></td>
<td><p>• Padding tối đa sao cho các phép tích chập có thể được sử dụng tại các rìa của đầu vào<br>• Bộ lọc ‘thấy’ được đầu vào từ đầu đến cuối</p></td>
</tr>
</tbody>
</table>
<ol class="arabic simple" start="3">
<li><p><strong>Kernel size</strong>: kích thước của bộ <strong>filter</strong> chạy qua kernel tạo ra output. Giá trị <strong>kernel size</strong> ảnh hưởng lớn đến khả năng phân loại ảnh. Nếu kernel size nhỏ: tức sẽ trích xuất được 1 lượng lớn information từ input feature, đồng thời  cũng giảm khả năng giảm chiều dữ liệu ( do số lượng feature output lớn hơn ), tạo ra mạng deeper và phức tạp hơn. Nếu kernel size lớn sẽ trích xuất ít thông tin hơn, dẫn đến giảm kích thước lớp nhiều hơn, thường dẫn đến hiệu suất kém hơn. Việc chọn kích thước hạt nhân phù hợp sẽ phụ thuộc vào nhiệm vụ và tập dữ liệu của bạn, nhưng nói chung, kích thước hạt nhân nhỏ hơn dẫn đến hiệu suất tốt hơn cho nhiệm vụ phân loại hình ảnh.</p></li>
</ol>
<blockquote>
<div><p>Ví dụ: kernel size = 3 tức sử dụng 3x3 = 9 điểm ảnh để tạo ra 1 điểm ảnh ở output.
Các giá trị thường là 3, 5, 7,..</p>
</div></blockquote>
<ol class="arabic simple" start="4">
<li><p><strong>Stride</strong>: Kích thước bước nhảy pixel qua mỗi lần tính. Stride tác động đến CNN tương tự như kernel_size, nếu stride nhỏ thì output càng chi tiết và higher dimension</p></li>
</ol>
<blockquote>
<div><p>Ví dụ: stride = 1 tức sau mỗi lần tính toán, kernel window sẽ shift sang phải 1 pixel cho lần tính toán tiếp theo.
<img alt="" src="https://stanford.edu/~shervine/teaching/cs-230/illustrations/stride.png?36b5b2e02f7e02c3c4075a9d836c048c" /></p>
</div></blockquote>
</section>
</section>
<section id="hidden-activation-function">
<h4><span class="section-number">3.4.2.1.3. </span>Hidden Activation Function<a class="headerlink" href="#hidden-activation-function" title="Permalink to this heading">#</a></h4>
<p>Tạo ra các tính chất non-linearity cho output của convolutional layers, thường áp dụng hàm ReLU (<a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/keras/activations/relu"><code class="docutils literal notranslate"><span class="pre">tf.keras.activations.relu</span></code></a>)</p>
<p>Với hàm ReLU, tất cả các output của CL sẽ luôn lớn hơn hoặc bằng 0
<img alt="" src="../../_images/activation_func_cnn.png" /></p>
</section>
<section id="pooling-layer">
<h4><span class="section-number">3.4.2.1.4. </span>Pooling layer<a class="headerlink" href="#pooling-layer" title="Permalink to this heading">#</a></h4>
<p>Pooling layer là 1 lớp được sử dụng với mục đích giảm chiều dữ liệu (gộp 1 nhóm các pixel lại thành 1 theo 1 hàm nào đó), thường được đặt sau convolution layer. Việc giảm chiều dữ liệu giúp cho giảm được số lượng parameters khi triển khai, giảm thời gian tính toán mà vẫn giữ được phần lớn các feature quan trọng.</p>
<p>Có rất nhiều phương pháp pooling như Average (<a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/keras/layers/AveragePooling2D"><code class="docutils literal notranslate"><span class="pre">tf.keras.layers.AvgPool2D</span></code></a>) or Max (<a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/keras/layers/MaxPool2D"><code class="docutils literal notranslate"><span class="pre">tf.keras.layers.MaxPool2D</span></code></a>).</p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Kiểu</p></th>
<th class="head"><p>Max pooling</p></th>
<th class="head"><p>Average pooling</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Chức năng</p></td>
<td><p>Từng phép pooling chọn giá trị lớn nhất trong khu vực mà nó đang được áp dụng</p></td>
<td><p>Từng phép pooling tính trung bình các giá trị trong khu vực mà nó đang được áp dụng</p></td>
</tr>
<tr class="row-odd"><td><p>Minh hoạ</p></td>
<td><p><img alt="" src="https://stanford.edu/~shervine/teaching/cs-230/illustrations/max-pooling-a.png?711b14799d07f9306864695e2713ae07" /></p></td>
<td><p><img alt="" src="https://stanford.edu/~shervine/teaching/cs-230/illustrations/average-pooling-a.png?58f9ab6d61248c3ec8d526ef65763d2f" /></p></td>
</tr>
<tr class="row-even"><td><p>Nhận xét</p></td>
<td><p>• Bảo toàn các đặc trưng đã phát hiện<br>• Được sử dụng thường xuyên</p></td>
<td><p>• Giảm kích thước feature map<br>• Được sử dụng trong mạng LeNet</p></td>
</tr>
</tbody>
</table>
<p><strong>Các hyperparameters</strong>: <code class="docutils literal notranslate"><span class="pre">pool_size</span></code>, <code class="docutils literal notranslate"><span class="pre">stride</span></code>, <code class="docutils literal notranslate"><span class="pre">padding</span></code></p>
<blockquote>
<div><p>Trong TinyVGG sử dụng Max-pooling với tham số <code class="docutils literal notranslate"><span class="pre">pool_size=2</span></code> (tương tự <code class="docutils literal notranslate"><span class="pre">kernel_size</span></code>) và <code class="docutils literal notranslate"><span class="pre">stride=1</span></code> (các tham số này có ý nghĩa tương tự convolutional layer), mỗi window 2x2 sẽ lấy ra giá trị <code class="docutils literal notranslate"><span class="pre">Max</span></code> là output, qua đó giảm đi 75% kích thước dữ liệu.</p>
</div></blockquote>
</section>
<section id="flatten-layer-fully-connected-dense">
<h4><span class="section-number">3.4.2.1.5. </span>Flatten Layer (Fully Connected Dense)<a class="headerlink" href="#flatten-layer-fully-connected-dense" title="Permalink to this heading">#</a></h4>
<p>Flatten Layer giúp convert 3-dimensional layer trong mạng CNN thành 1-dimensional vector để tạo thành full-connected input layer cho output layer. Trong mô hình mạng CNNs, các tầng kết nối đầy đủ thường được tìm thấy ở cuối mạng và được dùng để tối ưu hóa mục tiêu của mạng ví dụ như độ chính xác của lớp.</p>
<p><a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/keras/layers/Dense"><code class="docutils literal notranslate"><span class="pre">tf.keras.layers.Dense</span></code></a>
<img alt="" src="https://stanford.edu/~shervine/teaching/cs-230/illustrations/fully-connected-ltr.png?32caf9e07c79d652faa292812579d063" /></p>
</section>
<section id="output-layer-and-activation">
<h4><span class="section-number">3.4.2.1.6. </span>Output Layer and activation<a class="headerlink" href="#output-layer-and-activation" title="Permalink to this heading">#</a></h4>
<p>Sử dụng các pattern được học để cho ra kết quả dự đoán với output_shape = <code class="docutils literal notranslate"><span class="pre">[number_of_classes]</span></code> hoặc output là scalar với binary classification</p>
<p><strong>Output Activation Function</strong></p>
<ul class="simple">
<li><p>Đối với bài toán multi-class classification, thường áp dụng hàm softmax <a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/keras/activations/softmax"><code class="docutils literal notranslate"><span class="pre">tf.keras.activations.softmax</span></code></a>, để chuẩn hoá các giá trị output về dạng probability ( giá trị thuộc khoảng [0,1] và có tổng các output bằng 1)</p></li>
<li><p>Đối với bài toán binary classification, thường áp dụng hàm sigmoid <a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/keras/activations/sigmoid"><code class="docutils literal notranslate"><span class="pre">tf.keras.activations.sigmoid</span></code></a></p></li>
</ul>
</section>
</section>
<section id="tunning-hyperparameters">
<h3><span class="section-number">3.4.2.2. </span>Tunning hyperparameters<a class="headerlink" href="#tunning-hyperparameters" title="Permalink to this heading">#</a></h3>
<section id="cau-truc-convolution-layer">
<h4><span class="section-number">3.4.2.2.1. </span>Cấu trúc convolution layer<a class="headerlink" href="#cau-truc-convolution-layer" title="Permalink to this heading">#</a></h4>
<p>Công thức tính output shape cho convolutional layer, ứng với mỗi chiều height/width, cách tính size:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">output_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">input_size</span> <span class="o">-</span> <span class="n">kernel_size</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">padding_size</span><span class="p">)</span> <span class="o">/</span> <span class="n">stride</span> <span class="o">+</span> <span class="mi">1</span>
</pre></div>
</div>
<p><img alt="" src="../../_images/cl_archi.png" /></p>
</section>
<section id="model-complexity">
<h4><span class="section-number">3.4.2.2.2. </span>Model complexity<a class="headerlink" href="#model-complexity" title="Permalink to this heading">#</a></h4>
<p>Độ phức tạp của model thường đo bằng số params của model, xét trong 1 tầng của CNN, mức độ phức tạp được tính toán như sau
<img alt="" src="../../_images/model_cnn_complexity.png" /></p>
</section>
</section>
<section id="ung-dung-cnn">
<h3><span class="section-number">3.4.2.3. </span>Ứng dụng CNN<a class="headerlink" href="#ung-dung-cnn" title="Permalink to this heading">#</a></h3>
<section id="object-detection">
<h4><span class="section-number">3.4.2.3.1. </span>Object detection<a class="headerlink" href="#object-detection" title="Permalink to this heading">#</a></h4>
<p><strong>1. Các loại nhận diện vật thể</strong></p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Image Classification</p></th>
<th class="head"><p>Classification with localization</p></th>
<th class="head"><p>Detection</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><img alt="" src="https://stanford.edu/~shervine/teaching/cs-230/illustrations/object-detection-clas-en.jpeg?f380203d7e5d88936e654205473e86c2" /></p></td>
<td><p><img alt="" src="https://stanford.edu/~shervine/teaching/cs-230/illustrations/object-detection-loc-en.jpeg?f8ec96e14fb13f2515f2c179cd326545" /></p></td>
<td><p><img alt="" src="https://stanford.edu/~shervine/teaching/cs-230/illustrations/object-detection-det-en.jpeg?f735de7d1c1bccd2ff1c864b587ad842" /></p></td>
</tr>
<tr class="row-odd"><td><p>Traditional CNN</p></td>
<td><p>Simplified YOLO, R-CNN</p></td>
<td><p>YOLO, R-CNN</p></td>
</tr>
<tr class="row-even"><td><p>• Classifies a picture<br>• Predicts probability of object</p></td>
<td><p>• Detects an object in a picture<br>• Predicts probability of object and where it is located</p></td>
<td><p>• Detects up to several objects in a picture<br>• Predicts probabilities of objects and where they are located</p></td>
</tr>
</tbody>
</table>
<p><strong>2. Phương pháp nhận diện vật thể</strong></p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Bounding box detection</p></th>
<th class="head"><p>Landmark detection</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><img alt="" src="https://stanford.edu/~shervine/teaching/cs-230/illustrations/detection-bounding-box.jpeg?4fab94de8d967605519bfc6bafd14df3" /></p></td>
<td><p><img alt="" src="https://stanford.edu/~shervine/teaching/cs-230/illustrations/detection-landmark.jpeg?ed85ca8d6c2673f35e8c266c5476690f" /></p></td>
</tr>
<tr class="row-odd"><td><p>Phát hiện phần trong ảnh mà có sự xuất hiện của vật thể</p></td>
<td><p>Phát hiện hình dạng và đặc điểm của một đối tượng bằng các điểm có tương quan với nhau</p></td>
</tr>
</tbody>
</table>
</section>
<section id="face-verification-and-recognition">
<h4><span class="section-number">3.4.2.3.2. </span>Face verification and recognition<a class="headerlink" href="#face-verification-and-recognition" title="Permalink to this heading">#</a></h4>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Face verification</p></th>
<th class="head"><p>Face recognition</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><img alt="" src="https://stanford.edu/~shervine/teaching/cs-230/illustrations/face-verification-en.jpeg?9b6ea3c15805347193943fe09692f71b" /></p></td>
<td><p><img alt="" src="https://stanford.edu/~shervine/teaching/cs-230/illustrations/face-recognition-en.jpeg?ed30504000897087c2549f4f964c9441" /></p></td>
</tr>
<tr class="row-odd"><td><p>Is this the correct person? - One-to-one lookup</p></td>
<td><p>Is this one of the K persons in the database? - One-to-many lookup</p></td>
</tr>
</tbody>
</table>
</section>
</section>
</section>
<section id="extra-curriculum">
<h2><span class="section-number">3.4.3. </span>Extra-curriculum<a class="headerlink" href="#extra-curriculum" title="Permalink to this heading">#</a></h2>
<ol class="arabic simple">
<li><p><strong>Watch:</strong> <a class="reference external" href="https://www.youtube.com/watch?v=iaSUYvmCekI&amp;list=PLtBw6njQRU-rwp5__7C0oIVt26ZgjG9NI&amp;index=3">MIT’s Introduction to Deep Computer Vision</a> lecture. This will give you a great intuition behind convolutional neural networks.</p></li>
<li><p><strong>Watch:</strong> Deep dive on <a class="reference external" href="https://youtu.be/-_4Zi8fCZO4">mini-batch gradient descent</a> by <a class="reference external" href="http://deeplearning.ai">deeplearning.ai</a>. If you’re still curious about why we use <strong>batches</strong> to train models, this technical overview covers many of the reasons why.</p></li>
<li><p><strong>Read:</strong> <a class="reference external" href="https://cs231n.github.io/convolutional-networks/">CS231n Convolutional Neural Networks for Visual Recognition</a> class notes. This will give a very deep understanding of what’s going on behind the scenes of the convolutional neural network architectures we’re writing.</p></li>
<li><p><strong>Read:</strong> <a class="reference external" href="https://arxiv.org/pdf/1603.07285.pdf">“A guide to convolution arithmetic for deep learning”</a>. This paper goes through all of the mathematics running behind the scenes of our convolutional layers.</p></li>
<li><p><strong>Code practice:</strong> <a class="reference external" href="https://www.tensorflow.org/tutorials/images/data_augmentation">TensorFlow Data Augmentation Tutorial</a>. For a more in-depth introduction on data augmentation with TensorFlow, spend an hour or two reading through this tutorial.</p></li>
</ol>
</section>
<section id="build-cnn-binary">
<h2><span class="section-number">3.4.4. </span>Build CNN binary<a class="headerlink" href="#build-cnn-binary" title="Permalink to this heading">#</a></h2>
<section id="dataview">
<h3><span class="section-number">3.4.4.1. </span>Dataview<a class="headerlink" href="#dataview" title="Permalink to this heading">#</a></h3>
<p>Folder datasets được chia thành <code class="docutils literal notranslate"><span class="pre">train</span></code> + <code class="docutils literal notranslate"><span class="pre">test</span></code>. Trong đó, trong folder <code class="docutils literal notranslate"><span class="pre">train</span></code>/<code class="docutils literal notranslate"><span class="pre">test</span></code> chứa các subfolder là tên <code class="docutils literal notranslate"><span class="pre">class</span></code>, trong subfolder là ảnh tương ứng với tên của subfolder.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Example of file structure

pizza_steak &lt;- top level folder
└───train &lt;- training images
│   └───pizza
│   │   │   1008104.jpg
│   │   │   1638227.jpg
│   │   │   ...      
│   └───steak
│       │   1000205.jpg
│       │   1647351.jpg
│       │   ...
│   
└───test &lt;- testing images
│   └───pizza
│   │   │   1001116.jpg
│   │   │   1507019.jpg
│   │   │   ...      
│   └───steak
│       │   100274.jpg
│       │   1653815.jpg
│       │   ...    
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">tqdm.keras</span> <span class="kn">import</span> <span class="n">TqdmCallback</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.image</span> <span class="k">as</span> <span class="nn">mpimg</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="nb">print</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.12.0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_folder</span> <span class="o">=</span> <span class="s2">&quot;Datasets/pizza_steak/&quot;</span>

<span class="c1"># Walk through pizza_steak directory and list number of files</span>
<span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">data_folder</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dirpath</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dirnames</span><span class="p">)</span><span class="si">}</span><span class="s2"> directories + </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span><span class="si">}</span><span class="s2"> images&quot;</span><span class="p">)</span>
    
<span class="c1"># class_name</span>
<span class="n">class_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_folder</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">))</span> 
              <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_folder</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">))]</span>
<span class="n">class_name</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Datasets/pizza_steak/: 2 directories + 1 images
Datasets/pizza_steak/test: 2 directories + 1 images
Datasets/pizza_steak/test/steak: 0 directories + 250 images
Datasets/pizza_steak/test/pizza: 0 directories + 250 images
Datasets/pizza_steak/train: 2 directories + 0 images
Datasets/pizza_steak/train/steak: 0 directories + 750 images
Datasets/pizza_steak/train/pizza: 0 directories + 750 images
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;steak&#39;, &#39;pizza&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">view_random_image</span><span class="p">(</span><span class="n">tar_folder</span> <span class="o">=</span> <span class="s1">&#39;Datasets/pizza_steak/train&#39;</span><span class="p">,</span> <span class="n">tar_class</span> <span class="o">=</span> <span class="s1">&#39;pizza&#39;</span><span class="p">):</span>
    <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tar_folder</span><span class="p">,</span> <span class="n">tar_class</span><span class="p">)</span>
    <span class="n">rand_img</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">mpimg</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">rand_img</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">tar_class</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; ,with shape: </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">img</span>

<span class="n">img</span> <span class="o">=</span> <span class="n">view_random_image</span><span class="p">(</span><span class="n">tar_class</span> <span class="o">=</span> <span class="s1">&#39;steak&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/26546b75731bfac46469e943046dae8f47b49d7c4cd3c4b80644079ec79cb168.png" src="../../_images/26546b75731bfac46469e943046dae8f47b49d7c4cd3c4b80644079ec79cb168.png" />
</div>
</div>
<p>image shape = (Height, Width,  Colour Channels)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">img</span><span class="o">.</span><span class="n">shape</span> <span class="c1"># return height, width,  color channels</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(341, 512, 3)
</pre></div>
</div>
</div>
</div>
</section>
<section id="thiet-ke-pipeline-end-to-end-model">
<h3><span class="section-number">3.4.4.2. </span>Thiết kế pipeline end-to-end model<a class="headerlink" href="#thiet-ke-pipeline-end-to-end-model" title="Permalink to this heading">#</a></h3>
<section id="load-and-preprocess-images">
<h4><span class="section-number">3.4.4.2.1. </span>Load and preprocess images<a class="headerlink" href="#load-and-preprocess-images" title="Permalink to this heading">#</a></h4>
<p>Dữ liệu được chia vào <code class="docutils literal notranslate"><span class="pre">train</span></code> và <code class="docutils literal notranslate"><span class="pre">test</span></code> directories và phân tách vào subfolders in each class.</p>
<p><strong>Normalize the data</strong>: Dữ liệu ảnh thì mỗi giá trị color channel sẽ biến thiên trong khoảng [0, 255]. Để model train nhanh hơn và tăng performance, normalize cần phải được thực hiện để đưa các giá trị về [0,1]</p>
<p><strong>Set the batch size</strong>: Thay vì train toàn bộ các ảnh  cùng 1 lúc thì sẽ train theo batch. Thường lựa chọn batch_size = 32 vì nó thường hiệu quả trong nhiều TH khác nhau.</p>
<p><strong>class_mode</strong>: cách label được return trong output</p>
<ul class="simple">
<li><p>“categorical” will be 2D one-hot encoded labels,</p></li>
<li><p>“binary” will be 1D binary labels,</p></li>
<li><p>“sparse” will be 1D integer labels,</p></li>
<li><p>“input” will be images identical to input images (mainly used to work with autoencoders).</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># data batch generator</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.preprocessing.image</span> <span class="kn">import</span> <span class="n">ImageDataGenerator</span>

<span class="c1"># set random seed</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">train_data</span> <span class="o">=</span> <span class="n">ImageDataGenerator</span><span class="p">(</span><span class="n">rescale</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">255</span><span class="p">)</span>\
                <span class="o">.</span><span class="n">flow_from_directory</span><span class="p">(</span>
                    <span class="n">directory</span> <span class="o">=</span> <span class="n">data_folder</span> <span class="o">+</span> <span class="s2">&quot;/train&quot;</span><span class="p">,</span> <span class="c1"># data directory</span>
                    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>                    <span class="c1"># number of images to process at a time</span>
                    <span class="n">target_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">224</span><span class="p">,</span><span class="mi">224</span><span class="p">),</span>            <span class="c1"># convert all images to be 224 x 224 </span>
                                                        <span class="c1"># (common size to balance the remain info and chi phí tính toán)</span>
                    <span class="n">class_mode</span> <span class="o">=</span> <span class="s1">&#39;binary&#39;</span><span class="p">,</span>              <span class="c1"># cách label được return trong output</span>
                    <span class="p">)</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">ImageDataGenerator</span><span class="p">(</span><span class="n">rescale</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">255</span><span class="p">)</span>\
                <span class="o">.</span><span class="n">flow_from_directory</span><span class="p">(</span>
                    <span class="n">directory</span> <span class="o">=</span> <span class="n">data_folder</span> <span class="o">+</span> <span class="s2">&quot;/test&quot;</span><span class="p">,</span>
                    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>                    
                    <span class="n">target_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">224</span><span class="p">,</span><span class="mi">224</span><span class="p">),</span>            
                    <span class="n">class_mode</span> <span class="o">=</span> <span class="s1">&#39;binary&#39;</span><span class="p">,</span>              
                    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Found 1500 images belonging to 2 classes.
Found 500 images belonging to 2 classes.
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-cnn-model">
<h4><span class="section-number">3.4.4.2.2. </span>Create CNN model<a class="headerlink" href="#create-cnn-model" title="Permalink to this heading">#</a></h4>
<p>(Xem phần overview CNN)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create CNN model (the same TinyVGG in https://poloclub.github.io/cnn-explainer/)</span>
<span class="n">cnn_1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="c1"># số lượng bộ trích xuất đặc trưng của ảnh (feature extrator) được tạo ra trên conv layer </span>
                                         <span class="c1"># (hiểu đơn giản giống như số lượng nodes trên 1 layer của MLP)</span>
                           <span class="n">kernel_size</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="c1"># (window shape). Can set specific shape like (4,3)</span>
                           <span class="n">activation</span> <span class="o">=</span> <span class="s1">&#39;relu&#39;</span><span class="p">,</span>
                           <span class="n">input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">224</span><span class="p">,</span><span class="mi">224</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="c1"># first layer specifies input shape (height, width, colour channels)</span>
                          <span class="p">),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="s1">&#39;relu&#39;</span><span class="p">),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPool2D</span><span class="p">(</span><span class="n">pool_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="s1">&#39;relu&#39;</span><span class="p">),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="s1">&#39;relu&#39;</span><span class="p">),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPool2D</span><span class="p">(</span><span class="n">pool_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;sigmoid&#39;</span><span class="p">),</span> <span class="c1"># because binary classification</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="compile-model">
<h4><span class="section-number">3.4.4.2.3. </span>Compile model<a class="headerlink" href="#compile-model" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p><strong>Loss function</strong>:</p>
<ul>
<li><p>‘binary_crossentropy’ for binary classification</p></li>
<li><p>‘categorical_crossentropy’ for multi-class classification</p></li>
</ul>
</li>
<li><p><strong>Optimizer</strong>: Adam (default)</p></li>
<li><p><strong>Evaluation metric</strong>: accuracy.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cnn_1</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">legacy</span><span class="o">.</span><span class="n">Adam</span><span class="p">(),</span>
              <span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">BinaryCrossentropy</span><span class="p">(),</span>
              <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span>
             <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="fit-model">
<h4><span class="section-number">3.4.4.2.4. </span>Fit model<a class="headerlink" href="#fit-model" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">steps_per_epoch</span></code> - Số lượng batches mà model sẽ train qua mỗi epoch, sử dụng len(data_train) để đảm bảo mỗi epoch sẽ train qua toàn bộ dữ liệu</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">validation_steps</span></code> - tương tự nhưng với validation batch</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqdm.keras</span> <span class="kn">import</span> <span class="n">TqdmCallback</span>
<span class="c1"># from livelossplot import PlotLossesKerasTF</span>

<span class="n">history</span> <span class="o">=</span> <span class="n">cnn_1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">epochs</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">TqdmCallback</span><span class="p">()],</span>
         <span class="n">steps_per_epoch</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="p">),</span> <span class="c1"># number of batches in traindata</span>
          <span class="n">validation_data</span><span class="o">=</span><span class="n">test_data</span><span class="p">,</span> <span class="n">validation_steps</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
         <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "e7bc6a5bab8a4b5d96c56de77665a044", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cnn_1</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;sequential_1&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 conv2d_4 (Conv2D)           (None, 222, 222, 3)       84        
                                                                 
 conv2d_5 (Conv2D)           (None, 220, 220, 10)      280       
                                                                 
 max_pooling2d_2 (MaxPooling  (None, 110, 110, 10)     0         
 2D)                                                             
                                                                 
 conv2d_6 (Conv2D)           (None, 108, 108, 10)      910       
                                                                 
 conv2d_7 (Conv2D)           (None, 106, 106, 10)      910       
                                                                 
 max_pooling2d_3 (MaxPooling  (None, 53, 53, 10)       0         
 2D)                                                             
                                                                 
 flatten_1 (Flatten)         (None, 28090)             0         
                                                                 
 dense_1 (Dense)             (None, 1)                 28091     
                                                                 
=================================================================
Total params: 30,275
Trainable params: 30,275
Non-trainable params: 0
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tensorflow.keras.utils</span> <span class="kn">import</span> <span class="n">plot_model</span>

<span class="n">plot_model</span><span class="p">(</span><span class="n">cnn_1</span><span class="p">,</span> <span class="n">show_shapes</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/b9e5175cb480f9e79a5d67dbbf9b0a4249a1a7b2c048a1811f7816acb22242f2.png" src="../../_images/b9e5175cb480f9e79a5d67dbbf9b0a4249a1a7b2c048a1811f7816acb22242f2.png" />
</div>
</div>
</section>
<section id="evaluate-model">
<h4><span class="section-number">3.4.4.2.5. </span>Evaluate model<a class="headerlink" href="#evaluate-model" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="c1"># Plot the validation and training data separately</span>
<span class="k">def</span> <span class="nf">plot_loss_curves</span><span class="p">(</span><span class="n">history</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns separate loss curves for training and validation metrics.</span>
<span class="sd">    &quot;&quot;&quot;</span> 
    <span class="n">loss</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span>
    <span class="n">val_loss</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">]</span>

    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span>
    <span class="n">val_accuracy</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_accuracy&#39;</span><span class="p">]</span>

    <span class="n">epochs</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]))</span>

    <span class="c1"># Plot loss</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;training_loss&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">val_loss</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Loss&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Epochs&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="c1"># Plot accuracy</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;training_accuracy&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">val_accuracy</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;val_accuracy&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Epochs&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    
<span class="n">plot_loss_curves</span><span class="p">(</span><span class="n">history</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/d391796327da9cc2b9124aeacd8cbcf670c222bd39481b946b4f9d3ce15e653a.png" src="../../_images/d391796327da9cc2b9124aeacd8cbcf670c222bd39481b946b4f9d3ce15e653a.png" />
<img alt="../../_images/282c657191ce91c780e024a124e582ca152f816ab4a44ed696b5a95bebf5f95d.png" src="../../_images/282c657191ce91c780e024a124e582ca152f816ab4a44ed696b5a95bebf5f95d.png" />
</div>
</div>
</section>
<section id="improving-model">
<h4><span class="section-number">3.4.4.2.6. </span>Improving model<a class="headerlink" href="#improving-model" title="Permalink to this heading">#</a></h4>
<p>Có một vài cách để cải thiện thêm model:</p>
<ul class="simple">
<li><p>Tăng số lượng convolutional layer</p></li>
<li><p>Tăng số lượng filter tại mỗi conv layer</p></li>
<li><p>Add thêm Dense layer sau lớp Flatten()
…</p></li>
</ul>
<p>Tuy nhiên model đang bị overfitting nên ta sẽ ko cần thực hiện bước improving model.</p>
</section>
<section id="id1">
<h4><span class="section-number">3.4.4.2.7. </span>Tunning hyperparameters<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h4>
<p>Có vẻ như model trên đang bị overfit (the validation loss có xu hướng tăng ở các epochs cuối) với kết quả model là:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">loss</span><span class="o">=</span><span class="mf">0.00018</span><span class="p">,</span> <span class="n">accuracy</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">val_loss</span><span class="o">=</span><span class="mf">1.12</span><span class="p">,</span> <span class="n">val_accuracy</span><span class="o">=</span><span class="mf">0.844</span>
</pre></div>
</div>
<p>Có một vài phương pháp giảm overfitting như sau:</p>
<ul class="simple">
<li><p>Thay đổi cấu trúc mạng:</p>
<ul>
<li><p>Giảm Conv layers hoặc số filter của Conv layers</p></li>
<li><p>Bổ sung thêm MaxPooling layer phía sau Conv layers nếu chưa có</p></li>
</ul>
</li>
<li><p>Data processing:</p>
<ul>
<li><p>Sử dụng kỹ thuật image data augmentation: xoay ảnh, zoom-in, zoom-out, shift ảnh, flip ảnh,…</p></li>
</ul>
</li>
</ul>
<p>Ngoài ra các phương pháp tìm kiếm idea model:</p>
<ul class="simple">
<li><p>Thay đổi thứ tự mạng CNN, số lượng layer/filter</p></li>
<li><p>Tăng số epochs train</p></li>
<li><p>Finding ân ideal learning rate</p></li>
<li><p>Get more data to train</p></li>
<li><p>Use transfer learning model: tận dụng lại các model đã được train và điều chỉnh sau cho phục vụ mục đích bài toán</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">munch</span> <span class="kn">import</span> <span class="n">DefaultMunch</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">choice</span>

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.preprocessing.image</span> <span class="kn">import</span> <span class="n">ImageDataGenerator</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">Sequential</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Conv2D</span><span class="p">,</span> <span class="n">MaxPool2D</span><span class="p">,</span> <span class="n">Dropout</span><span class="p">,</span> <span class="n">Flatten</span><span class="p">,</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">Activation</span><span class="p">,</span> <span class="n">BatchNormalization</span>
<span class="kn">from</span> <span class="nn">keras.callbacks</span> <span class="kn">import</span> <span class="n">EarlyStopping</span><span class="p">,</span> <span class="n">ReduceLROnPlateau</span><span class="p">,</span> <span class="n">ModelCheckpoint</span>
<span class="kn">from</span> <span class="nn">tqdm.keras</span> <span class="kn">import</span> <span class="n">TqdmCallback</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.utils</span> <span class="kn">import</span> <span class="n">plot_model</span><span class="p">,</span> <span class="n">img_to_array</span><span class="p">,</span> <span class="n">load_img</span>

<span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># thực hiện tunning giảm overfitting bằng bổ sung thêm maxpooling và data augmentation</span>
<span class="n">CFG</span> <span class="o">=</span> <span class="p">{</span>
   <span class="s1">&#39;seed&#39;</span><span class="p">:</span><span class="mi">1</span> <span class="p">,</span>
   <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
       <span class="s1">&#39;dirs&#39;</span><span class="p">:{</span>
            <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;Datasets/pizza_steak/&quot;</span><span class="p">,</span>
            <span class="s1">&#39;train_subfolder&#39;</span><span class="p">:</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span>
            <span class="s1">&#39;test_subfolder&#39;</span><span class="p">:</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span>
            <span class="s1">&#39;pred_subfolder&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>           
       <span class="p">},</span>
       <span class="s1">&#39;aug_generator&#39;</span><span class="p">:{</span>
            <span class="s1">&#39;rescale&#39;</span> <span class="p">:</span> <span class="mi">1</span><span class="o">/</span><span class="mf">255.</span><span class="p">,</span>
             <span class="s1">&#39;rotation_range&#39;</span> <span class="p">:</span> <span class="mi">20</span><span class="p">,</span> 
             <span class="s1">&#39;shear_range&#39;</span> <span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> 
             <span class="s1">&#39;zoom_range&#39;</span> <span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> 
             <span class="s1">&#39;width_shift_range&#39;</span> <span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> 
             <span class="s1">&#39;height_shift_range&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> 
             <span class="s1">&#39;horizontal_flip&#39;</span> <span class="p">:</span> <span class="kc">True</span>
       <span class="p">},</span>
       <span class="s1">&#39;non_aug_generator&#39;</span><span class="p">:{</span>
            <span class="s1">&#39;rescale&#39;</span> <span class="p">:</span> <span class="mi">1</span><span class="o">/</span><span class="mf">255.</span><span class="p">,</span>
       <span class="p">},</span>
       <span class="s1">&#39;loader&#39;</span><span class="p">:{</span>
           <span class="s1">&#39;aug_train&#39;</span> <span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
           <span class="s1">&#39;aug_test&#39;</span><span class="p">:</span> <span class="kc">False</span>
       <span class="p">},</span>
       <span class="s1">&#39;flow&#39;</span><span class="p">:{</span>
           <span class="s1">&#39;batch_size&#39;</span> <span class="p">:</span> <span class="mi">32</span><span class="p">,</span>                   
           <span class="s1">&#39;target_size&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">224</span><span class="p">,</span><span class="mi">224</span><span class="p">),</span>            
           <span class="s1">&#39;class_mode&#39;</span> <span class="p">:</span> <span class="s1">&#39;binary&#39;</span><span class="p">,</span>
       <span class="p">},</span>
    <span class="p">},</span>
    <span class="s2">&quot;model&quot;</span><span class="p">:{</span>
        <span class="s1">&#39;build&#39;</span><span class="p">:{</span>
            
        <span class="p">},</span>
        <span class="s1">&#39;compile&#39;</span><span class="p">:{</span>
            <span class="s2">&quot;optimizer&quot;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">legacy</span><span class="o">.</span><span class="n">Adam</span><span class="p">(),</span>
            <span class="s1">&#39;loss&#39;</span><span class="p">:</span><span class="s1">&#39;binary_crossentropy&#39;</span><span class="p">,</span>
            <span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">],</span>
        <span class="p">},</span>
        <span class="s1">&#39;fit&#39;</span><span class="p">:{</span>
            <span class="s1">&#39;epochs&#39;</span> <span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s1">&#39;verbose&#39;</span> <span class="p">:</span> <span class="mi">0</span>
        <span class="p">},</span>
        <span class="s1">&#39;save&#39;</span><span class="p">:{</span>
            <span class="s1">&#39;dirs&#39;</span> <span class="p">:</span> <span class="s1">&#39;models&#39;</span><span class="p">,</span>
            <span class="s1">&#39;export_graph&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CNN_Model</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">pathmodel</span> <span class="o">=</span> <span class="kc">None</span> <span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">DefaultMunch</span><span class="o">.</span><span class="n">fromDict</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="o">.</span><span class="n">epochs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="o">.</span><span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_datagen</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pathmodel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pathmodel</span> <span class="o">=</span> <span class="n">pathmodel</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">pathmodel</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_datafolder</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">load_datafolder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">data_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dirs</span>
        <span class="n">data_folder</span> <span class="o">=</span> <span class="n">data_cfg</span><span class="o">.</span><span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_folder</span><span class="p">,</span> <span class="n">data_cfg</span><span class="o">.</span><span class="n">train_subfolder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_folder</span><span class="p">,</span> <span class="n">data_cfg</span><span class="o">.</span><span class="n">test_subfolder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_folder</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span> 
                           <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_folder</span><span class="p">,</span> <span class="n">i</span><span class="p">))]</span>
        <span class="k">if</span> <span class="n">view</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">data_folder</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dirpath</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dirnames</span><span class="p">)</span><span class="si">}</span><span class="s2"> directories + </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span><span class="si">}</span><span class="s2"> images&quot;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">create_datagen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">load_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aug_datagen</span> <span class="o">=</span> <span class="n">ImageDataGenerator</span><span class="p">(</span><span class="o">**</span><span class="n">load_cfg</span><span class="o">.</span><span class="n">aug_generator</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nonaug_datagen</span> <span class="o">=</span> <span class="n">ImageDataGenerator</span><span class="p">(</span><span class="o">**</span><span class="n">load_cfg</span><span class="o">.</span><span class="n">non_aug_generator</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loads and Preprocess data &quot;&quot;&quot;</span>
        <span class="n">load_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aug_datagen</span> <span class="k">if</span> <span class="n">load_cfg</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">aug_train</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonaug_datagen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aug_datagen</span> <span class="k">if</span> <span class="n">load_cfg</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">aug_test</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonaug_datagen</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;train: &quot;</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_gen</span><span class="o">.</span><span class="n">flow_from_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_folder</span><span class="p">,</span><span class="o">**</span><span class="n">load_cfg</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;test: &quot;</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_gen</span><span class="o">.</span><span class="n">flow_from_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_folder</span><span class="p">,</span><span class="o">**</span><span class="n">load_cfg</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_indices</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_data</span><span class="o">.</span><span class="n">class_indices</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    
    <span class="k">def</span> <span class="nf">load_pred_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred_dir</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pred_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dirs</span><span class="o">.</span><span class="n">pred_subfolder</span> <span class="k">if</span> <span class="n">pred_dir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pred_dir</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pred_dir</span><span class="p">):</span>
            <span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">pred_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;.&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">pred_dir</span><span class="p">):</span>
            <span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">pred_dir</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pred_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_dir</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No pred_dir !&#39;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="n">flow</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;class_mode&#39;</span><span class="p">}</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">])</span>
        <span class="n">pred_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonaug_datagen</span><span class="o">.</span><span class="n">flow_from_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_dir</span><span class="p">,</span>
                                                <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">y_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                                                <span class="n">class_mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">flow</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">pred_data</span>
            
    <span class="k">def</span> <span class="nf">preview_image_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span> <span class="o">=</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">n_aug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_gen</span> <span class="k">if</span> <span class="n">dataset</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_gen</span>
        <span class="n">fol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_folder</span> <span class="k">if</span> <span class="n">dataset</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_folder</span>
        <span class="n">class_name</span> <span class="o">=</span> <span class="n">choice</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span>  <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">fol</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_list</span><span class="p">])</span>
        <span class="n">ran_img</span> <span class="o">=</span> <span class="n">choice</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fol</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)))</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;filename&quot;</span><span class="p">:</span><span class="n">ran_img</span><span class="p">,</span><span class="s2">&quot;class&quot;</span><span class="p">:</span><span class="n">class_name</span><span class="p">},</span> <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">flow</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;class_mode&#39;</span><span class="p">}</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="n">flow_from_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fol</span><span class="p">,</span> <span class="n">class_name</span><span class="p">),</span> <span class="o">**</span><span class="n">flow</span><span class="p">)</span>
        <span class="n">imgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">next</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_aug</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_view</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imgs</span><span class="p">,</span> <span class="n">subtitles</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">(</span><span class="n">num</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="o">//</span><span class="mi">4</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="mi">4</span> <span class="k">if</span> <span class="p">(</span><span class="n">rows</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
        <span class="c1"># plt.figure(figsize=(4*rows, 4*cols))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">imgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
            <span class="k">if</span> <span class="n">subtitles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">subtitles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="s1">&#39;relu&#39;</span><span class="p">,</span><span class="n">input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">224</span><span class="p">,</span><span class="mi">224</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="s1">&#39;relu&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPool2D</span><span class="p">(</span><span class="n">pool_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="s1">&#39;relu&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="s1">&#39;relu&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPool2D</span><span class="p">(</span><span class="n">pool_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Flatten</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;sigmoid&#39;</span><span class="p">))</span>

    
    <span class="k">def</span> <span class="nf">get_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># To prevent over fitting we will stop the learning after 4 epochs and val_loss value not decreased</span>
        <span class="n">earlystop</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">patience</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        
        <span class="c1"># reduce the learning rate when then accuracy not increase for 2 steps</span>
        <span class="n">learning_rate_reduction</span> <span class="o">=</span> <span class="n">ReduceLROnPlateau</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_accuracy&#39;</span><span class="p">,</span> 
                                            <span class="n">patience</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
                                            <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                                            <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
                                            <span class="n">min_lr</span><span class="o">=</span><span class="mf">0.00001</span><span class="p">)</span>
        <span class="c1"># process bar</span>
        <span class="n">tqdm_probar</span> <span class="o">=</span> <span class="n">TqdmCallback</span><span class="p">()</span>
        
        <span class="c1"># save model checkpoint</span>
        <span class="c1"># modelcheck = ModelCheckpoint(filepath, monitor=&#39;val_accuracy&#39;,mode=&#39;max&#39;, save_best_only=True)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">tqdm_probar</span><span class="p">,</span> <span class="n">learning_rate_reduction</span><span class="p">,</span> <span class="n">earlystop</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epochs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">epochs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span> <span class="o">=</span> <span class="n">epochs</span>
        <span class="n">model_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_callbacks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="o">**</span><span class="n">model_cfg</span><span class="o">.</span><span class="n">compile</span><span class="p">)</span>
        <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_data</span><span class="p">,</span> <span class="n">steps_per_epoch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_len</span><span class="p">,</span>
                                <span class="n">validation_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_data</span><span class="p">,</span> <span class="n">validation_steps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_len</span><span class="p">,</span> 
                               <span class="n">callbacks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">,</span> <span class="n">epochs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">train_res</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;val_&quot;</span><span class="p">)]</span>
        <span class="n">valid_res</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;val_&quot;</span><span class="p">)]</span>
        <span class="n">epochs</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_res</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_res</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;training_&#39;</span><span class="o">+</span><span class="n">m</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;val_&quot;</span><span class="o">+</span><span class="n">m</span><span class="p">)</span> <span class="ow">in</span> <span class="n">valid_res</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;val_&quot;</span><span class="o">+</span><span class="n">m</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;val_&quot;</span><span class="o">+</span><span class="n">m</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Epochs&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epochs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">export</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">modelname</span> <span class="o">=</span> <span class="s1">&#39;model&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">epochs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">export</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">modelname</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">plot_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">show_shapes</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_load_image_from_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">url</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">load_img</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">read</span><span class="p">()),</span> <span class="n">target_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">target_size</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">img_to_array</span><span class="p">(</span><span class="n">img</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># @tf.function</span>
    <span class="k">def</span> <span class="nf">predict_from_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_image_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonaug_datagen</span><span class="o">.</span><span class="n">flow</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="n">steps</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
            <span class="n">pred_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_indices</span><span class="p">[</span><span class="n">pred</span><span class="p">]</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;prediction: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pred_label</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_view</span><span class="p">(</span><span class="n">gen</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="p">[</span><span class="n">title</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error to load url, try another !&#39;</span><span class="p">)</span>
    
    
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred_dir</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">max_visualization</span> <span class="o">=</span> <span class="mi">4</span><span class="p">):</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">pred_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_pred_data</span><span class="p">(</span><span class="n">pred_dir</span><span class="p">)</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">pred_data</span><span class="p">,</span> <span class="n">steps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_data</span><span class="p">))</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">preds</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prediction_label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_indices</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_visualization</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_visualization</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="o">//</span><span class="mi">4</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="n">rows</span><span class="p">))</span>
            <span class="n">df_sample</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">max_visualization</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df_sample</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()):</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span>
                <span class="n">category</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;prediction_label&#39;</span><span class="p">]</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">load_img</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pred_dir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">,</span> <span class="n">target_size</span><span class="o">=</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span><span class="mi">224</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;(prediction: </span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">category</span><span class="p">)</span> <span class="p">)</span>
                
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">graph</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">history</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">save_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save</span>
        <span class="n">timesr</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;_%Y_%m_</span><span class="si">%d</span><span class="s2">_%H_%M_%S&quot;</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_cfg</span><span class="o">.</span><span class="n">dirs</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="n">timesr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/class_indices.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_pi</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_indices</span><span class="p">,</span> <span class="n">file_pi</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">graph</span><span class="p">:</span>
            <span class="n">plot_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">to_file</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/model_architecture.png&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">history</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/history.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_pi</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">,</span> <span class="n">file_pi</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model has saved in: &#39;</span> <span class="o">+</span> <span class="n">path</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span> <span class="o">+</span> <span class="s1">&#39;/class_indices.pkl&#39;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_pi</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">class_indices</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_pi</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;history.pkl&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span> <span class="o">+</span> <span class="s1">&#39;/history.pkl&#39;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_pi</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_pi</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loaded a model in: &quot;</span> <span class="o">+</span> <span class="n">filepath</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">distributed_train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;train with multi-GPU and clusters&quot;&quot;&quot;</span>
        <span class="n">mirrored_strategy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">distribute</span><span class="o">.</span><span class="n">MirroredStrategy</span><span class="p">(</span><span class="n">devices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;/gpu:0&quot;</span><span class="p">,</span> <span class="s2">&quot;/gpu:1&quot;</span><span class="p">])</span>
        <span class="k">with</span> <span class="n">mirrored_strategy</span><span class="o">.</span><span class="n">scope</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>


        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TF_CONFIG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;cluster&quot;</span><span class="p">:{</span>
                    <span class="s2">&quot;worker&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;host1:port&quot;</span><span class="p">,</span> <span class="s2">&quot;host2:port&quot;</span><span class="p">,</span> <span class="s2">&quot;host3:port&quot;</span><span class="p">]</span>
                <span class="p">},</span>
                <span class="s2">&quot;task&quot;</span><span class="p">:{</span>
                     <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;worker&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="mi">1</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">multi_worker_mirrored_strategy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">distribute</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">MultiWorkerMirroredStrategy</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">multi_worker_mirrored_strategy</span><span class="o">.</span><span class="n">scope</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

        <span class="n">parameter_server_strategy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">distribute</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">ParameterServerStrategy</span><span class="p">()</span>

        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TF_CONFIG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;cluster&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;worker&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;host1:port&quot;</span><span class="p">,</span> <span class="s2">&quot;host2:port&quot;</span><span class="p">,</span> <span class="s2">&quot;host3:port&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;ps&quot;</span><span class="p">:</span>  <span class="p">[</span><span class="s2">&quot;host4:port&quot;</span><span class="p">,</span> <span class="s2">&quot;host5:port&quot;</span><span class="p">]</span>
                <span class="p">},</span>
                <span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;worker&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="mi">1</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">CNN_Model</span><span class="p">(</span><span class="n">CFG</span><span class="p">)</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>train: Found 1500 images belonging to 2 classes.
test: Found 500 images belonging to 2 classes.
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "bf0d284300ae4d7d8e82e13fb78db23b", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:absl:Found untraced functions such as _jit_compiled_convolution_op, _jit_compiled_convolution_op, _jit_compiled_convolution_op, _jit_compiled_convolution_op while saving (showing 4 of 4). These functions will not be directly callable after loading.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:tensorflow:Assets written to: models/model_2023_04_28_15_44_30/assets
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:tensorflow:Assets written to: models/model_2023_04_28_15_44_30/assets
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model has saved in: models/model_2023_04_28_15_44_30
</pre></div>
</div>
<img alt="../../_images/9e2aa921e15a16920a1983957bdf8589cd9e3a5129dd9315d65bccc692075903.png" src="../../_images/9e2aa921e15a16920a1983957bdf8589cd9e3a5129dd9315d65bccc692075903.png" />
</div>
</div>
</section>
<section id="prediction">
<h4><span class="section-number">3.4.4.2.8. </span>Prediction<a class="headerlink" href="#prediction" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="s1">&#39;Datasets/pizza_steak/predict/&#39;</span><span class="p">,</span> <span class="n">max_visualization</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Found 8 validated image filenames.
1/1 [==============================] - 0s 105ms/step
</pre></div>
</div>
<img alt="../../_images/20a612cbf294a0613898c78119abbbe270ccf493fc41141da098dad3ffa0513d.png" src="../../_images/20a612cbf294a0613898c78119abbbe270ccf493fc41141da098dad3ffa0513d.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">predict_from_url</span><span class="p">(</span><span class="n">url</span><span class="o">=</span> <span class="s1">&#39;https://upload.wikimedia.org/wikipedia/commons/e/e0/Hamburg-Steak.jpg&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1/1 [==============================] - 0s 86ms/step
</pre></div>
</div>
<img alt="../../_images/b95e2a891dbcbe04b098ffd06788d62a709bd532d79dbc59f77ccadaf7db2295.png" src="../../_images/b95e2a891dbcbe04b098ffd06788d62a709bd532d79dbc59f77ccadaf7db2295.png" />
</div>
</div>
</section>
<section id="save-load-model">
<h4><span class="section-number">3.4.4.2.9. </span>Save/load model<a class="headerlink" href="#save-load-model" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model2</span> <span class="o">=</span> <span class="n">CNN_Model</span><span class="p">(</span><span class="n">CFG</span><span class="p">,</span> <span class="s1">&#39;models/model_2023_04_28_15_44_30&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loaded a model in: models/model_2023_04_28_15_44_30
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model2</span><span class="o">.</span><span class="n">predict_from_url</span><span class="p">(</span><span class="n">url</span><span class="o">=</span> <span class="s1">&#39;https://upload.wikimedia.org/wikipedia/commons/e/e0/Hamburg-Steak.jpg&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1/1 [==============================] - 0s 68ms/step
</pre></div>
</div>
<img alt="../../_images/b95e2a891dbcbe04b098ffd06788d62a709bd532d79dbc59f77ccadaf7db2295.png" src="../../_images/b95e2a891dbcbe04b098ffd06788d62a709bd532d79dbc59f77ccadaf7db2295.png" />
</div>
</div>
</section>
</section>
</section>
<section id="multi-class">
<h2><span class="section-number">3.4.5. </span>Multi-class<a class="headerlink" href="#multi-class" title="Permalink to this heading">#</a></h2>
<p>So sánh với model binary classification thì với model multi-class, cần thay đổi những thứ sau:</p>
<ul class="simple">
<li><p>Thay đổi số node tại output layer bằng số class data (number of class)</p></li>
<li><p>Thay đổi hàm activation thành <code class="docutils literal notranslate"><span class="pre">'softmax'</span></code></p></li>
<li><p>Thay đổi hàm loss thành <code class="docutils literal notranslate"><span class="pre">'categorical_crossentropy'</span></code> thay vì <code class="docutils literal notranslate"><span class="pre">'binary_crossentropy'</span></code></p></li>
<li><p>Thay đổi datagen <code class="docutils literal notranslate"><span class="pre">class_mode</span></code> thành <code class="docutils literal notranslate"><span class="pre">'categorical'</span></code></p></li>
<li><p>Thay đổi cách tìm ra prediction label bằng việc sử dụng <code class="docutils literal notranslate"><span class="pre">argmax</span></code></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">munch</span> <span class="kn">import</span> <span class="n">DefaultMunch</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">choice</span>

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.preprocessing.image</span> <span class="kn">import</span> <span class="n">ImageDataGenerator</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">Sequential</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Conv2D</span><span class="p">,</span> <span class="n">MaxPool2D</span><span class="p">,</span> <span class="n">Dropout</span><span class="p">,</span> <span class="n">Flatten</span><span class="p">,</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">Activation</span><span class="p">,</span> <span class="n">BatchNormalization</span>
<span class="kn">from</span> <span class="nn">keras.callbacks</span> <span class="kn">import</span> <span class="n">EarlyStopping</span><span class="p">,</span> <span class="n">ReduceLROnPlateau</span><span class="p">,</span> <span class="n">ModelCheckpoint</span>
<span class="kn">from</span> <span class="nn">tqdm.keras</span> <span class="kn">import</span> <span class="n">TqdmCallback</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.utils</span> <span class="kn">import</span> <span class="n">plot_model</span><span class="p">,</span> <span class="n">img_to_array</span><span class="p">,</span> <span class="n">load_img</span>

<span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># thực hiện tunning giảm overfitting bằng bổ sung thêm maxpooling và data augmentation</span>
<span class="n">CFG2</span> <span class="o">=</span> <span class="p">{</span>
   <span class="s1">&#39;seed&#39;</span><span class="p">:</span><span class="mi">1</span> <span class="p">,</span>
   <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
       <span class="s1">&#39;dirs&#39;</span><span class="p">:{</span>
            <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;Datasets/10_food_classes_all_data/&quot;</span><span class="p">,</span>
            <span class="s1">&#39;train_subfolder&#39;</span><span class="p">:</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span>
            <span class="s1">&#39;test_subfolder&#39;</span><span class="p">:</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span>
            <span class="s1">&#39;pred_subfolder&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>           
       <span class="p">},</span>
       <span class="s1">&#39;aug_generator&#39;</span><span class="p">:{</span>
            <span class="s1">&#39;rescale&#39;</span> <span class="p">:</span> <span class="mi">1</span><span class="o">/</span><span class="mf">255.</span><span class="p">,</span>
             <span class="s1">&#39;rotation_range&#39;</span> <span class="p">:</span> <span class="mi">20</span><span class="p">,</span> 
             <span class="s1">&#39;shear_range&#39;</span> <span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> 
             <span class="s1">&#39;zoom_range&#39;</span> <span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> 
             <span class="s1">&#39;width_shift_range&#39;</span> <span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> 
             <span class="s1">&#39;height_shift_range&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> 
             <span class="s1">&#39;horizontal_flip&#39;</span> <span class="p">:</span> <span class="kc">True</span>
       <span class="p">},</span>
       <span class="s1">&#39;non_aug_generator&#39;</span><span class="p">:{</span>
            <span class="s1">&#39;rescale&#39;</span> <span class="p">:</span> <span class="mi">1</span><span class="o">/</span><span class="mf">255.</span><span class="p">,</span>
       <span class="p">},</span>
       <span class="s1">&#39;loader&#39;</span><span class="p">:{</span>
           <span class="s1">&#39;aug_train&#39;</span> <span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
           <span class="s1">&#39;aug_test&#39;</span><span class="p">:</span> <span class="kc">False</span>
       <span class="p">},</span>
       <span class="s1">&#39;flow&#39;</span><span class="p">:{</span>
           <span class="s1">&#39;batch_size&#39;</span> <span class="p">:</span> <span class="mi">32</span><span class="p">,</span>                   
           <span class="s1">&#39;target_size&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">224</span><span class="p">,</span><span class="mi">224</span><span class="p">),</span>            
           <span class="s1">&#39;class_mode&#39;</span> <span class="p">:</span> <span class="s1">&#39;categorical&#39;</span><span class="p">,</span>
       <span class="p">},</span>
    <span class="p">},</span>
    <span class="s2">&quot;model&quot;</span><span class="p">:{</span>
        <span class="s1">&#39;build&#39;</span><span class="p">:{</span>
            
        <span class="p">},</span>
        <span class="s1">&#39;compile&#39;</span><span class="p">:{</span>
            <span class="s2">&quot;optimizer&quot;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">legacy</span><span class="o">.</span><span class="n">Adam</span><span class="p">(),</span>
            <span class="s1">&#39;loss&#39;</span><span class="p">:</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span>
            <span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">],</span>
        <span class="p">},</span>
        <span class="s1">&#39;fit&#39;</span><span class="p">:{</span>
            <span class="s1">&#39;epochs&#39;</span> <span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="s1">&#39;verbose&#39;</span> <span class="p">:</span> <span class="mi">0</span>
        <span class="p">},</span>
        <span class="s1">&#39;save&#39;</span><span class="p">:{</span>
            <span class="s1">&#39;dirs&#39;</span> <span class="p">:</span> <span class="s1">&#39;models&#39;</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;multiclass_model&#39;</span><span class="p">,</span>
            <span class="s1">&#39;export_graph&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CNN_Model</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">pathmodel</span> <span class="o">=</span> <span class="kc">None</span> <span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">DefaultMunch</span><span class="o">.</span><span class="n">fromDict</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="o">.</span><span class="n">epochs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="o">.</span><span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_datagen</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pathmodel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pathmodel</span> <span class="o">=</span> <span class="n">pathmodel</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">pathmodel</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_datafolder</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">load_datafolder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">data_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dirs</span>
        <span class="n">data_folder</span> <span class="o">=</span> <span class="n">data_cfg</span><span class="o">.</span><span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_folder</span><span class="p">,</span> <span class="n">data_cfg</span><span class="o">.</span><span class="n">train_subfolder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_folder</span><span class="p">,</span> <span class="n">data_cfg</span><span class="o">.</span><span class="n">test_subfolder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_folder</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span> 
                           <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_folder</span><span class="p">,</span> <span class="n">i</span><span class="p">))]</span>
        <span class="k">if</span> <span class="n">view</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">data_folder</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dirpath</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dirnames</span><span class="p">)</span><span class="si">}</span><span class="s2"> directories + </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span><span class="si">}</span><span class="s2"> images&quot;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">create_datagen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">load_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aug_datagen</span> <span class="o">=</span> <span class="n">ImageDataGenerator</span><span class="p">(</span><span class="o">**</span><span class="n">load_cfg</span><span class="o">.</span><span class="n">aug_generator</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nonaug_datagen</span> <span class="o">=</span> <span class="n">ImageDataGenerator</span><span class="p">(</span><span class="o">**</span><span class="n">load_cfg</span><span class="o">.</span><span class="n">non_aug_generator</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loads and Preprocess data &quot;&quot;&quot;</span>
        <span class="n">load_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aug_datagen</span> <span class="k">if</span> <span class="n">load_cfg</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">aug_train</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonaug_datagen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aug_datagen</span> <span class="k">if</span> <span class="n">load_cfg</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">aug_test</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonaug_datagen</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;train: &quot;</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_gen</span><span class="o">.</span><span class="n">flow_from_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_folder</span><span class="p">,</span><span class="o">**</span><span class="n">load_cfg</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;test: &quot;</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_gen</span><span class="o">.</span><span class="n">flow_from_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_folder</span><span class="p">,</span><span class="o">**</span><span class="n">load_cfg</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_indices</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_data</span><span class="o">.</span><span class="n">class_indices</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    
    <span class="k">def</span> <span class="nf">load_pred_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred_dir</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pred_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dirs</span><span class="o">.</span><span class="n">pred_subfolder</span> <span class="k">if</span> <span class="n">pred_dir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pred_dir</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pred_dir</span><span class="p">):</span>
            <span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">pred_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;.&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">pred_dir</span><span class="p">):</span>
            <span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">pred_dir</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pred_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_dir</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No pred_dir !&#39;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="n">flow</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;class_mode&#39;</span><span class="p">}</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">])</span>
        <span class="n">pred_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonaug_datagen</span><span class="o">.</span><span class="n">flow_from_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_dir</span><span class="p">,</span>
                                                <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">y_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                                                <span class="n">class_mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">flow</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">pred_data</span>
            
    <span class="k">def</span> <span class="nf">preview_image_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span> <span class="o">=</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">n_aug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_gen</span> <span class="k">if</span> <span class="n">dataset</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_gen</span>
        <span class="n">fol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_folder</span> <span class="k">if</span> <span class="n">dataset</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_folder</span>
        <span class="n">class_name</span> <span class="o">=</span> <span class="n">choice</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span>  <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">fol</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_list</span><span class="p">])</span>
        <span class="n">ran_img</span> <span class="o">=</span> <span class="n">choice</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fol</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)))</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;filename&quot;</span><span class="p">:</span><span class="n">ran_img</span><span class="p">,</span><span class="s2">&quot;class&quot;</span><span class="p">:</span><span class="n">class_name</span><span class="p">},</span> <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">flow</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;class_mode&#39;</span><span class="p">}</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="n">flow_from_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fol</span><span class="p">,</span> <span class="n">class_name</span><span class="p">),</span> <span class="o">**</span><span class="n">flow</span><span class="p">)</span>
        <span class="n">imgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">next</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_aug</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_view</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imgs</span><span class="p">,</span> <span class="n">subtitles</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">(</span><span class="n">num</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="o">//</span><span class="mi">4</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="mi">4</span> <span class="k">if</span> <span class="p">(</span><span class="n">rows</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
        <span class="c1"># plt.figure(figsize=(4*rows, 4*cols))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">imgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
            <span class="k">if</span> <span class="n">subtitles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">subtitles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="s1">&#39;relu&#39;</span><span class="p">,</span><span class="n">input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">224</span><span class="p">,</span><span class="mi">224</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="s1">&#39;relu&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPool2D</span><span class="p">(</span><span class="n">pool_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="s1">&#39;relu&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="s1">&#39;relu&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPool2D</span><span class="p">(</span><span class="n">pool_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Flatten</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;softmax&#39;</span><span class="p">))</span>

    
    <span class="k">def</span> <span class="nf">get_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># To prevent over fitting we will stop the learning after 4 epochs and val_loss value not decreased</span>
        <span class="n">earlystop</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">patience</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        
        <span class="c1"># reduce the learning rate when then accuracy not increase for 2 steps</span>
        <span class="n">learning_rate_reduction</span> <span class="o">=</span> <span class="n">ReduceLROnPlateau</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_accuracy&#39;</span><span class="p">,</span> 
                                            <span class="n">patience</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
                                            <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                                            <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
                                            <span class="n">min_lr</span><span class="o">=</span><span class="mf">0.00001</span><span class="p">)</span>
        <span class="c1"># process bar</span>
        <span class="n">tqdm_probar</span> <span class="o">=</span> <span class="n">TqdmCallback</span><span class="p">()</span>
        
        <span class="c1"># save model checkpoint</span>
        <span class="c1"># modelcheck = ModelCheckpoint(filepath, monitor=&#39;val_accuracy&#39;,mode=&#39;max&#39;, save_best_only=True)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">tqdm_probar</span><span class="p">,</span> <span class="n">learning_rate_reduction</span><span class="p">,</span> <span class="n">earlystop</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epochs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">epochs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span> <span class="o">=</span> <span class="n">epochs</span>
        <span class="n">model_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_callbacks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="o">**</span><span class="n">model_cfg</span><span class="o">.</span><span class="n">compile</span><span class="p">)</span>
        <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_data</span><span class="p">,</span> <span class="n">steps_per_epoch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_len</span><span class="p">,</span>
                                <span class="n">validation_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_data</span><span class="p">,</span> <span class="n">validation_steps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_len</span><span class="p">,</span> 
                               <span class="n">callbacks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">,</span> <span class="n">epochs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">train_res</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;val_&quot;</span><span class="p">)]</span>
        <span class="n">valid_res</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;val_&quot;</span><span class="p">)]</span>
        <span class="n">epochs</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_res</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_res</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;training_&#39;</span><span class="o">+</span><span class="n">m</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;val_&quot;</span><span class="o">+</span><span class="n">m</span><span class="p">)</span> <span class="ow">in</span> <span class="n">valid_res</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;val_&quot;</span><span class="o">+</span><span class="n">m</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;val_&quot;</span><span class="o">+</span><span class="n">m</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Epochs&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epochs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">export</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">modelname</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">modelname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">modelname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">epochs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">export</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">modelname</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">plot_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">show_shapes</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_load_image_from_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">url</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">load_img</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">read</span><span class="p">()),</span> <span class="n">target_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">target_size</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">img_to_array</span><span class="p">(</span><span class="n">img</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># @tf.function</span>
    <span class="k">def</span> <span class="nf">predict_from_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_image_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonaug_datagen</span><span class="o">.</span><span class="n">flow</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="n">steps</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
            <span class="n">pred_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_indices</span><span class="p">[</span><span class="n">pred</span><span class="p">]</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;prediction: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pred_label</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_view</span><span class="p">(</span><span class="n">gen</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="p">[</span><span class="n">title</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error to load url, try another !&#39;</span><span class="p">)</span>
    
    
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred_dir</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">max_visualization</span> <span class="o">=</span> <span class="mi">4</span><span class="p">):</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">pred_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_pred_data</span><span class="p">(</span><span class="n">pred_dir</span><span class="p">)</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">pred_data</span><span class="p">,</span> <span class="n">steps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_data</span><span class="p">))</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">preds</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prediction_label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_indices</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_visualization</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_visualization</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="o">//</span><span class="mi">4</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="n">rows</span><span class="p">))</span>
            <span class="n">df_sample</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">max_visualization</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df_sample</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()):</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span>
                <span class="n">category</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;prediction_label&#39;</span><span class="p">]</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">load_img</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pred_dir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">,</span> <span class="n">target_size</span><span class="o">=</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span><span class="mi">224</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;(prediction: </span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">category</span><span class="p">)</span> <span class="p">)</span>
                
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">graph</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">history</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">save_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save</span>
        <span class="n">timesr</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;_%Y_%m_</span><span class="si">%d</span><span class="s2">_%H_%M_%S&quot;</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_cfg</span><span class="o">.</span><span class="n">dirs</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="n">timesr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/class_indices.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_pi</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_indices</span><span class="p">,</span> <span class="n">file_pi</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">graph</span><span class="p">:</span>
            <span class="n">plot_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">to_file</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/model_architecture.png&#39;</span><span class="p">,</span> <span class="n">show_shapes</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">history</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/history.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_pi</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">,</span> <span class="n">file_pi</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model has saved in: &#39;</span> <span class="o">+</span> <span class="n">path</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span> <span class="o">+</span> <span class="s1">&#39;/class_indices.pkl&#39;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_pi</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">class_indices</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_pi</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;history.pkl&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span> <span class="o">+</span> <span class="s1">&#39;/history.pkl&#39;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_pi</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_pi</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loaded a model in: &quot;</span> <span class="o">+</span> <span class="n">filepath</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">distributed_train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;train with multi-GPU and clusters&quot;&quot;&quot;</span>
        <span class="n">mirrored_strategy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">distribute</span><span class="o">.</span><span class="n">MirroredStrategy</span><span class="p">(</span><span class="n">devices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;/gpu:0&quot;</span><span class="p">,</span> <span class="s2">&quot;/gpu:1&quot;</span><span class="p">])</span>
        <span class="k">with</span> <span class="n">mirrored_strategy</span><span class="o">.</span><span class="n">scope</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>


        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TF_CONFIG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;cluster&quot;</span><span class="p">:{</span>
                    <span class="s2">&quot;worker&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;host1:port&quot;</span><span class="p">,</span> <span class="s2">&quot;host2:port&quot;</span><span class="p">,</span> <span class="s2">&quot;host3:port&quot;</span><span class="p">]</span>
                <span class="p">},</span>
                <span class="s2">&quot;task&quot;</span><span class="p">:{</span>
                     <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;worker&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="mi">1</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">multi_worker_mirrored_strategy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">distribute</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">MultiWorkerMirroredStrategy</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">multi_worker_mirrored_strategy</span><span class="o">.</span><span class="n">scope</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

        <span class="n">parameter_server_strategy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">distribute</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">ParameterServerStrategy</span><span class="p">()</span>

        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TF_CONFIG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;cluster&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;worker&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;host1:port&quot;</span><span class="p">,</span> <span class="s2">&quot;host2:port&quot;</span><span class="p">,</span> <span class="s2">&quot;host3:port&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;ps&quot;</span><span class="p">:</span>  <span class="p">[</span><span class="s2">&quot;host4:port&quot;</span><span class="p">,</span> <span class="s2">&quot;host5:port&quot;</span><span class="p">]</span>
                <span class="p">},</span>
                <span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;worker&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="mi">1</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">multiclass</span> <span class="o">=</span> <span class="n">CNN_Model</span><span class="p">(</span><span class="n">CFG2</span><span class="p">)</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>train: Found 5860 images belonging to 10 classes.
test: Found 2500 images belonging to 10 classes.
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "8ee9c85b06894b02994469bee4776573", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:absl:Found untraced functions such as _jit_compiled_convolution_op, _jit_compiled_convolution_op, _jit_compiled_convolution_op, _jit_compiled_convolution_op while saving (showing 4 of 4). These functions will not be directly callable after loading.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:tensorflow:Assets written to: models/multiclass_model_2023_04_28_17_04_05/assets
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:tensorflow:Assets written to: models/multiclass_model_2023_04_28_17_04_05/assets
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model has saved in: models/multiclass_model_2023_04_28_17_04_05
</pre></div>
</div>
<img alt="../../_images/60bdd98bbd648c65652ee407eaa643ae5ac50958576ed0a458136a79f0d42c2c.png" src="../../_images/60bdd98bbd648c65652ee407eaa643ae5ac50958576ed0a458136a79f0d42c2c.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">multiclass</span><span class="o">.</span><span class="n">load_datafolder</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Datasets/10_food_classes_all_data/: 2 directories + 0 images
Datasets/10_food_classes_all_data/test: 10 directories + 0 images
Datasets/10_food_classes_all_data/test/ice_cream: 0 directories + 250 images
Datasets/10_food_classes_all_data/test/chicken_curry: 0 directories + 250 images
Datasets/10_food_classes_all_data/test/steak: 0 directories + 250 images
Datasets/10_food_classes_all_data/test/sushi: 0 directories + 250 images
Datasets/10_food_classes_all_data/test/chicken_wings: 0 directories + 250 images
Datasets/10_food_classes_all_data/test/grilled_salmon: 0 directories + 250 images
Datasets/10_food_classes_all_data/test/hamburger: 0 directories + 250 images
Datasets/10_food_classes_all_data/test/pizza: 0 directories + 250 images
Datasets/10_food_classes_all_data/test/ramen: 0 directories + 250 images
Datasets/10_food_classes_all_data/test/fried_rice: 0 directories + 250 images
Datasets/10_food_classes_all_data/train: 10 directories + 0 images
Datasets/10_food_classes_all_data/train/ice_cream: 0 directories + 750 images
Datasets/10_food_classes_all_data/train/chicken_curry: 0 directories + 470 images
Datasets/10_food_classes_all_data/train/steak: 0 directories + 750 images
Datasets/10_food_classes_all_data/train/sushi: 0 directories + 470 images
Datasets/10_food_classes_all_data/train/chicken_wings: 0 directories + 747 images
Datasets/10_food_classes_all_data/train/grilled_salmon: 0 directories + 470 images
Datasets/10_food_classes_all_data/train/hamburger: 0 directories + 470 images
Datasets/10_food_classes_all_data/train/pizza: 0 directories + 469 images
Datasets/10_food_classes_all_data/train/ramen: 0 directories + 514 images
Datasets/10_food_classes_all_data/train/fried_rice: 0 directories + 750 images
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">multiclass</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;sequential_12&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 conv2d_48 (Conv2D)          (None, 222, 222, 10)      280       
                                                                 
 conv2d_49 (Conv2D)          (None, 220, 220, 10)      910       
                                                                 
 max_pooling2d_24 (MaxPoolin  (None, 110, 110, 10)     0         
 g2D)                                                            
                                                                 
 conv2d_50 (Conv2D)          (None, 108, 108, 10)      910       
                                                                 
 conv2d_51 (Conv2D)          (None, 106, 106, 10)      910       
                                                                 
 max_pooling2d_25 (MaxPoolin  (None, 53, 53, 10)       0         
 g2D)                                                            
                                                                 
 flatten_12 (Flatten)        (None, 28090)             0         
                                                                 
 dense_12 (Dense)            (None, 10)                280910    
                                                                 
=================================================================
Total params: 283,920
Trainable params: 283,920
Non-trainable params: 0
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://media.gettyimages.com/id/170940477/photo/ice-cream.jpg?s=612x612&amp;w=gi&amp;k=20&amp;c=5Xb4b9Y5pJzyQuh1ER-0-BO51GR8kcBwuokqRkTYWpM=&#39;</span>
<span class="n">multiclass</span><span class="o">.</span><span class="n">predict_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1/1 [==============================] - 0s 24ms/step
</pre></div>
</div>
<img alt="../../_images/ac7f78d894425ded7fd7c3779cafbb23e35306e5c914f81c775aabd7fb521dfb.png" src="../../_images/ac7f78d894425ded7fd7c3779cafbb23e35306e5c914f81c775aabd7fb521dfb.png" />
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./5_Deep_learning/learning_course"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="1_TF_Fundamentals_v2.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">3.1. </span>Fundamentals</p>
      </div>
    </a>
    <a class="right-next"
       href="3_NLP_RNN.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">3.5. </span>Natural Language Processing</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview-cv">3.4.1. Overview CV</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#usage">3.4.1.1. Usage</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#inputs-and-outputs">3.4.1.2. Inputs and outputs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview-cnn">3.4.2. Overview CNN</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#types-of-layer">3.4.2.1. Types of layer</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#input-layer">3.4.2.1.1. Input layer</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#convolutional-layer">3.4.2.1.2. Convolutional layer</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#filter-hyperparameters">3.4.2.1.2.1. Filter hyperparameters</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#hidden-activation-function">3.4.2.1.3. Hidden Activation Function</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#pooling-layer">3.4.2.1.4. Pooling layer</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#flatten-layer-fully-connected-dense">3.4.2.1.5. Flatten Layer (Fully Connected Dense)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#output-layer-and-activation">3.4.2.1.6. Output Layer and activation</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tunning-hyperparameters">3.4.2.2. Tunning hyperparameters</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#cau-truc-convolution-layer">3.4.2.2.1. Cấu trúc convolution layer</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#model-complexity">3.4.2.2.2. Model complexity</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ung-dung-cnn">3.4.2.3. Ứng dụng CNN</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#object-detection">3.4.2.3.1. Object detection</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#face-verification-and-recognition">3.4.2.3.2. Face verification and recognition</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extra-curriculum">3.4.3. Extra-curriculum</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#build-cnn-binary">3.4.4. Build CNN binary</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dataview">3.4.4.1. Dataview</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#thiet-ke-pipeline-end-to-end-model">3.4.4.2. Thiết kế pipeline end-to-end model</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#load-and-preprocess-images">3.4.4.2.1. Load and preprocess images</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#create-cnn-model">3.4.4.2.2. Create CNN model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#compile-model">3.4.4.2.3. Compile model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-model">3.4.4.2.4. Fit model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluate-model">3.4.4.2.5. Evaluate model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#improving-model">3.4.4.2.6. Improving model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">3.4.4.2.7. Tunning hyperparameters</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#prediction">3.4.4.2.8. Prediction</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#save-load-model">3.4.4.2.9. Save/load model</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#multi-class">3.4.5. Multi-class</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Khổng Tiến Đạt
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>