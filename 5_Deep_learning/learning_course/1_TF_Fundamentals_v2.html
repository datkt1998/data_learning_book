

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>3.1. Fundamentals &#8212; Machine Learning book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '5_Deep_learning/learning_course/1_TF_Fundamentals_v2';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="3.4. Computer Vision and CNN" href="2_ComputerVision_CNN.html" />
    <link rel="prev" title="3. Deep Learning Algorithms" href="../../1_Process_Modelling/Split_notebooks/0_toc_dl.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../../_jupyter_book_files/intro.html">
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../_jupyter_book_files/intro.html">
                    Welcome to Dat’s Notebook
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Process Modeling</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/0_toc_eda.html">1. Statistic and EDA</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/1_Statistics_and_EDA-0.html">1.1. Data Analyst Process</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/1_Statistics_and_EDA-1.html">1.2. Read datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/1_Statistics_and_EDA-2.html">1.3. Explore data analysis (EDA)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/1_Statistics_and_EDA-3.html">1.4. Description statistic</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/1_Statistics_and_EDA-4.html">1.5. Inferential statistic</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/1_Statistics_and_EDA-5.html">1.6. Kiểm định giả thuyết (Hypothesis testing)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/1_Statistics_and_EDA-6.html">1.7. ANOVA</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/0_toc_fe.html">2. Feature Engineering</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/2_Feature_engineering-1.html">2.1. Custom Transforms Function</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/2_Feature_engineering-2.html">2.2. Feature extraction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/2_Feature_engineering-3.html">2.3. Variable Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/2_Feature_engineering-4.html">2.4. Missing Imputation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/2_Feature_engineering-5.html">2.5. Categorical Encoding</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/2_Feature_engineering-6.html">2.6. Feature transformation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/2_Feature_engineering-7.html">2.7. Discretisation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/2_Feature_engineering-8.html">2.8. Outliers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/2_Feature_engineering-9.html">2.9. Feature scaling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/2_Feature_engineering-10.html">2.10. Feature selection</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/0_toc_imb.html">3. Imbalance Dataset Handling</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/3_Imbalance_data_handling-1.html">3.1. Data-level approaches</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/3_Imbalance_data_handling-2.html">3.2. Cost sensitive approaches</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/3_Imbalance_data_handling-3.html">3.3. Ensemble approaches</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/3_Imbalance_data_handling-4.html">3.4. Ensemble approaches</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/0_toc_fs.html">4. Feature Selection</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/3_Feature_selection_and_decomposition-1.html">4.1. Filter methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/3_Feature_selection_and_decomposition-2.html">4.2. Wrapped methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/3_Feature_selection_and_decomposition-3.html">4.3. Embedded methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/3_Feature_selection_and_decomposition-4.html">4.4. Hybrid methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/3_Feature_selection_and_decomposition-5.html">4.5. Feature decomposition</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/0_toc_eva.html">5. Evaluation Metrics</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/5_Evaluation_metrics-0.html">5.1. Define scorer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/5_Evaluation_metrics-1.html">5.2. Classification metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/5_Evaluation_metrics-2.html">5.3. Regression metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/5_Evaluation_metrics-3.html">5.4. Clustering metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/5_Evaluation_metrics-4.html">5.5. Pairwise metrics</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/6_Models_monitoring_production-0.html">6. Model Monitoring</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/6_Models_monitoring_production-1.html">6.7. Functional level monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/6_Models_monitoring_production-2.html">6.8. Operational level monitoring</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">ML/DL Algorithms</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/0_toc_ml_su.html">1. ML Supervised Learning</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/4_ML_Supervised_learning_Algorithms-0.html">1.1. Regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/4_ML_Supervised_learning_Algorithms-1.html">1.2. Naive Bayes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/4_ML_Supervised_learning_Algorithms-2.html">1.3. Discriminant Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/4_ML_Supervised_learning_Algorithms-3.html">1.4. Stochastic Gradient Descent</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/4_ML_Supervised_learning_Algorithms-4.html">1.5. Support Vector Machines (SVM)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/4_ML_Supervised_learning_Algorithms-5.html">1.6. Nearest neighbors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/4_ML_Supervised_learning_Algorithms-6.html">1.7. Tree-base model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/4_ML_Supervised_learning_Algorithms-7.html">1.8. Ensemble learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/4_ML_Supervised_learning_Algorithms-8.html">1.9. Multi-class and multi-output</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/4_ML_Supervised_learning_Algorithms-9.html">1.10. Neural network models</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/0_toc_ml_unsu.html">2. ML Unsupervised Learning</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-8"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/4_ML_Unsupervised_learning_Algorithms-0.html">2.1. Clustering</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/4_ML_Unsupervised_learning_Algorithms-1.html">2.2. Decomposing components</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/4_ML_Unsupervised_learning_Algorithms-2.html">2.3. Manifold learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/4_ML_Unsupervised_learning_Algorithms-3.html">2.4. Novelty and Outlier Detection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/4_ML_Unsupervised_learning_Algorithms-4.html">2.5. Neural network</a></li>
</ul>
</li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../../1_Process_Modelling/Split_notebooks/0_toc_dl.html">3. Deep Learning</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-9"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2 current active"><a class="current reference internal" href="#">3.1. Fundamentals</a></li>


<li class="toctree-l2"><a class="reference internal" href="2_ComputerVision_CNN.html">3.4. Computer Vision and CNN</a></li>
<li class="toctree-l2"><a class="reference internal" href="3_NLP_RNN.html">3.5. Natural Language Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="4_Transfer_Learning.html">3.6. Transfer learning in CV</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">My Modules</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../3_Mathematics/0_toc.html">1. Mathematics</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-10"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../3_Mathematics/1_Linear_algebra.html">1.1. Linear algebra</a></li>



<li class="toctree-l2"><a class="reference internal" href="../../3_Mathematics/2_Calculus_and_optimization.html">1.5. Calculus and optimization</a></li>






<li class="toctree-l2"><a class="reference internal" href="../../3_Mathematics/3_Distribution_and_statistic.html">1.12. Distribution and statistics</a></li>

<li class="toctree-l2"><a class="reference internal" href="../../3_Mathematics/4_Information_theory.html">1.14. Information theory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../3_Mathematics/5_Graph_theory.html">1.15. Graph theory</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../4_Programming/0_toc.html">2. Programming</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-11"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../4_Programming/1_SQL.html">2.1. SQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../4_Programming/2_noSQL.html">2.2. noSQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../4_Programming/3_pySpark.html">2.3. pySpark</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../4_Programming/4_Python.html">2.4. Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../4_Programming/6_Git.html">2.5. Git</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../4_Programming/7_Docker.html">2.6. Docker</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../2_My_Modules/0_toc.html">3. My Functions</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-12"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../2_My_Modules/1_Data_Cleaning.html">3.1. Data Cleaning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2_My_Modules/2_Connection.html">3.2. Connection</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../6_Tools_and_Projects/0_toc.html">4. Tools and Projects</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-13"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../6_Tools_and_Projects/deploy_callAPI_model_in_GCP.html">4.1. Deploy model on GCP and call API streamlit</a></li>
</ul>
</li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/datkt1998/DS_learning_book" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/5_Deep_learning/learning_course/1_TF_Fundamentals_v2.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Fundamentals</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">3.1. Fundamentals</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview-of-deeplearning">3.1.1. Overview of DeepLearning</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#nhung-loi-khi-huan-luyen-mang">3.1.1.1. Những lỗi khi huấn luyện mạng</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#khong-hieu-cach-hoat-dong">3.1.1.1.1. Không hiểu cách hoạt động</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#train-khong-dung-logic">3.1.1.1.2. Train không đúng logic</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kinh-nghiem-train-nn">3.1.1.2. Kinh nghiệm train NN</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#hieu-ro-data">3.1.1.2.1. Hiểu rõ data</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#thiet-lap-1-quy-trinh-xay-dung-va-danh-gia-model">3.1.1.2.2. Thiết lập 1 quy trình xây dựng và đánh giá model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#overfitting">3.1.1.2.3. Overfitting</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#regularization">3.1.1.2.4. Regularization</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#tune-model">3.1.1.2.5. Tune model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#tan-dung-het-kha-nang-co-the">3.1.1.2.6. Tận dụng hết khả năng có thể</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#good-practice">3.1.1.3. Good practice</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#training-a-nn">3.1.1.3.1. Training a NN</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#definitions">3.1.1.3.1.1. Definitions</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#finding-optimal-weights">3.1.1.3.1.2. Finding optimal weights</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#parameter-tuning">3.1.1.3.2. Parameter tuning</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#weights-initialization">3.1.1.3.2.1. Weights initialization</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#optimizing-convergence-by-learning-rate">3.1.1.3.2.2. Optimizing convergence by learning rate</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">3.1.1.3.3. Regularization</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#overfitting-small-batch">3.1.1.3.4. Overfitting small batch</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#gradient-checking">3.1.1.3.5. Gradient checking</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#gradient-descent-optimization">3.1.2. Gradient descent optimization</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gradient-descent">3.1.2.1. Gradient descent</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cac-loai-gradient-descent-gd">3.1.2.2. Các loại gradient descent (GD)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cac-phuong-phap-optimize-gd">3.1.2.3. Các phương pháp optimize GD</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#newton">3.1.2.3.1. Newton</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-rate-changes">3.1.2.3.2. Learning rate changes</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#momentum">3.1.2.3.3. Momentum</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#nestorov-accelerated-gradient-nag">3.1.2.3.4. Nestorov accelerated gradient (NAG)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#adagrad">3.1.2.3.5. Adagrad</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#rmsprop">3.1.2.3.6. RMSprop</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#ada-delta">3.1.2.3.7. Ada-delta</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#adam">3.1.2.3.8. Adam</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#naadam">3.1.2.3.9. NaAdam</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#loss-function">3.1.2.4. Loss Function</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#cross-entropy-loss">3.1.2.4.1. Cross Entropy Loss</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#focal-loss">3.1.2.4.2. Focal loss</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#get-started-with-tf">3.1.3. Get started with TF</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tensor">3.1.4. Tensor</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-tensor">3.1.4.1. create tensor</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#create-tensor-with-tf-constant">3.1.4.1.1. create tensor with <code class="docutils literal notranslate"><span class="pre">tf.constant</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#create-tensors-with-tf-variable">3.1.4.1.2. create tensors with <code class="docutils literal notranslate"><span class="pre">tf.Variable()</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#create-random-tensor">3.1.4.1.3. create random tensor</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#zero-one-tensor">3.1.4.1.4. zero/one tensor</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#tensor-from-numpy-array">3.1.4.1.5. tensor from numpy array</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#convert-to-numpy-array">3.1.4.1.6. convert to numpy array</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tensor-function">3.1.4.2. tensor function</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#info-ndim-rank-size-shape">3.1.4.2.1. info: ndim, rank, size, shape</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#indexing">3.1.4.2.2. indexing</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#shuffle">3.1.4.2.3. shuffle</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#expand-dim">3.1.4.2.4. expand dim</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#set-global-random-seed">3.1.4.2.5. set global random seed</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#reshape">3.1.4.2.6. reshape</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#transpose">3.1.4.2.7. transpose</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tensor-operations">3.1.4.3. tensor operations</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#change-datatype">3.1.4.3.1. Change datatype</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#basic-operation">3.1.4.3.2. Basic operation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#dot-product-multiplication">3.1.4.3.3. Dot product / multiplication</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#tf-matmul">3.1.4.3.3.1. tf.matmul</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#tf-tensordot">3.1.4.3.3.2. tf.tensordot</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#absolute">3.1.4.3.4. absolute</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#aggregation">3.1.4.3.5. aggregation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#map-function">3.1.4.3.6. map function</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#squeezing">3.1.4.3.7. squeezing</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#one-hot-encoding">3.1.4.3.8. one-hot encoding</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#square-square-root-log">3.1.4.3.9. square / square_root / log</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tf-function">3.1.4.4. @tf.function</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configs-and-tools">3.1.5. Configs and tools</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#training-vs-inference-mode">3.1.5.1. Training vs Inference Mode</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#use-mixed-precision">3.1.5.2. Use mixed_precision</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tf-profiler">3.1.5.3. TF Profiler</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#types-of-layers">3.1.6. Types of layers</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#basic">3.1.6.1. Basic</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#dense">3.1.6.1.1. Dense</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activation">3.1.6.1.2. Activation</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#unit-step">3.1.6.1.2.1. Unit step</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#linear">3.1.6.1.2.2. Linear</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#softmax">3.1.6.1.2.3. Softmax</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#sigmoid">3.1.6.1.2.4. Sigmoid</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#hyperbolic-tangent-tanh">3.1.6.1.2.5. Hyperbolic Tangent (tanh)</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#relu">3.1.6.1.2.6. ReLU</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#leaky-relu">3.1.6.1.2.7. Leaky ReLU</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#parametric-relu">3.1.6.1.2.8. Parametric ReLU</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#exponential-linear-unit-elu">3.1.6.1.2.9. Exponential Linear Unit (ELU)</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#scaled-exponential-linear-unit-selu">3.1.6.1.2.10. Scaled Exponential Linear Unit (SELU)</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#swish">3.1.6.1.2.11. Swish</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#input">3.1.6.1.3. Input</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#flatten">3.1.6.1.4. Flatten</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pooling">3.1.6.2. Pooling</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#max-average-pooling">3.1.6.2.1. Max/Average Pooling</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#global-max-average-pooling">3.1.6.2.2. Global Max/Average Pooling</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#convolution">3.1.6.3. Convolution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">3.1.6.4. Regularization</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#weight-regularization">3.1.6.4.1. Weight regularization</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#early-stopping">3.1.6.4.2. Early stopping</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#dropout">3.1.6.4.3. Dropout</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#batch-normalization">3.1.6.5. Batch Normalization</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-augmentation">3.1.7. Data Augmentation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#image-augmentation">3.1.7.1. Image Augmentation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#text-augmentation">3.1.7.2. Text Augmentation</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#back-translation">3.1.7.2.1. Back translation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#easy-data-augmentation">3.1.7.2.2. Easy Data Augmentation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-generation">3.1.8. Data Generation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#imagedatagenerator">3.1.8.1. ImageDataGenerator</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#image-dataset-from-directory">3.1.8.2. image_dataset_from_directory</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tf-data-dataset">3.1.8.3. tf.data.Dataset</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#load-data-from-tensorflow-datasets">3.1.8.3.1. load data from tensorflow datasets</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#load-data-from-local-images">3.1.8.3.2. load data from local images</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#tfrecords">3.1.8.3.3. TFRecords</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#writing-tfrecords">3.1.8.3.3.1. Writing TFRecords</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#reading-tfrecords">3.1.8.3.3.2. Reading TFRecords</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#tfrecords-with-tpu-optional">3.1.8.3.3.3. Tfrecords with TPU (optional)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modeling-sytax">3.1.9. Modeling sytax</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sequential-api">3.1.9.1. Sequential API</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#keras-function-api">3.1.9.2. Keras Function API</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#subclassing-keras-model">3.1.9.3. Subclassing keras.Model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-template">3.1.9.4. Model Template</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#callbacks">3.1.10. Callbacks</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#process-bar">3.1.10.1. Process bar</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#early-stop">3.1.10.2. Early stop</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#decay-learning-rate">3.1.10.3. Decay learning rate</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#modelcheckpoint">3.1.10.4. ModelCheckpoint</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#log-tensorboard">3.1.10.5. Log TensorBoard</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluation">3.1.11. Evaluation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tracking-the-experiments">3.1.12. Tracking the experiments</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#setup-tensorboard-callback">3.1.12.1. Setup tensorboard callback</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#view-real-time-tu-notebook">3.1.12.2. View real-time từ notebook</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#see-experiments-on-local">3.1.12.3. See experiments on local</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#uploading-experiments-to-tensorboard">3.1.12.4. Uploading experiments to TensorBoard</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#check-list-uploaded">3.1.12.5. Check list uploaded</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#deleting-experiments-from-tensorboard">3.1.12.6. Deleting experiments from TensorBoard</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prediction">3.1.13. Prediction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#save-load-model">3.1.14. Save/load model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#transfer-learning">3.1.15. Transfer learning</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#phan-loai-cac-pretrain-model">3.1.15.1. Phân loại các pretrain model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#workflow">3.1.15.2. Workflow</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tensorflow-hub">3.1.15.3. TensorFlow Hub</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#keras-applications">3.1.15.4. Keras applications</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#dataset">3.1.15.4.1. Dataset</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#data-augumentation">3.1.15.4.2. Data Augumentation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#train-model">3.1.15.4.3. Train model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#warm-up">3.1.15.4.4. Warm up</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#fine-tuning-model">3.1.15.4.5. Fine tuning model</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#helper-module">3.1.16. Helper module</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#regression">3.2. Regression</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#datasets">3.2.1. Datasets</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modeling">3.2.2. Modeling</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-model-by-sequential">3.2.2.1. Create model by Sequential</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#create-delay-build-pattern-model">3.2.2.1.1. create delay-build pattern model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#create-model-with-input-shape">3.2.2.1.2. create model with Input_shape</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">3.2.2.2. Prediction</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#improving-model">3.2.2.3. Improving model</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#earlystopping">3.2.2.3.1. EarlyStopping</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluate-model">3.2.2.4. Evaluate model</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-data">3.2.2.4.1. visualize data</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-the-model">3.2.2.4.2. Visualize the model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-the-predictions">3.2.2.4.3. Visualize the predictions</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluate-prediction">3.2.2.4.4. Evaluate prediction</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">3.2.2.5. Tracking the experiments</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#clone-model">3.2.2.6. Clone model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">3.2.2.7. Save/load model</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#the-savedmodel-format-default">3.2.2.7.1. The SavedModel format (default)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#h5-format">3.2.2.7.2. H5 format</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#load-from-colab">3.2.2.7.3. load from colab</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-1">3.2.3. Example 1</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-2">3.2.4. Example 2</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#classification">3.3. Classification</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#binary-classification">3.3.1. Binary Classification</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-model">3.3.1.1. Create model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">3.3.1.2. Improving model</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#add-activation-function">3.3.1.2.1. add activation function</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-rate-scheduler-callback">3.3.1.2.2. learning rate scheduler callback</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#use-polynomial-features">3.3.1.2.3. Use Polynomial features</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#multi-class-classification">3.3.2. Multi-class classification</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">3.3.2.1. Create model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">3.3.2.2. Improving model</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#normalize-data">3.3.2.2.1. Normalize data</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">3.3.2.2.2. learning rate scheduler callback</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">3.3.2.3. Evaluate model</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#confusion-matrix">3.3.2.3.1. confusion matrix</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-model">3.3.2.3.2. plot model</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example">3.3.2.4. Example</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="fundamentals">
<h1><span class="section-number">3.1. </span>Fundamentals<a class="headerlink" href="#fundamentals" title="Permalink to this heading">#</a></h1>
<section id="overview-of-deeplearning">
<h2><span class="section-number">3.1.1. </span>Overview of DeepLearning<a class="headerlink" href="#overview-of-deeplearning" title="Permalink to this heading">#</a></h2>
<p><strong>1. DL good for ?</strong></p>
<ul class="simple">
<li><p>Problem with long list of rules/features</p></li>
<li><p>Continually changing model/prediction</p></li>
<li><p>Discovering insights within large collection of data</p></li>
</ul>
<p><strong>2. DL not good for ?</strong></p>
<ul class="simple">
<li><p>Need explainability model</p></li>
<li><p>traditional model is the good option</p></li>
<li><p>when errors are not unacceptable</p></li>
<li><p>when you don’t have much data</p></li>
</ul>
<p><strong>3. ML vs DL</strong></p>
<ul class="simple">
<li><p>ML thường phục vụ structured data và có perform tốt hơn so với DL với dữ liệu này, còn DL performs better on unstructured data such as images, voice, text,…</p></li>
<li><p>Các thuật toán:</p>
<ul>
<li><p>ML: RF, naive bayes, nn, svm,…</p></li>
<li><p>DL: NN, CNN, RNN</p></li>
</ul>
</li>
</ul>
<p><strong>4. DL use case</strong></p>
<p><strong>Nguồn tìm kiếm các paper + code của các model SOTA theo từng task tại <a class="reference external" href="https://paperswithcode.com/sota">papers with code</a></strong></p>
<ul class="simple">
<li><p>Recommendation</p></li>
<li><p>Sequence to sequency:</p>
<ul>
<li><p>Translation</p></li>
<li><p>Speed recognition</p></li>
</ul>
</li>
<li><p>Classification/ Regression:</p>
<ul>
<li><p>Computer vision</p></li>
<li><p>NLP</p></li>
</ul>
</li>
</ul>
<section id="nhung-loi-khi-huan-luyen-mang">
<h3><span class="section-number">3.1.1.1. </span>Những lỗi khi huấn luyện mạng<a class="headerlink" href="#nhung-loi-khi-huan-luyen-mang" title="Permalink to this heading">#</a></h3>
<section id="khong-hieu-cach-hoat-dong">
<h4><span class="section-number">3.1.1.1.1. </span>Không hiểu cách hoạt động<a class="headerlink" href="#khong-hieu-cach-hoat-dong" title="Permalink to this heading">#</a></h4>
<p>Mặc dù các thư viện cung cấp các API giúp việc xây dựng và train model trở nên thuận tiện, nhưng nếu chúng ta ko hiểu cách hoạt động của chúng ( ví dụ : không biết sự khác biệt giữa SGD và Adam ) thì rất khó có cơ sở để lựa chọn phương pháp sao cho phù hợp với vấn đề cần giải quyết, từ đó tiến đến sự ổn định và hiệu quả của model.</p>
<p>Tóm gọn lại, trước khi sử dụng bất kỳ một thứ gì trong quá trình train, mặc dù ta sử dụng API nên rất dễ dàng trong việc áp dụng nhưng phải hiểu được bản chất của phương pháp, ưu và nhược điểm hay các TH sử dụng của nó.</p>
</section>
<section id="train-khong-dung-logic">
<h4><span class="section-number">3.1.1.1.2. </span>Train không đúng logic<a class="headerlink" href="#train-khong-dung-logic" title="Permalink to this heading">#</a></h4>
<p>Mặc dù trong quá trình train đến kết quả không gặp lỗi hay biến số bất thường nào, nhưng vẫn có thể sai về mặt logic trong quá trình biến đổi dữ liệu.</p>
<blockquote>
<div><p>Ví dụ: Thay vì hạn chế tác động của gradient lớn thì lại làm giảm loss, nguyên nhân là do outlier bị loại bỏ</p>
</div></blockquote>
<p>Từ đó dẫn tới việc, model train ko ra lỗi, nhưng càng train thì performance càng tệ đi.</p>
</section>
</section>
<section id="kinh-nghiem-train-nn">
<h3><span class="section-number">3.1.1.2. </span>Kinh nghiệm train NN<a class="headerlink" href="#kinh-nghiem-train-nn" title="Permalink to this heading">#</a></h3>
<p>Kinh nghiệm chung là với mỗi vấn đề cần phải thử, thí nghiệm cho tới khi đạt được hiệu quả hoặc hiểu rõ vấn đề, rồi mới giải quyết vấn đề tiếp theo thay vì 1 lần đem một đống thứ cần thử và không thể biết hướng đi nào cần cải tiến tiếp theo.</p>
<p><strong>Kinh nghiệm modeling theo quá trình build model:</strong></p>
<section id="hieu-ro-data">
<h4><span class="section-number">3.1.1.2.1. </span>Hiểu rõ data<a class="headerlink" href="#hieu-ro-data" title="Permalink to this heading">#</a></h4>
<p>Thay vì sử dụng ngay các dòng code xây dựng mạng NN thì việc đầu tiên nên làm đó là hiểu thật kỹ về data:</p>
<ul class="simple">
<li><p>Hiểu sample: variance, distribution, tìm kiếm những pattern đại diện trong data</p></li>
<li><p>Sự imbalance data</p></li>
<li><p>Những sample outlier</p></li>
<li><p>Tính tương quan của dữ liệu</p></li>
</ul>
<p>Thêm vào đó, cần tracking được lý do các dự đoán sai từ model, từ đó đưa ra được hướng cải thiện</p>
</section>
<section id="thiet-lap-1-quy-trinh-xay-dung-va-danh-gia-model">
<h4><span class="section-number">3.1.1.2.2. </span>Thiết lập 1 quy trình xây dựng và đánh giá model<a class="headerlink" href="#thiet-lap-1-quy-trinh-xay-dung-va-danh-gia-model" title="Permalink to this heading">#</a></h4>
<p>Ban đầu hãy xây dựng 1 baseline model từ bước tạo model, comppile, fitting, evaluate model thành 1 quy trình có khung sườn. Sử dụng các đánh giá và thí nghiệm thay đổi các hyperparameters để quan sát sự cải thiện của model dần dần. Các tips cho việc này bao gồm:</p>
<ol class="arabic simple">
<li><p>Tạo <strong>baseline model</strong> có thể là những model đơn giản nhất hoặc mạng nn đơn giản nhất</p></li>
<li><p>Sử dụng <strong>cố định random seed</strong></p></li>
<li><p><strong>Đơn giản hoá cho model ban đầu</strong>: loại bỏ data augmentation vì học tăng cường lại dữ liệu chỉ là 1 chiến lược regularization sau này, ở bước ban đầu nên hạn chế để tránh gặp các lỗi ko cần thiết. Ví dụ : xoay ảnh, lật ảnh chính là học tăng cường</p></li>
<li><p><strong>Xây dựng các bộ đánh giá trên đầy đủ các khía cạnh</strong> để đảm bảo tính hiệu quả và chất lượng của model</p></li>
<li><p><strong>Xác định đúng Loss function</strong> ngay từ thời điểm ban đầu và nhất quán sử dụng nó.</p></li>
<li><p><strong>Khởi tạo tốt tham số cho layer output</strong>: xây dựng các ước lượng ban đầu tốt cho output sẽ giúp model nhanh chóng tìm được điểm tối ưu và tránh các điểm giả global minimum loss sẽ phải gặp tại các iter ban đầu trong quá trình train</p></li>
</ol>
<blockquote>
<div><ul class="simple">
<li><p>Nếu trong bài toán regression, giá trị mean target là 50 thì có thể đặt giá trị bias là 50 để nhanh chóng tìm được điểm tối ưu cho bias</p></li>
<li><p>Nếu trong bài toán classification bị imbalance là good/bad = 9/1 thì có thể đặt giá trị cutoff probability ban đầu là tại điểm 0.9 để phù hợp với tỷ lệ good/bad ngoài thực tế.</p></li>
</ul>
</div></blockquote>
<ol class="arabic simple" start="7">
<li><p><strong>Chú ý vào metrics thay vì loss</strong>: metrics (ví dụ như accuracy) là thứ mà có thể giải thích và có thể so sánh được giữa các model với nhau</p></li>
<li><p>Tạo một <strong>baseline model với dự đoán ngẫu nhiên</strong> so sánh với model học được dữ liệu xem xem model sau khi được train có học được gì từ dữ liệu hay không hay hiệu suất tương đương với random guess model</p></li>
<li><p>Thử <strong>overfit 1 batch với số lượng samples nhỏ</strong> ( ví dụ batch chỉ có 5 samples và overfit batch này) để lấy được giá trị minimumm loss, nếu minimum loss không tiệm cận được 0 thì có vẻ như có 1 bug ở đâu đó trong quá trình biến đổi dữ liệu (lỗi 2)</p></li>
<li><p>Đánh giá <strong>mức giảm của loss khi tăng độ phức tạp của model</strong></p></li>
<li><p>Sử dụng dữ liệu ngay trước khi đưa vào mạng, decode ngược lại raw data để tracking tính đúng đắn của việc preprocessing và data augmentation</p></li>
<li><p><strong>Quan sát sự thay đổi của prediction</strong>: visualize the test prediction trong suốt quá trình training để đảm bảo việc đi đúng hướng của model. Nếu hiệu suất của tập test ko cải thiện hoặc ổn định theo quá trình training thì có thể nên set một learning_rate thấp hơn để tăng sự ổn định.</p></li>
</ol>
</section>
<section id="overfitting">
<h4><span class="section-number">3.1.1.2.3. </span>Overfitting<a class="headerlink" href="#overfitting" title="Permalink to this heading">#</a></h4>
<p><img alt="various options you can use to improve a neural network model" src="https://raw.githubusercontent.com/mrdbourke/tensorflow-deep-learning/main/images/02-improving-a-model-from-model-perspective.png" /></p>
<p>Ở bước này chúng ta đã hiểu về dữ liệu và có 1 pipeline train + đánh giá hoạt động được.
Việc cần làm là tìm ra 1 model tốt bằng việc <strong>tìm 1 mô hình đủ lớn để overfit</strong> (loss tập train đủ thấp) rồi sau đó <strong>regularize cho phù hợp</strong> để cải thiện val_loss.</p>
<blockquote>
<div><p>Lý do chọn hướng tiếp cận này là nếu loss_train ko đủ thấp tức là model có thể bị lỗi, có vấn đề hoặc misconfiguration nào đó.</p>
</div></blockquote>
<p><strong>Một số tips:</strong></p>
<ol class="arabic simple">
<li><p><strong>Chọn model</strong>: Để có 1 train_loss đủ thấp thì model cần có 1 architecture phù hợp với dữ liệu. Thay vì sáng tạo các kiến trúc cảm thấy sẽ hiệu quả thì hãy tìm các paper liên quan nhất và copy những kiến trúc đơn giản nhất của họ và phát triển nó.</p></li>
</ol>
<blockquote>
<div><p>Ví dụ nếu làm image classification, hãy copy kiến trúc mạng của ResNet-50 trước, sau đó có thể phát triển lên từ đó.</p>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p><strong>Adam là sự lựa chọn an toàn</strong>: với những baseline ban đầu, hãy ưu tiên với Adam(lr = 3e-4). Adam có thể dễ dàng bỏ qua những hyperparameter tệ (bao gồm cả learning_rate).</p>
<ul class="simple">
<li><p>Với các mạng CNN, optimizer = SGD sẽ hiệu quả hơn 1 chút so với Adam, những giá trị lr tối ưu chỉ trong 1 range rất hẹp và tuỳ vào bài toán cụ thể</p></li>
<li><p>Với bài toán RNN, time-series thì ưu tiên Adam</p></li>
</ul>
</li>
<li><p><strong>Chỉ nên tunning (làm phức tạp) một yếu tố tại 1 thời điểm</strong>: hãy tunning từng parameter và đảm bảo performance được cải thiện trước khi sang hyperparameter tiếp theo</p></li>
<li><p><strong>Đừng tin vào default decay-learning rate</strong>: Với mỗi bài toán và vấn đề cụ thể thì hệ số giảm của learning rate sẽ khác nhau, nếu ko cẩn thận sẽ đưa lr về 0 trong khi việc học vẫn chưa xong. Hãy sử dụng <strong>constant learning rate và tunning decay - learning rate sau cùng</strong></p></li>
</ol>
</section>
<section id="regularization">
<h4><span class="section-number">3.1.1.2.4. </span>Regularization<a class="headerlink" href="#regularization" title="Permalink to this heading">#</a></h4>
<p>Sau khi đã có một model đủ tốt trên tập train với train_loss đủ thấp thì chúng ta cần regularize để cải thiện độ chính xác của validation set ( đương nhiên là sẽ giảm hiệu xuất của train set), một số phương pháp giúp regularize:</p>
<ol class="arabic simple">
<li><p><strong>Lấy thêm dữ liệu</strong> : Đây là cách tốt nhất và được khuyến khích nhất để regularize một mô hình trong bất cứ setting nào. Một sai lầm thường thấy là vắt kiệt việc học từ data train đã có mà ko bổ sung thêm dữ liệu sẵn có mới bên ngoài mà có thể thu thập được.</p></li>
<li><p><strong>Sử dụng Emsemble model</strong>: nếu có thể thì tối đa nên sử dụng 5 model</p></li>
<li><p><strong>Dữ liệu tăng cường (data augmentation)</strong>: Nếu ko thể lấy thêm dữ liệu thì hãy sử dụng 1 số phương pháp biến đổi dữ liệu để học tăng cường</p></li>
<li><p><strong>Dữ liệu tăng cường bằng việc làm giả hoàn toàn bằng các phương pháp</strong>: tạo thêm dữ liệu xung quanh dataraw, domain randomization, use of simulation, clever hybrids such as inserting (potentially simulated) data into scenes, or even GANs.</p></li>
<li><p><strong>Pretrain model</strong>: Sử dụng các model đã được pretrain sẵn bằng nguồn dữ liệu lớn đã có</p></li>
<li><p><strong>Hãy bám vào supervised learning</strong>: đừng nên quá lạm dụng các model unsupervised learning</p></li>
<li><p><strong>Giảm input dimensionality</strong> : loại bỏ một số đặc trưng có thể giúp bỏ đi các tín hiệu giả (các tín hiệu ko hỗ trợ trong việc dự đoán output), những redunce feature được sử dụng sẽ làm model bị overfitting. Có thể sử dụng các phương pháp làm giảm chiều dữ liệu như PCA.</p></li>
<li><p><strong>Thử một model nhỏ hơn (giảm số layers/nodes)</strong>: sử dụng kiến thức về dữ liệu có thể làm một cách để ràng buộc sử dụng/ hoặc ko sử dụng một số node/hay layers nào đó thay vì sử dụng fully connected layers.</p></li>
<li><p><strong>Giảm batch_size</strong>: Sử dụng normalize với smaller batch sẽ tâng mức độ regularization</p></li>
<li><p><strong>Sử dụng phạt L1/L2</strong>: Sử dụng L2 phạt nặng hơn L1 khi W tăng mạnh</p></li>
<li><p><strong>Dropout</strong> : Thêm Dropout, bổ sung xác xuất tắt node trong layer,  tuy nhiên sử dụng một cách cẩn thận, hạn chế vì có vẻ Dropout không thích chơi chung với BatchNorm</p></li>
<li><p><strong>Batch Normalization</strong>: normalize batch trước khi đưa vào training</p></li>
<li><p><strong>Early stopping</strong>: Bổ sung điều kiện dừng sớm epochs khi validattion_loss có xu hướng overfit. Ưu tiên sử dụng Early stopping với large model so với full-epoch + smaller model</p></li>
<li><p><strong>Decay weighted</strong>: Tăng mức weight decay cho các tham số học, tăng regularization</p></li>
</ol>
<p>Hãy visualize first layer output để chắc chắn những khía cạnh nó học được là hợp lý</p>
</section>
<section id="tune-model">
<h4><span class="section-number">3.1.1.2.5. </span>Tune model<a class="headerlink" href="#tune-model" title="Permalink to this heading">#</a></h4>
<p>muốn tìm một kiến trúc đạt được validation loss tốt nhất. Một vài tip và trick cho bước này:</p>
<ul class="simple">
<li><p>random grid search. Tune một lúc nhiều hyperparameter nghe có vẻ rất hấp dẫn bằng việc grid search nhằm bao quát hết tất cả các cách thiết lập, nhưng hãy nhớ trong đầu rằng cách tốt nhất là sử dụng random search (tham khảo <a class="reference external" href="https://jmlr.csail.mit.edu/papers/volume13/bergstra12a/bergstra12a.pdf">tại đây</a>). Một cách trực giác, bởi vì các mạng neuron thường nhạy cảm với một vài parameter hơn những cái khác. Trong giới hạn, nếu parameter a có nhiều tác động, nhưng thay đổi parameter b không có nhiều ảnh hưởng vậy bạn nên sample parameter a nhiều hơn thay vì cố định tại 1 điểm nhiều lần.</p></li>
</ul>
</section>
<section id="tan-dung-het-kha-nang-co-the">
<h4><span class="section-number">3.1.1.2.6. </span>Tận dụng hết khả năng có thể<a class="headerlink" href="#tan-dung-het-kha-nang-co-the" title="Permalink to this heading">#</a></h4>
<p>Một khi bạn đã tìm ra kiến trúc tốt nhất và các hyperparameter, bạn vẫn có thể sử dụng thêm 1 vài trick để tận dụng nốt các phần còn lại của hệ thống:</p>
<ul class="simple">
<li><p>Có một kĩ thuật gọi là Knowledge Distillation nhằm chuyển các tri thức học từ một mô hình lớn về một mô hình nhỏ hơn</p></li>
<li><p>Thử train model trong 1 thời gian dài, có thể sẽ đạt SOTA</p></li>
</ul>
</section>
</section>
<section id="good-practice">
<h3><span class="section-number">3.1.1.3. </span>Good practice<a class="headerlink" href="#good-practice" title="Permalink to this heading">#</a></h3>
<section id="training-a-nn">
<h4><span class="section-number">3.1.1.3.1. </span>Training a NN<a class="headerlink" href="#training-a-nn" title="Permalink to this heading">#</a></h4>
<section id="definitions">
<h5><span class="section-number">3.1.1.3.1.1. </span>Definitions<a class="headerlink" href="#definitions" title="Permalink to this heading">#</a></h5>
<ul class="simple">
<li><p>📚 <strong>Epoch</strong>: In the context of training a model, epoch is a term used to refer to one iteration where the model sees the whole training set to update its weights.</p></li>
<li><p>📚 <strong>Mini-batch gradient descent</strong>: During the training phase, updating weights is usually not based on the whole training set at once due to computation complexities or one data point due to noise issues. Instead, the update step is done on mini-batches, where the number of data points in a batch is a hyperparameter that we can tune.</p></li>
<li><p>📚 <strong>Loss function</strong>: In order to quantify how a given model performs, the loss function L is usually used to evaluate to what extent the actual outputs y are correctly predicted by the model outputs z</p></li>
<li><p>📚 <strong>Cross-entropy loss</strong>: In the context of binary classification in neural networks, the cross-entropy loss L(z,y) is commonly used and is defined as follows:</p></li>
</ul>
<p><img alt="" src="https://cdn.analyticsvidhya.com/wp-content/uploads/2021/03/Screenshot-from-2021-03-03-11-33-29.png" /></p>
</section>
<section id="finding-optimal-weights">
<h5><span class="section-number">3.1.1.3.1.2. </span>Finding optimal weights<a class="headerlink" href="#finding-optimal-weights" title="Permalink to this heading">#</a></h5>
<ul class="simple">
<li><p>📚 <strong>Backpropagation</strong>: Backpropagation là method để update the weights trong neural network bằng việc sử dụng sai lệch giữa output được predict và thực tế. The derivative liên quan đến each weight <code class="docutils literal notranslate"><span class="pre">w</span></code> sẽ được tính toán thông qua <strong>chain rule</strong>.</p></li>
</ul>
<p><img alt="" src="https://stanford.edu/~shervine/teaching/cs-230/illustrations/backpropagation-ltr.png?7ab0719a4825260ef208d87cdd195b9f" /></p>
<p>Qua đó, mỗi 1 weight sẽ được update theo công thức:
$<span class="math notranslate nohighlight">\(w \longleftarrow w-\alpha \frac{\partial L(z, y)}{\partial w}\)</span>$</p>
<p><img alt="" src="https://stanford.edu/~shervine/teaching/cs-230/illustrations/update-weights-en.png?5394a7bb976892418366d08646a0fd09" /></p>
</section>
</section>
<section id="parameter-tuning">
<h4><span class="section-number">3.1.1.3.2. </span>Parameter tuning<a class="headerlink" href="#parameter-tuning" title="Permalink to this heading">#</a></h4>
<section id="weights-initialization">
<h5><span class="section-number">3.1.1.3.2.1. </span>Weights initialization<a class="headerlink" href="#weights-initialization" title="Permalink to this heading">#</a></h5>
<ul class="simple">
<li><p>📚 <strong>Xavier initialization</strong>: Thay vì lựa chọn các params/weights ban đầu 1 cách ngẫu nhiên thì khởi tạo chúng bằng những khảo sát ban đầu và có khả năng là điểm optimal gần đó.</p></li>
<li><p>📚 <strong>Transfer learning</strong>: Các weights/params ban đầu hay thậm trí là 1 phần kiến trúc mạng đã được thiết kế từ trước và train trên các bộ dữ liệu lớn, đạt performance cao nên chỉ cần tận dụng lại.</p></li>
</ul>
<blockquote>
<div><p>Tips: Dữ liệu có size càng lớn thì unfreeze càng nhiều top layer của pretrain model sau khi đã train qua 1 vài epochs với feature extraction model.</p>
</div></blockquote>
</section>
<section id="optimizing-convergence-by-learning-rate">
<h5><span class="section-number">3.1.1.3.2.2. </span>Optimizing convergence by learning rate<a class="headerlink" href="#optimizing-convergence-by-learning-rate" title="Permalink to this heading">#</a></h5>
<ul class="simple">
<li><p>Fixed Learning rate</p></li>
<li><p>Schedule reduce learning rate</p></li>
<li><p>Adaptive learning rate</p>
<ul>
<li><p>Momentum</p></li>
<li><p>RMSprop</p></li>
<li><p>Adam</p></li>
</ul>
</li>
</ul>
</section>
</section>
<section id="id1">
<h4><span class="section-number">3.1.1.3.3. </span>Regularization<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h4>
</section>
<section id="overfitting-small-batch">
<h4><span class="section-number">3.1.1.3.4. </span>Overfitting small batch<a class="headerlink" href="#overfitting-small-batch" title="Permalink to this heading">#</a></h4>
<p>Khi debugging model, thường sử dụng quick test để kiểm tra các vấn đề liên quan đến kiến trúc mạng, tham số hay những tinh chỉnh đã đúng hay chưa ? Khi đó, cần sử dụng mini-datatrain và fit cho tới khi overfit trên small batch đó. Nếu không thể overfitting trên tập nhỏ thì khả năng mô hình chưa đủ tốt hoặc sai cấu trúc</p>
</section>
<section id="gradient-checking">
<h4><span class="section-number">3.1.1.3.5. </span>Gradient checking<a class="headerlink" href="#gradient-checking" title="Permalink to this heading">#</a></h4>
<p>Kiểm tra gradien là một phương thức được sử dụng trong quá trình thực hiện lan truyền ngược của mạng neural. Nó so sánh giá trị của gradien phân tích (analytical gradient) với gradien số (numerical gradient) tại các điểm đã cho và đóng vai trò kiểm tra độ chính xác của hàm đạo hàm xây dựng</p>
<p><img alt="" src="../../_images/gradient_checking.png" /></p>
</section>
</section>
</section>
<section id="gradient-descent-optimization">
<h2><span class="section-number">3.1.2. </span>Gradient descent optimization<a class="headerlink" href="#gradient-descent-optimization" title="Permalink to this heading">#</a></h2>
<section id="gradient-descent">
<h3><span class="section-number">3.1.2.1. </span>Gradient descent<a class="headerlink" href="#gradient-descent" title="Permalink to this heading">#</a></h3>
<p><strong>1. Gradient</strong></p>
<ul class="simple">
<li><p>là 1 vector chứa đạo hàm thành phần của hàm f(x1,x2,..,xn), nhiều gradient tạo thành 1 matrix jacobian</p></li>
</ul>
<p><strong>2. Gradient descent</strong></p>
<p><img alt="image.png" src="../../_images/gd1.png" /></p>
<p>Trong tối ưu, gradient là 1 hyperplane tiếp tuyến của f(x) tại điểm x = t, tương ứng với <span class="math notranslate nohighlight">\(W_t\)</span>, khi đó hệ số được update theo công thức: $<span class="math notranslate nohighlight">\(W_{t+1} = W_t - lr * gradient\)</span>$</p>
<ul class="simple">
<li><p>Thuật toán sẽ stop khi <span class="math notranslate nohighlight">\(|W_{t+1} - W_t| &lt;= \epsilon \)</span></p></li>
<li><p><strong>gradient</strong> = <span class="math notranslate nohighlight">\(\frac{\partial L}{\partial w}\)</span> = với hệ số góc của hyperplane = đạo hàm bậc 1 của f(x) tại x=t</p></li>
<li><p>Learning rate (lr) sẽ tác động tới khả năng học nhanh/chậm bằng việc điều chỉnh gradient</p>
<ul>
<li><p>Nếu nhiều data có thể set lr nhỏ, và ngược lại</p></li>
<li><p>Có thể để lr = <code class="docutils literal notranslate"><span class="pre">constant</span></code> hoặc lr giảm dần theo quá trình train (<span class="math notranslate nohighlight">\(\frac{lr}{\sqrt{t+1}}\)</span>)</p></li>
</ul>
</li>
</ul>
</section>
<section id="cac-loai-gradient-descent-gd">
<h3><span class="section-number">3.1.2.2. </span>Các loại gradient descent (GD)<a class="headerlink" href="#cac-loai-gradient-descent-gd" title="Permalink to this heading">#</a></h3>
<p>Các loại GD theo số lượng obs cho mỗi epoch train</p>
<p><strong>1. Vanilla GD/ Batch GD</strong></p>
<ul class="simple">
<li><p>Update 1 lần trên toàn bộ dataset</p></li>
<li><p><strong>Pros</strong> : đảm bảo hội tụ được tới <strong>GLOBAL minimum</strong> cho convex loss hoặc non-convex loss</p></li>
<li><p><strong>Cons</strong> :</p>
<ul>
<li><p>thuật toán chạy sẽ chậm với dữ liệu lớn,</p></li>
<li><p>ko đủ memory để load hết dữ liệu</p></li>
<li><p>không có khả năng update real-time</p></li>
</ul>
</li>
</ul>
<p><strong>2. Stochastic gradient descent (SGD)</strong></p>
<ul class="simple">
<li><p>Update weight theo từng quan sát lần lượt trên dataset</p></li>
<li><p><strong>Pros</strong> :</p>
<ul>
<li><p>Không gặp vấn đề về khả năng load, tính toán nhanh</p></li>
<li><p>Có tính train real-time, học online</p></li>
</ul>
</li>
<li><p><strong>Cons</strong> :</p>
<ul>
<li><p>Do học theo từng obs nên có variance cao</p></li>
<li><p>hướng di chuyển của hàm Loss không ổn định</p></li>
<li><p>Khả năng hội tụ lâu do học không ổn định hoặc đi sai hướng để tìm điểm loss tối ưu</p></li>
</ul>
</li>
</ul>
<p><strong>2. Mini-batch gradient descent</strong></p>
<ul class="simple">
<li><p>Chia data thành nhiều mini batch gồm n obs và lần lượt học theo từng mini-batch. Dữ liệu được lấy random cho từng batch.</p></li>
<li><p><strong>Pros</strong> :</p>
<ul>
<li><p>Giảm variance của parameter update, more stable convergence</p></li>
<li><p>Có thể sử dụng các thuật toán tối ưu hoá matrix theo từng batch để tăng tính hiệu quả. Ví dụ như batch normalization</p></li>
</ul>
</li>
<li><p><strong>Cons</strong> :</p>
<ul>
<li><p>Lựa chọn lr: Nếu quá nhỏ sẽ học chậm, nếu quá lớn thì loss sẽ giao động quanh điểm hội tụ hoặc thậm trí đi qua điểm tối ưu</p></li>
<li><p>Chưa giải quyết được vấn đề saddle point</p></li>
</ul>
</li>
</ul>
</section>
<section id="cac-phuong-phap-optimize-gd">
<h3><span class="section-number">3.1.2.3. </span>Các phương pháp optimize GD<a class="headerlink" href="#cac-phuong-phap-optimize-gd" title="Permalink to this heading">#</a></h3>
<section id="newton">
<h4><span class="section-number">3.1.2.3.1. </span>Newton<a class="headerlink" href="#newton" title="Permalink to this heading">#</a></h4>
<p>Là phương pháp tìm nghiệm điểm tối ưu (thay vì GD) bằng hessian matrix và inverse matrix</p>
<ul class="simple">
<li><p>Không có tính ứng dụng trong thực tiễn cho dữ liệu nhiều chiều hoặc do sự phúc tạp trong tính toán</p></li>
</ul>
</section>
<section id="learning-rate-changes">
<h4><span class="section-number">3.1.2.3.2. </span>Learning rate changes<a class="headerlink" href="#learning-rate-changes" title="Permalink to this heading">#</a></h4>
<p><strong>1. Decay lr</strong></p>
<p>Learning rate giảm qua mỗi epoch, tuy nhiên ko control được yếu tố còn lại là gradient
$<span class="math notranslate nohighlight">\(lr_{new} = \frac{lr_{old}}{1 + \text{decay rate} * \text{num rate}}\)</span>$</p>
<p><strong>2. Scheduled drop lr</strong></p>
<p>Lr drop sau 1 chu kỳ nhất định</p>
<p><strong>3. Adaptive lr</strong></p>
<p>Lr thay đổi dựa vào value của hàm Loss</p>
<p><strong>4. Cycling lr</strong></p>
<p>Lr thay đổi trong 1 cycle và lặp lại sự thay đổi đó trong cycle tiếp theo.</p>
</section>
<section id="momentum">
<h4><span class="section-number">3.1.2.3.3. </span>Momentum<a class="headerlink" href="#momentum" title="Permalink to this heading">#</a></h4>
<p>Điều chỉnh gradient bằng hướng di chuyển trước đó (bổ sung momentum vào update weight). Quy trình:</p>
<ol class="arabic simple">
<li><p>Set vận tốc ban đầu <span class="math notranslate nohighlight">\(v_0\)</span> = 0</p></li>
<li><p>Với mỗi 1 epoch thứ t:</p></li>
</ol>
<ul class="simple">
<li><p>gradient : <span class="math notranslate nohighlight">\(\nabla w_{t-1}\)</span></p></li>
<li><p>Vận tốc mới: <span class="math notranslate nohighlight">\(v_{t}=\gamma v_{t-1} + \eta \nabla w_{t-1}\)</span></p></li>
<li><p>Update weight: <span class="math notranslate nohighlight">\(W_t  = W_{t-1} - v_t\)</span></p></li>
</ul>
<p>Lựa chọn <span class="math notranslate nohighlight">\(\gamma\)</span>:</p>
<ul class="simple">
<li><p>Nếu <span class="math notranslate nohighlight">\(\gamma\)</span> càng lớn thì update càng có hướng smooth do tỷ trọng hướng di chuyển trước đó càng cao, đồng nghĩa với tỷ trọng việc học mới càng thấp.</p></li>
<li><p>Nên lựa chọn <span class="math notranslate nohighlight">\(\gamma\)</span> in [0.8, 0.99]</p></li>
<li><p><span class="math notranslate nohighlight">\(\gamma\)</span> cang cao thì càng làm giảm khả năng hội tụ và có thể vượt qua local minimum hiện tại.</p></li>
</ul>
<p><img alt="image.png" src="../../_images/momentum11.png" /></p>
<p>Momentum giúp giảm giao động, nhanh đưa loss về điểm local minimum. Mặt khác, sử dụng vận tốc để update weight nên việc học sẽ không dừng lại ngay cả khi có gradient = 0. Từ đó có khả năng vượt qua local minimum để khám phá các điểm loss mới.</p>
<p><img alt="image.png" src="../../_images/momentum21.png" /></p>
<p>Sử dụng momentum có 1 nhược điểm là khi gần tới điểm hội tụ thì mất nhiều thời gian để dưng lại vì lúc nào cũng có đà di chuyển trước đó</p>
</section>
<section id="nestorov-accelerated-gradient-nag">
<h4><span class="section-number">3.1.2.3.4. </span>Nestorov accelerated gradient (NAG)<a class="headerlink" href="#nestorov-accelerated-gradient-nag" title="Permalink to this heading">#</a></h4>
<p>NAG giải quyết vấn đề lâu hội tụ tại gần điểm optimize do vấn đề momentum gây ra, bằng việc sử dụng <strong>gradient của bước tiếp theo mà ko tính momentum</strong> (thay vì gradient của bước hiện tại như momentum)</p>
<p><img alt="" src="../../_images/nesterov1.jpeg" /></p>
<p>Khi GD ko sử dụng momentum thì “gradient tại điểm xấp xỉ tiếp theo” chính là lượng thay đổi tại điểm mới nhưng ko có momentum</p>
<ul class="simple">
<li><p>Vận tốc mới: <span class="math notranslate nohighlight">\(v_{t}=\gamma v_{t-1} + \eta \nabla (w_{t-1} - \gamma v_{t-1})\)</span></p></li>
<li><p>Update weight: <span class="math notranslate nohighlight">\(W_t  = W_{t-1} - v_t\)</span></p></li>
</ul>
</section>
<section id="adagrad">
<h4><span class="section-number">3.1.2.3.5. </span>Adagrad<a class="headerlink" href="#adagrad" title="Permalink to this heading">#</a></h4>
<p>Điều chỉnh lr bưởi tổng gradient^2 trước đó, do tổng gradient^2 càng ngày càng tăng nên Lr sẽ càng giảm theo thời gian, dẫn tới tác động của gradient hiện tại càng ít, có thể bị mất gradient
<img alt="" src="../../_images/Adagrad1.png" /></p>
</section>
<section id="rmsprop">
<h4><span class="section-number">3.1.2.3.6. </span>RMSprop<a class="headerlink" href="#rmsprop" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>RMSprop thay đổi hệ số của gradient, khắc phục được nhược điểm của AdaGrad là càng học càng chậm</p>
<ul>
<li><p>Trung bình có trọng số của bình phương các gradient trong quá khứ <span class="math notranslate nohighlight">\(G_t\)</span> có trọng số <span class="math notranslate nohighlight">\(\gamma\)</span>: <span class="math notranslate nohighlight">\({\bf G}_{t} = \gamma{\bf G}_{t-1}+({1-\gamma}){\bf g}_{t}^{2}\)</span></p></li>
<li><p>update weight : <span class="math notranslate nohighlight">\({\bf w}_{t} = {\bf w}_{t-1}-\frac{\eta}{\sqrt{{\bf G}_{t}+\epsilon}}g_t\)</span></p></li>
</ul>
</li>
<li><p>Thuật toán RMSProp rất giống với Adagrad ở chỗ cả hai đều sử dụng bình phương của gradient để thay đổi tỉ lệ hệ số.</p></li>
<li><p>RMSProp có điểm chung với phương pháp động lượng là chúng đều sử dụng trung bình rò rỉ. Tuy nhiên, RMSProp sử dụng kỹ thuật này để điều chỉnh tiền điều kiện theo hệ số.</p></li>
<li><p>Trong thực tế, tốc độ học cần được định thời bởi người lập trình.</p></li>
<li><p>Hệ số  𝛾  xác định độ dài thông tin quá khứ được sử dụng khi điều chỉnh tỉ lệ theo từng tọa độ.</p></li>
</ul>
</section>
<section id="ada-delta">
<h4><span class="section-number">3.1.2.3.7. </span>Ada-delta<a class="headerlink" href="#ada-delta" title="Permalink to this heading">#</a></h4>
<p>Adadelta tương tự như RMSprop, tức là điều chỉnh điều chỉnh mức độ cập nhật gradient vào trọng số thông qua <span class="math notranslate nohighlight">\({\bf G}_{t}\)</span> và <span class="math notranslate nohighlight">\({\bf S}_{t}\)</span>, không cần thông qua learning_rate. Cụ thể quy trình tính:</p>
<ul class="simple">
<li><p>Tính trung bình có trọng số của bình phương các gradient trong quá khứ: $<span class="math notranslate nohighlight">\({\bf G}_{t} = \gamma{\bf G}_{t-1}+({1-\gamma}){\bf g}_{t}^{2}\)</span>$</p></li>
<li><p>Update weight: $<span class="math notranslate nohighlight">\({\bf w}_{t} = {\bf w}_{t-1}-\sqrt{\frac{{\bf S}_{t-1}+\epsilon}{{\bf G}_{t}+\epsilon}}g_t\)</span>$</p></li>
<li><p>Tính trung bình có trọng số của các weight trong quá khứ: $<span class="math notranslate nohighlight">\({\bf S}_{t} = \gamma{\bf S}_{t-1}+({1-\gamma}) w_t\)</span>$</p></li>
</ul>
<p>Tóm lại:</p>
<ul class="simple">
<li><p>Adadelta không sử dụng tham số tốc độ học. Thay vào đó, nó sử dụng tốc độ thay đổi của chính bản thân các tham số để điều chỉnh tốc độ học.</p></li>
<li><p>Adadelta cần sử dụng hai biến trạng thái để lưu trữ các mô-men bậc hai của gradient và của lượng thay đổi trong các tham số.</p></li>
<li><p>Adadelta sử dụng trung bình rò rỉ để lưu ước lượng động của các giá trị thống kê cần thiết.</p></li>
</ul>
</section>
<section id="adam">
<h4><span class="section-number">3.1.2.3.8. </span>Adam<a class="headerlink" href="#adam" title="Permalink to this heading">#</a></h4>
<p>Adam kết hợp sự thay đổi momentum dựa theo gradient bậc 1 và bậc 2 :</p>
<ul class="simple">
<li><p>tính trung bình có trong số momentum và có hiệu chỉnh: $<span class="math notranslate nohighlight">\( \hat{m}_t = \frac{\beta_1 m_{t-1} + (1- \beta_1) g_t}{1-\beta_1^t} \)</span>$</p></li>
<li><p>tính trung bình có trong số momentum bậc 2 và có hiệu chỉnh: $<span class="math notranslate nohighlight">\( \hat{v}_t = \frac{\beta_2 v_{t-1} + (1- \beta_2) g_t^2}{1-\beta_2^t} \)</span>$</p></li>
<li><p>update weight t+1: $<span class="math notranslate nohighlight">\(w_{t+1} = w_{t} - \frac{\eta}{\sqrt{\hat{v}_t } +\epsilon} \hat{m}_t\)</span>$</p></li>
</ul>
<p>default: <span class="math notranslate nohighlight">\(\beta_1 = 0.9\)</span> , <span class="math notranslate nohighlight">\(beta_2 = 0.999\)</span> , <span class="math notranslate nohighlight">\(\epsilon = 10^{-8}\)</span></p>
<p>Tóm lại:</p>
<ul class="simple">
<li><p>Adam kết hợp các kỹ thuật của nhiều thuật toán tối ưu thành một quy tắc cập nhật khá mạnh mẽ.</p></li>
<li><p>Dựa trên RMSProp, Adam cũng sử dụng trung bình động trọng số mũ cho gradient ngẫu nhiên theo minibatch.</p></li>
<li><p>Adam sử dụng phép hiệu chỉnh độ chệch (bias correction) để điều chỉnh cho trường hợp khởi động chậm khi ước lượng động lượng và mô-men bậc hai.</p></li>
<li><p>Đối với gradient có phương sai đáng kể, chúng ta có thể gặp phải những vấn đề liên quan tới hội tụ. Những vấn đề này có thể được khắc phục bằng cách sử dụng các minibatch có kích thước lớn hơn</p></li>
</ul>
</section>
<section id="naadam">
<h4><span class="section-number">3.1.2.3.9. </span>NaAdam<a class="headerlink" href="#naadam" title="Permalink to this heading">#</a></h4>
<p>Tương tự như Adam nhưng NaAdam sử dụng NAG momentum thay cho vanilla momentum component (như của Adam). Nhắc lại là NAG giúp hội tụ tại khu vực minimal nhanh hơn so với vanilla momentum:</p>
<ul class="simple">
<li><p>tính trung bình có trong số momentum và có hiệu chỉnh: $<span class="math notranslate nohighlight">\( \hat{m}_t = \frac{\beta_1 m_{t-1} + (1- \beta_1) g_t}{1-\beta_1^t} \)</span>$</p></li>
<li><p>tính trung bình có trong số momentum bậc 2 và có hiệu chỉnh: $<span class="math notranslate nohighlight">\( \hat{v}_t = \frac{\beta_2 v_{t-1} + (1- \beta_2) g_t^2}{1-\beta_2^t} \)</span>$</p></li>
<li><p>update weight t+1: $<span class="math notranslate nohighlight">\(w_{t+1} = w_{t} - \frac{\eta}{\sqrt{\hat{v}_t } +\epsilon} (\beta_1 \hat{m}_t + (1- \beta_1) g_t)\)</span>$</p></li>
</ul>
<p>default: <span class="math notranslate nohighlight">\(\beta_1 = 0.9\)</span> , <span class="math notranslate nohighlight">\(beta_2 = 0.999\)</span> , <span class="math notranslate nohighlight">\(\epsilon = 10^{-8}\)</span></p>
</section>
</section>
<section id="loss-function">
<h3><span class="section-number">3.1.2.4. </span>Loss Function<a class="headerlink" href="#loss-function" title="Permalink to this heading">#</a></h3>
<p>Loss thể hiện sự khác biệt / error giữa predictive (với regression là giá trị dự đoán, classification là xác suất) và real value</p>
<p><strong>1. Classification</strong></p>
<ul class="simple">
<li><p><strong>Log Loss/ Cross entropy Loss</strong>: có thể bị loss thay đổi lớn khi gặp các extremely value x, dữ liệu cần phải ở trạng thái balance</p></li>
<li><p><strong>Focal loss</strong>: phù hợp trong TH dữ liệu imbalance</p></li>
<li><p><strong>KL Divergence</strong>: xác định tính tương đồng của phân phối của predict và actual</p></li>
<li><p><strong>Exponential loss</strong>: thường sử dụng khi muốn kết hợp nhiều model độc lập đã có hàm loss riêng, tạo thành 1 hàm loss tổng hợp</p></li>
<li><p><strong>Hinge loss</strong>: tìm đường phân loại (hyperplane) để chia các nhóm ( tính distance từ hyperplane tới các nhóm)</p></li>
</ul>
<p><strong>2. Regression</strong></p>
<ul class="simple">
<li><p><strong>Root mean squared error</strong></p></li>
<li><p><strong>Mean absolute error</strong></p></li>
<li><p><strong>Huber loss</strong></p></li>
<li><p><strong>Log cosh loss</strong></p></li>
<li><p><strong>Quantile loss</strong></p></li>
</ul>
<section id="cross-entropy-loss">
<h4><span class="section-number">3.1.2.4.1. </span>Cross Entropy Loss<a class="headerlink" href="#cross-entropy-loss" title="Permalink to this heading">#</a></h4>
<div class="math notranslate nohighlight">
\[
H(p,q) = -\sum_{x} p(x) \log q(x)
\]</div>
<p>Trong đó:</p>
<ul class="simple">
<li><p>x là 1 class trong tập class C</p></li>
<li><p>p(x) là xác suất thực của class x</p></li>
<li><p>q(x) là xác suất dự đoán của class x</p></li>
</ul>
<p>Nếu p(x) == q(x) thì CE = 0, ngược lại nếu p(x) khác xa q(x) thì CE loss sẽ rất lớn</p>
<ul class="simple">
<li><p>Một số biến thể:</p>
<ul>
<li><p>Categorical Cross Entropy</p></li>
<li><p>Binary Cross Entropy</p></li>
</ul>
</li>
</ul>
</section>
<section id="focal-loss">
<h4><span class="section-number">3.1.2.4.2. </span>Focal loss<a class="headerlink" href="#focal-loss" title="Permalink to this heading">#</a></h4>
<div class="math notranslate nohighlight">
\[
L_{FL}(p_x) = -\alpha_x(1-p_x)^\gamma \log(p_x)
\]</div>
<p>Trong đó:</p>
<ul class="simple">
<li><p>x là 1 class trong tập class C</p></li>
<li><p><span class="math notranslate nohighlight">\(p_x\)</span> là xác suất dự đoán của class x</p></li>
<li><p><span class="math notranslate nohighlight">\(\alpha_x\)</span> là the balancing parameter for the true class, nếu <span class="math notranslate nohighlight">\(\alpha_x\)</span> gần 1 thì more loss cho y = 1 tức focal_loss(FN) &gt; focal_loss(FP)</p></li>
<li><p><span class="math notranslate nohighlight">\(\gamma\)</span> thể hiện mức độ chênh lệch giữa từng class</p>
<ul>
<li><p><span class="math notranslate nohighlight">\(\gamma = 0\)</span>: thì FL = Binary CE</p></li>
<li><p><span class="math notranslate nohighlight">\(\gamma\)</span> &gt;&gt; 0: thì càng tăng loss cho class có balance thấp</p></li>
</ul>
</li>
</ul>
<p>So sánh với Cross Entropy, Focal tác động thêm trọng số với mục tiêu tăng tỷ trọng class có tỷ lệ thấp và giảm tỷ trọng class có tỷ lệ cao. Ứng dụng vào các bài toán object classification hoặc bài toán có class bị imbalance, khi đó với focal loss sẽ tập trung học những class khó dự đoán, ít update weight bởi các class dễ dự đoán</p>
</section>
</section>
</section>
<section id="get-started-with-tf">
<h2><span class="section-number">3.1.3. </span>Get started with TF<a class="headerlink" href="#get-started-with-tf" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># check system</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">platform</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Python Platform: </span><span class="si">{</span><span class="n">platform</span><span class="o">.</span><span class="n">platform</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Python </span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TensorFlow Version: </span><span class="si">{</span><span class="n">tf</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Keras Version: </span><span class="si">{</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">gpu</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">list_physical_devices</span><span class="p">(</span><span class="s1">&#39;GPU&#39;</span><span class="p">))</span><span class="o">&gt;</span><span class="mi">0</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GPU is&quot;</span><span class="p">,</span> <span class="s2">&quot;available&quot;</span> <span class="k">if</span> <span class="n">gpu</span> <span class="k">else</span> <span class="s2">&quot;NOT AVAILABLE&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Python Platform: macOS-13.1-arm64-arm-64bit
Python 3.10.9 (main, Jan 11 2023, 09:18:18) [Clang 14.0.6 ]
TensorFlow Version: 2.12.0
Keras Version: 2.12.0
GPU is available
</pre></div>
</div>
</div>
</div>
</section>
<section id="tensor">
<h2><span class="section-number">3.1.4. </span>Tensor<a class="headerlink" href="#tensor" title="Permalink to this heading">#</a></h2>
<p>Tensor tương tự như numpy array (array n chiều) nhưng cho phép sử dụng GPU/TPU để tính toán, từ đó tăng tốc độ tính toán và khả năng hội tụ của mạng.
Tensor đóng vai trò là input và output của mạng NN, trong các class <code class="docutils literal notranslate"><span class="pre">tf.data</span></code> hoặc <code class="docutils literal notranslate"><span class="pre">tf.io</span></code> sẽ tự động convert data sang <strong>tensor</strong>, mặc định dtype là <code class="docutils literal notranslate"><span class="pre">int32</span></code> hoặc <code class="docutils literal notranslate"><span class="pre">float32</span></code>.
Một tensor có thể có số lượng dimensions không giới hạn.</p>
<blockquote>
<div><p>Ví dụ, biến đổi một series of images thành tensors with shape (224, 224, 3, 32), trong đó:</p>
<ul class="simple">
<li><p>224, 224 (the first 2 dimensions) là kích thước ảnh in pixels.</p></li>
<li><p>3 là số kênh màu của ảnh (red, green blue).</p></li>
<li><p>32 là the batch size (the number of images a neural network sees at any one time).</p></li>
</ul>
</div></blockquote>
<p>Có những loại tensors sau:</p>
<ul class="simple">
<li><p><strong>scalar</strong>: a single number.</p></li>
<li><p><strong>vector</strong>: a number with direction (e.g. tốc đọ gió kèm hướng gió).</p></li>
<li><p><strong>matrix</strong>: ma trận số 2 chiều.</p></li>
<li><p><strong>tensor</strong>: một n-dimensional array of numbers (trong đó n có thể là bất kỳ số nào, a 0-dimension tensor is a scalar, a 1-dimension tensor is a vector).</p></li>
</ul>
<p><img alt="difference between scalar, vector, matrix, tensor" src="https://raw.githubusercontent.com/mrdbourke/tensorflow-deep-learning/main/images/00-scalar-vector-matrix-tensor.png" /></p>
<blockquote>
<div><p>For more on the mathematical difference between scalars, vectors and matrices see the <a class="reference external" href="https://www.mathsisfun.com/algebra/scalar-vector-matrix.html">visual algebra post by Math is Fun</a>.</p>
</div></blockquote>
<section id="create-tensor">
<h3><span class="section-number">3.1.4.1. </span>create tensor<a class="headerlink" href="#create-tensor" title="Permalink to this heading">#</a></h3>
<section id="create-tensor-with-tf-constant">
<h4><span class="section-number">3.1.4.1.1. </span>create tensor with <code class="docutils literal notranslate"><span class="pre">tf.constant</span></code><a class="headerlink" href="#create-tensor-with-tf-constant" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># scalar , rank = 0</span>
<span class="n">scalar</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">scalar</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Metal device set to: Apple M1 Pro
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(), dtype=int32, numpy=10&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># check number of dimensions</span>
<span class="n">scalar</span><span class="o">.</span><span class="n">ndim</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a vector (1 dimensions)</span>
<span class="n">vector</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">vector</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>
<span class="n">vector</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(2,), dtype=int32, numpy=array([10, 10], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create matrix and define the datatype (default int32, float32)</span>
<span class="n">matrix</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([[</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">7.</span><span class="p">],</span>
                              <span class="p">[</span><span class="mf">3.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">],</span>
                              <span class="p">[</span><span class="mf">8.</span><span class="p">,</span> <span class="mf">9.</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span> <span class="c1"># specify the datatype with &#39;dtype&#39;</span>
<span class="n">matrix</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(3, 2), dtype=float16, numpy=
array([[10.,  7.],
       [ 3.,  2.],
       [ 8.,  9.]], dtype=float16)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create tensor (more than 2 dimensions, although, all of the above items are also technically tensors)</span>
<span class="n">tensor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
                       <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]],</span>
                      <span class="p">[[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span>
                       <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">]],</span>
                      <span class="p">[[</span><span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">],</span>
                       <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">]],</span>
                     <span class="p">[[</span><span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">],</span>
                       <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">]]])</span>
<span class="n">tensor</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(4, 2, 3), dtype=int32, numpy=
array([[[ 1,  2,  3],
        [ 4,  5,  6]],

       [[ 7,  8,  9],
        [10, 11, 12]],

       [[13, 14, 15],
        [16, 17, 18]],

       [[13, 14, 15],
        [16, 17, 18]]], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-tensors-with-tf-variable">
<h4><span class="section-number">3.1.4.1.2. </span>create tensors with <code class="docutils literal notranslate"><span class="pre">tf.Variable()</span></code><a class="headerlink" href="#create-tensors-with-tf-variable" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>tensor được tạo bởi <code class="docutils literal notranslate"><span class="pre">tf.constant()</span></code> là dạng ko thể thay đổi được, thường dùng trong việc tạo mới tensor</p></li>
<li><p>tensor được tạo bởi <code class="docutils literal notranslate"><span class="pre">tf.Variable()</span></code> có thể thay đổi được</p></li>
</ul>
<blockquote>
<div><p>Which one should you use? <code class="docutils literal notranslate"><span class="pre">tf.constant()</span></code> or <code class="docutils literal notranslate"><span class="pre">tf.Variable()</span></code>?</p>
<ul class="simple">
<li><p>It will depend on what your problem requires. However, most of the time, TensorFlow will automatically choose for you (when loading data or modelling data).</p></li>
</ul>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create the same tensor with tf.Variable() and tf.constant()</span>
<span class="n">changeable_tensor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>
<span class="n">unchangeable_tensor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>
<span class="n">changeable_tensor</span><span class="p">,</span> <span class="n">unchangeable_tensor</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&lt;tf.Variable &#39;Variable:0&#39; shape=(2,) dtype=int32, numpy=array([10,  7], dtype=int32)&gt;,
 &lt;tf.Tensor: shape=(2,), dtype=int32, numpy=array([10,  7], dtype=int32)&gt;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># change in tf.Variable()</span>
<span class="n">changeable_tensor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="n">changeable_tensor</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Variable &#39;Variable:0&#39; shape=(2,) dtype=int32, numpy=array([7, 7], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-random-tensor">
<h4><span class="section-number">3.1.4.1.3. </span>create random tensor<a class="headerlink" href="#create-random-tensor" title="Permalink to this heading">#</a></h4>
<p>Trong quá trình khởi tạo mạng NN, các weight sẽ được tạo ra random (random tensor) trước khi tiến tới các weight tối ưu trong quá trình học</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">random_1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="o">.</span><span class="n">from_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span> <span class="c1"># set the seed for reproducibility</span>
<span class="n">random_1</span> <span class="o">=</span> <span class="n">random_1</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="c1"># create tensor from a normal distribution</span>
<span class="n">random_1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(3, 2), dtype=float32, numpy=
array([[-0.75658023, -0.06854693],
       [ 0.07595028, -1.2573844 ],
       [-0.23193759, -1.8107857 ]], dtype=float32)&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="zero-one-tensor">
<h4><span class="section-number">3.1.4.1.4. </span>zero/one tensor<a class="headerlink" href="#zero-one-tensor" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make a tensor of all ones</span>
<span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(3, 2), dtype=float32, numpy=
array([[1., 1.],
       [1., 1.],
       [1., 1.]], dtype=float32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make a tensor of all zeros</span>
<span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(3, 2), dtype=float32, numpy=
array([[0., 0.],
       [0., 0.],
       [0., 0.]], dtype=float32)&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="tensor-from-numpy-array">
<h4><span class="section-number">3.1.4.1.5. </span>tensor from numpy array<a class="headerlink" href="#tensor-from-numpy-array" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">numpy_A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> <span class="c1"># create a NumPy array between 1 and 25</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">numpy_A</span><span class="p">,</span>  
                <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span> <span class="c1"># note: the shape total (2*4*3) has to match the number of elements in the array</span>
<span class="n">numpy_A</span><span class="p">,</span> <span class="n">A</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([ 1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15, 16, 17,
        18, 19, 20, 21, 22, 23, 24], dtype=int32),
 &lt;tf.Tensor: shape=(2, 4, 3), dtype=int32, numpy=
 array([[[ 1,  2,  3],
         [ 4,  5,  6],
         [ 7,  8,  9],
         [10, 11, 12]],
 
        [[13, 14, 15],
         [16, 17, 18],
         [19, 20, 21],
         [22, 23, 24]]], dtype=int32)&gt;)
</pre></div>
</div>
</div>
</div>
</section>
<section id="convert-to-numpy-array">
<h4><span class="section-number">3.1.4.1.6. </span>convert to numpy array<a class="headerlink" href="#convert-to-numpy-array" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
<span class="c1"># or </span>
<span class="n">A</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[[ 1,  2,  3],
        [ 4,  5,  6],
        [ 7,  8,  9],
        [10, 11, 12]],

       [[13, 14, 15],
        [16, 17, 18],
        [19, 20, 21],
        [22, 23, 24]]], dtype=int32)
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="tensor-function">
<h3><span class="section-number">3.1.4.2. </span>tensor function<a class="headerlink" href="#tensor-function" title="Permalink to this heading">#</a></h3>
<section id="info-ndim-rank-size-shape">
<h4><span class="section-number">3.1.4.2.1. </span>info: ndim, rank, size, shape<a class="headerlink" href="#info-ndim-rank-size-shape" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>Shape: The length (number of elements) of each of the dimensions of a tensor.</p></li>
<li><p>Rank: The number of tensor dimensions. A scalar has rank 0, a vector has rank 1, a matrix is rank 2, a tensor has rank n.</p></li>
<li><p>Axis or Dimension: A particular dimension of a tensor.</p></li>
<li><p>Size: The total number of items in the tensor.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tensor</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(4, 2, 3), dtype=int32, numpy=
array([[[ 1,  2,  3],
        [ 4,  5,  6]],

       [[ 7,  8,  9],
        [10, 11, 12]],

       [[13, 14, 15],
        [16, 17, 18]],

       [[13, 14, 15],
        [16, 17, 18]]], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tensor</span><span class="o">.</span><span class="n">dtype</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>tf.int32
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># number of dimension</span>
<span class="n">tensor</span><span class="o">.</span><span class="n">ndim</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># shape</span>
<span class="n">tensor</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>TensorShape([4, 2, 3])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># size: tổng số element trong tensor</span>
<span class="n">tf</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>24
</pre></div>
</div>
</div>
</div>
</section>
<section id="indexing">
<h4><span class="section-number">3.1.4.2.2. </span>indexing<a class="headerlink" href="#indexing" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># indexing tensor</span>
<span class="n">tensor2</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">[:</span><span class="mi">2</span><span class="p">,:</span><span class="mi">1</span><span class="p">,:</span><span class="mi">2</span><span class="p">]</span>
<span class="n">tensor2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(2, 1, 2), dtype=int32, numpy=
array([[[1, 2]],

       [[7, 8]]], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="shuffle">
<h4><span class="section-number">3.1.4.2.3. </span>shuffle<a class="headerlink" href="#shuffle" title="Permalink to this heading">#</a></h4>
<p>shuffle giúp hạn chế việc model chỉ học 1 số class nhất định được order theo thứ tự</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(4, 2, 3), dtype=int32, numpy=
array([[[ 1,  2,  3],
        [ 4,  5,  6]],

       [[13, 14, 15],
        [16, 17, 18]],

       [[ 7,  8,  9],
        [10, 11, 12]],

       [[13, 14, 15],
        [16, 17, 18]]], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="expand-dim">
<h4><span class="section-number">3.1.4.2.4. </span>expand dim<a class="headerlink" href="#expand-dim" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tensor3</span> <span class="o">=</span> <span class="n">tensor2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">tensor3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(2,), dtype=int32, numpy=array([1, 2], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">tensor3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># &quot;-1&quot; means last axis</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(2, 1), dtype=int32, numpy=
array([[1],
       [2]], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">tensor3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># &quot;-1&quot; means last axis</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(1, 2), dtype=int32, numpy=array([[1, 2]], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Insert another dimension</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">1</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">tensor3</span><span class="p">[:,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">2</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">tensor3</span><span class="p">[:,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
 tf.Tensor(
[[1]
 [2]], shape=(2, 1), dtype=int32)


2
 tf.Tensor(
[[1]
 [2]], shape=(2, 1), dtype=int32)
</pre></div>
</div>
</div>
</div>
</section>
<section id="set-global-random-seed">
<h4><span class="section-number">3.1.4.2.5. </span>set global random seed<a class="headerlink" href="#set-global-random-seed" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>sửu dụng global level random seed sẽ fix seed cố định cho mọi hàm có sử dụng tới yếu tố random và không được set operation level random seed</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">21</span><span class="p">)</span> <span class="c1"># global random seed</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">tensor2</span><span class="p">,</span><span class="n">seed</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="c1"># operation level random seed</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(2, 1, 2), dtype=int32, numpy=
array([[[1, 2]],

       [[7, 8]]], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="reshape">
<h4><span class="section-number">3.1.4.2.6. </span>reshape<a class="headerlink" href="#reshape" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create (3, 2) tensor</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                 <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
                 <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]])</span>

<span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(2, 3), dtype=int32, numpy=
array([[1, 2, 3],
       [4, 5, 6]], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="transpose">
<h4><span class="section-number">3.1.4.2.7. </span>transpose<a class="headerlink" href="#transpose" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(2, 3), dtype=int32, numpy=
array([[1, 3, 5],
       [2, 4, 6]], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="tensor-operations">
<h3><span class="section-number">3.1.4.3. </span>tensor operations<a class="headerlink" href="#tensor-operations" title="Permalink to this heading">#</a></h3>
<section id="change-datatype">
<h4><span class="section-number">3.1.4.3.1. </span>Change datatype<a class="headerlink" href="#change-datatype" title="Permalink to this heading">#</a></h4>
<p>change datatype make model run faster and use less memory</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(2, 2), dtype=float16, numpy=
array([[1., 2.],
       [3., 4.]], dtype=float16)&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="basic-operation">
<h4><span class="section-number">3.1.4.3.2. </span>Basic operation<a class="headerlink" href="#basic-operation" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tensor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]])</span>
<span class="n">tensor</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(2, 2), dtype=int32, numpy=
array([[1, 2],
       [3, 4]], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># add value</span>
<span class="n">tensor</span> <span class="o">+</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(2, 2), dtype=int32, numpy=
array([[11, 12],
       [13, 14]], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Subtraction</span>
<span class="n">tensor</span> <span class="o">-</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(2, 2), dtype=int32, numpy=
array([[-9, -8],
       [-7, -6]], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Multiplication</span>
<span class="n">tensor</span> <span class="o">*</span> <span class="mi">2</span>
<span class="c1"># or </span>
<span class="n">tf</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># prefer using</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(2, 2), dtype=int32, numpy=
array([[2, 4],
       [6, 8]], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tensor</span> <span class="o">*</span> <span class="n">tensor</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(2, 2), dtype=int32, numpy=
array([[ 1,  4],
       [ 9, 16]], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="dot-product-multiplication">
<h4><span class="section-number">3.1.4.3.3. </span>Dot product / multiplication<a class="headerlink" href="#dot-product-multiplication" title="Permalink to this heading">#</a></h4>
<section id="tf-matmul">
<h5><span class="section-number">3.1.4.3.3.1. </span>tf.matmul<a class="headerlink" href="#tf-matmul" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create (3, 2) tensor</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                 <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
                 <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]])</span>

<span class="c1"># Create another (3, 2) tensor</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span>
                 <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
                 <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">]])</span>
<span class="n">X</span><span class="p">,</span> <span class="n">Y</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&lt;tf.Tensor: shape=(3, 2), dtype=int32, numpy=
 array([[1, 2],
        [3, 4],
        [5, 6]], dtype=int32)&gt;,
 &lt;tf.Tensor: shape=(3, 2), dtype=int32, numpy=
 array([[ 7,  8],
        [ 9, 10],
        [11, 12]], dtype=int32)&gt;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Y</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(3, 3), dtype=int32, numpy=
array([[ 23,  29,  35],
       [ 53,  67,  81],
       [ 83, 105, 127]], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># or</span>
<span class="n">X</span> <span class="o">@</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(3, 3), dtype=int32, numpy=
array([[ 23,  29,  35],
       [ 53,  67,  81],
       [ 83, 105, 127]], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># or</span>
<span class="c1"># You can achieve the same result with parameters</span>
<span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">Y</span><span class="p">,</span> <span class="n">transpose_a</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">transpose_b</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(3, 3), dtype=int32, numpy=
array([[ 23,  29,  35],
       [ 53,  67,  81],
       [ 83, 105, 127]], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="tf-tensordot">
<h5><span class="section-number">3.1.4.3.3.2. </span>tf.tensordot<a class="headerlink" href="#tf-tensordot" title="Permalink to this heading">#</a></h5>
<p>Sử dụng khi muốn customize nhân matrix cho tensor (any dimention), do đó sẽ tốn kém chi phí hơn</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Z</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">minval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">maxval</span><span class="o">=</span><span class="mi">10</span> <span class="p">,</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<span class="n">Z</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(3, 2, 2), dtype=int32, numpy=
array([[[9, 0],
        [3, 6]],

       [[4, 3],
        [3, 8]],

       [[0, 5],
        [3, 4]]], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(2, 3), dtype=int32, numpy=
array([[1, 3, 5],
       [2, 4, 6]], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(2, 3), dtype=int32, numpy=
array([[ 9, 27, 45],
       [15, 33, 51]], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">axes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(3, 2, 3), dtype=int32, numpy=
array([[[ 9, 27, 45],
        [15, 33, 51]],

       [[10, 24, 38],
        [19, 41, 63]],

       [[10, 20, 30],
        [11, 25, 39]]], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="absolute">
<h4><span class="section-number">3.1.4.3.4. </span>absolute<a class="headerlink" href="#absolute" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create tensor with negative values</span>
<span class="n">D</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([</span><span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">])</span>
<span class="n">tf</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(2,), dtype=int32, numpy=array([ 7, 10], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="aggregation">
<h4><span class="section-number">3.1.4.3.5. </span>aggregation<a class="headerlink" href="#aggregation" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>max/min</p></li>
<li><p>sum</p></li>
<li><p>mean</p></li>
<li><p>std</p></li>
<li><p>variance</p></li>
<li><p>argmax/argmin</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Z</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(3, 2, 2), dtype=int32, numpy=
array([[[9, 0],
        [3, 6]],

       [[4, 3],
        [3, 8]],

       [[0, 5],
        [3, 4]]], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># max (whole tensor)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(), dtype=int32, numpy=9&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(3, 2), dtype=int32, numpy=
array([[9, 6],
       [4, 8],
       [5, 4]], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(2, 2), dtype=int32, numpy=
array([[9, 5],
       [3, 8]], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># find the position of maximum value</span>
<span class="n">arg_max_ind</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
<span class="n">arg_max_ind</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(2, 2), dtype=int64, numpy=
array([[0, 2],
       [0, 1]])&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">A</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">minval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">maxval</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">reduce_min</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(), dtype=float32, numpy=1.4280438&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="map-function">
<h4><span class="section-number">3.1.4.3.6. </span>map function<a class="headerlink" href="#map-function" title="Permalink to this heading">#</a></h4>
<p>map specific function to each element unstacked on axis 0</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">map_fn</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(3,), dtype=int32, numpy=array([9, 8, 5], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">map_fn</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">3</span><span class="p">),</span> <span class="n">elems</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(3, 3), dtype=int32, numpy=
array([[3, 4, 5],
       [5, 6, 7],
       [2, 3, 4]], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="squeezing">
<h4><span class="section-number">3.1.4.3.7. </span>squeezing<a class="headerlink" href="#squeezing" title="Permalink to this heading">#</a></h4>
<p>removing all single dimensions, xoá những dimension có rank 1, ví dụ shape:</p>
<ul class="simple">
<li><p>(1, 1, 1, 1, 50)  –&gt; (50,)</p></li>
<li><p>(2, 1, 1, 25) –&gt; (2,50)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a rank 5 (5 dimensions) tensor of 50 numbers between 0 and 100</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
<span class="n">G</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(1, 1, 1, 1, 50), dtype=int64, numpy=
array([[[[[93, 58, 58, 19, 47, 50, 31, 33,  2, 70, 58, 26, 72, 39, 54,
           76, 48, 83, 91, 65, 75, 58, 71, 48, 37, 59, 84, 55,  2,  3,
           62, 70, 63, 92, 16, 72, 67,  2,  6, 50, 47, 84, 55, 51,  8,
           48, 34, 67, 57, 45]]]]])&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(50,), dtype=int64, numpy=
array([93, 58, 58, 19, 47, 50, 31, 33,  2, 70, 58, 26, 72, 39, 54, 76, 48,
       83, 91, 65, 75, 58, 71, 48, 37, 59, 84, 55,  2,  3, 62, 70, 63, 92,
       16, 72, 67,  2,  6, 50, 47, 84, 55, 51,  8, 48, 34, 67, 57, 45])&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">H</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">25</span><span class="p">))</span>
<span class="n">H</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(2, 1, 1, 25), dtype=int64, numpy=
array([[[[17,  8, 57, 43, 32, 83, 83, 61, 22, 93, 61, 28, 63, 34, 71,
          35, 66, 27, 10, 38, 35, 95, 76, 37,  1]]],


       [[[51, 22, 20, 77, 48, 24, 76, 54,  8, 11, 86, 99, 50, 16, 32,
          99, 72, 60, 44, 40, 49, 16, 10, 59,  3]]]])&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(2, 25), dtype=int64, numpy=
array([[17,  8, 57, 43, 32, 83, 83, 61, 22, 93, 61, 28, 63, 34, 71, 35,
        66, 27, 10, 38, 35, 95, 76, 37,  1],
       [51, 22, 20, 77, 48, 24, 76, 54,  8, 11, 86, 99, 50, 16, 32, 99,
        72, 60, 44, 40, 49, 16, 10, 59,  3]])&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="one-hot-encoding">
<h4><span class="section-number">3.1.4.3.8. </span>one-hot encoding<a class="headerlink" href="#one-hot-encoding" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a list of indices</span>
<span class="n">some_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>

<span class="c1"># One hot encode them, need to specify the depth parameter</span>
<span class="n">tf</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">some_list</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(4, 4), dtype=float32, numpy=
array([[1., 0., 0., 0.],
       [0., 1., 0., 0.],
       [0., 0., 1., 0.],
       [0., 0., 0., 1.]], dtype=float32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">some_list</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(4, 3), dtype=float32, numpy=
array([[1., 0., 0.],
       [0., 1., 0.],
       [0., 0., 1.],
       [0., 0., 0.]], dtype=float32)&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="square-square-root-log">
<h4><span class="section-number">3.1.4.3.9. </span>square / square_root / log<a class="headerlink" href="#square-square-root-log" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">tf.square()</span></code> - get the square of every value in a tensor.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tf.sqrt()</span></code> - get the squareroot of every value in a tensor (note: the elements need to be floats or this will error).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tf.math.log()</span></code> - get the natural log of every value in a tensor (elements need to floats).</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(3, 2), dtype=int32, numpy=
array([[1, 2],
       [3, 4],
       [5, 6]], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># square</span>
<span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(3, 2), dtype=int32, numpy=
array([[ 1,  4],
       [ 9, 16],
       [25, 36]], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># square root</span>
<span class="n">tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(3, 2), dtype=float32, numpy=
array([[1.       , 1.4142135],
       [1.7320508, 2.       ],
       [2.236068 , 2.4494898]], dtype=float32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># log</span>
<span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(3, 2), dtype=float32, numpy=
array([[0.       , 0.6931472],
       [1.0986122, 1.3862944],
       [1.6094378, 1.7917594]], dtype=float32)&gt;
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="tf-function">
<h3><span class="section-number">3.1.4.4. </span>&#64;tf.function<a class="headerlink" href="#tf-function" title="Permalink to this heading">#</a></h3>
<p>sử dụng decorator &#64;tf.function để callable <strong>TensorFlow graph</strong>, giúp function chạy nhanh hơn</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="nd">@tf</span><span class="o">.</span><span class="n">function</span>
<span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">y</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">))</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">))</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:AutoGraph could not transform &lt;function function at 0x29833beb0&gt; and will run it as-is.
Cause: Unable to locate the source code of &lt;function function at 0x29833beb0&gt;. Note that functions defined in certain environments, like the interactive Python shell, do not expose their source code. If that is the case, you should define them in a .py source file. If you are certain the code is graph-compatible, wrap the call using @tf.autograph.experimental.do_not_convert. Original error: could not get source code
To silence this warning, decorate the function with @tf.autograph.experimental.do_not_convert
WARNING: AutoGraph could not transform &lt;function function at 0x29833beb0&gt; and will run it as-is.
Cause: Unable to locate the source code of &lt;function function at 0x29833beb0&gt;. Note that functions defined in certain environments, like the interactive Python shell, do not expose their source code. If that is the case, you should define them in a .py source file. If you are certain the code is graph-compatible, wrap the call using @tf.autograph.experimental.do_not_convert. Original error: could not get source code
To silence this warning, decorate the function with @tf.autograph.experimental.do_not_convert
CPU times: user 18.3 ms, sys: 4.4 ms, total: 22.8 ms
Wall time: 25 ms
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="configs-and-tools">
<h2><span class="section-number">3.1.5. </span>Configs and tools<a class="headerlink" href="#configs-and-tools" title="Permalink to this heading">#</a></h2>
<section id="training-vs-inference-mode">
<h3><span class="section-number">3.1.5.1. </span>Training vs Inference Mode<a class="headerlink" href="#training-vs-inference-mode" title="Permalink to this heading">#</a></h3>
</section>
<section id="use-mixed-precision">
<h3><span class="section-number">3.1.5.2. </span>Use mixed_precision<a class="headerlink" href="#use-mixed-precision" title="Permalink to this heading">#</a></h3>
<p>Thông thường, tensors in TF sử dụng mặc định datatype là float32 (<a class="reference external" href="https://en.wikipedia.org/wiki/Single-precision_floating-point_format">single-precision floating-point format</a>) , tương đương với việc sử dụng bộ nhớ 32 bits, tuy nhiên vì GPU có lượng memory nhất định, cho nên cần lựa chọn định dạng phù hợp để tối ưu chi phí lưu trữ là tính toán. <strong>Mixed precision training</strong> sử dụng kết hợp single precision (float32) and half-preicison (float16) data types để tăng tốc dộ training model (up 3x on modern GPUs). Khi đó, dữ liệu được chuyển từ 32 –&gt; 16 nếu có thể.</p>
<blockquote>
<div><p>Need to set output layer về dạng <code class="docutils literal notranslate"><span class="pre">float32</span></code> bởi more stable for calculate loss function (<a class="reference external" href="https://www.tensorflow.org/guide/mixed_precision#building_the_model">detail for build model with mixed precision</a>)</p>
</div></blockquote>
<p><img alt="" src="https://raw.githubusercontent.com/mrdbourke/tensorflow-deep-learning/main/images/07-mixed-precision-code-before-and-after.png" /></p>
<ul class="simple">
<li><p><strong>Does it make the model train faster?</strong></p></li>
</ul>
<p>Not much, but it saved us some seconds.</p>
<ul class="simple">
<li><p><strong>Does it effect the accuracy or performance of our model?</strong></p></li>
</ul>
<p>By 1% not that much tho.</p>
<ul class="simple">
<li><p><strong>What’s the advatanges of using mixed_precision training?</strong></p></li>
</ul>
<p>The advantages of mixed precision is evident when we are training pretty big models for longer epochs. In that case, we can spot a huge difference in our training time.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set global policy to mixed precision</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">mixed_precision</span>
<span class="n">mixed_precision</span><span class="o">.</span><span class="n">set_global_policy</span><span class="p">(</span><span class="n">policy</span><span class="o">=</span><span class="s2">&quot;mixed_float16&quot;</span><span class="p">)</span> 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">layers</span>

<span class="c1"># Create base model</span>
<span class="n">input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">base_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">applications</span><span class="o">.</span><span class="n">EfficientNetB0</span><span class="p">(</span><span class="n">include_top</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">base_model</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># freeze base model layers</span>

<span class="c1"># Create Functional model </span>
<span class="n">inputs</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;input_layer&quot;</span><span class="p">)</span>
<span class="c1"># Note: EfficientNetBX models have rescaling built-in but if your model didn&#39;t you could have a layer like below</span>
<span class="c1"># x = layers.Rescaling(1./255)(x)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">base_model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># set base_model to inference mode only</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">GlobalAveragePooling2D</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;pooling_layer&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">class_names</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span> <span class="c1"># want one output neuron per class </span>
<span class="c1"># Separate activation of output layer so we can output float32 activations</span>
<span class="n">outputs</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s2">&quot;softmax&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;softmax_float32&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span> 
<span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>

<span class="c1"># Compile the model</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;sparse_categorical_crossentropy&quot;</span><span class="p">,</span> <span class="c1"># Use sparse_categorical_crossentropy when labels are *not* one-hot</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Check the dtype_policy</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">layer.name</span></code> : Tên của layer</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">layer.trainable</span></code> : các tham số của layer có được train/update hay ko ?</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">layer.dtype</span></code> : the datatype của các biến trong layer</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">layer.dtype_policy</span></code> : the datatype của các tính toán trong layer</p></li>
</ul>
<blockquote>
<div><p><strong>Note</strong>: A layer can have a dtype of <code class="docutils literal notranslate"><span class="pre">float32</span></code> and a dtype policy of “mixed_float16” because it stores its variables (weights &amp; biases) in <code class="docutils literal notranslate"><span class="pre">float32</span></code> (more numerically stable), however it computes in <code class="docutils literal notranslate"><span class="pre">float16</span></code> (faster).</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check the dtype_policy attributes of layers in our model</span>
<span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">trainable</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">dtype_policy</span><span class="p">)</span> <span class="c1"># Check the dtype policy of layers</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="tf-profiler">
<h3><span class="section-number">3.1.5.3. </span>TF Profiler<a class="headerlink" href="#tf-profiler" title="Permalink to this heading">#</a></h3>
<p><a class="reference external" href="https://www.tensorflow.org/tensorboard/tensorboard_profiling_keras#use_the_tensorflow_profiler_to_profile_model_training_performance">details</a></p>
<p>Analyze <code class="docutils literal notranslate"><span class="pre">tf.data</span></code> performance with the TF Profiler</p>
</section>
</section>
<section id="types-of-layers">
<h2><span class="section-number">3.1.6. </span>Types of layers<a class="headerlink" href="#types-of-layers" title="Permalink to this heading">#</a></h2>
<section id="basic">
<h3><span class="section-number">3.1.6.1. </span>Basic<a class="headerlink" href="#basic" title="Permalink to this heading">#</a></h3>
<section id="dense">
<h4><span class="section-number">3.1.6.1.1. </span>Dense<a class="headerlink" href="#dense" title="Permalink to this heading">#</a></h4>
</section>
<section id="activation">
<h4><span class="section-number">3.1.6.1.2. </span>Activation<a class="headerlink" href="#activation" title="Permalink to this heading">#</a></h4>
<p><img alt="image.png" src="../../_images/ac_f1.png" /></p>
<ul class="simple">
<li><p>AF giúp biến đổi non-linear các hàm ban đầu để phù hợp với thực tế, do hàm trước AF chỉ là tổ hợp tuyến tính</p></li>
<li><p>AF giúp hạn chế tác động và kiểm soát những value lớn</p></li>
<li><p>Trong việc learn của model, cần tránh các TH:</p>
<ul>
<li><p>Học bùng nổ: hàm loss rất lớn khi có nhiễu</p></li>
<li><p>triệt tiêu thông tin: gradient trở nên rất bé và gần như ko học được gì</p></li>
</ul>
</li>
</ul>
<p><strong>Lựa chọn activate function</strong></p>
<ul class="simple">
<li><p>Thông thường SELU &gt; ELU &gt; leaky ReLU (và các biến thể) &gt; ReLU &gt; tanh &gt; logistic.</p></li>
<li><p>Quan tâm tới runtime, prefer leaky ReLU.</p></li>
<li><p>PReLU if you have a huge training set</p></li>
<li><p>Bài toán hình ảnh: ưu tiên hàm ReLU</p></li>
<li><p>NLP: sigmoid, Tanh, Ramp</p></li>
</ul>
<ol class="arabic simple">
<li><p>For regression problems(Only 1 neuron, multiple inputs, real-world outputs), a linear activation function must be used.</p></li>
<li><p>For multi-class classification problems, use Softmax at the output layer</p></li>
<li><p>For multi-label and binary classification problems, use the Sigmoid activation function.</p></li>
<li><p>Sigmoid and hyperbolic tangent activation functions must be never used in the hidden layers as they can lead to vanishing gradients.</p></li>
<li><p>For networks where unnecessary neurons need to turn OFF, use ReLU as the activation function because it also works as a dropout layer. In case there is confusion about which activation function, use <a class="reference external" href="http://ReLU.It">ReLU.It</a> is used in most CNN problems.</p></li>
<li><p>For deep neural networks having greater than 40 layers, use the swish activation function.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="nn">go</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">activations</span> <span class="k">as</span> <span class="n">af</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">derivative_value</span><span class="p">(</span><span class="n">func</span> <span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">step</span><span class="p">)</span> <span class="o">-</span> <span class="n">func</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="n">step</span>

<span class="k">def</span> <span class="nf">plot_output_and_deriv</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">range_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span> <span class="mi">50</span><span class="p">)):</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">func</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">range_x</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">y_deri</span> <span class="o">=</span> <span class="p">[</span><span class="n">derivative_value</span><span class="p">(</span><span class="n">func</span> <span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_deri</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines+markers&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;derivative of &#39;</span><span class="o">+</span><span class="n">name</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">renderer</span> <span class="o">=</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="unit-step">
<h5><span class="section-number">3.1.6.1.2.1. </span>Unit step<a class="headerlink" href="#unit-step" title="Permalink to this heading">#</a></h5>
<p><img alt="image.png" src="../../_images/unitstep1.png" /></p>
<ul class="simple">
<li><p><strong>Mô tả</strong>: Input là toàn bộ số thực, trả về 1 nếu dương, trả 0 nếu âm</p></li>
<li><p><strong>Đạo hàm</strong>: = 0</p></li>
<li><p><strong>Pros</strong>: Đơn giản + dễ áp dụng</p></li>
<li><p><strong>Cons</strong>: Đạo hàm = 0 nên không có tác dụng trong việc cập nhật trọng số</p></li>
<li><p><strong>Usage</strong>: Thường áp dụng cho output layer thay vì hidden layer và áp dụng trong các bài toán binary classification</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">unitstep</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">z</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">z</span> <span class="o">==</span><span class="mi">0</span><span class="p">)</span> 
<span class="n">plot_output_and_deriv</span><span class="p">(</span><span class="n">unitstep</span><span class="p">,</span> <span class="s1">&#39;unitstep&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/bde803377eda543be5ffcc021c0dcc394f53ecb38521a0513d2c6f4224c6c759.jpg" src="../../_images/bde803377eda543be5ffcc021c0dcc394f53ecb38521a0513d2c6f4224c6c759.jpg" />
</div>
</div>
</section>
<section id="linear">
<h5><span class="section-number">3.1.6.1.2.2. </span>Linear<a class="headerlink" href="#linear" title="Permalink to this heading">#</a></h5>
<div class="math notranslate nohighlight">
\[y = aX + b\]</div>
<ul class="simple">
<li><p><strong>Mô tả</strong>: Trả output là 1 hàm linear của input</p></li>
<li><p><strong>Đạo hàm</strong>: = constant</p></li>
<li><p><strong>Pros</strong>:</p>
<ul>
<li><p>Range output rộng và không bị ràng buộc</p></li>
<li><p>Chi phí tính toán thấp</p></li>
<li><p>Không có hiện tượng biến mất gradient trong quá trình lan truyền ngược</p></li>
</ul>
</li>
<li><p><strong>Cons</strong>: Do đạo hàm cố định, tức giá trị update weight luôn cố định nên không phản ánh sự tương quan giữa X và y</p></li>
<li><p><strong>Usage</strong>: Áp dụng cho các bài toán regression(univariate)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_output_and_deriv</span><span class="p">(</span><span class="n">af</span><span class="o">.</span><span class="n">linear</span><span class="p">,</span> <span class="s1">&#39;linear&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/3f2546034554b51c284bccecdc62d55c83cc146bfe9301964dc808edeb23d0e9.jpg" src="../../_images/3f2546034554b51c284bccecdc62d55c83cc146bfe9301964dc808edeb23d0e9.jpg" />
</div>
</div>
</section>
<section id="softmax">
<h5><span class="section-number">3.1.6.1.2.3. </span>Softmax<a class="headerlink" href="#softmax" title="Permalink to this heading">#</a></h5>
<div class="math notranslate nohighlight">
\[\text{softmax}(z_i) = \frac{e^{z_i}}{\sum_{j=1}^{k} e^{z_j}}\]</div>
<p>where <span class="math notranslate nohighlight">\(z_i\)</span> is the <span class="math notranslate nohighlight">\(i\)</span>-th element of the input vector, and <span class="math notranslate nohighlight">\(k\)</span> is the length of the vector</p>
<ul class="simple">
<li><p><strong>Mô tả</strong>: Chuẩn hoá các giá trị đầu vào về range (0,1) và có tổng bằng 1</p></li>
<li><p><strong>Đạo hàm</strong>:</p></li>
<li><p><strong>Pros</strong>:</p>
<ul>
<li><p>Phù hợp multi-class classification do có sum = 1</p></li>
<li><p>Hàm liên tục và khả vi tại mọi vị trí, nên phù hơp với backpropagation</p></li>
</ul>
</li>
<li><p><strong>Cons</strong>:</p>
<ul>
<li><p>Tốn chi phí tính toán</p></li>
<li><p>Chỉ dùng cho output layer</p></li>
</ul>
</li>
<li><p><strong>Usage</strong>:</p>
<ul>
<li><p>Áp dụng cho output là multi-class classification</p></li>
<li><p>Chỉ áp dụng cho output layer</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">softmax</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">sum_ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ex</span><span class="o">/</span><span class="n">sum_ex</span>

<span class="n">af</span><span class="o">.</span><span class="n">softmax</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;function keras.activations.softmax(x, axis=-1)&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="sigmoid">
<h5><span class="section-number">3.1.6.1.2.4. </span>Sigmoid<a class="headerlink" href="#sigmoid" title="Permalink to this heading">#</a></h5>
<div class="math notranslate nohighlight">
\[{\displaystyle S(x)={\frac {1}{1+e^{-x}}}={\frac {e^{x}}{e^{x}+1}}.}\]</div>
<ul class="simple">
<li><p><strong>Mô tả</strong>: Nhận input số thực và trả ra value trong (0,1), số input càng lớn, output càng gần 1, input càng bé thì output càng gần 0</p></li>
<li><p><strong>Đạo hàm</strong>: Thay đổi và luôn dương, lớn nhất tại x = 0 và bé nhất khi x càng lớn hoặc càng bé</p></li>
<li><p><strong>Pros</strong>:</p>
<ul>
<li><p>Weight luôn được cập nhật qua mỗi lần học</p></li>
<li><p>Hàm liên tục và khả vi tại mọi vị trí, nên phù hơp với backpropagation</p></li>
</ul>
</li>
<li><p><strong>Cons</strong>:</p>
<ul>
<li><p>Tốn chi phí tính toán</p></li>
<li><p>Không có tính đối xứng qua số 0 nên học các negative value sẽ ít hơn so với positive value</p></li>
<li><p>vanishing gradient problem xuất hiện tại các điểm giá trị input quá lớn hoặc quá bé, khi đó derivative xấp xỉ 0</p></li>
</ul>
</li>
<li><p><strong>Usage</strong>:</p>
<ul>
<li><p>Áp dụng cho output là xác suất hoặc bài toán binary classification</p></li>
<li><p>Nếu sử dụng cho multi-class classification thì tổng các xác suất sẽ khác 1, cần phải hiệu chỉnh lại bằng softmax</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sigmoid</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">z</span><span class="p">))</span>

<span class="n">plot_output_and_deriv</span><span class="p">(</span><span class="n">af</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">,</span> <span class="s1">&#39;sigmoid&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/723dcfc25b73647444067ff0baa0302adb09e565928594960feeb9343a323cbd.jpg" src="../../_images/723dcfc25b73647444067ff0baa0302adb09e565928594960feeb9343a323cbd.jpg" />
</div>
</div>
</section>
<section id="hyperbolic-tangent-tanh">
<h5><span class="section-number">3.1.6.1.2.5. </span>Hyperbolic Tangent (tanh)<a class="headerlink" href="#hyperbolic-tangent-tanh" title="Permalink to this heading">#</a></h5>
<div class="math notranslate nohighlight">
\[\tanh(x) = \frac{\sinh(x)}{\cosh(x)} = \frac{e^x - e^{-x}}{e^x + e^{-x}}\]</div>
<ul class="simple">
<li><p><strong>Mô tả</strong>:</p>
<ul>
<li><p>Nhận input số thực và trả ra value trong (-1,1), số input càng lớn, output càng gần 1, input càng bé thì output càng gần -1</p></li>
<li><p>Giống sigmod nhưng range output = (-1,1)</p></li>
<li><p>Thường làm output tiến gần về/đến 0, tăng khả năng hội tụ</p></li>
</ul>
</li>
<li><p><strong>Đạo hàm</strong>: Thay đổi và luôn dương, lớn nhất tại x = 0 và bé nhất khi x càng lớn hoặc càng bé</p></li>
<li><p><strong>Pros</strong>:</p>
<ul>
<li><p>Weight luôn được cập nhật qua mỗi lần học</p></li>
<li><p>Hàm liên tục và khả vi tại mọi vị trí, nên phù hơp với backpropagation</p></li>
<li><p>Có tính đối xứng qua số 0 nên học các negative value ngang bằng positive value, do đó hội tụ nhanh hơn sigmoid</p></li>
</ul>
</li>
<li><p><strong>Cons</strong>:</p>
<ul>
<li><p>Tốn chi phí tính toán</p></li>
<li><p>vanishing gradient problem xuất hiện tại các điểm giá trị input quá lớn hoặc quá bé, khi đó derivative xấp xỉ 0</p></li>
</ul>
</li>
<li><p><strong>Usage</strong>:</p>
<ul>
<li><p>Thường áp dụng cho bài toán có nhiều output hoặc binary classification (sigmod thường áp dụng cho bài toán phân loại 2 output)</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">tanh</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
    <span class="n">ez</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">enz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">z</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">ez</span> <span class="o">-</span> <span class="n">enz</span><span class="p">)</span><span class="o">/</span> <span class="p">(</span><span class="n">ez</span> <span class="o">+</span> <span class="n">enz</span><span class="p">)</span>

<span class="n">plot_output_and_deriv</span><span class="p">(</span><span class="n">af</span><span class="o">.</span><span class="n">tanh</span><span class="p">,</span> <span class="s1">&#39;tanh&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/679bb7af1ab5ef2536ae7178b08c57186f4e5803e5b31bcc80541d5e48863bad.jpg" src="../../_images/679bb7af1ab5ef2536ae7178b08c57186f4e5803e5b31bcc80541d5e48863bad.jpg" />
</div>
</div>
</section>
<section id="relu">
<h5><span class="section-number">3.1.6.1.2.6. </span>ReLU<a class="headerlink" href="#relu" title="Permalink to this heading">#</a></h5>
<div class="math notranslate nohighlight">
\[f(x) = \max(0, x)\]</div>
<ul class="simple">
<li><p><strong>Mô tả</strong>:</p>
<ul>
<li><p>Trả ra input nếu dương, trả ra 0 nếu âm (tạo thành dead node)</p></li>
</ul>
</li>
<li><p><strong>Đạo hàm</strong>:  = 1 cho các giá trị input dương, và = 0 cho các giá trị input âm</p></li>
<li><p><strong>Pros</strong>:</p>
<ul>
<li><p>Tính toán nhanh</p></li>
<li><p>Có tính chất non-linear</p></li>
<li><p>Đạo hàm không đổi tại các value của x nên khắc phục các giá trị input bất tường hoặc lớn</p></li>
<li><p>best activation function cho CNNs bởi vì hiệu quả cho việc extracting features hoặc for pattern recognition.</p></li>
<li><p>Có thể hoạt động như 1 dropout layer ví dụ như deactive node nếu input = 0</p></li>
</ul>
</li>
<li><p><strong>Cons</strong>:</p>
<ul>
<li><p>Với x giá trị âm, gradient = 0, có khả năng kết thúc sớm khi học.</p></li>
<li><p>Không khả vi tại 0 nên các continuous output không phù hợp áp dụng</p></li>
</ul>
</li>
<li><p><strong>Usage</strong>:</p>
<ul>
<li><p>Thường áp dụng cho bài toán CNN, Natural Language Processing, Pattern Recognition</p></li>
<li><p>Trong bài toán nhận diện hình ảnh:</p>
<ul>
<li><p>Chạy qua các điểm highlight sẽ có update &gt; 0</p></li>
<li><p>Chạy qua vùng background sẽ không có update</p></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">relu</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>

<span class="n">plot_output_and_deriv</span><span class="p">(</span><span class="n">af</span><span class="o">.</span><span class="n">relu</span><span class="p">,</span> <span class="s1">&#39;relu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/875763dfb58d80776a2c322d12823b236f5ba897b870a800c38ca3765916a9ee.jpg" src="../../_images/875763dfb58d80776a2c322d12823b236f5ba897b870a800c38ca3765916a9ee.jpg" />
</div>
</div>
</section>
<section id="leaky-relu">
<h5><span class="section-number">3.1.6.1.2.7. </span>Leaky ReLU<a class="headerlink" href="#leaky-relu" title="Permalink to this heading">#</a></h5>
<div class="math notranslate nohighlight">
\[\begin{split}
LReLU(x)=\left\{{\begin{array}{c l c r}{\alpha x}&amp;{x\leq0}\\ {x}&amp;{x&gt;0}\end{array}}\right.
\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(\alpha\)</span> is a small constant typically set to 0.01.</p>
<ul class="simple">
<li><p><strong>Mô tả</strong>:</p>
<ul>
<li><p>Trả ra x nếu x dương, trả ra số 0.01x nếu x âm (vẫn tạo ra derivative khi x âm)</p></li>
</ul>
</li>
<li><p><strong>Đạo hàm</strong>:  = 1 cho các giá trị input dương, và = 0.01 cho các giá trị input âm</p></li>
<li><p><strong>Pros</strong>:</p>
<ul>
<li><p>Có ưu điểm của RelU</p></li>
<li><p>Khắc phục sự chết của ReLU khi x âm, thay vào đó derivative = 0.01, tăng độ chính xác so với ReLU</p></li>
</ul>
</li>
<li><p><strong>Cons</strong>:</p>
<ul>
<li><p>Với x giá trị âm bất kỳ đều có derivative = 0.01, nên quá trình học diễn ra lâu với bất kể x âm như nào</p></li>
</ul>
</li>
<li><p><strong>Usage</strong>:</p>
<ul>
<li><p>Thường áp dụng cho bài toán CNN, Natural Language Processing, Pattern Recognition</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lrelu</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.01</span><span class="o">*</span><span class="n">i</span>
<span class="n">lrelu</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">af</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">)</span>
<span class="n">plot_output_and_deriv</span><span class="p">(</span><span class="n">lrelu</span><span class="p">,</span> <span class="s1">&#39;leaky relu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/6c3259d321a3fec14e23ed2d3ecb7608997f9c213169bb9f8a21f0ebd2046757.jpg" src="../../_images/6c3259d321a3fec14e23ed2d3ecb7608997f9c213169bb9f8a21f0ebd2046757.jpg" />
</div>
</div>
</section>
<section id="parametric-relu">
<h5><span class="section-number">3.1.6.1.2.8. </span>Parametric ReLU<a class="headerlink" href="#parametric-relu" title="Permalink to this heading">#</a></h5>
<ul class="simple">
<li><p><strong>Mô tả</strong>:</p>
<ul>
<li><p>Giống Leaky ReLU nhưng <span class="math notranslate nohighlight">\(\alpha\)</span> có thể set 1 giá trị bất kỳ</p></li>
</ul>
</li>
<li><p><strong>Đạo hàm</strong>:  = 1 cho các giá trị input dương, và = <span class="math notranslate nohighlight">\(\alpha\)</span> cho các giá trị input âm</p></li>
<li><p><strong>Pros</strong>:</p>
<ul>
<li><p>Tăng độ chính xác và mức độ hội tụ nhanh hơn so với ReLU và Leaky ReLU</p></li>
</ul>
</li>
<li><p><strong>Cons</strong>:</p>
<ul>
<li><p>Với x giá trị âm bất kỳ đều có derivative = <span class="math notranslate nohighlight">\(\alpha\)</span>, nên quá trình học diễn ra lâu với bất kể x âm như nào</p></li>
<li><p>Cần check mức độ alpha phù hợp</p></li>
<li></li>
</ul>
</li>
<li><p><strong>Usage</strong>:</p>
<ul>
<li><p>Thường áp dụng cho bài toán CNN, Natural Language Processing, Pattern Recognition</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prelu</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">af</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">plot_output_and_deriv</span><span class="p">(</span><span class="n">lrelu</span><span class="p">,</span> <span class="s1">&#39;para relu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/47497e15ecf89e598d9f2d1fd3df82725913f41997e6c50975fa91e0987b11f8.jpg" src="../../_images/47497e15ecf89e598d9f2d1fd3df82725913f41997e6c50975fa91e0987b11f8.jpg" />
</div>
</div>
</section>
<section id="exponential-linear-unit-elu">
<h5><span class="section-number">3.1.6.1.2.9. </span>Exponential Linear Unit (ELU)<a class="headerlink" href="#exponential-linear-unit-elu" title="Permalink to this heading">#</a></h5>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{equation}
ELU(x)=\begin{cases}
x &amp; \text{if } x&gt;0\\
\alpha(e^x-1) &amp; \text{if } x\leq 0
\end{cases}
\end{equation}
\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(\alpha\)</span> is a hyperparameter that controls the slope of the function for negative inputs.</p>
<ul class="simple">
<li><p><strong>Mô tả</strong>:</p>
<ul>
<li><p>Với giá trị input dương x, trả ra hàm linear, còn nếu x âm thì trả ra giá trị gần với mức <span class="math notranslate nohighlight">\(-\alpha\)</span>, output range (-α,∞)</p></li>
</ul>
</li>
<li><p><strong>Đạo hàm</strong>:  = 1 cho các giá trị input dương, và  cho các giá trị input âm</p></li>
<li><p><strong>Pros</strong>:</p>
<ul>
<li><p>Tăng độ chính xác và mức độ hội tụ nhanh hơn so với ReLU và biến thể</p></li>
</ul>
</li>
<li><p><strong>Cons</strong>:</p>
<ul>
<li><p>Cần tunning giá trị alpha</p></li>
<li><p>Chi phí tính toán lớn</p></li>
</ul>
</li>
<li><p><strong>Usage</strong>:</p>
<ul>
<li><p>Thường áp dụng cho bài toán CNN, Natural Language Processing, Pattern Recognition</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">ELU</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">α</span><span class="p">)</span> <span class="p">:</span>
    <span class="k">return</span> <span class="n">z</span> <span class="k">if</span> <span class="p">(</span><span class="n">z</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="k">else</span>  <span class="p">(</span><span class="n">α</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

<span class="n">plot_output_and_deriv</span><span class="p">(</span><span class="n">af</span><span class="o">.</span><span class="n">elu</span><span class="p">,</span> <span class="s1">&#39;elu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/18938297edb605e1d9cdcb0e66c8a05542ad9e72f118ee1c1d4094d13287072a.jpg" src="../../_images/18938297edb605e1d9cdcb0e66c8a05542ad9e72f118ee1c1d4094d13287072a.jpg" />
</div>
</div>
</section>
<section id="scaled-exponential-linear-unit-selu">
<h5><span class="section-number">3.1.6.1.2.10. </span>Scaled Exponential Linear Unit (SELU)<a class="headerlink" href="#scaled-exponential-linear-unit-selu" title="Permalink to this heading">#</a></h5>
<div class="math notranslate nohighlight">
\[\begin{split}
\text{SELU}(x) = \lambda
\begin{cases}
x &amp; \text{if } x &gt; 0 \\
\alpha \cdot (\exp(x) - 1) &amp; \text{if } x \leq 0
\end{cases}
\end{split}\]</div>
<ul class="simple">
<li><p><strong>Mô tả</strong>:</p></li>
<li><p><strong>Đạo hàm</strong>:  = 1 cho các giá trị input dương, và  cho các giá trị input âm</p></li>
<li><p><strong>Pros</strong>:</p>
<ul>
<li><p>Không có hiện tượng biến mất gradient trong quá trình lan truyền ngược</p></li>
<li><p>Mạng nơ ron hội tụ nhanh hơn.</p></li>
<li><p>Đây là một hàm kích hoạt tự chuẩn hóa, nghĩa là giá trị trung bình trở thành 0 và phương sai thành 1.</p></li>
<li><p>Nó có thể được sử dụng trong các mạng thần kinh rất phức tạp.</p></li>
</ul>
</li>
<li><p><strong>Cons</strong>:</p>
<ul>
<li><p>Chi phí tính toán lớn</p></li>
</ul>
</li>
<li><p><strong>Usage</strong>:</p>
<ul>
<li><p>multi-class classification</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_output_and_deriv</span><span class="p">(</span><span class="n">af</span><span class="o">.</span><span class="n">selu</span><span class="p">,</span> <span class="s1">&#39;selu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/13261b7c20732b1aa8f4cabc7c5b00047a3a562a9a6a10f5711653af462caa3e.jpg" src="../../_images/13261b7c20732b1aa8f4cabc7c5b00047a3a562a9a6a10f5711653af462caa3e.jpg" />
</div>
</div>
</section>
<section id="swish">
<h5><span class="section-number">3.1.6.1.2.11. </span>Swish<a class="headerlink" href="#swish" title="Permalink to this heading">#</a></h5>
<div class="math notranslate nohighlight">
\[\mathrm{Swish}(x) = x \cdot \mathrm{sigmoid}(\beta x) = \]</div>
<ul class="simple">
<li><p><strong>Mô tả</strong>:</p>
<ul>
<li><p>Hàm trả output range (1/e,∞)</p></li>
<li><p>Với input dương, the output là 1 hàm linear của input. Với input âm, cho phép cập nhật 1 phần giá trị tại gần 0, với x quá âm thì ko cập nhật</p></li>
<li><p>Tuỳ thuộc vào <span class="math notranslate nohighlight">\(\beta\)</span>:</p>
<ul>
<li><p><span class="math notranslate nohighlight">\(\beta\)</span> = 0: trở thành hàm linear</p></li>
<li><p><span class="math notranslate nohighlight">\(\beta\)</span> = 1: trở thành hàm linear sigmoid</p></li>
<li><p><span class="math notranslate nohighlight">\(\beta\)</span> = ∞: trở thành hàm ReLU</p></li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Đạo hàm</strong>:  = 1 cho các giá trị input dương, và  cho các giá trị input âm</p></li>
<li><p><strong>Pros</strong>:</p>
<ul>
<li><p>Tăng độ chính xác hơn ReLU</p></li>
<li><p>Có tính chất non-monotonic cho negative input</p></li>
<li><p>Là hàm liên tục và khả vi mọi điểm</p></li>
</ul>
</li>
<li><p><strong>Cons</strong>:</p>
<ul>
<li><p>Chi phí tính toán lớn</p></li>
</ul>
</li>
<li><p><strong>Usage</strong>:</p>
<ul>
<li><p>the same applications as ReLU</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_output_and_deriv</span><span class="p">(</span><span class="n">af</span><span class="o">.</span><span class="n">swish</span><span class="p">,</span> <span class="s1">&#39;swish&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/182691bc6842c751395eb3077cc46d725a386a4293dc9219ff3b0f9cf200dcf9.jpg" src="../../_images/182691bc6842c751395eb3077cc46d725a386a4293dc9219ff3b0f9cf200dcf9.jpg" />
</div>
</div>
</section>
</section>
<section id="input">
<h4><span class="section-number">3.1.6.1.3. </span>Input<a class="headerlink" href="#input" title="Permalink to this heading">#</a></h4>
</section>
<section id="flatten">
<h4><span class="section-number">3.1.6.1.4. </span>Flatten<a class="headerlink" href="#flatten" title="Permalink to this heading">#</a></h4>
</section>
</section>
<section id="pooling">
<h3><span class="section-number">3.1.6.2. </span>Pooling<a class="headerlink" href="#pooling" title="Permalink to this heading">#</a></h3>
<section id="max-average-pooling">
<h4><span class="section-number">3.1.6.2.1. </span>Max/Average Pooling<a class="headerlink" href="#max-average-pooling" title="Permalink to this heading">#</a></h4>
<ol class="arabic simple">
<li><p>Max-Pooling (<a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/keras/layers/MaxPool2D"><code class="docutils literal notranslate"><span class="pre">tf.keras.layers.MaxPool2D</span></code></a>)</p></li>
</ol>
<p><img alt="" src="https://androidkt.com/wp-content/uploads/2021/06/max-pooling.png" /></p>
<p><strong>Max-Pooling</strong> thường được sử dụng trong CNN model, add phía sau các convolutional layer có tác dụng giảm chiều ảnh bằng cách giảm số pixels mỗi chiều của ảnh output từ convolutional layer trước, mà giữ lại được lượng lớn các features có ý nghĩa bằng việc lựa chọn ra giá trị lớn nhất trong cụm</p>
<ol class="arabic simple" start="2">
<li><p>Average-Pooling (<a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/keras/layers/AveragePooling2D"><code class="docutils literal notranslate"><span class="pre">tf.keras.layers.AveragePooling2D</span></code></a>)</p></li>
</ol>
<p><img alt="" src="https://androidkt.com/wp-content/uploads/2021/06/Avg-Pooling.png" /></p>
<p><strong>Average-Pooling</strong> thường ít được sử dụng hơn so với <strong>Max-Pooling</strong>, trừ TH muốn thu gọn lại (thay vì muốn filter ra feature có ý nghĩa)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPool2D</span><span class="p">(</span>
    <span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="c1"># kích thước pool</span>
    <span class="n">strides</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>     <span class="c1"># bước nhảy</span>
    <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">,</span>  <span class="c1"># có dùng padding outter = 0 hay ko ?</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="global-max-average-pooling">
<h4><span class="section-number">3.1.6.2.2. </span>Global Max/Average Pooling<a class="headerlink" href="#global-max-average-pooling" title="Permalink to this heading">#</a></h4>
<p><img alt="" src="https://androidkt.com/wp-content/uploads/2021/06/Global-Avg-Pooling-2.png" /></p>
<p>Thường sử dụng để map the last convolutional layer vào trong mạng fully connected layers (tradicontional neural network). Global Average pooling layers giống như 1 Flatten layers in CNN, nhưng thay vì flatten full node (dễ overfitting nên cần dropout hoặc regularization) thì chúng lấy giá trị average/max của mỗi feature, và kết quả được fit trực tiếp vào softmax layer.</p>
<p>Một ưu điểm của <strong>Global Max/Average Pooling</strong> so với <strong>Flatten fully connected</strong> là chúng more native hơn so với mạng CNN bởi tạo ra tính kết nối giữa feature và category, hơn nữa chúng ko có parameter cần optimize, nên tránh được overfitting</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">GlobalAveragePooling2D</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="convolution">
<h3><span class="section-number">3.1.6.3. </span>Convolution<a class="headerlink" href="#convolution" title="Permalink to this heading">#</a></h3>
</section>
<section id="id2">
<h3><span class="section-number">3.1.6.4. </span>Regularization<a class="headerlink" href="#id2" title="Permalink to this heading">#</a></h3>
<section id="weight-regularization">
<h4><span class="section-number">3.1.6.4.1. </span>Weight regularization<a class="headerlink" href="#weight-regularization" title="Permalink to this heading">#</a></h4>
<p><img alt="" src="https://media.licdn.com/dms/image/C4D12AQEgtRRdCc0GTQ/article-cover_image-shrink_600_2000/0/1558564556262?e=2147483647&amp;v=beta&amp;t=YGgnX0iAeGLxH9EFGzi6O0CEZSie8HFL67DMtdW94ho" /></p>
<p><strong>L1 regularization (LASSO)</strong></p>
<ul class="simple">
<li><p>Hàm Cost/Loss sẽ được bổ sung penalty L1 tương ứng theo khoảng cách <strong>manhattan</strong></p></li>
<li><p>Khi đó hàm Loss sẽ luôn tiến sát về 0 nhưng cách 1 khoảng tối thiểu là mức penalty</p>
<ul>
<li><p>Chỉ có giới hạn số điểm để Loss chạm được L1 min (điểm mà error = 0)</p></li>
</ul>
</li>
<li><p>Giảm hệ số về 0 nên tốt cho <strong>feature selection</strong>, hiệu quả với dữ liệu sparsity, khi có nhiều inputs features và bạn tin rằng chỉ có 1 ít trong số chúng có ý nghĩa</p></li>
</ul>
<p><strong>L2 regularization (RIDGE)</strong></p>
<ul class="simple">
<li><p>Hàm Cost/Loss sẽ được bổ sung penalty L2 tương ứng theo khoảng cách <strong>euclidean</strong></p></li>
<li><p>Khi đó hàm Loss sẽ luôn tiến sát về 0 nhưng cách 1 khoảng tối thiểu là mức penalty euclidean,</p></li>
<li><p>Có nhiều nghiệm thoả mãn min L2 hơn so với L1</p></li>
<li><p>Làm cho hệ số nhỏ hơn, có ý nghĩa trong việc tăng robost model bằng việc giải quyết <strong>multicollinearity problem</strong></p></li>
</ul>
<hr class="docutils" />
<ul class="simple">
<li><p>Nếu máy học W lớn thì <strong>Loss giảm</strong> nhưng <strong>Regularization tăng</strong></p></li>
<li><p>Một hàm Cost tốt khi cả loss và Regu đều giảm</p></li>
<li><p>Sử dụng <code class="docutils literal notranslate"><span class="pre">L2</span></code> phạt nặng hơn <code class="docutils literal notranslate"><span class="pre">L1</span></code> khi <code class="docutils literal notranslate"><span class="pre">W</span></code> tăng mạnh</p></li>
<li><p>Kết hợp <code class="docutils literal notranslate"><span class="pre">L1</span> <span class="pre">+</span> <span class="pre">L2</span></code> mang lại kết quả tốt hơn</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">regularizers</span>

<span class="n">l1</span> <span class="o">=</span> <span class="n">regularizers</span><span class="o">.</span><span class="n">l1</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">l2</span> <span class="o">=</span> <span class="n">regularizers</span><span class="o">.</span><span class="n">l2</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">l1l2</span> <span class="o">=</span> <span class="n">regularizers</span><span class="o">.</span><span class="n">l1_l2</span><span class="p">(</span><span class="n">l1</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">l2</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># weight regularization dense</span>
<span class="n">Dense</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">l2</span><span class="p">(</span><span class="mf">0.01</span><span class="p">),</span> <span class="n">bias_regularizer</span><span class="o">=</span><span class="n">l2</span><span class="p">(</span><span class="mf">0.01</span><span class="p">))</span>

<span class="c1"># weight regularization convolutional layer</span>
<span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">l2</span><span class="p">(</span><span class="mf">0.01</span><span class="p">),</span> <span class="n">bias_regularizer</span><span class="o">=</span><span class="n">l2</span><span class="p">(</span><span class="mf">0.01</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="early-stopping">
<h4><span class="section-number">3.1.6.4.2. </span>Early stopping<a class="headerlink" href="#early-stopping" title="Permalink to this heading">#</a></h4>
<p><strong>1. Giới hạn vòng lặp</strong> : <code class="docutils literal notranslate"><span class="pre">MLPClassifier(max_iter=300)</span></code></p>
<ul class="simple">
<li><p>nhược điểm là model có thể dừng trước khi hội tụ</p></li>
</ul>
<p><strong>2. So sánh gradient</strong></p>
<ul class="simple">
<li><p>So sánh gradient của nghiệm 2 lần update liên tiếp nếu chênh lệch với giá trị threshold</p></li>
<li><p>ảnh hưởng performance nếu việc tính toán đạo hàm quá phức tạp khi có dữ liệu lớn, ko được hưởng lợi từ SGD hoặc mini-batch GD</p></li>
</ul>
<p><strong>3. So sánh Loss</strong>: <code class="docutils literal notranslate"><span class="pre">MLPClassifier(tol=0.0001)</span></code></p>
<ul class="simple">
<li><p>So sánh los của 1 vài lần update, nếu hàm loss it thay đổi thì dừng</p></li>
</ul>
<p><strong>3. Đặt ngưỡng dừng cho Loss</strong>:</p>
<ul class="simple">
<li><p>Thiết lập ngưỡng chấp nhận được cho Loss, nếu loss trong tập validate dưới mức đó trong quá trình training thì dừng lại</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tensorflow.keras.callbacks</span> <span class="kn">import</span> <span class="n">EarlyStopping</span>

<span class="n">earstop</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span>
    <span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span>      <span class="c1"># chỉ số tracking</span>
    <span class="n">min_delta</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>        <span class="c1"># giá trị tối thiểu cho phép thay đổi ngược </span>
                        <span class="c1"># ( ví dụ với accuracy là mức giảm tối thiểu cho phép, </span>
                        <span class="c1"># hoặc với MAE thì là mức tăng tối thiểu cho phép)</span>
    <span class="n">patience</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>         <span class="c1"># số epoch tối đa cho phép no improvement</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
    <span class="n">baseline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">restore_best_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1"># restore model về best weights</span>
    <span class="n">start_from_epoch</span><span class="o">=</span><span class="mi">100</span> <span class="c1"># number epochs chạy trước khi bắt đầu monitoring</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="dropout">
<h4><span class="section-number">3.1.6.4.3. </span>Dropout<a class="headerlink" href="#dropout" title="Permalink to this heading">#</a></h4>
<p>Việc quá nhiều nút (full connected) dẫn tới các nút phụ thuộc nhiều vào nhau. Vậy nên cần tắt bớt 1 số nút trong mạng thông qua việc set mỗi node có xác suất activate là <code class="docutils literal notranslate"><span class="pre">p</span></code> và deactivate là <code class="docutils literal notranslate"><span class="pre">1-p</span></code>. Điều này giúp model tránh phụ thuộc quá nhiều bởi 1 số node cụ thể nào đó</p>
<ul class="simple">
<li><p>Tuy nhiên có thể làm mất thông tin trong quá trình học do tắt 1 số nút quan trọng</p></li>
</ul>
<p><img alt="" src="https://stanford.edu/~shervine/teaching/cs-230/illustrations/dropout-ltr.png?27ab877c24a915d22e598fb772fcdc96" /></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span>
    <span class="n">rate</span><span class="p">,</span> <span class="n">noise_shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="batch-normalization">
<h3><span class="section-number">3.1.6.5. </span>Batch Normalization<a class="headerlink" href="#batch-normalization" title="Permalink to this heading">#</a></h3>
<p>BN thường sử dụng phía sau các layer fully connected dense/convolutional layer và phía trước non-linearity layer. Có tác dụng tăng learning rate và giảm tác động của những tham số khởi tạo ban đầu</p>
<p>BN đề cập đến việc chuẩn hóa giá trị input của layer bất kỳ. Chuẩn hóa có nghĩa là đưa phân phối của layer về xấp xỉ phân phối chuẩn với trung bình xấp xỉ 0 và phương sai xấp xỉ 1. Về mặc toán học, Batch Normalization (BN) thực hiện như sau: với mỗi layer, BN tính giá trị trung bình và phương sai của nó. Sau đó sẽ lấy giá trị đặc trưng trừ giá trị trung bình , sau đó chia cho độ lệch chuẩn. Data được chia nhỏ thành nhiều batch và normalize từng batch giúp:</p>
<ul class="simple">
<li><p>Giảm tác động khi thay đổi nhỏ của weight</p></li>
<li><p>Dễ dàng optimize</p></li>
<li><p>Các weight có cùng cơ sở để so sánh với nhau</p></li>
<li><p>Giảm sự biến thiên giữa các batch</p></li>
</ul>
<p><strong>Normalize input</strong></p>
<p>Normalize batch <span class="math notranslate nohighlight">\({x_i}\)</span> với <span class="math notranslate nohighlight">\(\mu_B\)</span>, <span class="math notranslate nohighlight">\(\sigma_B^2\)</span> là mean và variance của batch. Các hyperparameter là <span class="math notranslate nohighlight">\(\gamma\)</span>, <span class="math notranslate nohighlight">\(\beta\)</span></p>
<div class="math notranslate nohighlight">
\[x_i \longleftarrow \gamma \frac{x_i-\mu_B}{\sqrt{\sigma_B^2+\epsilon}}+\beta\]</div>
<p><strong>Tác dụng của normalized</strong></p>
<ul class="simple">
<li><p>Giảm tác động của những tham số khởi tạo ban đầu</p></li>
<li><p>Speedup training time (tăng learning rate)</p></li>
<li><p>Hạn chế vanishing gradient (bị mất gradient theo lan truyền ngược)</p></li>
<li><p>Giảm overfitting do giảm tác động của noise và cố định phân phối của các feature qua các lớp layer. Sử dụng batch normalization, chúng ta sẽ không cần phải sử dụng quá nhiều dropput và điều này rất có ý nghĩa vì chúng ta sẽ không cần phải lo lắng vì bị mất quá nhiều thông tin khi dropout weigths của mạng</p></li>
</ul>
<p><strong>Hạn chế của BN</strong></p>
<ul class="simple">
<li><p>BN thực hiện lại các phép tính trình bày phía trên qua các lần lặp, cho nên, về lý thuyết, chúng ta cần batch size đủ lớn để phân phối của mini-batch xấp xỉ phân phối của dữ liệu. Điều này gây khó khăn cho các mô hình đòi hỏi ảnh đầu vào có chất lượng cao (1920x1080) như object detection, semantic segmentation, … Việc huấn luyện với batch size lớn làm mô hình phải tính toán nhiều và chậm</p></li>
<li><p>Với Batch size = 1, giá trị phương sai sẽ là 0. Do đó BN sẽ không hoạt động hiệu quả</p></li>
<li><p>BN không hoạt động tốt với RNN. Lý do là RNN có các kết nối lặp lại với các timestamps trước đó, và yêu cầu các giá trị beta và gamma khác nhau cho mỗi timestep, dẫn đến độ phức tạp tăng lên gấp nhiều lần, và gây khó khăn cho việc sử dụng BN trong RNN.</p></li>
<li><p>Trong quá trình test, BN không tính toán lại giá trị trung bình và phương sai của tập test. Mà sử dụng giá trị trung bình và phương sai được tính toán từ tập train. Điều này làm cho việc tính toán tăng thêm. Ỏ pytorch, hàm model.eval() giúp chúng ta thiết lập mô hình ở chế độ evaluation. Ở chế độ này, BN layer sẽ sử dụng các giá trị trung bình và phương sai được tính toán từ trước trong dữ liệu huấn luyện. Giúp cho chúng ta không phải tính đi tính lại giá trị này.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">(</span>
    <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">momentum</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span>
    <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
    <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">beta_initializer</span><span class="o">=</span><span class="s1">&#39;zeros&#39;</span><span class="p">,</span>
    <span class="n">gamma_initializer</span><span class="o">=</span><span class="s1">&#39;ones&#39;</span><span class="p">,</span>
    <span class="n">moving_mean_initializer</span><span class="o">=</span><span class="s1">&#39;zeros&#39;</span><span class="p">,</span>
    <span class="n">moving_variance_initializer</span><span class="o">=</span><span class="s1">&#39;ones&#39;</span><span class="p">,</span>
    <span class="n">beta_regularizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">gamma_regularizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">beta_constraint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">gamma_constraint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">synchronized</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="data-augmentation">
<h2><span class="section-number">3.1.7. </span>Data Augmentation<a class="headerlink" href="#data-augmentation" title="Permalink to this heading">#</a></h2>
<section id="image-augmentation">
<h3><span class="section-number">3.1.7.1. </span>Image Augmentation<a class="headerlink" href="#image-augmentation" title="Permalink to this heading">#</a></h3>
<p>Models thường cần rất nhiều data ở các tính chất khác nhau để học, do đó cần phải sử dụng kỹ thuật data augmentation để transform image</p>
<p>Sử dụng <code class="docutils literal notranslate"><span class="pre">tf.keras.layers</span></code> để tạo data augmentation layer, mang lại hiệu quả hơn :</p>
<ul class="simple">
<li><p>Preprocessing images sẽ được sử lý thông qua GPU thay vì CPU, cho nên tốc độ sẽ nhanh hơn</p></li>
</ul>
<blockquote>
<div><p>Note: Các dữ liệu dạng unstructured (images) sẽ phù hợp hơn khi xử lý trên GPU, con các dữ liệu có structured như</p>
</div></blockquote>
<ul class="simple">
<li><p>Augmentation data được xây dựng như 1 layer của model cho nên có thể export toàn bộ model (bao gồm cả lớp layer augmentation), và áp dụng các tham số augmentation được giữ nguyên</p></li>
<li><p><strong>Data augmentation layers chỉ run khi training</strong>, do đó, khi thực hiện việc prediction hoặc evaluation model thì layer này được tự động turn-off (Chỉ có <code class="docutils literal notranslate"><span class="pre">Resizing</span></code> và <code class="docutils literal notranslate"><span class="pre">Rescaling</span></code> là run in inference mode, còn lại các transformation khác là run in training mode)</p></li>
</ul>
<p><strong>Một số data augmentation transformations được sử dụng phổ biến:</strong></p>
<p><img alt="" src="../../_images/data_augmentation.png" /></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">RandomFlip</span></code> - flips image on horizontal or vertical axis. (lật ảnh ngang/dọc) <em>(training)</em></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RandomRotation</span></code> - randomly rotates image by a specified amount. (xoay ảnh) <em>(training)</em></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RandomZoom</span></code> - randomly zooms into an image by specified amount. (zoom ảnh) <em>(training)</em></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RandomHeight</span></code> - randomly shifts image height by a specified amount. (shift chiều cao) <em>(training)</em></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RandomWidth</span></code> - randomly shifts image width by a specified amount. (shift chiều rộng) <em>(training)</em></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Rescaling</span></code> - normalizes the image pixel values to be between 0 and 1 (normalization) <em>(inference)</em></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Resizing</span></code> - resize the image with specificly height and width. (resize image) <em>(inference)</em></p></li>
</ul>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">Rescaling</span></code> is required for some image models, but <strong>EfficientNetB0</strong> (keras apps) is not required.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># sử dụng data augmentation layer</span>
<span class="n">data_aug</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">RandomFlip</span><span class="p">(</span><span class="s2">&quot;horizontal&quot;</span><span class="p">),</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">RandomRotation</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">RandomZoom</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">RandomHeight</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">RandomWidth</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
    <span class="c1"># layers.Resizing(224,224),  # (dont need to EfficientNetB0 because it&#39;s has)</span>
    <span class="c1"># layers.Rescaling(1./255) # (dont need to EfficientNetB0 because it&#39;s has)</span>
<span class="p">],</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;data_augmentation&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="text-augmentation">
<h3><span class="section-number">3.1.7.2. </span>Text Augmentation<a class="headerlink" href="#text-augmentation" title="Permalink to this heading">#</a></h3>
<section id="back-translation">
<h4><span class="section-number">3.1.7.2.1. </span>Back translation<a class="headerlink" href="#back-translation" title="Permalink to this heading">#</a></h4>
<p>Translate text sang language khác, rồi sau có translate ngược lại ngôn ngữ ban đầu, giúp cho text mới sinh ra vấn giữ được nguyên ý nghĩa nhưng sử dụng các từ khác so với ban đầu</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>translators

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="c1"># current version have logs, which is not very comfortable</span>
<span class="kn">import</span> <span class="nn">translators</span> <span class="k">as</span> <span class="nn">ts</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">CSV_PATH</span> <span class="o">=</span> <span class="s1">&#39;../input/jigsaw-multilingual-toxic-comment-classification/jigsaw-toxic-comment-train.csv&#39;</span>
<span class="n">LANG</span> <span class="o">=</span> <span class="s1">&#39;es&#39;</span>
<span class="n">API</span> <span class="o">=</span> <span class="s1">&#39;google&#39;</span>


<span class="k">def</span> <span class="nf">translator_constructor</span><span class="p">(</span><span class="n">api</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">api</span> <span class="o">==</span> <span class="s1">&#39;google&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ts</span><span class="o">.</span><span class="n">google</span>
    <span class="k">elif</span> <span class="n">api</span> <span class="o">==</span> <span class="s1">&#39;bing&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ts</span><span class="o">.</span><span class="n">bing</span>
    <span class="k">elif</span> <span class="n">api</span> <span class="o">==</span> <span class="s1">&#39;baidu&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ts</span><span class="o">.</span><span class="n">baidu</span>
    <span class="k">elif</span> <span class="n">api</span> <span class="o">==</span> <span class="s1">&#39;sogou&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ts</span><span class="o">.</span><span class="n">sogou</span>
    <span class="k">elif</span> <span class="n">api</span> <span class="o">==</span> <span class="s1">&#39;youdao&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ts</span><span class="o">.</span><span class="n">youdao</span>
    <span class="k">elif</span> <span class="n">api</span> <span class="o">==</span> <span class="s1">&#39;tencent&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ts</span><span class="o">.</span><span class="n">tencent</span>
    <span class="k">elif</span> <span class="n">api</span> <span class="o">==</span> <span class="s1">&#39;alibaba&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ts</span><span class="o">.</span><span class="n">alibaba</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">api</span><span class="si">}</span><span class="s1"> translator is not realised!&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">translate</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">translator_constructor</span><span class="p">(</span><span class="n">API</span><span class="p">)(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;en&#39;</span><span class="p">,</span> <span class="n">LANG</span><span class="p">),</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">]]</span>


<span class="k">def</span> <span class="nf">imap_unordered_bar</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">n_processes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">48</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">n_processes</span><span class="p">,</span> <span class="n">maxtasksperchild</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">res_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">))</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">imap_unordered</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">))):</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
            <span class="n">res_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="n">pbar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">res_list</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">CSV_PATH</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">tqdm</span><span class="o">.</span><span class="n">pandas</span><span class="p">(</span><span class="s1">&#39;Translation progress&#39;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;comment_text&#39;</span><span class="p">,</span> <span class="s1">&#39;toxic&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">imap_unordered_bar</span><span class="p">(</span><span class="n">translate</span><span class="p">,</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;comment_text&#39;</span><span class="p">,</span> <span class="s1">&#39;toxic&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;jigsaw-toxic-comment-train-</span><span class="si">{</span><span class="n">API</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">LANG</span><span class="si">}</span><span class="s1">.csv&#39;</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="easy-data-augmentation">
<h4><span class="section-number">3.1.7.2.2. </span>Easy Data Augmentation<a class="headerlink" href="#easy-data-augmentation" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p><strong>Synonym Replacement</strong>: thay thế 1 từ non-stopwords trong câu thành 1 từ khác tương ứng (có thể lặp lại n lần)</p></li>
<li><p><strong>Random Insertion</strong>: tìm 1 từ đồng nghĩa với 1 từ ngẫu nhiên trong câu và chèn vào câu với vị trí ngẫu nhiên (có thể lặp lại n lần)</p></li>
<li><p><strong>Random Swap</strong>: Chọn ngẫu nhiên 2 từ trong câu và swap position (có thể lặp lại n lần)</p></li>
<li><p><strong>Random Deletion</strong>: remove ngẫu nhiên 1 từ trong câu với xác suất p (có thể lặp lại n lần)</p></li>
<li><p><strong>Shuffle Sentences Transform</strong>: xáo trộn vị trí các câu trong văn bản</p></li>
<li><p><strong>Exclude duplicate transform</strong>: xoá những câu bị trùng lặp trong văn bản</p></li>
</ul>
<p><strong>Synonym replacement via word-level embeddings</strong> thường hay được sử dụng và mang lại hiệu quả cao nhất</p>
</section>
</section>
</section>
<section id="data-generation">
<h2><span class="section-number">3.1.8. </span>Data Generation<a class="headerlink" href="#data-generation" title="Permalink to this heading">#</a></h2>
<p>có 4 phương pháp tiếp cận data generator phổ biến:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ImageDataGenerator</span></code>: đơn giản + dễ áp dụng data augmentation, tuy nhiên load data chậm do sử dụng CPU thông qua generator</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">image_dataset_from_directory</span></code>: sẽ tạo đối tượng thuộc lớp <code class="docutils literal notranslate"><span class="pre">tf.data.Dataset</span></code> (thay vì một <code class="docutils literal notranslate"><span class="pre">generator</span></code>), hiệu quả hơn với dữ liệu lớn, tốc độ xử lý cao hơn <code class="docutils literal notranslate"><span class="pre">generator</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tf.data.Dataset</span></code>: tạo dataset từ tensors, apply các transformations to data, hoạt động với bất kỳ loại datatype nào (tables, images, text,…), customize được cách import để đạt được hiệu quả tối đa (prefer using)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TFRecords</span></code>: một cấu trúc phức tạp vì biến đối data dưới dạng nhị phân và lưu vào 1/nhiều file TFRecords. Sử dụng TFRecords (thay vì image file) làm train time diễn ra nhanh hơn, đặc biệt cho dữ liệu lớn</p></li>
</ul>
<p><img alt="" src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EzgrQmFcsG5GARjEESY69w.png" /></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># datasets: bộ dữ liệu sử dụng 10% dữ liệu train của 10-food-class-all</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">data_folder</span> <span class="o">=</span> <span class="s1">&#39;Datasets/10_food_classes_10_percent/&#39;</span>
<span class="n">data_folder</span> <span class="o">=</span> <span class="n">data_folder</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
<span class="n">root_level</span> <span class="o">=</span> <span class="n">data_folder</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
<span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">data_folder</span><span class="p">):</span>
    <span class="n">dir_level</span> <span class="o">=</span> <span class="n">dirpath</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;|-----&quot;</span><span class="o">*</span><span class="p">(</span><span class="n">dir_level</span> <span class="o">-</span> <span class="n">root_level</span><span class="p">),</span> <span class="n">end</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">dirpath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">end</span> <span class="o">=</span> <span class="s2">&quot;: &quot;</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dirnames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">t</span><span class="o">+=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dirnames</span><span class="p">)</span><span class="si">}</span><span class="s2"> folders &quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
        <span class="n">t</span><span class="o">+=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span><span class="si">}</span><span class="s2"> files &quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10_food_classes_10_percent: 2 folders 1 files 
|-----test: 10 folders 
|-----|-----ice_cream: 250 files 
|-----|-----chicken_curry: 250 files 
|-----|-----steak: 250 files 
|-----|-----sushi: 250 files 
|-----|-----chicken_wings: 250 files 
|-----|-----grilled_salmon: 250 files 
|-----|-----hamburger: 250 files 
|-----|-----pizza: 250 files 
|-----|-----ramen: 250 files 
|-----|-----fried_rice: 250 files 
|-----train: 10 folders 
|-----|-----ice_cream: 75 files 
|-----|-----chicken_curry: 75 files 
|-----|-----steak: 75 files 
|-----|-----sushi: 75 files 
|-----|-----chicken_wings: 75 files 
|-----|-----grilled_salmon: 75 files 
|-----|-----hamburger: 75 files 
|-----|-----pizza: 75 files 
|-----|-----ramen: 75 files 
|-----|-----fried_rice: 75 files 
</pre></div>
</div>
</div>
</div>
<section id="imagedatagenerator">
<h3><span class="section-number">3.1.8.1. </span>ImageDataGenerator<a class="headerlink" href="#imagedatagenerator" title="Permalink to this heading">#</a></h3>
<p>Trong class <code class="docutils literal notranslate"><span class="pre">ImageDataGenerator</span></code> có các parameters cho việc áp dụng augmentation</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">directory</span></code> là folder mà mỗi class là 1 subfoder trong đó (labels được tạo từ subfolder names)</p></li>
</ul>
<p>Dữ liệu được chia vào <code class="docutils literal notranslate"><span class="pre">train</span></code> và <code class="docutils literal notranslate"><span class="pre">test</span></code> directories và phân tách vào subfolders in each class.</p>
<p><strong>Normalize the data</strong>: Dữ liệu ảnh thì mỗi giá trị color channel sẽ biến thiên trong khoảng [0, 255]. Để model train nhanh hơn và tăng performance, normalize cần phải được thực hiện để đưa các giá trị về [0,1]</p>
<p><strong>Set the batch size</strong>: Thay vì train toàn bộ các ảnh  cùng 1 lúc thì sẽ train theo batch. Thường lựa chọn batch_size = 32 vì nó thường hiệu quả trong nhiều TH khác nhau.</p>
<p><strong>class_mode</strong>: cách label được return trong output</p>
<ul class="simple">
<li><p>“categorical” will be 2D one-hot encoded labels,</p></li>
<li><p>“binary” will be 1D binary labels,</p></li>
<li><p>“sparse” will be 1D integer labels,</p></li>
<li><p>“input” will be images identical to input images (mainly used to work with autoencoders).</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># data batch generator</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.preprocessing.image</span> <span class="kn">import</span> <span class="n">ImageDataGenerator</span>

<span class="c1"># set random seed</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">train_data</span> <span class="o">=</span> <span class="n">ImageDataGenerator</span><span class="p">(</span><span class="n">rescale</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">255</span><span class="p">)</span>\
                <span class="o">.</span><span class="n">flow_from_directory</span><span class="p">(</span>
                    <span class="n">directory</span> <span class="o">=</span> <span class="n">data_folder</span> <span class="o">+</span> <span class="s2">&quot;/train&quot;</span><span class="p">,</span> <span class="c1"># data directory</span>
                    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>                    <span class="c1"># number of images to process at a time</span>
                    <span class="n">target_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">224</span><span class="p">,</span><span class="mi">224</span><span class="p">),</span>            <span class="c1"># convert all images to be 224 x 224 </span>
                                                        <span class="c1"># (common size to balance the remain info and chi phí tính toán)</span>
                    <span class="n">class_mode</span> <span class="o">=</span> <span class="s1">&#39;binary&#39;</span><span class="p">,</span>              <span class="c1"># cách label được return trong output</span>
                    <span class="p">)</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">ImageDataGenerator</span><span class="p">(</span><span class="n">rescale</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">255</span><span class="p">)</span>\
                <span class="o">.</span><span class="n">flow_from_directory</span><span class="p">(</span>
                    <span class="n">directory</span> <span class="o">=</span> <span class="n">data_folder</span> <span class="o">+</span> <span class="s2">&quot;/test&quot;</span><span class="p">,</span>
                    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>                    
                    <span class="n">target_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">224</span><span class="p">,</span><span class="mi">224</span><span class="p">),</span>            
                    <span class="n">class_mode</span> <span class="o">=</span> <span class="s1">&#39;binary&#39;</span><span class="p">,</span>              
                    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Found 1500 images belonging to 2 classes.
Found 500 images belonging to 2 classes.
</pre></div>
</div>
</div>
</div>
</section>
<section id="image-dataset-from-directory">
<h3><span class="section-number">3.1.8.2. </span>image_dataset_from_directory<a class="headerlink" href="#image-dataset-from-directory" title="Permalink to this heading">#</a></h3>
<p>Tuy nhiên ko có tuỳ chọn <strong>data augmentation</strong>, phải sử dụng <strong>data augmentation layer</strong> trong model</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tensorflow.keras.utils</span> <span class="kn">import</span> <span class="n">image_dataset_from_directory</span>

<span class="c1"># Create training and test directories</span>
<span class="n">train_dir</span> <span class="o">=</span> <span class="n">data_folder</span> <span class="o">+</span> <span class="s2">&quot;/train/&quot;</span>
<span class="n">test_dir</span> <span class="o">=</span> <span class="n">data_folder</span> <span class="o">+</span> <span class="s2">&quot;/test/&quot;</span>
<span class="n">IMG_SIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">224</span><span class="p">,</span><span class="mi">224</span><span class="p">)</span>
<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">32</span>

<span class="n">train_data</span> <span class="o">=</span> <span class="n">image_dataset_from_directory</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="n">train_dir</span><span class="p">,</span>
                                        <span class="n">image_size</span><span class="o">=</span><span class="n">IMG_SIZE</span><span class="p">,</span>
                                        <span class="n">label_mode</span><span class="o">=</span><span class="s2">&quot;categorical&quot;</span><span class="p">,</span>
                                        <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> 
                                         <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> 
<span class="n">test_data</span> <span class="o">=</span> <span class="n">image_dataset_from_directory</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="n">test_dir</span><span class="p">,</span>
                                       <span class="n">image_size</span><span class="o">=</span><span class="n">IMG_SIZE</span><span class="p">,</span>
                                       <span class="n">label_mode</span><span class="o">=</span><span class="s2">&quot;categorical&quot;</span><span class="p">,</span>
                                       <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="tf-data-dataset">
<h3><span class="section-number">3.1.8.3. </span>tf.data.Dataset<a class="headerlink" href="#tf-data-dataset" title="Permalink to this heading">#</a></h3>
<p>tạo dataset từ tensors, apply các transformations to data, hoạt động với bất kỳ loại datatype nào (tables, images, text,…), customize được cách import để đạt được hiệu quả tối đa (prefer using)</p>
<section id="load-data-from-tensorflow-datasets">
<h4><span class="section-number">3.1.8.3.1. </span>load data from tensorflow datasets<a class="headerlink" href="#load-data-from-tensorflow-datasets" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tensorflow_datasets</span> <span class="k">as</span> <span class="nn">tfds</span>

<span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span><span class="p">),</span> <span class="n">ds_info</span> <span class="o">=</span> <span class="n">tfds</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;food101&quot;</span><span class="p">,</span> <span class="c1"># target dataset to get from TFDS</span>
                                             <span class="n">split</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;validation&quot;</span><span class="p">],</span> <span class="c1"># what splits of data should we get? note: not all datasets have train, valid, test</span>
                                             <span class="n">shuffle_files</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1"># shuffle files on download?</span>
                                             <span class="n">as_supervised</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1"># download data in tuple format (sample, label), e.g. (image, label)</span>
                                             <span class="n">with_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># include dataset metadata? if so, tfds.load() returns tuple (data, ds_info)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">make_dataset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="n">img_size</span> <span class="o">=</span> <span class="mi">224</span><span class="p">,</span> <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">preprocess_img</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">[</span><span class="n">img_size</span><span class="p">,</span> <span class="n">img_size</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">label</span>

    <span class="k">def</span> <span class="nf">configure_for_performance</span><span class="p">(</span><span class="n">ds</span><span class="p">):</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">AUTOTUNE</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ds</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">preprocess_img</span><span class="p">,</span> <span class="n">num_parallel_calls</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">AUTOTUNE</span><span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">configure_for_performance</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ds</span>

<span class="n">train_data</span> <span class="o">=</span> <span class="n">make_dataset</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="load-data-from-local-images">
<h4><span class="section-number">3.1.8.3.2. </span>load data from local images<a class="headerlink" href="#load-data-from-local-images" title="Permalink to this heading">#</a></h4>
<p><strong>Procedure:</strong></p>
<ol class="arabic simple">
<li><p>Khởi tạo <code class="docutils literal notranslate"><span class="pre">tf.data.Dataset</span></code> là danh sách filenames và <code class="docutils literal notranslate"><span class="pre">map()</span></code> function <code class="docutils literal notranslate"><span class="pre">preprocess_img</span></code> vào datasets, chức năng của function thực hiện read_file từ filename, decode ảnh, resize ảnh về target image, convert dtype về <code class="docutils literal notranslate"><span class="pre">float32</span></code>.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">num_parallel_calls=tf.data.AUTOTUNE</span></code> giúp load nhiều ảnh song song</p></li>
<li><p>không thể tạo batch tensors với các shapes khác nhau, đo đó phải resize ảnh về target image_size</p></li>
</ul>
</li>
<li><p>Khởi tạo <code class="docutils literal notranslate"><span class="pre">tf.data.Dataset</span></code> là danh sách labels</p></li>
<li><p>Zip data và labels thành 1 <code class="docutils literal notranslate"><span class="pre">tf.data.Dataset</span></code></p></li>
<li><p>Configure dataset:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/data/Dataset#shuffle"><code class="docutils literal notranslate"><span class="pre">shuffle()</span></code></a>: trộn data theo 1 bộ có size là buffer_size (from 1000 to 10000)</p>
<ul>
<li><p>Nếu <code class="docutils literal notranslate"><span class="pre">buffer_size</span> <span class="pre">&gt;</span> <span class="pre">datasize</span></code> tương đương với trộn trên toàn bộ dữ liệu, tuy nhiên sẽ ảnh hưởng đến performance vì phải load hết filenames của dataset</p></li>
<li><p>Nếu <code class="docutils literal notranslate"><span class="pre">buffer_size</span> <span class="pre">=</span> <span class="pre">1</span></code>, tương đương với việc ko shuffle dữ liệu</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/data/Dataset#batch"><code class="docutils literal notranslate"><span class="pre">batch()</span></code></a>: tạo batch dữ liệu theo tham số batch_size</p></li>
<li><p><a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/data/Dataset#prefetch"><code class="docutils literal notranslate"><span class="pre">prefetch()</span></code></a>: số lượng batches được preload trong khi 1 batch trước đó đang được computing, sử dụng <code class="docutils literal notranslate"><span class="pre">tf.data.AUTOTUNE</span></code> để tự động tối ưu.</p></li>
<li><p><a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/data/Dataset#cache"><code class="docutils literal notranslate"><span class="pre">cache()</span></code></a> : sử dụng caches (lưu dữ liệu để sử dụng cho epoch tiếp theo) để tiết kiệm thời gian load cho lần chạy epoch tiếp theo, tuy nhiên chỉ sử dụng cache khi dữ liệu đủ nhỏ để fit được hết vào memory.</p></li>
</ul>
</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/mrdbourke/tensorflow-deep-learning/main/images/07-prefetching-from-hands-on-ml.png" /></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">make_dataset</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="n">img_size</span> <span class="o">=</span> <span class="mi">224</span><span class="p">,</span> <span class="n">shuffle_size</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">label_encode</span> <span class="o">=</span> <span class="s1">&#39;sparse&#39;</span><span class="p">):</span>
    <span class="c1"># shuffle_size = 1 mean not shuffle</span>
    
    <span class="k">def</span> <span class="nf">preprocess_img</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">decode_jpeg</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">[</span><span class="n">img_size</span><span class="p">,</span> <span class="n">img_size</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">configure_for_performance</span><span class="p">(</span><span class="n">ds</span><span class="p">):</span>
        <span class="c1"># ds = ds.cache()</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="n">shuffle_size</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">AUTOTUNE</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ds</span>

    
    <span class="n">filenames</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/*/*&#39;</span><span class="p">)</span>
    <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">label_encode</span> <span class="o">==</span> <span class="s1">&#39;sparse&#39;</span><span class="p">:</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">classes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">label_encode</span> <span class="o">==</span> <span class="s1">&#39;categorical&#39;</span><span class="p">:</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[(</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">classes</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">]</span>
        

    <span class="n">filenames_ds</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>
    <span class="n">images_ds</span> <span class="o">=</span> <span class="n">filenames_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">preprocess_img</span><span class="p">,</span> <span class="n">num_parallel_calls</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">AUTOTUNE</span><span class="p">)</span>
    <span class="n">labels_ds</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">zip</span><span class="p">((</span><span class="n">images_ds</span><span class="p">,</span> <span class="n">labels_ds</span><span class="p">))</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">configure_for_performance</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ds</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_folder</span> <span class="o">=</span> <span class="s2">&quot;Datasets/10_food_classes_10_percent&quot;</span>
<span class="n">train_dir</span> <span class="o">=</span> <span class="n">data_folder</span> <span class="o">+</span> <span class="s2">&quot;/train/&quot;</span>
<span class="n">test_dir</span> <span class="o">=</span> <span class="n">data_folder</span> <span class="o">+</span> <span class="s2">&quot;/test/&quot;</span>
<span class="n">IMG_SIZE</span> <span class="o">=</span> <span class="mi">224</span>
<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">32</span>

<span class="n">train_data</span> <span class="o">=</span> <span class="n">make_dataset</span><span class="p">(</span><span class="n">train_dir</span><span class="p">,</span> <span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">IMG_SIZE</span><span class="p">)</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">make_dataset</span><span class="p">(</span><span class="n">test_dir</span><span class="p">,</span> <span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">IMG_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># set shuffle_size = 1 mean not shuffle for testset</span>
<span class="n">train_data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;_PrefetchDataset element_spec=(TensorSpec(shape=(None, 224, 224, 3), dtype=tf.float32, name=None), TensorSpec(shape=(None,), dtype=tf.int32, name=None))&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>24
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">img</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">test_data</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">break</span>
<span class="n">label</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(32,), dtype=int32, numpy=
array([3, 5, 4, 5, 7, 6, 0, 8, 8, 7, 0, 4, 4, 1, 3, 0, 9, 5, 4, 8, 7, 5,
       5, 4, 5, 3, 3, 4, 4, 2, 2, 0], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="tfrecords">
<h4><span class="section-number">3.1.8.3.3. </span>TFRecords<a class="headerlink" href="#tfrecords" title="Permalink to this heading">#</a></h4>
<p>Sử dụng TFRecords trong TH cần merge data thành 1/nhiều file hoặc sử dụng với TPUs, vì sử dụng GPUs + TFRecords ko có sự khác biệt về time performance so với local-files.</p>
<p>Sử dụng <strong>TFRecords + TPUs</strong> tăng đáng kể hiệu suất nhưng cũng giảm đôi chút sự chính xác của model. The drop in accuracy comes simply from the fact that different hyperparameter combinations are efficient with the TPUs but the tests used the same as the GPU. Using the right hyperparameters lead to similar accuracies than with the other methods.</p>
<section id="writing-tfrecords">
<h5><span class="section-number">3.1.8.3.3.1. </span>Writing TFRecords<a class="headerlink" href="#writing-tfrecords" title="Permalink to this heading">#</a></h5>
<p>Save data to TFRecords file once time, then use for future/sharing to other.</p>
<p>For larger datasets, the TFRecords có thể chia thành nhiều files nhỏ hơn (shards), làm việc training nhanh hơn.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Writing TFRecords</span>

<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="k">def</span> <span class="nf">serialize_example</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    transform each datapoint into Features, then to string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">feature</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span><span class="n">bytes_list</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">BytesList</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="n">image</span><span class="p">])),</span>
        <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span><span class="n">int64_list</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Int64List</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="n">label</span><span class="p">]))</span>
    <span class="p">}</span>

    <span class="n">example_proto</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Example</span><span class="p">(</span><span class="n">features</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Features</span><span class="p">(</span><span class="n">feature</span><span class="o">=</span><span class="n">feature</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">example_proto</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">make_tfrecords</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">record_file</span><span class="o">=</span><span class="s1">&#39;Datasets/images.tfrecords&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Chức năng tương tự như bước preparation, khác ở chỗ là image sẽ được lưu fullsize</span>
<span class="sd">    (thay vì phải resize về target_size) lưu vào TFRecords </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">classes</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">TFRecordWriter</span><span class="p">(</span><span class="n">record_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
        <span class="n">files_list</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/*/*&#39;</span><span class="p">)</span>
        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">files_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">files_list</span><span class="p">:</span>
            <span class="n">image_string</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">category</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">classes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">category</span><span class="p">)</span>
            <span class="n">tf_example</span> <span class="o">=</span> <span class="n">serialize_example</span><span class="p">(</span><span class="n">image_string</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tf_example</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">make_tfrecords</span><span class="p">(</span><span class="n">train_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="reading-tfrecords">
<h5><span class="section-number">3.1.8.3.3.2. </span>Reading TFRecords<a class="headerlink" href="#reading-tfrecords" title="Permalink to this heading">#</a></h5>
<p>Dữ liệu được load theo <code class="docutils literal notranslate"><span class="pre">tf.data.Dataset</span></code> từ các file TFRecords (thay vì image file)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_parse_image_function</span><span class="p">(</span><span class="n">example</span><span class="p">):</span>
    <span class="n">image_feature_description</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">([],</span> <span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">),</span>
        <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">([],</span> <span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="n">features</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">parse_single_example</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">image_feature_description</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">decode_jpeg</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">],</span> <span class="n">channels</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">[</span><span class="n">IMG_SIZE</span><span class="p">,</span> <span class="n">IMG_SIZE</span><span class="p">])</span>

    <span class="n">label</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">label</span>


<span class="k">def</span> <span class="nf">read_dataset</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">):</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">TFRecordDataset</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_parse_image_function</span><span class="p">,</span> <span class="n">num_parallel_calls</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">AUTOTUNE</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># dataset = dataset.repeat()</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">AUTOTUNE</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dataset</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train</span> <span class="o">=</span> <span class="n">read_dataset</span><span class="p">(</span><span class="s1">&#39;Datasets/images.tfrecords&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">img</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">train</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">break</span>
<span class="n">label</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(32,), dtype=int32, numpy=
array([5, 6, 9, 3, 1, 1, 0, 9, 0, 4, 0, 8, 1, 7, 1, 3, 8, 7, 1, 9, 1, 7,
       3, 4, 7, 6, 8, 4, 4, 5, 9, 7], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="tfrecords-with-tpu-optional">
<h5><span class="section-number">3.1.8.3.3.3. </span>Tfrecords with TPU (optional)<a class="headerlink" href="#tfrecords-with-tpu-optional" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">tensorflow.python.profiler</span> <span class="kn">import</span> <span class="n">profiler_client</span>

<span class="n">tpu_profile_service_address</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;COLAB_TPU_ADDR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;8470&#39;</span><span class="p">,</span> <span class="s1">&#39;8466&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">profiler_client</span><span class="o">.</span><span class="n">monitor</span><span class="p">(</span><span class="n">tpu_profile_service_address</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">use_tfrecords_tpu</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">tfrecords_path</span><span class="p">):</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">read_dataset</span><span class="p">(</span><span class="n">tfrecords_path</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>

    <span class="n">num_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
    <span class="n">num_images</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/*/*&#39;</span><span class="p">))</span>

    <span class="n">tpu_cluster_resolver</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">distribute</span><span class="o">.</span><span class="n">cluster_resolver</span><span class="o">.</span><span class="n">TPUClusterResolver</span><span class="p">()</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">experimental_connect_to_cluster</span><span class="p">(</span><span class="n">tpu_cluster_resolver</span><span class="p">)</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">tpu</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">initialize_tpu_system</span><span class="p">(</span><span class="n">tpu_cluster_resolver</span><span class="p">)</span>
    <span class="n">strategy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">distribute</span><span class="o">.</span><span class="n">TPUStrategy</span><span class="p">(</span><span class="n">tpu_cluster_resolver</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">strategy</span><span class="o">.</span><span class="n">scope</span><span class="p">():</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="n">num_classes</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">steps_per_epoch</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
</section>
<section id="modeling-sytax">
<h2><span class="section-number">3.1.9. </span>Modeling sytax<a class="headerlink" href="#modeling-sytax" title="Permalink to this heading">#</a></h2>
<p><strong>1. Creating a model</strong>
define:</p>
<ul class="simple">
<li><p>the input layer</p></li>
<li><p>the hidden layer + activate_function</p></li>
<li><p>the output layer + activate_function</p></li>
</ul>
<blockquote>
<div><p>có 3 cách thức create model: <a class="reference external" href="https://machinelearningmastery.com/three-ways-to-build-machine-learning-models-in-keras/">Chi tiết</a></p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.tensorflow.org/guide/keras/sequential_model"><strong>Sequential class</strong></a>: It is a simple, easy-to-use way to start building your Keras model.</p></li>
<li><p><a class="reference external" href="https://www.tensorflow.org/guide/keras/functional"><strong>Keras’s functional interface</strong></a>: more flexible way of representing the model with multiple paths, multiple inputs, multiple outputs</p></li>
<li><p><a class="reference external" href="https://www.tensorflow.org/guide/keras/custom_layers_and_models"><strong>Subclassing keras.Model</strong></a>: tiếp cận theo OOP approach to creating models, give the full control and customize the model</p></li>
</ul>
</div></blockquote>
<p><strong>2. Compiling the model</strong>
define:</p>
<ul class="simple">
<li><p>the <code class="docutils literal notranslate"><span class="pre">loss</span></code> function : Cách đo độ sai lệch giữa prediction và actual</p></li>
<li><p>the <code class="docutils literal notranslate"><span class="pre">optimizer</span></code> : cách update the weights để minimize the loss</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">evaluation</span> <span class="pre">metrics</span></code>: đo performance of the model</p></li>
</ul>
<p><strong>3. Fitting the model</strong></p>
<ul class="simple">
<li><p>Fit X and Y to find the patterns between them</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">epochs</span></code>: số lần model sẽ chạy thông qua all training examples</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">batch_size</span></code>: số samples được học cho 1 lần update weight</p></li>
</ul>
<blockquote>
<div><p>Ví dụ: giả sử data có 200 samples , set batch_size = 5 and epochs = 100 có nghĩa là data sẽ gồm 40 batch, tương đương với 40 lần update weight cho mỗi 1 epoch, với số epochs = 100 thì tổng cộng maximum có 4000 batches được training, tương đương 4000 lần update weight.</p>
</div></blockquote>
<p><strong>4. Evaluation</strong></p>
<ul class="simple">
<li><p>Evaluate the model on the test data</p></li>
</ul>
<section id="sequential-api">
<h3><span class="section-number">3.1.9.1. </span>Sequential API<a class="headerlink" href="#sequential-api" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">layers</span><span class="p">,</span> <span class="n">Sequential</span><span class="p">,</span> <span class="n">optimizers</span><span class="p">,</span> <span class="n">losses</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># list sytax</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">([</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">224</span><span class="p">,</span><span class="mi">224</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="s1">&#39;relu&#39;</span><span class="p">),</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">MaxPool2D</span><span class="p">(</span><span class="n">pool_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="s1">&#39;relu&#39;</span><span class="p">),</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="s1">&#39;relu&#39;</span><span class="p">),</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">MaxPool2D</span><span class="p">(</span><span class="n">pool_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(),</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;sigmoid&#39;</span><span class="p">),</span>
<span class="p">])</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizers</span><span class="o">.</span><span class="n">legacy</span><span class="o">.</span><span class="n">Adam</span><span class="p">(),</span>
             <span class="n">loss</span><span class="o">=</span> <span class="n">losses</span><span class="o">.</span><span class="n">binary_crossentropy</span><span class="p">(),</span>
             <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># adding layer sytax</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">224</span><span class="p">,</span><span class="mi">224</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPool2D</span><span class="p">(</span><span class="n">pool_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPool2D</span><span class="p">(</span><span class="n">pool_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">())</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;sigmoid&#39;</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizers</span><span class="o">.</span><span class="n">legacy</span><span class="o">.</span><span class="n">Adam</span><span class="p">(),</span>
             <span class="n">loss</span><span class="o">=</span> <span class="n">losses</span><span class="o">.</span><span class="n">binary_crossentropy</span><span class="p">(),</span>
             <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="keras-function-api">
<h3><span class="section-number">3.1.9.2. </span>Keras Function API<a class="headerlink" href="#keras-function-api" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">build_model</span><span class="p">(</span><span class="n">n_classes</span><span class="p">):</span>
    <span class="c1"># set params</span>
    <span class="n">input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">IMG_SIZE</span><span class="p">,</span> <span class="n">IMG_SIZE</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    
    <span class="c1"># data augmentation</span>
    <span class="n">data_aug</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">RandomFlip</span><span class="p">(</span><span class="s2">&quot;horizontal&quot;</span><span class="p">),</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">RandomRotation</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">RandomZoom</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">RandomHeight</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">RandomWidth</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
        <span class="c1"># layers.Resizing(224,224),  # (dont need to EfficientNetB0 because it&#39;s has)</span>
        <span class="c1"># layers.Rescaling(1./255) # (dont need to EfficientNetB0 because it&#39;s has)</span>
    <span class="p">],</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;data_augmentation&#39;</span><span class="p">)</span>
    
    <span class="c1"># base model</span>
    <span class="n">base_model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">applications</span><span class="o">.</span><span class="n">EfficientNetV2B0</span><span class="p">(</span><span class="n">include_top</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">base_model</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># create model</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span> <span class="o">=</span> <span class="n">input_shape</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;input_layer&quot;</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">data_aug</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">base_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">training</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">GlobalAveragePooling2D</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;pooling_layer&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">n_classes</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;output_layer&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="c1"># convert output from mixed-float16 to float32, to calculate loss stablelity</span>
    <span class="c1"># outputs = layers.Activation(&#39;softmax&#39;, dtype = tf.float32, name = &#39;output_activation&#39;)(x)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>

    <span class="c1"># Use sparse_categorical_crossentropy when labels are *not* one-hot</span>
    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;sparse_categorical_crossentropy&#39;</span><span class="p">,</span> 
                  <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">legacy</span><span class="o">.</span><span class="n">Adam</span><span class="p">(),</span>
                  <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">IMG_SIZE</span> <span class="o">=</span> <span class="mi">224</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;model_2&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 input_layer (InputLayer)    [(None, 224, 224, 3)]     0         
                                                                 
 data_augmentation (Sequenti  (None, None, None, 3)    0         
 al)                                                             
                                                                 
 efficientnetv2-b0 (Function  (None, None, None, 1280)  5919312  
 al)                                                             
                                                                 
 pooling_layer (GlobalAverag  (None, 1280)             0         
 ePooling2D)                                                     
                                                                 
 output_layer (Dense)        (None, 10)                12810     
                                                                 
=================================================================
Total params: 5,932,122
Trainable params: 12,810
Non-trainable params: 5,919,312
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
</section>
<section id="subclassing-keras-model">
<h3><span class="section-number">3.1.9.3. </span>Subclassing keras.Model<a class="headerlink" href="#subclassing-keras-model" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FoodClassifier</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_size</span><span class="p">,</span> <span class="n">nclasses</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FoodClassifier</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nclasses</span> <span class="o">=</span> <span class="n">nclasses</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">img_size</span><span class="p">,</span> <span class="n">img_size</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;input_layer&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_aug</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
                <span class="c1"># self.inputs,</span>
                <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">RandomFlip</span><span class="p">(</span><span class="s2">&quot;horizontal&quot;</span><span class="p">),</span>
                <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">RandomRotation</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
                <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">RandomZoom</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
                <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">RandomHeight</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
                <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">RandomWidth</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
                <span class="c1"># keras.layers.Resizing(224,224),  # (dont need to EfficientNetB0 because it&#39;s has)</span>
                <span class="c1"># keras.layers.Rescaling(1./255) # (dont need to EfficientNetB0 because it&#39;s has)</span>
            <span class="p">],</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;data_augmentation&#39;</span><span class="p">,</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">applications</span><span class="o">.</span><span class="n">EfficientNetV2B0</span><span class="p">(</span><span class="n">include_top</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pooling1</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">GlobalAveragePooling2D</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;pooling_layer&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dense1</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">nclasses</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span> <span class="p">,</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;dense_output_layer&#39;</span><span class="p">)</span>
        <span class="c1"># self.activ1 = keras.layers.Activation(&#39;softmax&#39;, dtype = tf.float32, name = &#39;output_activation&#39;)</span>
        
    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">training</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_aug</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">training</span> <span class="o">=</span> <span class="n">training</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pooling1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>
    
    <span class="k">def</span> <span class="nf">recompile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;sparse_categorical_crossentropy&#39;</span><span class="p">,</span> 
                  <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">legacy</span><span class="o">.</span><span class="n">Adam</span><span class="p">(),</span>
                  <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">])</span>
        
    <span class="k">def</span> <span class="nf">build_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> 
                           <span class="n">outputs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">food_classifier</span> <span class="o">=</span> <span class="n">FoodClassifier</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">food_classifier</span><span class="o">.</span><span class="n">build_graph</span><span class="p">()</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;model_6&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 input_layer (InputLayer)    [(None, 224, 224, 3)]     0         
                                                                 
 data_augmentation (Sequenti  (None, None, None, 3)    0         
 al)                                                             
                                                                 
 efficientnetv2-b0 (Function  (None, None, None, 1280)  5919312  
 al)                                                             
                                                                 
 pooling_layer (GlobalAverag  (None, 1280)             0         
 ePooling2D)                                                     
                                                                 
 dense_output_layer (Dense)  (None, 10)                12810     
                                                                 
=================================================================
Total params: 5,932,122
Trainable params: 12,810
Non-trainable params: 5,919,312
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">projects.image_classify_food101.helper.dataloader</span> <span class="kn">import</span> <span class="n">make_dataset</span>
<span class="n">dataraw_folder</span> <span class="o">=</span> <span class="s2">&quot;/Users/datkhong/Downloads/food-101/images&quot;</span>
<span class="n">train_data</span> <span class="o">=</span> <span class="n">make_dataset</span><span class="p">(</span><span class="s2">&quot;/Users/datkhong/Downloads/food-101/images/train&quot;</span><span class="p">)</span>
<span class="n">train_10perc_data</span> <span class="o">=</span> <span class="n">make_dataset</span><span class="p">(</span><span class="s2">&quot;/Users/datkhong/Downloads/food-101/images/train_0.1&quot;</span><span class="p">)</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">make_dataset</span><span class="p">(</span><span class="s2">&quot;/Users/datkhong/Downloads/food-101/images/test&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqdm.keras</span> <span class="kn">import</span> <span class="n">TqdmCallback</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">food_classifier</span><span class="o">.</span><span class="n">recompile</span><span class="p">()</span>
<span class="n">food_classifier</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_10perc_data</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">steps_per_epoch</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_10perc_data</span><span class="p">)</span><span class="o">*</span><span class="mf">0.05</span><span class="p">),</span>
                     <span class="n">validation_data</span><span class="o">=</span><span class="n">test_data</span><span class="p">,</span>
                     <span class="n">validation_steps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.05</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_data</span><span class="p">)),</span>
                     <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">TqdmCallback</span><span class="p">()])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "2e2fde26a0cc410d96638e87edcd6d26", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "", "version_major": 2, "version_minor": 0}</script><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;keras.callbacks.History at 0x5f37734f0&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">food_classifier</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;food_classifier_22&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 data_augmentation (Sequenti  (None, None, None, 3)    0         
 al)                                                             
                                                                 
 efficientnetv2-b0 (Function  (None, None, None, 1280)  5919312  
 al)                                                             
                                                                 
 pooling_layer (GlobalAverag  (None, 1280)             0         
 ePooling2D)                                                     
                                                                 
 dense_output_layer (Dense)  (None, 10)                12810     
                                                                 
=================================================================
Total params: 5,932,122
Trainable params: 12,810
Non-trainable params: 5,919,312
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># check trainable </span>
<span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">food_classifier</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">trainable</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">dtype_policy</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>data_augmentation True float32 &lt;Policy &quot;float32&quot;&gt;
efficientnetv2-b0 False float32 &lt;Policy &quot;float32&quot;&gt;
pooling_layer True float32 &lt;Policy &quot;float32&quot;&gt;
dense_output_layer True float32 &lt;Policy &quot;float32&quot;&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># finetune</span>
<span class="n">food_classifier</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># check trainable </span>
<span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">food_classifier</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">trainable</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">dtype_policy</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>data_augmentation True float32 &lt;Policy &quot;float32&quot;&gt;
efficientnetv2-b0 True float32 &lt;Policy &quot;float32&quot;&gt;
pooling_layer True float32 &lt;Policy &quot;float32&quot;&gt;
dense_output_layer True float32 &lt;Policy &quot;float32&quot;&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">food_classifier</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">layers</span><span class="p">[:</span><span class="o">-</span><span class="mi">10</span><span class="p">]:</span>
    <span class="n">layer</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="kc">False</span>
    
<span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">food_classifier</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">15</span><span class="p">:]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">trainable</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">dtype_policy</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>block6h_dwconv2 False float32 &lt;Policy &quot;float32&quot;&gt;
block6h_bn False float32 &lt;Policy &quot;float32&quot;&gt;
block6h_activation False float32 &lt;Policy &quot;float32&quot;&gt;
block6h_se_squeeze False float32 &lt;Policy &quot;float32&quot;&gt;
block6h_se_reshape False float32 &lt;Policy &quot;float32&quot;&gt;
block6h_se_reduce True float32 &lt;Policy &quot;float32&quot;&gt;
block6h_se_expand True float32 &lt;Policy &quot;float32&quot;&gt;
block6h_se_excite True float32 &lt;Policy &quot;float32&quot;&gt;
block6h_project_conv True float32 &lt;Policy &quot;float32&quot;&gt;
block6h_project_bn True float32 &lt;Policy &quot;float32&quot;&gt;
block6h_drop True float32 &lt;Policy &quot;float32&quot;&gt;
block6h_add True float32 &lt;Policy &quot;float32&quot;&gt;
top_conv True float32 &lt;Policy &quot;float32&quot;&gt;
top_bn True float32 &lt;Policy &quot;float32&quot;&gt;
top_activation True float32 &lt;Policy &quot;float32&quot;&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># check trainable in summary</span>
<span class="n">food_classifier</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;food_classifier_22&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 data_augmentation (Sequenti  (None, None, None, 3)    0         
 al)                                                             
                                                                 
 efficientnetv2-b0 (Function  (None, None, None, 1280)  5919312  
 al)                                                             
                                                                 
 pooling_layer (GlobalAverag  (None, 1280)             0         
 ePooling2D)                                                     
                                                                 
 dense_output_layer (Dense)  (None, 10)                12810     
                                                                 
=================================================================
Total params: 5,932,122
Trainable params: 594,490
Non-trainable params: 5,337,632
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
</section>
<section id="model-template">
<h3><span class="section-number">3.1.9.4. </span>Model Template<a class="headerlink" href="#model-template" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">munch</span> <span class="kn">import</span> <span class="n">DefaultMunch</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">choice</span>

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">tensorflow_hub</span> <span class="k">as</span> <span class="nn">hub</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.preprocessing.image</span> <span class="kn">import</span> <span class="n">ImageDataGenerator</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">Sequential</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Conv2D</span><span class="p">,</span> <span class="n">MaxPool2D</span><span class="p">,</span> <span class="n">Dropout</span><span class="p">,</span> <span class="n">Flatten</span><span class="p">,</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">Activation</span><span class="p">,</span> <span class="n">BatchNormalization</span>
<span class="kn">from</span> <span class="nn">keras.callbacks</span> <span class="kn">import</span> <span class="n">EarlyStopping</span><span class="p">,</span> <span class="n">ReduceLROnPlateau</span><span class="p">,</span> <span class="n">ModelCheckpoint</span>
<span class="kn">from</span> <span class="nn">tqdm.keras</span> <span class="kn">import</span> <span class="n">TqdmCallback</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.utils</span> <span class="kn">import</span> <span class="n">plot_model</span><span class="p">,</span> <span class="n">img_to_array</span><span class="p">,</span> <span class="n">load_img</span>

<span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">CFG</span> <span class="o">=</span> <span class="p">{</span>
   <span class="s1">&#39;seed&#39;</span><span class="p">:</span><span class="mi">1</span> <span class="p">,</span>
   <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
       <span class="s1">&#39;dirs&#39;</span><span class="p">:{</span>
            <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;Datasets/10_food_classes_all_data/&quot;</span><span class="p">,</span>
            <span class="s1">&#39;train_subfolder&#39;</span><span class="p">:</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span>
            <span class="s1">&#39;test_subfolder&#39;</span><span class="p">:</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span>
            <span class="s1">&#39;pred_subfolder&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>           
       <span class="p">},</span>
       <span class="s1">&#39;aug_generator&#39;</span><span class="p">:{</span>
            <span class="s1">&#39;rescale&#39;</span> <span class="p">:</span> <span class="mi">1</span><span class="o">/</span><span class="mf">255.</span><span class="p">,</span>
             <span class="s1">&#39;rotation_range&#39;</span> <span class="p">:</span> <span class="mi">20</span><span class="p">,</span> 
             <span class="s1">&#39;shear_range&#39;</span> <span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> 
             <span class="s1">&#39;zoom_range&#39;</span> <span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> 
             <span class="s1">&#39;width_shift_range&#39;</span> <span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> 
             <span class="s1">&#39;height_shift_range&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> 
             <span class="s1">&#39;horizontal_flip&#39;</span> <span class="p">:</span> <span class="kc">True</span>
       <span class="p">},</span>
       <span class="s1">&#39;non_aug_generator&#39;</span><span class="p">:{</span>
            <span class="s1">&#39;rescale&#39;</span> <span class="p">:</span> <span class="mi">1</span><span class="o">/</span><span class="mf">255.</span><span class="p">,</span>
       <span class="p">},</span>
       <span class="s1">&#39;loader&#39;</span><span class="p">:{</span>
           <span class="s1">&#39;aug_train&#39;</span> <span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
           <span class="s1">&#39;aug_test&#39;</span><span class="p">:</span> <span class="kc">False</span>
       <span class="p">},</span>
       <span class="s1">&#39;flow&#39;</span><span class="p">:{</span>
           <span class="s1">&#39;batch_size&#39;</span> <span class="p">:</span> <span class="mi">32</span><span class="p">,</span>                   
           <span class="s1">&#39;target_size&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">224</span><span class="p">,</span><span class="mi">224</span><span class="p">),</span>            
           <span class="s1">&#39;class_mode&#39;</span> <span class="p">:</span> <span class="s1">&#39;categorical&#39;</span><span class="p">,</span>
       <span class="p">},</span>
    <span class="p">},</span>
    <span class="s2">&quot;model&quot;</span><span class="p">:{</span>
        <span class="s1">&#39;build&#39;</span><span class="p">:{</span>
            <span class="s1">&#39;pathmodel&#39;</span><span class="p">:</span> <span class="kc">None</span>
            <span class="s1">&#39;pretrain_url&#39;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">},</span>
        <span class="s1">&#39;compile&#39;</span><span class="p">:{</span>
            <span class="s2">&quot;optimizer&quot;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">legacy</span><span class="o">.</span><span class="n">Adam</span><span class="p">(),</span>
            <span class="s1">&#39;loss&#39;</span><span class="p">:</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span>
            <span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">],</span>
        <span class="p">},</span>
        <span class="s1">&#39;fit&#39;</span><span class="p">:{</span>
            <span class="s1">&#39;epochs&#39;</span> <span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="s1">&#39;verbose&#39;</span> <span class="p">:</span> <span class="mi">0</span>
        <span class="p">},</span>
        <span class="s1">&#39;save&#39;</span><span class="p">:{</span>
            <span class="s1">&#39;dirs&#39;</span> <span class="p">:</span> <span class="s1">&#39;models&#39;</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;multiclass_model&#39;</span><span class="p">,</span>
            <span class="s1">&#39;export_graph&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TempModel</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">pathmodel</span> <span class="o">=</span> <span class="kc">None</span> <span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">DefaultMunch</span><span class="o">.</span><span class="n">fromDict</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="o">.</span><span class="n">epochs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="o">.</span><span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_datagen</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pathmodel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pathmodel</span> <span class="o">=</span> <span class="n">pathmodel</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">pathmodel</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_datafolder</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">load_datafolder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">data_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dirs</span>
        <span class="n">data_folder</span> <span class="o">=</span> <span class="n">data_cfg</span><span class="o">.</span><span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_folder</span><span class="p">,</span> <span class="n">data_cfg</span><span class="o">.</span><span class="n">train_subfolder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_folder</span><span class="p">,</span> <span class="n">data_cfg</span><span class="o">.</span><span class="n">test_subfolder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_folder</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span> 
                           <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_folder</span><span class="p">,</span> <span class="n">i</span><span class="p">))]</span>
        <span class="k">if</span> <span class="n">view</span><span class="p">:</span>
            <span class="n">data_folder</span> <span class="o">=</span> <span class="n">data_folder</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
            <span class="n">root_level</span> <span class="o">=</span> <span class="n">data_folder</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">data_folder</span><span class="p">):</span>
                <span class="n">dir_level</span> <span class="o">=</span> <span class="n">dirpath</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;|-----&quot;</span><span class="o">*</span><span class="p">(</span><span class="n">dir_level</span> <span class="o">-</span> <span class="n">root_level</span><span class="p">),</span> <span class="n">end</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">dirpath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">end</span> <span class="o">=</span> <span class="s2">&quot;: &quot;</span><span class="p">)</span>
                <span class="n">t</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dirnames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">t</span><span class="o">+=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dirnames</span><span class="p">)</span><span class="si">}</span><span class="s2"> folders &quot;</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
                    <span class="n">t</span><span class="o">+=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span><span class="si">}</span><span class="s2"> files &quot;</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">create_datagen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">load_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aug_datagen</span> <span class="o">=</span> <span class="n">ImageDataGenerator</span><span class="p">(</span><span class="o">**</span><span class="n">load_cfg</span><span class="o">.</span><span class="n">aug_generator</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nonaug_datagen</span> <span class="o">=</span> <span class="n">ImageDataGenerator</span><span class="p">(</span><span class="o">**</span><span class="n">load_cfg</span><span class="o">.</span><span class="n">non_aug_generator</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loads and Preprocess data &quot;&quot;&quot;</span>
        <span class="n">load_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aug_datagen</span> <span class="k">if</span> <span class="n">load_cfg</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">aug_train</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonaug_datagen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aug_datagen</span> <span class="k">if</span> <span class="n">load_cfg</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">aug_test</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonaug_datagen</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;train: &quot;</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_gen</span><span class="o">.</span><span class="n">flow_from_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_folder</span><span class="p">,</span><span class="o">**</span><span class="n">load_cfg</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;test: &quot;</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_gen</span><span class="o">.</span><span class="n">flow_from_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_folder</span><span class="p">,</span><span class="o">**</span><span class="n">load_cfg</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_indices</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_data</span><span class="o">.</span><span class="n">class_indices</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    
    <span class="k">def</span> <span class="nf">load_pred_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred_dir</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pred_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dirs</span><span class="o">.</span><span class="n">pred_subfolder</span> <span class="k">if</span> <span class="n">pred_dir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pred_dir</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pred_dir</span><span class="p">):</span>
            <span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">pred_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;.&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">pred_dir</span><span class="p">):</span>
            <span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">pred_dir</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pred_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_dir</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No pred_dir !&#39;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="n">flow</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;class_mode&#39;</span><span class="p">}</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">])</span>
        <span class="n">pred_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonaug_datagen</span><span class="o">.</span><span class="n">flow_from_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_dir</span><span class="p">,</span>
                                                <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">y_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                                                <span class="n">class_mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">flow</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">pred_data</span>
    
    <span class="k">def</span> <span class="nf">load_image_from_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">url</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">load_img</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">read</span><span class="p">()),</span> <span class="n">target_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">target_size</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">img_to_array</span><span class="p">(</span><span class="n">img</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">preview_image_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span> <span class="o">=</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">n_aug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_gen</span> <span class="k">if</span> <span class="n">dataset</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_gen</span>
        <span class="n">fol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_folder</span> <span class="k">if</span> <span class="n">dataset</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_folder</span>
        <span class="n">class_name</span> <span class="o">=</span> <span class="n">choice</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span>  <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">fol</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_list</span><span class="p">])</span>
        <span class="n">ran_img</span> <span class="o">=</span> <span class="n">choice</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fol</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)))</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;filename&quot;</span><span class="p">:</span><span class="n">ran_img</span><span class="p">,</span><span class="s2">&quot;class&quot;</span><span class="p">:</span><span class="n">class_name</span><span class="p">},</span> <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">flow</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;class_mode&#39;</span><span class="p">}</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="n">flow_from_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fol</span><span class="p">,</span> <span class="n">class_name</span><span class="p">),</span> <span class="o">**</span><span class="n">flow</span><span class="p">)</span>
        <span class="n">imgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">next</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_aug</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imgs</span><span class="p">,</span> <span class="n">subtitles</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">(</span><span class="n">num</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="o">//</span><span class="mi">4</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="mi">4</span> <span class="k">if</span> <span class="p">(</span><span class="n">rows</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
        <span class="c1"># plt.figure(figsize=(4*rows, 4*cols))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">imgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">subtitles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">subtitles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                
    <span class="k">def</span> <span class="nf">load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">num_class</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">filepath</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;https://tfhub.dev&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_from_pretrain</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">num_class</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span> <span class="o">+</span> <span class="s1">&#39;/class_indices.pkl&#39;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_pi</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">class_indices</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_pi</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;history.pkl&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span> <span class="o">+</span> <span class="s1">&#39;/history.pkl&#39;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_pi</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_pi</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loaded a model in: &quot;</span> <span class="o">+</span> <span class="n">filepath</span><span class="p">)</span>
                
    <span class="k">def</span> <span class="nf">build_from_pretrain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_url</span><span class="p">,</span> <span class="n">num_class</span><span class="p">):</span>
        <span class="c1"># Download the pretrained model and save it as a Keras layer</span>
        <span class="n">feature_extractor</span> <span class="o">=</span> <span class="n">hub</span><span class="o">.</span><span class="n">KerasLayer</span><span class="p">(</span><span class="n">model_url</span><span class="p">,</span>
                                               <span class="n">trainable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1"># freeze the underlying patterns</span>
                                               <span class="n">name</span><span class="o">=</span><span class="s1">&#39;feature_extraction&#39;</span><span class="p">,</span>
                                               <span class="n">input_shape</span><span class="o">=</span><span class="n">IMAGE_SHAPE</span><span class="o">+</span><span class="p">(</span><span class="mi">3</span><span class="p">,))</span> <span class="c1"># define the input image shape</span>
        <span class="c1"># Create our own model</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
            <span class="n">feature_extractor</span><span class="p">,</span> <span class="c1"># use the feature extraction layer as the base</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;output_layer&#39;</span><span class="p">)</span> <span class="c1"># create our own output layer      </span>
        <span class="p">])</span>
        <span class="k">return</span> <span class="n">model</span>
        

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="s1">&#39;relu&#39;</span><span class="p">,</span><span class="n">input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">224</span><span class="p">,</span><span class="mi">224</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="s1">&#39;relu&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPool2D</span><span class="p">(</span><span class="n">pool_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="s1">&#39;relu&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="s1">&#39;relu&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPool2D</span><span class="p">(</span><span class="n">pool_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Flatten</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;softmax&#39;</span><span class="p">))</span>

    
    <span class="k">def</span> <span class="nf">get_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># To prevent over fitting we will stop the learning after 4 epochs and val_loss value not decreased</span>
        <span class="n">earlystop</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">patience</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        
        <span class="c1"># reduce the learning rate when then accuracy not increase for 2 steps</span>
        <span class="n">learning_rate_reduction</span> <span class="o">=</span> <span class="n">ReduceLROnPlateau</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_accuracy&#39;</span><span class="p">,</span> 
                                            <span class="n">patience</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
                                            <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                                            <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
                                            <span class="n">min_lr</span><span class="o">=</span><span class="mf">0.00001</span><span class="p">)</span>
        <span class="c1"># process bar</span>
        <span class="n">tqdm_probar</span> <span class="o">=</span> <span class="n">TqdmCallback</span><span class="p">()</span>
        
        <span class="c1"># save model checkpoint</span>
        <span class="c1"># modelcheck = ModelCheckpoint(filepath, monitor=&#39;val_accuracy&#39;,mode=&#39;max&#39;, save_best_only=True)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">tqdm_probar</span><span class="p">,</span> <span class="n">learning_rate_reduction</span><span class="p">,</span> <span class="n">earlystop</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epochs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">epochs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span> <span class="o">=</span> <span class="n">epochs</span>
        <span class="n">model_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_callbacks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="o">**</span><span class="n">model_cfg</span><span class="o">.</span><span class="n">compile</span><span class="p">)</span>
        <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_data</span><span class="p">,</span> <span class="n">steps_per_epoch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_len</span><span class="p">,</span>
                                <span class="n">validation_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_data</span><span class="p">,</span> <span class="n">validation_steps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_len</span><span class="p">,</span> 
                               <span class="n">callbacks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">,</span> <span class="n">epochs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">train_res</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;val_&quot;</span><span class="p">)]</span>
        <span class="n">valid_res</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;val_&quot;</span><span class="p">)]</span>
        <span class="n">epochs</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_res</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_res</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;training_&#39;</span><span class="o">+</span><span class="n">m</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;val_&quot;</span><span class="o">+</span><span class="n">m</span><span class="p">)</span> <span class="ow">in</span> <span class="n">valid_res</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;val_&quot;</span><span class="o">+</span><span class="n">m</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;val_&quot;</span><span class="o">+</span><span class="n">m</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Epochs&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epochs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">export</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">modelname</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">modelname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">modelname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">epochs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">export</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">modelname</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">plot_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">show_shapes</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
    

    <span class="k">def</span> <span class="nf">predict_from_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_image_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonaug_datagen</span><span class="o">.</span><span class="n">flow</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="n">steps</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
            <span class="n">pred_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_indices</span><span class="p">[</span><span class="n">pred</span><span class="p">]</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;prediction: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pred_label</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">gen</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="p">[</span><span class="n">title</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error to load url, try another !&#39;</span><span class="p">)</span>
    
    
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred_dir</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">max_visualization</span> <span class="o">=</span> <span class="mi">4</span><span class="p">):</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">pred_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_pred_data</span><span class="p">(</span><span class="n">pred_dir</span><span class="p">)</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">pred_data</span><span class="p">,</span> <span class="n">steps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_data</span><span class="p">))</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">preds</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prediction_label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_indices</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_visualization</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_visualization</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="o">//</span><span class="mi">4</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="n">rows</span><span class="p">))</span>
            <span class="n">df_sample</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">max_visualization</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df_sample</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()):</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span>
                <span class="n">category</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;prediction_label&#39;</span><span class="p">]</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">load_img</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pred_dir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">,</span> <span class="n">target_size</span><span class="o">=</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span><span class="mi">224</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;(prediction: </span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">category</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">graph</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">history</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">save_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save</span>
        <span class="n">timesr</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;_%Y_%m_</span><span class="si">%d</span><span class="s2">_%H_%M_%S&quot;</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_cfg</span><span class="o">.</span><span class="n">dirs</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="n">timesr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/class_indices.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_pi</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_indices</span><span class="p">,</span> <span class="n">file_pi</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">graph</span><span class="p">:</span>
            <span class="n">plot_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">to_file</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/model_architecture.png&#39;</span><span class="p">,</span> <span class="n">show_shapes</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">history</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/history.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_pi</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">,</span> <span class="n">file_pi</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model has saved in: &#39;</span> <span class="o">+</span> <span class="n">path</span><span class="p">)</span>
    

    
    <span class="k">def</span> <span class="nf">distributed_train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;train with multi-GPU and clusters&quot;&quot;&quot;</span>
        <span class="n">mirrored_strategy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">distribute</span><span class="o">.</span><span class="n">MirroredStrategy</span><span class="p">(</span><span class="n">devices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;/gpu:0&quot;</span><span class="p">,</span> <span class="s2">&quot;/gpu:1&quot;</span><span class="p">])</span>
        <span class="k">with</span> <span class="n">mirrored_strategy</span><span class="o">.</span><span class="n">scope</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>


        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TF_CONFIG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;cluster&quot;</span><span class="p">:{</span>
                    <span class="s2">&quot;worker&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;host1:port&quot;</span><span class="p">,</span> <span class="s2">&quot;host2:port&quot;</span><span class="p">,</span> <span class="s2">&quot;host3:port&quot;</span><span class="p">]</span>
                <span class="p">},</span>
                <span class="s2">&quot;task&quot;</span><span class="p">:{</span>
                     <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;worker&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="mi">1</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">multi_worker_mirrored_strategy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">distribute</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">MultiWorkerMirroredStrategy</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">multi_worker_mirrored_strategy</span><span class="o">.</span><span class="n">scope</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

        <span class="n">parameter_server_strategy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">distribute</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">ParameterServerStrategy</span><span class="p">()</span>

        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TF_CONFIG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;cluster&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;worker&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;host1:port&quot;</span><span class="p">,</span> <span class="s2">&quot;host2:port&quot;</span><span class="p">,</span> <span class="s2">&quot;host3:port&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;ps&quot;</span><span class="p">:</span>  <span class="p">[</span><span class="s2">&quot;host4:port&quot;</span><span class="p">,</span> <span class="s2">&quot;host5:port&quot;</span><span class="p">]</span>
                <span class="p">},</span>
                <span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;worker&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="mi">1</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="callbacks">
<h2><span class="section-number">3.1.10. </span>Callbacks<a class="headerlink" href="#callbacks" title="Permalink to this heading">#</a></h2>
<p>Callbacks giúp mở rộng hoặc bổ sung cách functions trung lúc hoặc sau khi train model. Một số functions callbacks:</p>
<section id="process-bar">
<h3><span class="section-number">3.1.10.1. </span>Process bar<a class="headerlink" href="#process-bar" title="Permalink to this heading">#</a></h3>
<p>Hiển thị process training theo level thay vì show all từng epoch</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqdm.keras</span> <span class="kn">import</span> <span class="n">TqdmCallback</span>

<span class="n">tqdm_probar</span> <span class="o">=</span> <span class="n">TqdmCallback</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="early-stop">
<h3><span class="section-number">3.1.10.2. </span>Early stop<a class="headerlink" href="#early-stop" title="Permalink to this heading">#</a></h3>
<p>Ngăn chặn việc overfitting bằng cách kết thúc sớm việc training nếu chỉ số tracking ko được cải thiện sau 1 số lượng nhất định các epochs</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tensorflow.keras.callbacks</span> <span class="kn">import</span> <span class="n">EarlyStopping</span>

<span class="n">earstop</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span>
    <span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span>      <span class="c1"># chỉ số tracking</span>
    <span class="n">min_delta</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>        <span class="c1"># giá trị tối thiểu cho phép thay đổi ngược </span>
                        <span class="c1"># ( ví dụ với accuracy là mức giảm tối thiểu cho phép, </span>
                        <span class="c1"># hoặc với MAE thì là mức tăng tối thiểu cho phép)</span>
    <span class="n">patience</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>         <span class="c1"># số epoch tối đa cho phép no improvement</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
    <span class="n">baseline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">restore_best_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1"># restore model về best weights</span>
    <span class="n">start_from_epoch</span><span class="o">=</span><span class="mi">100</span> <span class="c1"># number epochs chạy trước khi bắt đầu monitoring</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="decay-learning-rate">
<h3><span class="section-number">3.1.10.3. </span>Decay learning rate<a class="headerlink" href="#decay-learning-rate" title="Permalink to this heading">#</a></h3>
<p>Giảm hệ số learning-rate theo 1 số điều kiện nhất định trong lúc train hoặc theo số lần epochs đã train</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Learning rate giảm khi chỉ số accuracy ko tăng trong vòng 2 epochs</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.callbacks</span> <span class="kn">import</span> <span class="n">ReduceLROnPlateau</span>

<span class="n">learning_rate_reduction</span> <span class="o">=</span> <span class="n">ReduceLROnPlateau</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_accuracy&#39;</span><span class="p">,</span> 
                                    <span class="n">patience</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
                                    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                                    <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
                                    <span class="n">min_lr</span><span class="o">=</span><span class="mf">0.00001</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Learning rate giảm khi số epochs train tăng</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.callbacks</span> <span class="kn">import</span> <span class="n">LearningRateScheduler</span>

<span class="n">lr_scheduler</span> <span class="o">=</span> <span class="n">LearningRateScheduler</span><span class="p">(</span><span class="k">lambda</span> <span class="n">epoch</span><span class="p">:</span> <span class="mf">1e-4</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">epoch</span><span class="o">/</span><span class="mi">20</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="k">else</span> <span class="mf">1e-4</span><span class="p">)</span> 
</pre></div>
</div>
</div>
</div>
</section>
<section id="modelcheckpoint">
<h3><span class="section-number">3.1.10.4. </span>ModelCheckpoint<a class="headerlink" href="#modelcheckpoint" title="Permalink to this heading">#</a></h3>
<p>Save model (SavedModel) hoặc only weights trong lúc train để có thể:</p>
<ul class="simple">
<li><p>break việc training nhiều lần ko liên tục trong TH training for long time and need to backup những gì đã học được và có thể reload cho lần học tiếp theo</p></li>
<li><p>save lại model có performance is the best</p></li>
<li><p>update parameters/date to enhance model</p></li>
</ul>
<blockquote>
<div><p>Sử dụng <code class="docutils literal notranslate"><span class="pre">save_weights_only</span> <span class="pre">=</span> <span class="pre">True</span></code> sẽ giúp faster cho việc save checkpoint, tiết kiệm disk space lưu trữ, đồng thời chỉ muốn share weights only cho người khác mà không muốn share chi tiết về model architecture và training configuration</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tensorflow.keras.callbacks</span> <span class="kn">import</span> <span class="n">ModelCheckpoint</span>

<span class="n">checkpoint_path</span> <span class="o">=</span> <span class="s2">&quot;models/checkpoint.ckpt&quot;</span>

<span class="n">checkpoint</span> <span class="o">=</span> <span class="n">ModelCheckpoint</span><span class="p">(</span>
    <span class="n">filepath</span> <span class="o">=</span> <span class="n">checkpoint_path</span><span class="p">,</span>                       <span class="c1"># địa chỉ save model</span>
    <span class="n">monitor</span><span class="o">=</span> <span class="s1">&#39;val_loss&#39;</span><span class="p">,</span>                              <span class="c1"># chỉ số muốn tracking trong lúc train model</span>
    <span class="n">verbose</span><span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">save_best_only</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>                           <span class="c1"># save the best monitor tracking only</span>
    <span class="n">save_weights_only</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># trong trường hợp save weights only, load lại weights cho model</span>
<span class="n">new_model</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="n">chechpoint_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<blockquote>
<div><p>Có thể khi evaluation 2 model (tạo ra weight checkoint và load weight checkpoint) trên cùng 1 tập test thì giá trị output xấp xỉ bằng nhau, check <code class="docutils literal notranslate"><span class="pre">np.isclose</span></code> sẽ bằng <code class="docutils literal notranslate"><span class="pre">True</span></code></p>
</div></blockquote>
</section>
<section id="log-tensorboard">
<h3><span class="section-number">3.1.10.5. </span>Log TensorBoard<a class="headerlink" href="#log-tensorboard" title="Permalink to this heading">#</a></h3>
<p>log lại performance của multiple models trong lúc train và sau đó view and compare these models in a visual way on TensorBoard (a dashboard for inspecting neural network parameters).</p>
<p>Helpful to compare the results of different models on your data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tensorflow.keras.callbacks</span> <span class="kn">import</span> <span class="n">TensorBoard</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="k">def</span> <span class="nf">create_tensorboard_callback</span><span class="p">(</span><span class="n">dir_name</span><span class="p">,</span> <span class="n">experiment_name</span><span class="p">):</span>
    <span class="n">log_dir</span> <span class="o">=</span> <span class="n">dir_name</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">experiment_name</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">-%H%M%S&quot;</span><span class="p">)</span>
    <span class="n">board</span> <span class="o">=</span> <span class="n">TensorBoard</span><span class="p">(</span>
                    <span class="n">log_dir</span><span class="o">=</span><span class="n">log_dir</span><span class="p">,</span>
                    <span class="n">histogram_freq</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">write_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">write_images</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">write_steps_per_second</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">update_freq</span><span class="o">=</span><span class="s1">&#39;epoch&#39;</span><span class="p">,</span>
                    <span class="n">profile_batch</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">embeddings_freq</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">embeddings_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving TensorBoard log files to: </span><span class="si">{</span><span class="n">log_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">board</span><span class="p">,</span> <span class="n">logdir</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="evaluation">
<h2><span class="section-number">3.1.11. </span>Evaluation<a class="headerlink" href="#evaluation" title="Permalink to this heading">#</a></h2>
</section>
<section id="tracking-the-experiments">
<h2><span class="section-number">3.1.12. </span>Tracking the experiments<a class="headerlink" href="#tracking-the-experiments" title="Permalink to this heading">#</a></h2>
<p>log lại performance của multiple models trong lúc train và sau đó view and compare these models in a visual way on TensorBoard (a dashboard for inspecting neural network parameters).</p>
<p>Helpful to compare the results of different models on your data.</p>
<section id="setup-tensorboard-callback">
<h3><span class="section-number">3.1.12.1. </span>Setup tensorboard callback<a class="headerlink" href="#setup-tensorboard-callback" title="Permalink to this heading">#</a></h3>
<p>(check mục callbacks)</p>
</section>
<section id="view-real-time-tu-notebook">
<h3><span class="section-number">3.1.12.2. </span>View real-time từ notebook<a class="headerlink" href="#view-real-time-tu-notebook" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># run code before model.fit</span>
<span class="c1"># load extension tensorboard</span>
<span class="o">%</span><span class="k">load_ext</span> tensorboard
<span class="o">%</span><span class="k">tensorboard</span> --logdir={logdir}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># example</span>
<span class="n">tsb</span><span class="p">,</span> <span class="n">logdir</span> <span class="o">=</span> <span class="n">create_tensorboard_callback</span><span class="p">(</span><span class="n">logdir</span><span class="p">)</span>

<span class="c1"># load extension tensorboard, refresh để load real-time</span>
<span class="o">%</span><span class="k">load_ext</span> tensorboard
<span class="o">%</span><span class="k">tensorboard</span> --logdir={logdir}

<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">epoch</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">tsb</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="see-experiments-on-local">
<h3><span class="section-number">3.1.12.3. </span>See experiments on local<a class="headerlink" href="#see-experiments-on-local" title="Permalink to this heading">#</a></h3>
<p>use command <code class="docutils literal notranslate"><span class="pre">!tensorboard</span> <span class="pre">--logdir</span> <span class="pre">[dir_to_logs]</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>tensorboard<span class="w"> </span>--logdir<span class="w"> </span><span class="s2">&quot;models/tensorflow_hub/&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>E0502 16:03:38.114454 8762030720 application.py:125] Failed to load plugin WhatIfToolPluginLoader.load; ignoring it.
Traceback (most recent call last):
  File &quot;/Users/datkhong/miniconda3/lib/python3.10/site-packages/tensorboard/backend/application.py&quot;, line 123, in TensorBoardWSGIApp
    plugin = loader.load(context)
  File &quot;/Users/datkhong/miniconda3/lib/python3.10/site-packages/tensorboard_plugin_wit/wit_plugin_loader.py&quot;, line 57, in load
    from tensorboard_plugin_wit.wit_plugin import WhatIfToolPlugin
  File &quot;/Users/datkhong/miniconda3/lib/python3.10/site-packages/tensorboard_plugin_wit/wit_plugin.py&quot;, line 40, in &lt;module&gt;
    from tensorboard_plugin_wit._utils import common_utils
  File &quot;/Users/datkhong/miniconda3/lib/python3.10/site-packages/tensorboard_plugin_wit/_utils/common_utils.py&quot;, line 17, in &lt;module&gt;
    from tensorboard_plugin_wit._vendor.tensorflow_serving.apis import classification_pb2
  File &quot;/Users/datkhong/miniconda3/lib/python3.10/site-packages/tensorboard_plugin_wit/_vendor/tensorflow_serving/apis/classification_pb2.py&quot;, line 15, in &lt;module&gt;
    from tensorboard_plugin_wit._vendor.tensorflow_serving.apis import input_pb2 as tensorflow__serving_dot_apis_dot_input__pb2
  File &quot;/Users/datkhong/miniconda3/lib/python3.10/site-packages/tensorboard_plugin_wit/_vendor/tensorflow_serving/apis/input_pb2.py&quot;, line 37, in &lt;module&gt;
    _descriptor.FieldDescriptor(
  File &quot;/Users/datkhong/miniconda3/lib/python3.10/site-packages/google/protobuf/descriptor.py&quot;, line 561, in __new__
    _message.Message._CheckCalledFromGeneratedFile()
TypeError: Descriptors cannot not be created directly.
If this call came from a _pb2.py file, your generated code is out of date and must be regenerated with protoc &gt;= 3.19.0.
If you cannot immediately regenerate your protos, some other possible workarounds are:
 1. Downgrade the protobuf package to 3.20.x or lower.
 2. Set PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION=python (but this will use pure-Python parsing and will be much slower).

More information: https://developers.google.com/protocol-buffers/docs/news/2022-05-06#python-updates
Serving TensorBoard on localhost; to expose to the network, use a proxy or pass --bind_all
TensorBoard 2.12.2 at http://localhost:6006/ (Press CTRL+C to quit)
^C
</pre></div>
</div>
</div>
</div>
</section>
<section id="uploading-experiments-to-tensorboard">
<h3><span class="section-number">3.1.12.4. </span>Uploading experiments to TensorBoard<a class="headerlink" href="#uploading-experiments-to-tensorboard" title="Permalink to this heading">#</a></h3>
<p>Uploading your results to TensorBoard.dev enables you to track and share multiple different modelling experiments. So if you needed to show someone your results, you could send them a link to your TensorBoard.dev as well as the accompanying Colab notebook.</p>
<blockquote>
<div><p><strong>Note</strong>: These experiments are public, do not upload sensitive data. You can delete experiments if needed</p>
</div></blockquote>
<p>Câu lệnh command</p>
<p><code class="docutils literal notranslate"><span class="pre">tensorboard</span> <span class="pre">dev</span> <span class="pre">upload</span> <span class="pre">--logdir</span></code></p>
<p>Ví dụ:</p>
<div class="highlight-cmd notranslate"><div class="highlight"><pre><span></span>tensorboard dev upload \
  --logdir models/tensorflow_hub/ \
  --name &quot;EfficientNetB0 vs. ResNet50V2&quot; \ 
  --description &quot;Comparing two different TF Hub feature extraction models architectures using 10% of training images&quot; \ 
  --one_shot
</pre></div>
</div>
<p>trong đó:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--logdir</span></code> is the target upload directory</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--name</span></code> is the name of the experiment</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--description</span></code> is a brief description of the experiment</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--one_shot</span></code> exits the TensorBoard uploader once uploading is finished</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>!tensorboard dev upload --logdir &quot;models/tensorflow_hub/&quot; \
--name &quot;EfficientNetB6 vs. ResNet50V2&quot; \
--description &quot;Comparing two different TF Hub feature extraction models architectures using 10% of training images&quot; \
--one_shot
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>New experiment created. View your TensorBoard at: https://tensorboard.dev/experiment/rP5xaYkRSAueefLXhNKZ6g/

<span class=" -Color -Color-Bold">[2023-05-02T16:08:21]</span> Started scanning logdir.
W0502 16:08:21.793509 8762030720 uploader.py:1092] Blob too large; skipping.  Size 11345235 exceeds limit of 10485760 bytes.
<span class=" -Color -Color-Bold">[2023-05-02T16:08:31]</span> Total uploaded: 60 scalars, 0 tensors, 1 binary objects (5.1 MB)
Total skipped: 1 binary objects (10.8 MB)
<span class=" -Color -Color-Bold">[2023-05-02T16:08:31]</span> Done scanning logdir.


Done. View your TensorBoard at https://tensorboard.dev/experiment/rP5xaYkRSAueefLXhNKZ6g/
</pre></div>
</div>
</div>
</div>
</section>
<section id="check-list-uploaded">
<h3><span class="section-number">3.1.12.5. </span>Check list uploaded<a class="headerlink" href="#check-list-uploaded" title="Permalink to this heading">#</a></h3>
<p>Check những experiments đã upload thông qua command <code class="docutils literal notranslate"><span class="pre">tensorboard</span> <span class="pre">dev</span> <span class="pre">list</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>tensorboard<span class="w"> </span>dev<span class="w"> </span>list
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>https://tensorboard.dev/experiment/rP5xaYkRSAueefLXhNKZ6g/
	Name                 EfficientNetB6 vs. ResNet50V2
	Description          Comparing two different TF Hub feature extraction models architectures using 10% of training images
	Id                   rP5xaYkRSAueefLXhNKZ6g
	Created              2023-05-02 16:08:21 (24 seconds ago)
	Updated              2023-05-02 16:08:31 (14 seconds ago)
	Runs                 4
	Tags                 5
	Scalars              60
	Tensor bytes         0
	Binary object bytes  5324546
Total: 1 experiment(s)
</pre></div>
</div>
</div>
</div>
</section>
<section id="deleting-experiments-from-tensorboard">
<h3><span class="section-number">3.1.12.6. </span>Deleting experiments from TensorBoard<a class="headerlink" href="#deleting-experiments-from-tensorboard" title="Permalink to this heading">#</a></h3>
<p>Vì các experiments upload to tensorBoard là publish nên xoá theo command</p>
<p><code class="docutils literal notranslate"><span class="pre">tensorboard</span> <span class="pre">dev</span> <span class="pre">delete</span> <span class="pre">--experiment_id</span> <span class="pre">[INSERT_EXPERIMENT_ID]</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>tensorboard<span class="w"> </span>dev<span class="w"> </span>delete<span class="w"> </span>--experiment_id<span class="w"> </span>BoSDZk5yTMOvXxrXWZoFpg
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Deleted experiment BoSDZk5yTMOvXxrXWZoFpg.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>tensorboard<span class="w"> </span>dev<span class="w"> </span>list
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>https://tensorboard.dev/experiment/rP5xaYkRSAueefLXhNKZ6g/
	Name                 EfficientNetB6 vs. ResNet50V2
	Description          Comparing two different TF Hub feature extraction models architectures using 10% of training images
	Id                   rP5xaYkRSAueefLXhNKZ6g
	Created              2023-05-02 16:08:21 (33 seconds ago)
	Updated              2023-05-02 16:08:31 (23 seconds ago)
	Runs                 4
	Tags                 5
	Scalars              60
	Tensor bytes         0
	Binary object bytes  5324546
Total: 1 experiment(s)
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="prediction">
<h2><span class="section-number">3.1.13. </span>Prediction<a class="headerlink" href="#prediction" title="Permalink to this heading">#</a></h2>
</section>
<section id="save-load-model">
<h2><span class="section-number">3.1.14. </span>Save/load model<a class="headerlink" href="#save-load-model" title="Permalink to this heading">#</a></h2>
</section>
<section id="transfer-learning">
<h2><span class="section-number">3.1.15. </span>Transfer learning<a class="headerlink" href="#transfer-learning" title="Permalink to this heading">#</a></h2>
<p>Phương pháp được xây dựng dựa trên ý tưởng chuyển giao tri thức đã được học từ những mô hình tốt trước đó, đã được pre-train từ trước. Một mô hình đã có khả năng tận dụng lại các tri thức đã huấn luyện trước đó và cải thiện lại trên tác vụ phân loại của nó</p>
<p>Có nhiều các pretrained-model có chất lượng tốt và độ chính xác cao, giúp tiết kiệm chi phí huấn luyện. Hầu như mọi domain đều có thể tìm kiếm được các pretrained-model.</p>
<ul class="simple">
<li><p>Có điểm khởi đầu của accuracy tốt hơn (higher start).</p></li>
<li><p>Accuracy có tốc độ tăng nhanh hơn (higher slope).</p></li>
<li><p>Đường tiệm cận của độ chính xác tối ưu cao hơn (higher asymptote).</p></li>
</ul>
<p><img alt="" src="https://phamdinhkhanh.github.io/assets/images/20200415_TransferLearning/pic1.jpg" /></p>
<p><strong>1. Nguyên nhân mô hình dự báo kém</strong></p>
<ul class="simple">
<li><p><strong>Dữ liệu nhỏ không đại diện</strong>: Bộ dữ liệu của chúng ta có kích thước quá bé. Do đó mô hình được huấn luyện không học được các đặc trưng tổng quát để áp dụng vào các tác vụ phân loại. Ví dụ: Cùng là bài toán phân loại chó và mèo nhưng dữ liệu của bạn chỉ có 100 ảnh chó và ảnh mèo của Việt Nam. Số lượng này còn ít hơn số lượng các loài chó và mèo trên thế giới. Nếu áp dụng mô hình được huấn luyện trên bộ dữ liệu nhỏ sẽ dẫn tới khả năng dự báo sai trên những dữ liệu mới cao hơn.</p></li>
<li><p><strong>Mô hình mất cân bằng dữ liệu</strong>: Khi mô hình mất cân bằng dữ liệu thì việc dự đoán các mẫu thuộc nhóm thiểu số khó khăn hơn.</p></li>
<li><p><strong>Kiến trúc mô hình quá phức tạp</strong>: Đối với những bộ dữ liệu lớn lên tới vài triệu ảnh thì mô hình có kiến trúc phức tạp có thể mang lại độ chính xác cao. Nhưng với những bộ dữ liệu kích thước nhỏ thì mô hình phức tạp lại giảm độ chính xác. Mình cho rằng nguyên nhân chính là bởi các mô hình phức tạp thường xảy ra overfitting.</p></li>
<li><p><strong>Quá trình tối ưu hóa gặp khó khăn</strong>: Có thể bạn đã thiết lập learning rate chưa tốt nên khiến mô hình huấn luyện lâu hội tụ hoặc chưa đạt tới điểm global optimal. Khi đó bạn có thể cân nhắc thay đổi phương pháp cập nhật gradient descent và thiết lập schedule learning rate. Trên <code class="docutils literal notranslate"><span class="pre">tensorflow.keras</span></code> chúng ta có thể thiết lập schedule learning thông qua <code class="docutils literal notranslate"><span class="pre">CheckPoint</span></code> như sau:</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>

<span class="k">def</span> <span class="nf">scheduler</span><span class="p">(</span><span class="n">epoch</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">epoch</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.001</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.001</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">-</span> <span class="n">epoch</span><span class="p">))</span>

<span class="n">callback</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">LearningRateScheduler</span><span class="p">(</span><span class="n">scheduler</span><span class="p">)</span>
<span class="n">your_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">callback</span><span class="p">],</span>
          <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">val_data</span><span class="p">,</span> <span class="n">val_labels</span><span class="p">))</span>
</pre></div>
</div>
<p><strong>2. Hiệu quả với dữ liệu nhỏ</strong></p>
<p>Trong trường hợp bộ dữ liệu có kích thước quá nhỏ và khó có thể tìm kiếm và mở rộng thêm thì các mô hình được huấn luyện từ chúng sẽ khó có thể dự báo tốt. Tận dụng lại tri thức từ các pretrained-model với cùng tác vụ phân loại sẽ giúp các mô hình được huấn luyện dự báo tốt hơn với dữ liệu mới vì mô hình được học trên cả 2 nguồn tri thức đó là dữ liệu huấn luyện và dữ liệu mà nó đã được học trước đó.</p>
<p><strong>3. Kiến trúc mạng transfer learning</strong></p>
<p><a class="reference external" href="https://phamdinhkhanh.github.io/2020/04/15/TransferLearning.html#22-ki%E1%BA%BFn-tr%C3%BAc-m%C3%B4-h%C3%ACnh-s%E1%BB%AD-d%E1%BB%A5ng-transfer-learning">Chi tiết</a></p>
<p><strong>4. Kinh nghiệm với TL</strong></p>
<ul class="simple">
<li><p><strong>4.1. Transfer learning theo kích thước dữ liệu</strong>: Các đặc trưng học được trên ít dữ liệu sẽ có tác dụng phân loại kém hơn so với các đặc trưng được trên bộ dữ liệu kích thước lớn. Do đó:</p>
<ul>
<li><p><em><strong>Đối với dữ liệu nhỏ</strong></em>: Train lại toàn bộ các layers sẽ làm mất đi các đặc trưng đã được học từ model pretrained và dẫn tới mô hình dự báo sẽ không chính xác. Chúng ta chỉ nên train lại các fully connected layers cuối.</p></li>
<li><p><em><strong>Đối với dữ liệu lớn và giống domain</strong></em>: Có thể train lại model trên toàn bộ layers. Nhưng để quá trình huấn luyện nhanh hơn thì chúng ta sẽ thực hiện bước khởi động (warm up) và sau đó mới fine tuning lại mô hình.</p></li>
<li><p><em><strong>Đối với dữ liệu lớn và khác domain</strong></em>: Chúng ta nên huấn luyện lại model từ đầu vì pretrain-model không tạo ra được các đặc trưng tốt cho dữ liệu khác domain.
<img alt="" src="https://phamdinhkhanh.github.io/assets/images/20200415_TransferLearning/pic5.jpg" /></p></li>
</ul>
</li>
<li><p><strong>4.2. Khi nào thực hiện transfer learning</strong>:</p>
<ul>
<li><p>Chỉ nên transfer learning giữa 2 mô hình có cùng domain. pretrained-model A và mô hình cần huấn luyện B không có chung domain về dữ liệu thì các đặc trưng học được từ bộ feature extractor của A sẽ không thực sự hữu ích trong việc phân loại của mô hình B. Cụ thể hơn. Nếu bạn muốn xây dựng một ứng dụng âm thanh đánh thức trợ lý ảo của google bằng tiếng Việt khi nói từ :”dậy đi google”. Bạn đã có sẵn pretrained-model A đối với tác vụ speech to text nhưng huấn luyện trên Tiếng Anh. Như vậy bạn không nên thực hiện transfer learning trong trường hợp này. Như trong ví dụ của mình thì pretrained-model của imagenet đã bao gồm 2 classes dog and cat.</p></li>
<li><p>Dữ liệu huấn luyện pretrained-model A phải lớn hơn so với mô hình B. Nếu chúng ta transfer hệ số từ một pretrained-model được huấn luyện trên dữ liệu có kích thước nhỏ thì các đặc trưng học được từ mô hình A sẽ không tổng quát để giúp ích phân loại dữ liệu mô hình B.</p></li>
<li><p>Pretrained-model A phải là mô hình có phẩm chất tốt. Đây là một yêu cầu hiển nhiên vì mô hình tốt mới tạo ra được những đặc trưng tốt.</p></li>
</ul>
</li>
</ul>
<section id="phan-loai-cac-pretrain-model">
<h3><span class="section-number">3.1.15.1. </span>Phân loại các pretrain model<a class="headerlink" href="#phan-loai-cac-pretrain-model" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>“As is”</strong> transfer learning khi muốn sử dụng toàn bộ kiến trúc model apply vào task mà ko cần thay đổi bất cứ cái gì. Trong <a class="reference external" href="https://tfhub.dev"><strong>TensorFlow Hub</strong></a> thì loại model này tương đương với title là <strong>Classification</strong>.</p>
<ul>
<li><p><strong>Phù hợp</strong> khi dữ liệu và predict image trùng khớp hoặc tương tự với data của pretrain model</p></li>
<li><p><strong>Không phù hợp</strong> khi model cần sử dụng chỉ classify 1 số lượng class nhỏ hơn nhiều so với số lượng class đã train trong pretrain model (ví dụ: trong pretrain model có 1000 class, tức output trả ra 1000 probabilities, tuy nhiên trong dữ liệu dự đoán chỉ cần phân loại 10 class)</p></li>
</ul>
</li>
<li><p><strong>Feature extraction</strong> transfer learning là model cho phép tận dụng lại các patterns (weights) của pretrain model và thay đổi cấu trúc <strong>Output layer</strong> sao cho phù hợp với bài toán. Chỉ có 1 số top layers (gần output layer) được train, phần còn lại sẽ bị đóng băng.</p>
<ul>
<li><p>Loại model này phù hợp với các bài toán có data tương tự/similar với data của pretrain model và data size nhỏ</p></li>
</ul>
</li>
<li><p><strong>Fine-tunning</strong> transfer learning là model tận dụng lại kiến trúc mạng của pretrain model, sử dụng weights của pretrain làm initial weights và train lại one/some/all các layers để phù hợp với bài toán.</p>
<ul>
<li><p>Phù hợp với TH data có sự khác biệt 1 chút với data của pretrain model và có data size lớn.</p></li>
</ul>
</li>
</ul>
<p><img alt="" src="https://raw.githubusercontent.com/mrdbourke/tensorflow-deep-learning/main/images/04-different-kinds-of-transfer-learning.png" /></p>
</section>
<section id="workflow">
<h3><span class="section-number">3.1.15.2. </span>Workflow<a class="headerlink" href="#workflow" title="Permalink to this heading">#</a></h3>
<p><strong>B1:</strong> Sử dụng feature extraction model với việc freeze all layers (warn up) của pretrain model, add output layer cho phù hợp với bài toán và thực hiện train với 2-3 epochs (subdata 1% hoặc 10% hoặc 20% trên tổng all train data) để hình thành pattern đầu tiên cho lớp output.</p>
<blockquote>
<div><p><strong>Note</strong>: Các layer càng gần <strong>input layer</strong> sẽ có chức năng nhận diện các chi tiết dễ nhận biết và có hình dạng lớn (chân tay, đầu,…), càng layers sau càng có chức năng nhận diện các chi tiết/đặc điểm phức tạp và có hình dạng nhỏ, đặc trưng của class (răng, mắt,…). Vì vậy, train các top layers và freeze các bottom layers sẽ giúp vừa giữ được các khả năng nhận diện đặc điểm chung dễ phân loại, vừa cải thiện nhận diện các đặc điểm riêng của bài toán cần phân loại.</p>
</div></blockquote>
<p><strong>B2:</strong> Scale up model cho đến khi fine-tune model đạt được hiệu quả với dữ liệu để beat được baseline model. Các tham số cần scale up bao gồm:</p>
<ul class="simple">
<li><p>Sử dụng model fine-tune bằng cách unfreeze các top layers dần dần hoặc theo ngưỡng. Nếu số lượng class lớn thì tỷ lệ unfreeze các layer của pretrain model càng nhiều.Ví dụ: nếu number of class &gt; 100 thì có thể unfreeze toàn bộ layer của EfficientNet (update weight cho toàn bộ layer)</p></li>
<li><p>Giảm learning-rate (thường là 10 lần so với lr của feature-extraction model)</p></li>
<li><p>Tăng kích thước bộ dữ liệu train lên 100% all-train</p></li>
<li><p>Tăng số lượng epochs</p></li>
</ul>
<blockquote>
<div><p>Mục đích chính của việc warm up model là để mô hình hội tụ nhanh hơn tới global optimal value. Sau khi mô hình đạt ngưỡng tối ưu trên các Fully Connected Layers, sẽ rất khó để chúng ta tăng được thêm độ chính xác hơn nữa. Lúc này chúng ta sẽ cần phá băng (unfrozen) các layers của base network và huấn luyện mô hình trên toàn bộ các layers từ pretrained- model. Quá trình này được gọi là fine tuning.</p>
</div></blockquote>
<blockquote>
<div><p>🔑 Tips: Có thể unfreeze dần dần các layer từ top –&gt; bottom, khi nào mạng có hiện tượng ko cải thiện được accuracy thì sẽ lại tiếp tục unfreeze (việc unfreeze dần dần giúp giữ lại các weights tại bottom layer có nhiệm vụ phân loại đặc điểm dễ dàng nhất, tận dụng những layers tốt của pretrain model và giúp việc training mau hội tụ)</p>
</div></blockquote>
</section>
<section id="tensorflow-hub">
<h3><span class="section-number">3.1.15.3. </span>TensorFlow Hub<a class="headerlink" href="#tensorflow-hub" title="Permalink to this heading">#</a></h3>
<p><a class="reference external" href="https://tfhub.dev"><strong>TensorFlow Hub</strong></a> là nguồn các pretrain model, sử dụng cho mục đích transfer learning. Các pretrain model trên hub đa dạng các versionn và phiên bản, phục vụ nhiều domain problem khác nhau.</p>
<p>Tuy nhiên, các model trên hub được import vào code dưới dạng single layer ( như 1 layer) nên ko thể sửa đổi bên trong, skip layer, hay trích xuất features từ mid-layer.</p>
<p><strong>Normalization</strong> được áp dụng trong pretrain model trên hub là dạng min-max, tức đưa về range [0,1]</p>
<p><strong>How to find the model in hub ?</strong></p>
<ol class="arabic simple">
<li><p>Đến <a class="reference external" href="https://tfhub.dev">tfhub.dev</a> và lựa chọn domain cho bài toán trong mục <strong>Domain problem</strong>. Ví dụ: “image” nếu bài toán liên quan đến ảnh.</p></li>
<li><p>Lựa chọn TF version TF2 + loại bỏ các “Problem domain” khác trừ problem liên quan đến bài toán</p></li>
</ol>
<blockquote>
<div><p>“Image feature vector” sử dụng cho hầu hết các bài toán hình ảnh</p>
</div></blockquote>
<ol class="arabic" start="3">
<li><p>Lựa chọn model phù hợp:</p>
<ul class="simple">
<li><p>Search SOTA model on <span class="xref myst">paperswithcode.com</span> (Bộ sưu tập the latest DL paper + code implementations)</p></li>
</ul>
<blockquote>
<div><p>Ví dụ nếu working with images, mục tiêu là models có perform best on ImageNet.</p>
</div></blockquote>
<ul class="simple">
<li><p>Lựa chọn các kiến trúc trên <strong>Architecture tab</strong>: Các version càng cao thì hiệu năng càng tốt nhưng đánh đổi lại là chi phí về tốc độ tính toán.</p></li>
</ul>
<blockquote>
<div><p>Ví dụ: <code class="docutils literal notranslate"><span class="pre">EfficientNetB4</span></code> performs better than <code class="docutils literal notranslate"><span class="pre">EfficientNetB0</span></code>.</p>
</div></blockquote>
</li>
<li><p>Copy link URL. Ví dụ: <a class="reference external" href="https://tfhub.dev/tensorflow/efficientnet/b0/feature-vector/1">https://tfhub.dev/tensorflow/efficientnet/b0/feature-vector/1</a></p></li>
</ol>
</section>
<section id="keras-applications">
<h3><span class="section-number">3.1.15.4. </span>Keras applications<a class="headerlink" href="#keras-applications" title="Permalink to this heading">#</a></h3>
<p>Keras applications cung cấp một vài các pretrain model phổ biến (thường là các model ImageNet) và số lượng ít hơn so với TF hub, khác với TF Hub thì sử dụng apps cho phép sửa đổi linh hoạt kiến trúc của pretrain model, trích xuất các features từ bất kỳ layers nào.</p>
<p>Hầu hết các model trên keras apps sử dụng cách normalize đưa về range [-1,1] thay vì [0,1] như TF hub</p>
<p><strong>Ví dụ sử dụng keras applications</strong></p>
<p>Module: <a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/keras/applications"><code class="docutils literal notranslate"><span class="pre">tf.keras.applications</span></code></a> chứa các pretrain architectures + pre-trained weights phổ biến thay vì download từ <strong>Tensorflow Hub</strong></p>
<p>Bài toán: Phân loại ảnh chó mèo</p>
<section id="dataset">
<h4><span class="section-number">3.1.15.4.1. </span>Dataset<a class="headerlink" href="#dataset" title="Permalink to this heading">#</a></h4>
<p>Dữ liệu được sử dụng để minh họa cho phương pháp transfer learning là bộ dữ liệu <strong>Sub Dog and Cat</strong> với khoảng 1400 ảnh.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">cd</span> Datasets
<span class="o">!</span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/ardamavi/Dog-Cat-Classifier.git
<span class="o">%</span><span class="k">cd</span> Dog-Cat-Classifier
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cloning into &#39;Dog-Cat-Classifier&#39;...
remote: Enumerating objects: 1654, done.
remote: Total 1654 (delta 0), reused 0 (delta 0), pack-reused 1654
Receiving objects: 100% (1654/1654), 34.83 MiB | 2.43 MiB/s, done.
Resolving deltas: 100% (147/147), done.
/Users/datkhong/Library/CloudStorage/GoogleDrive-k55.1613310017@ftu.edu.vn/My Drive/GitCode/My_learning/1. DA - DS/3. Learning/2_Notebooks/5_Deep_learning/Dog-Cat-Classifier
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pwd
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/datkhong/Library/CloudStorage/GoogleDrive-k55.1613310017@ftu.edu.vn/My Drive/GitCode/My_learning/1. DA - DS/3. Learning/2_Notebooks/5_Deep_learning/Datasets/Dog-Cat-Classifier
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># khảo sát data</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">glob2</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">dogs</span> <span class="o">=</span> <span class="n">glob2</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;Data/Train_Data/dog/*.jpg&#39;</span><span class="p">)</span>
<span class="n">dog_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dog&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">dogs</span><span class="p">)</span>
<span class="n">cats</span> <span class="o">=</span> <span class="n">glob2</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;Data/Train_Data/cat/*.jpg&#39;</span><span class="p">)</span>
<span class="n">cat_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cat&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">cats</span><span class="p">)</span>

<span class="n">labels</span> <span class="o">=</span> <span class="n">dog_labels</span> <span class="o">+</span> <span class="n">cat_labels</span>
<span class="n">image_links</span> <span class="o">=</span> <span class="n">dogs</span> <span class="o">+</span> <span class="n">cats</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="n">labels</span><span class="p">,</span> <span class="s1">&#39;image_links&#39;</span><span class="p">:</span><span class="n">image_links</span><span class="p">})</span>
<span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">image_links</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: &gt;
</pre></div>
</div>
<img alt="../../_images/2167be1dfc002deadc5bb2b89bcfaeea2ad9bfe9decd4cbd010177127e035f1a.png" src="../../_images/2167be1dfc002deadc5bb2b89bcfaeea2ad9bfe9decd4cbd010177127e035f1a.png" />
</div>
</div>
<p>Dữ liệu cân bằng giữa 2 label</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Phân chia tập train/validation</span>

<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="n">images_train</span><span class="p">,</span> <span class="n">images_val</span><span class="p">,</span> <span class="n">y_label_train</span><span class="p">,</span> <span class="n">y_label_val</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">image_links</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">stratify</span> <span class="o">=</span> <span class="n">labels</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;images_train len: </span><span class="si">{}</span><span class="s1">, image_test shape: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">images_train</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">images_val</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>images_train len: 1049, image_test shape: 350
</pre></div>
</div>
</div>
</div>
</section>
<section id="data-augumentation">
<h4><span class="section-number">3.1.15.4.2. </span>Data Augumentation<a class="headerlink" href="#data-augumentation" title="Permalink to this heading">#</a></h4>
<p><strong>Lưu ý</strong>: Khi khởi tạo Data Generator với các mô hình sử dụng pretrained model thì chúng ta sẽ phải thực hiện các bước biến đổi dữ liệu trong data pipeline đồng nhất với pipeline được áp dụng trên pretrained model. Khi đó các đặc trưng được tạo thành từ base network mới có tác dụng phân loại tốt.</p>
<p>Các phép biến đổi trên tập train và validation mình đã tham chiếu với biến đổi mà tác giả sử dụng khi thực hiện model pretrain với bộ dữ liệu imagenet từ trước.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.utils</span> <span class="kn">import</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">to_categorical</span>
<span class="kn">import</span> <span class="nn">cv2</span>

<span class="k">class</span> <span class="nc">DataGenerator</span><span class="p">(</span><span class="n">Sequence</span><span class="p">):</span>
    <span class="s1">&#39;Generates data for Keras&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">all_filenames</span><span class="p">,</span> 
                 <span class="n">labels</span><span class="p">,</span> 
                 <span class="n">batch_size</span><span class="p">,</span> 
                 <span class="n">index2class</span><span class="p">,</span>
                 <span class="n">input_dim</span><span class="p">,</span>
                 <span class="n">n_channels</span><span class="p">,</span>
                 <span class="n">n_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
                 <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">zoom_range</span><span class="o">=</span><span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                 <span class="n">rotation</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
                 <span class="n">brightness_range</span><span class="o">=</span><span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                 <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        all_filenames: list toàn bộ các filename</span>
<span class="sd">        labels: nhãn của toàn bộ các file</span>
<span class="sd">        batch_size: kích thước của 1 batch</span>
<span class="sd">        index2class: index của các class</span>
<span class="sd">        input_dim: (width, height) đầu vào của ảnh</span>
<span class="sd">        n_channels: số lượng channels của ảnh</span>
<span class="sd">        n_classes: số lượng các class </span>
<span class="sd">        normalize: có chuẩn hóa ảnh hay không?</span>
<span class="sd">        zoom_range: khoảng scale zoom là một khoảng nằm trong [0, 1].</span>
<span class="sd">        rotation: độ xoay ảnh.</span>
<span class="sd">        brightness_range: Khoảng biến thiên cường độ sáng</span>
<span class="sd">        shuffle: có shuffle dữ liệu sau mỗi epoch hay không?</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_filenames</span> <span class="o">=</span> <span class="n">all_filenames</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index2class</span> <span class="o">=</span> <span class="n">index2class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_dim</span> <span class="o">=</span> <span class="n">input_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">n_channels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_classes</span> <span class="o">=</span> <span class="n">n_classes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span> <span class="o">=</span> <span class="n">normalize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zoom_range</span> <span class="o">=</span> <span class="n">zoom_range</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotation</span> <span class="o">=</span> <span class="n">rotation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">brightness_range</span> <span class="o">=</span> <span class="n">brightness_range</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_epoch_end</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        return:</span>
<span class="sd">          Trả về số lượng batch/1 epoch</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_filenames</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        params:</span>
<span class="sd">          index: index của batch</span>
<span class="sd">        return:</span>
<span class="sd">          X, y cho batch thứ index</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Lấy ra indexes của batch thứ index</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="p">[</span><span class="n">index</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:(</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">]</span>

        <span class="c1"># List all_filenames trong một batch</span>
        <span class="n">all_filenames_temp</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">all_filenames</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">indexes</span><span class="p">]</span>

        <span class="c1"># Khởi tạo data</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data_generation</span><span class="p">(</span><span class="n">all_filenames_temp</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span>

    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Shuffle dữ liệu khi epochs end hoặc start.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_filenames</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__data_generation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">all_filenames_temp</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        params:</span>
<span class="sd">          all_filenames_temp: list các filenames trong 1 batch</span>
<span class="sd">        return:</span>
<span class="sd">          Trả về giá trị cho một batch.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_channels</span><span class="p">))</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Khởi tạo dữ liệu</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_filenames_temp</span><span class="p">):</span>
            <span class="c1"># Đọc file từ folder name</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dim</span><span class="p">)</span>
            <span class="n">img_reshape</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span><span class="p">:</span>
                <span class="c1"># Có thuẩn hóa mỗi một ảnh với theo phân phối chuẩn bằng cách trừ đi trung bình </span>
                <span class="c1"># và chia cho phương sai toàn bộ các pixels tương ứng ở mỗi kênh.</span>
                <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">img_reshape</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">img_reshape</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">img</span> <span class="o">=</span> <span class="p">(</span><span class="n">img</span><span class="o">-</span><span class="n">mean</span><span class="p">)</span><span class="o">/</span><span class="n">std</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zoom_range</span><span class="p">:</span>
                <span class="c1"># Là một khoảng giá trị phóng đại ảnh: [lower, upper]. </span>
                <span class="c1"># Giá trị phóng đại của một ảnh sẽ được sinh ngẫu nhiên nằm trong khoảng zoom_range. </span>
                <span class="c1"># Giá trị phóng đại này càng nhỏ thì ảnh sẽ càng được phóng to.</span>
                <span class="n">zoom_scale</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zoom_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">zoom_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="o">*</span><span class="n">zoom_scale</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="n">zoom_scale</span><span class="p">)),</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LINEAR</span><span class="p">)</span>
                <span class="p">(</span><span class="n">h_rz</span><span class="p">,</span> <span class="n">w_rz</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">start_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">w_rz</span><span class="o">-</span><span class="n">w</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">w_rz</span><span class="o">-</span><span class="n">w</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">start_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">h_rz</span><span class="o">-</span><span class="n">h</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">h_rz</span><span class="o">-</span><span class="n">h</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="c1"># print(start_w, start_h)</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">start_h</span><span class="p">:(</span><span class="n">start_h</span><span class="o">+</span><span class="n">h</span><span class="p">),</span> <span class="n">start_w</span><span class="p">:(</span><span class="n">start_w</span><span class="o">+</span><span class="n">w</span><span class="p">),</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation</span><span class="p">:</span>
                <span class="c1"># Góc xoay ngẫu nhiên của một bức ảnh. Thông thường chỉ thiết lập từ 10-20 độ.</span>
                <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation</span><span class="p">)</span>
                <span class="n">RotMat</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getRotationMatrix2D</span><span class="p">(</span><span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span> <span class="n">angle</span><span class="o">=</span><span class="n">angle</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">warpAffine</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">RotMat</span><span class="p">,</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">brightness_range</span><span class="p">:</span>
                <span class="c1"># Khoảng điều chỉnh độ sáng cho bức ảnh. Độ sáng sẽ là một giá trị ngẫu nhiên từ [minVal, maxVal].</span>
                <span class="n">scale_bright</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">brightness_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">brightness_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">*</span><span class="n">scale_bright</span>
            
            <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;dog&#39;</span> <span class="k">if</span> <span class="s1">&#39;dog&#39;</span> <span class="ow">in</span> <span class="n">fn</span> <span class="k">else</span> <span class="s1">&#39;cat&#39;</span>
            <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index2class</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
    
            <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,]</span> <span class="o">=</span> <span class="n">img</span>

            <span class="c1"># Lưu class</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span>
        <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span>

<span class="n">dict_labels</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;dog&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">&#39;cat&#39;</span><span class="p">:</span> <span class="mi">1</span>
<span class="p">}</span>

<span class="n">train_generator</span> <span class="o">=</span> <span class="n">DataGenerator</span><span class="p">(</span>
    <span class="n">all_filenames</span> <span class="o">=</span> <span class="n">images_train</span><span class="p">,</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">y_label_train</span><span class="p">,</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
    <span class="n">index2class</span> <span class="o">=</span> <span class="n">dict_labels</span><span class="p">,</span>
    <span class="n">input_dim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">),</span>
    <span class="n">n_channels</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">n_classes</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">normalize</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">zoom_range</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="n">rotation</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">brightness_range</span><span class="o">=</span><span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span>

<span class="n">val_generator</span> <span class="o">=</span> <span class="n">DataGenerator</span><span class="p">(</span>
    <span class="n">all_filenames</span> <span class="o">=</span> <span class="n">images_val</span><span class="p">,</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">y_label_val</span><span class="p">,</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
    <span class="n">index2class</span> <span class="o">=</span> <span class="n">dict_labels</span><span class="p">,</span>
    <span class="n">input_dim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">),</span>
    <span class="n">n_channels</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">n_classes</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">normalize</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">zoom_range</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="n">rotation</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">brightness_range</span> <span class="o">=</span><span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Kiểm tra dữ liệu Augumentation</strong></p>
<p>Chúng ta không nên tin hoàn toàn vào Augumentation mà cần khảo sát lại xem những step biến đổi trên pipeline đã thay đổi dữ liệu như thế nào? Những biến đổi đó có tạo ra các mẫu phù hợp với thực tế không? Đây là một qui trình cần thiết khi huấn luyện mô hình.</p>
<p>Để kiểm tra pipeline của ImageGenerator chúng ta có thể khởi tạo vòng lặp loop qua Generator:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">root</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;/Users/datkhong/Library/CloudStorage/GoogleDrive-k55.1613310017@ftu.edu.vn/My Drive/GitCode/My_learning/1. DA - DS/3. Learning/2_Notebooks/5_Deep_learning/&quot;</span>

<span class="n">check_aug</span><span class="o">=</span><span class="p">[</span><span class="n">root</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;Datasets/Dog-Cat-Classifier/Data/Train_Data/cat/cat.100.jpg&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">32</span>

<span class="n">check_generator</span> <span class="o">=</span> <span class="n">DataGenerator</span><span class="p">(</span>
    <span class="n">all_filenames</span> <span class="o">=</span> <span class="n">check_aug</span><span class="p">,</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">y_label_val</span><span class="p">,</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="n">index2class</span> <span class="o">=</span> <span class="n">dict_labels</span><span class="p">,</span>
    <span class="n">input_dim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">),</span>
    <span class="n">n_channels</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">n_classes</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">normalize</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">zoom_range</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="n">rotation</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
    <span class="n">brightness_range</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">],</span>
    <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span>

<span class="n">X_batch</span><span class="p">,</span> <span class="n">y_batch</span> <span class="o">=</span> <span class="n">check_generator</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">X_batch</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">y_batch</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(20, 224, 224, 3)
(20,)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Khởi tạo subplot với 4 dòng 5 cột.</span>
<span class="n">fg</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
<span class="n">fg</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Augumentation Images&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">X_batch</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span> <span class="o">+</span> <span class="n">j</span><span class="o">*</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="mf">255.0</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Image &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="o">+</span><span class="n">j</span><span class="o">*</span><span class="n">i</span><span class="p">))</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:matplotlib.image:Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
WARNING:matplotlib.image:Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
WARNING:matplotlib.image:Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
WARNING:matplotlib.image:Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
WARNING:matplotlib.image:Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
WARNING:matplotlib.image:Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
WARNING:matplotlib.image:Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
WARNING:matplotlib.image:Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
WARNING:matplotlib.image:Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
</pre></div>
</div>
<img alt="../../_images/04f8ae6ea503a97f8a694abb8654519382472526dfa4783d83a066cb455b9505.png" src="../../_images/04f8ae6ea503a97f8a694abb8654519382472526dfa4783d83a066cb455b9505.png" />
</div>
</div>
</section>
<section id="train-model">
<h4><span class="section-number">3.1.15.4.3. </span>Train model<a class="headerlink" href="#train-model" title="Permalink to this heading">#</a></h4>
<p>Tiếp theo chúng ta sẽ huấn luyện mô hình. Việc đầu tiên cần thực hiện là khởi tạo base network cho mô hình. Trên keras đã có hầu hết các model pretrain phổ biến trên bộ dữ liệu imagenet. Lý do tác giả lựa chọn bộ dữ liệu này để huấn luyện các pretrained-model là vì có tới 1000 classes khác nhau. Do đó hầu như mọi bài toán classification đều có nhãn xuất hiện trong imagenet và có thể tái sử dụng pretrained-model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">applications</span><span class="o">.</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">load_model</span><span class="p">,</span> <span class="n">Sequential</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">Flatten</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.applications</span> <span class="kn">import</span> <span class="n">MobileNet</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.optimizers</span> <span class="kn">import</span> <span class="n">Adam</span>


<span class="n">base_network</span> <span class="o">=</span> <span class="n">MobileNet</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">include_top</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="s1">&#39;imagenet&#39;</span><span class="p">)</span>
<span class="n">flat</span> <span class="o">=</span> <span class="n">Flatten</span><span class="p">()</span>
<span class="n">den</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">([</span><span class="n">base_network</span><span class="p">,</span> 
                    <span class="n">flat</span><span class="p">,</span>
                    <span class="n">den</span><span class="p">])</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(),</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;binary_crossentropy&#39;</span><span class="p">,</span> <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
<span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Metal device set to: Apple M1 Pro
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:absl:At this time, the v2.11+ optimizer `tf.keras.optimizers.Adam` runs slowly on M1/M2 Macs, please use the legacy Keras optimizer instead, located at `tf.keras.optimizers.legacy.Adam`.
WARNING:absl:There is a known slowdown when using v2.11+ Keras optimizers on M1/M2 Macs. Falling back to the legacy Keras optimizer, i.e., `tf.keras.optimizers.legacy.Adam`.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;sequential&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 mobilenet_1.00_224 (Functio  (None, 7, 7, 1024)       3228864   
 nal)                                                            
                                                                 
 flatten (Flatten)           (None, 50176)             0         
                                                                 
 dense (Dense)               (None, 1)                 50177     
                                                                 
=================================================================
Total params: 3,279,041
Trainable params: 3,257,153
Non-trainable params: 21,888
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<p>Để ý kĩ bạn sẽ thấy <strong>base network</strong> là một pretrain <strong>model Mobilenet</strong> đã được <code class="docutils literal notranslate"><span class="pre">truncate</span></code> top layer thông qua tham số <code class="docutils literal notranslate"><span class="pre">include_top=False</span></code>. Bài toán của chúng ta có số lượng nhãn khác với imagenet nên sẽ ta gán vào <strong>base network</strong> một mạng <strong>MLP</strong> gồm các <strong>Layers Fully Connected</strong> sao cho layer cuối có số <strong>units = số lượng output classes</strong>.</p>
</section>
<section id="warm-up">
<h4><span class="section-number">3.1.15.4.4. </span>Warm up<a class="headerlink" href="#warm-up" title="Permalink to this heading">#</a></h4>
<p>thực hiện quá trình warm up để huấn luyện mô hình nhanh hơn.</p>
<p>Warm up là quá trình cần thiết để mô hình hội tụ nhanh hơn. Warm up sẽ đóng băng lại các layers CNN để cho hệ số của chúng không đổi và chỉ train lại trên các Fully Conntected Layers ở cuối cùng. Mục đích của warm up là giữ nguyên được các đặc trưng bậc cao (high-level) đã được học từ pretrained-model mà những đặc trưng này là tốt vì được huấn luyện trên bộ dữ liệu có kích thước lớn hơn và có độ chính xác cao hơn sao với khởi tạo hệ số ngẫu nhiên. Như vậy Phrase 2 (xem hình 2) của mô hình sẽ không thay đổi input X và coi như chúng ta huấn luyện lại mạng MLP.</p>
<p><img alt="" src="https://phamdinhkhanh.github.io/assets/images/20200415_TransferLearning/pic3.jpg" />
<img alt="" src="https://phamdinhkhanh.github.io/assets/images/20200415_TransferLearning/pic4.jpg" /></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Frozen base_network</span>
<span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Layer: </span><span class="si">{}</span><span class="s1"> ; Trainable: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">trainable</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Layer: &lt;keras.engine.functional.Functional object at 0x2922431c0&gt; ; Trainable: False
Layer: &lt;keras.layers.reshaping.flatten.Flatten object at 0x128591330&gt; ; Trainable: True
Layer: &lt;keras.layers.core.dense.Dense object at 0x292242a10&gt; ; Trainable: True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Huấn luyện lại model trên 1 epoch</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>

<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_generator</span><span class="p">,</span>
          <span class="n">steps_per_epoch</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">train_generator</span><span class="p">),</span>
          <span class="n">validation_data</span><span class="o">=</span><span class="n">val_generator</span><span class="p">,</span>
          <span class="n">validation_steps</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
          <span class="n">epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>32/32 [==============================] - 6s 170ms/step - loss: 0.2725 - accuracy: 0.9277 - val_loss: 2.5612 - val_accuracy: 0.8000
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;keras.callbacks.History at 0x29e2bca90&gt;
</pre></div>
</div>
</div>
</div>
<p>Bạn sẽ thấy accuracy sẽ được cải thiện rất nhanh chỉ sau epoch đầu tiên. Tuy nhiên bài toán có hiện tượng overfitting khi val_accuracy thấp hơn nhiều so với train_accuracy. Để giảm thiểu overfitting chúng ta sẽ thực hiện một số hiệu chỉnh đối với mô hình như:</p>
<ul class="simple">
<li><p>Mạng nơ ron có khả năng xấp xỉ được hầu hết các hàm số. Khi kiến trúc mạng càng phức tạp và bộ dữ liệu huấn luyện có kích thước nhỏ thì khả năng học được chính xác trên từng điểm dữ liệu sẽ rất tốt. Nhưng việc học này sẽ không tốt trên dữ liệu mới. Chúng ta có thể sử dụng Dropout Layer để giảm thiểu độ phức tạp trong kiến trúc của mô hình. Dropout sẽ làm nhiệm vụ cắt tỉa bớt một số kết nối Fully Connected.</p></li>
<li><p>Để giảm thiểu mức độ phức tạp của hàm số chúng ta cũng có thể sử dụng các phương pháp hiệu chuẩn (regularization) bằng cách thêm vào loss function thành phần norm chuẩn Frobenius của ma trận hệ số các layers.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">regularizers</span>
<span class="n">your_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">input_dim</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
                <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">regularizers</span><span class="o">.</span><span class="n">l2</span><span class="p">(</span><span class="mf">0.01</span><span class="p">),</span>
                <span class="n">activity_regularizer</span><span class="o">=</span><span class="n">regularizers</span><span class="o">.</span><span class="n">l2</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<p>Một trong những nguyên nhân chủ yếu của overfitting đó là dữ liệu huấn luyện có kích thước quá bé và không tổng quát các trường hợp của ảnh. Trên thực tế bộ dữ liệu dog and cat gốc có kích thước là 25000 ảnh và lớn gấp hàng chục lần dữ liệu huấn luyện với khoảng 1000 ảnh ảnh. Tăng cường thêm dữ liệu huấn luyện cho tập train là một giải pháp có thể cân nhắc tới.</p>
<p>Fine tuning lại những layers của base network để cải thiện đặc trưng (sẽ được trình bày ở phần sau).</p>
</section>
<section id="fine-tuning-model">
<h4><span class="section-number">3.1.15.4.5. </span>Fine tuning model<a class="headerlink" href="#fine-tuning-model" title="Permalink to this heading">#</a></h4>
<p>Mục đích chính của việc warm up model là để mô hình hội tụ nhanh hơn tới global optimal value. Sau khi mô hình đạt ngưỡng tối ưu trên các Fully Connected Layers, sẽ rất khó để chúng ta tăng được thêm độ chính xác hơn nữa. Lúc này chúng ta sẽ cần phá băng (unfrozen) các layers của base network và huấn luyện mô hình trên toàn bộ các layers từ pretrained- model. Quá trình này được gọi là fine tuning.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Layer: </span><span class="si">{}</span><span class="s1"> ; Trainable: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">trainable</span><span class="p">))</span>

<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_generator</span><span class="p">,</span> <span class="n">validation_data</span> <span class="o">=</span> <span class="n">val_generator</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="n">epochs</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Layer: &lt;keras.engine.functional.Functional object at 0x2922431c0&gt; ; Trainable: True
Layer: &lt;keras.layers.reshaping.flatten.Flatten object at 0x128591330&gt; ; Trainable: True
Layer: &lt;keras.layers.core.dense.Dense object at 0x292242a10&gt; ; Trainable: True
Epoch 1/5
32/32 [==============================] - 6s 183ms/step - loss: 0.1417 - accuracy: 0.9600 - val_loss: 0.9506 - val_accuracy: 0.9196
Epoch 2/5
32/32 [==============================] - 6s 180ms/step - loss: 0.1339 - accuracy: 0.9648 - val_loss: 1.3298 - val_accuracy: 0.9018
Epoch 3/5
32/32 [==============================] - 6s 180ms/step - loss: 0.1287 - accuracy: 0.9492 - val_loss: 0.6633 - val_accuracy: 0.9256
Epoch 4/5
32/32 [==============================] - 6s 180ms/step - loss: 0.0750 - accuracy: 0.9727 - val_loss: 0.6217 - val_accuracy: 0.9137
Epoch 5/5
32/32 [==============================] - 6s 181ms/step - loss: 0.1726 - accuracy: 0.9658 - val_loss: 1.4123 - val_accuracy: 0.8929
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;keras.callbacks.History at 0x29e2d4df0&gt;
</pre></div>
</div>
</div>
</div>
<p>Chúng ta có thể nhận thấy rằng sau khi thực hiện fine tunning thì đồng thời accuracy trên tập train và tập validation đều tăng và đạt tới ngưỡng &gt;= 80%.</p>
<p>Như vậy fine tunning đã giải quyết được đồng thời 2 vấn đề overfitting và cải thiện accuracy của mô hình.</p>
<p>Đưa thêm hình về accuracy giữa transfer learning và mô hình gốc.</p>
</section>
</section>
</section>
<section id="helper-module">
<h2><span class="section-number">3.1.16. </span>Helper module<a class="headerlink" href="#helper-module" title="Permalink to this heading">#</a></h2>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="regression">
<h1><span class="section-number">3.2. </span>Regression<a class="headerlink" href="#regression" title="Permalink to this heading">#</a></h1>
<p><strong>1. Usage</strong> (predicting a number)</p>
<ul class="simple">
<li><p>predict giá nhà,… (output thường là scalar)</p></li>
<li><p>predict các giá trị bounding box của vật thể trong bức ảnh (output thường là toạ độ 4 điềm cùa bounding box)</p></li>
<li><p>…</p></li>
</ul>
<p><strong>2. Steps</strong></p>
<ul class="simple">
<li><p>Architecture of a regression model</p></li>
<li><p>Input shapes and output shapes</p>
<ul>
<li><p>X: features/data (inputs)</p></li>
<li><p>y: labels (outputs)</p></li>
</ul>
</li>
<li><p>Creating custom data to view and fit</p></li>
<li><p>Steps in modelling</p>
<ul>
<li><p>Creating a model</p></li>
<li><p>Compiling a model</p>
<ul>
<li><p>Defining a loss function</p></li>
<li><p>Setting up an optimizer</p></li>
<li><p>Creating evaluation metrics</p></li>
</ul>
</li>
<li><p>Fitting a model (getting it to find patterns in our data)</p></li>
<li><p>Evaluating a model</p>
<ul>
<li><p>Visualizng the model (“visualize, visualize, visualize”)</p></li>
<li><p>Looking at training curves</p></li>
<li><p>Compare predictions to ground truth (using our evaluation metrics)</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Saving a model (so we can use it later)</p></li>
<li><p>Loading a model</p></li>
</ul>
<p><strong>3. Typically Architecture</strong></p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p><strong>Hyperparameter</strong></p></th>
<th class="head"><p><strong>Typical value</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Input layer shape</p></td>
<td><p>bằng với số lượng input feature</p></td>
</tr>
<tr class="row-odd"><td><p>Hidden layer(s)</p></td>
<td><p>Không cố định</p></td>
</tr>
<tr class="row-even"><td><p>Neurons per hidden layer</p></td>
<td><p>không cố định, generally 10 to 100</p></td>
</tr>
<tr class="row-odd"><td><p>Output layer shape</p></td>
<td><p>dựa vào prediction shape (e.g. 1 for house price)</p></td>
</tr>
<tr class="row-even"><td><p>Hidden activation</p></td>
<td><p>Usually <a class="reference external" href="https://www.kaggle.com/dansbecker/rectified-linear-units-relu-in-deep-learning">ReLU</a> (rectified linear unit)</p></td>
</tr>
<tr class="row-odd"><td><p>Output activation</p></td>
<td><p>None, ReLU, logistic/tanh</p></td>
</tr>
<tr class="row-even"><td><p>Loss function</p></td>
<td><p>Cách tính sự sai lệch giữa prediction và actual <a class="reference external" href="https://en.wikipedia.org/wiki/Mean_squared_error">MSE</a> (mean square error) or <a class="reference external" href="https://en.wikipedia.org/wiki/Mean_absolute_error">MAE</a> (mean absolute error)/Huber (combination of MAE/MSE) if outliers</p></td>
</tr>
<tr class="row-odd"><td><p>Optimizer</p></td>
<td><p>Cách optimize the loss <a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/keras/optimizers/SGD">SGD</a> (stochastic gradient descent), <a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/keras/optimizers/Adam">Adam</a></p></td>
</tr>
</tbody>
</table>
<section id="datasets">
<h2><span class="section-number">3.2.1. </span>Datasets<a class="headerlink" href="#datasets" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(TensorShape([100]), TensorShape([100]))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">make_regression</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">make_regression</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">n_features</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="n">X_train</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">y_test</span><span class="p">)</span>

<span class="c1"># Visualize it</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_train</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.collections.PathCollection at 0x17c9ec760&gt;
</pre></div>
</div>
<img alt="../../_images/40417c464c812b8fba6ac1fadd17059a354a15089a76aed64370cd8ecc31c893.png" src="../../_images/40417c464c812b8fba6ac1fadd17059a354a15089a76aed64370cd8ecc31c893.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Take a single example of X</span>
<span class="n">input_shape</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> 

<span class="c1"># Take a single example of y</span>
<span class="n">output_shape</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>

<span class="n">input_shape</span><span class="p">,</span> <span class="n">output_shape</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(TensorShape([2]), TensorShape([]))
</pre></div>
</div>
</div>
</div>
</section>
<section id="modeling">
<h2><span class="section-number">3.2.2. </span>Modeling<a class="headerlink" href="#modeling" title="Permalink to this heading">#</a></h2>
<p><strong>1. Creating a model</strong>
define:</p>
<ul class="simple">
<li><p>the input layer</p></li>
<li><p>the hidden layer + activate_function</p></li>
<li><p>the output layer + activate_function</p></li>
</ul>
<blockquote>
<div><p>có 3 cách thức create model: <a class="reference external" href="https://machinelearningmastery.com/three-ways-to-build-machine-learning-models-in-keras/">Chi tiết</a></p>
<ul class="simple">
<li><p><strong>Sequential class</strong>: It is a simple, easy-to-use way to start building your Keras model.</p></li>
<li><p><strong>Keras’s functional interface</strong>: more flexible way of representing the model with multiple paths, multiple inputs, multiple outputs</p></li>
<li><p><strong>Subclassing keras.Model</strong>: tiếp cận theo OOP approach to creating models, give the full control and customize the model</p></li>
</ul>
</div></blockquote>
<p><strong>2. Compiling the model</strong>
define:</p>
<ul class="simple">
<li><p>the <code class="docutils literal notranslate"><span class="pre">loss</span></code> function : Cách đo độ sai lệch giữa prediction và actual</p></li>
<li><p>the <code class="docutils literal notranslate"><span class="pre">optimizer</span></code> : cách update the weights để minimize the loss</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">evaluation</span> <span class="pre">metrics</span></code>: đo performance of the model</p></li>
</ul>
<p><strong>3. Fitting the model</strong></p>
<ul class="simple">
<li><p>Fit X and Y to find the patterns between them</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">epochs</span></code>: số lần model sẽ chạy thông qua all training examples</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">batch_size</span></code>: số samples được học cho 1 lần update weight</p></li>
</ul>
<blockquote>
<div><p>Ví dụ: giả sử data có 200 samples , set batch_size = 5 and epochs = 100 có nghĩa là data sẽ gồm 40 batch, tương đương với 40 lần update weight cho mỗi 1 epoch, với số epochs = 100 thì tổng cộng maximum có 4000 batches được training, tương đương 4000 lần update weight.</p>
</div></blockquote>
<p><strong>4. Evaluation</strong></p>
<ul class="simple">
<li><p>Evaluate the model on the test data</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set global level seed</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="create-model-by-sequential">
<h3><span class="section-number">3.2.2.1. </span>Create model by Sequential<a class="headerlink" href="#create-model-by-sequential" title="Permalink to this heading">#</a></h3>
<section id="create-delay-build-pattern-model">
<h4><span class="section-number">3.2.2.1.1. </span>create delay-build pattern model<a class="headerlink" href="#create-delay-build-pattern-model" title="Permalink to this heading">#</a></h4>
<p>Model không truyền tham số <code class="docutils literal notranslate"><span class="pre">input_shape</span></code>  đầu vào, khi đó <code class="docutils literal notranslate"><span class="pre">weights</span></code> của model sẽ không được tạo cho tới khi gọi <code class="docutils literal notranslate"><span class="pre">build(batch_input_shape)</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create a model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span> 
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
<span class="p">])</span>

<span class="c1"># add more hidden layer</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="c1"># Compile the model</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">mae</span><span class="p">,</span>             <span class="c1"># mean absolute error</span>
              <span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">legacy</span><span class="o">.</span><span class="n">SGD</span><span class="p">(),</span>  <span class="c1"># stochastic gradient descent</span>
              <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">]</span>                       <span class="c1"># evaluated by the model during training and testing</span>
             <span class="p">)</span>
<span class="c1"># model.weights not created yet</span>

<span class="c1"># build weight </span>
<span class="n">model</span><span class="o">.</span><span class="n">build</span><span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span> <span class="c1"># model was created weights with batch size = 16</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">weights</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4
Model: &quot;sequential_12&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 dense_2 (Dense)             (None, 1)                 17        
                                                                 
 dense_3 (Dense)             (None, 4)                 8         
                                                                 
=================================================================
Total params: 25
Trainable params: 25
Non-trainable params: 0
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<p>Calling <code class="docutils literal notranslate"><span class="pre">summary()</span></code> on our model thể hiện số lượng node mỗi layer, output shape và số lượng parameters.</p>
<ul class="simple">
<li><p><strong>Total params</strong> : Tổng số lượng params của model.</p></li>
<li><p><strong>Trainable parameters</strong> : Có bao nhiêu params (weights) được update khi train.</p></li>
<li><p><strong>Non-trainable parameters</strong> : Có bao nhiều params ko được update khi train (thường các params này được học từ các pre-train model và chúng ta đang sử dụng transfer learning)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># or </span>
<span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>

<span class="c1"># add more hidden layer</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="c1"># Compile the model</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">mae</span><span class="p">,</span>             <span class="c1"># mean absolute error</span>
              <span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">legacy</span><span class="o">.</span><span class="n">SGD</span><span class="p">(),</span>  <span class="c1"># stochastic gradient descent</span>
              <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">]</span>                       <span class="c1"># evaluated by the model during training and testing</span>
             <span class="p">)</span>

<span class="c1"># This builds the model for the first time</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/3
24/24 [==============================] - 0s 11ms/step - loss: 70.4604 - mae: 70.4604 - val_loss: 73.7504 - val_mae: 73.7504
Epoch 2/3
24/24 [==============================] - 0s 7ms/step - loss: 70.4603 - mae: 70.4603 - val_loss: 73.7503 - val_mae: 73.7503
Epoch 3/3
24/24 [==============================] - 0s 8ms/step - loss: 70.4602 - mae: 70.4602 - val_loss: 73.7501 - val_mae: 73.7501
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;keras.callbacks.History at 0x2db619630&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-model-with-input-shape">
<h4><span class="section-number">3.2.2.1.2. </span>create model with Input_shape<a class="headerlink" href="#create-model-with-input-shape" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>khởi tạo weights bằng việc truyền tham số <code class="docutils literal notranslate"><span class="pre">input_shape</span></code> hoặc layer <code class="docutils literal notranslate"><span class="pre">Input</span></code></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create input_shape = number of feature = input_shape</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="c1"># compile</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;sgd&#39;</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mae&#39;</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span><span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/5
24/24 [==============================] - 0s 7ms/step - loss: 70.4144
Epoch 2/5
24/24 [==============================] - 0s 4ms/step - loss: 69.9650
Epoch 3/5
24/24 [==============================] - 0s 4ms/step - loss: 69.4490
Epoch 4/5
24/24 [==============================] - 0s 4ms/step - loss: 68.7830
Epoch 5/5
24/24 [==============================] - 0s 4ms/step - loss: 67.8538
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;keras.callbacks.History at 0x2d414b160&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># equally </span>
<span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,)))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;sgd&#39;</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mae&#39;</span><span class="p">)</span>
<span class="c1"># model.summary()</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/5
24/24 [==============================] - 0s 6ms/step - loss: 70.0660
Epoch 2/5
24/24 [==============================] - 0s 5ms/step - loss: 69.6612
Epoch 3/5
24/24 [==============================] - 0s 4ms/step - loss: 69.1434
Epoch 4/5
24/24 [==============================] - 0s 4ms/step - loss: 68.4236
Epoch 5/5
24/24 [==============================] - 0s 4ms/step - loss: 67.3903
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;keras.callbacks.History at 0x2dbdb5fc0&gt;
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="id3">
<h3><span class="section-number">3.2.2.2. </span>Prediction<a class="headerlink" href="#id3" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
<span class="n">y_pred</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1/1 [==============================] - 0s 32ms/step
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[-1.4260248],
       [ 4.2305183],
       [-1.3473065],
       [-4.4818244],
       [ 5.9511385]], dtype=float32)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># check y actual</span>
<span class="n">y_test</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(5,), dtype=float64, numpy=
array([-72.97160932,  68.83818878,  30.55985954, -37.93939065,
        42.45570185])&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="improving-model">
<h3><span class="section-number">3.2.2.3. </span>Improving model<a class="headerlink" href="#improving-model" title="Permalink to this heading">#</a></h3>
<p>To improve our model, ta thay đổi trên cả 3 steps, cụ thể:</p>
<ol class="arabic simple">
<li><p><strong>Creating a model</strong></p></li>
</ol>
<ul class="simple">
<li><p>tăng số lượng hidden layers : making the network deeper (prefer)</p></li>
<li><p>tăng số lượng node each hidden layer : making the network wider (prefer)</p></li>
<li><p>thay đổi activation functions mỗi layer.</p></li>
</ul>
<ol class="arabic simple" start="2">
<li><p><strong>Compiling a model</strong></p></li>
</ol>
<ul class="simple">
<li><p>Lựa chọn optimization function phù hợp</p></li>
<li><p>Thay đổi the <strong>learning rate</strong> of the optimization function. (prefer)</p></li>
</ul>
<ol class="arabic simple" start="3">
<li><p><strong>Fitting a model</strong></p></li>
</ol>
<ul class="simple">
<li><p>Fit a model với nhiều hơn <strong>epochs</strong>, tăng thời gian training (prefer)</p></li>
<li><p>Tăng lượng data để học (not always work)</p></li>
</ul>
<p><img alt="various options you can use to improve a neural network model" src="https://raw.githubusercontent.com/mrdbourke/tensorflow-deep-learning/main/images/02-improving-a-model-from-model-perspective.png" /></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqdm.keras</span> <span class="kn">import</span> <span class="n">TqdmCallback</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;layer1&#39;</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="kc">None</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;prediction&#39;</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span> <span class="o">=</span> <span class="s1">&#39;mae&#39;</span><span class="p">,</span> 
              <span class="n">optimizer</span> <span class="o">=</span> <span class="s1">&#39;sgd&#39;</span><span class="p">,</span> 
              <span class="n">metrics</span><span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">])</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span> <span class="mi">100</span><span class="p">,</span> 
          <span class="n">validation_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span> 
          <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">TqdmCallback</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span> <span class="c1"># set = 1, chay qua terminal</span>
         <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "f3b38ed19a2640a5a667472ae4a0d46a", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "54c5b29d365a463db7cc0d6464d97b3b", "version_major": 2, "version_minor": 0}</script><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;keras.callbacks.History at 0x1767400a0&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
<span class="n">y_pred</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1/1 [==============================] - 0s 28ms/step
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 64.71378 ],
       [-70.94364 ],
       [-22.879143],
       [-17.551132],
       [-21.43952 ]], dtype=float32)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># check y actual</span>
<span class="n">y_test</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(5,), dtype=float64, numpy=
array([ 64.10915436, -70.67262435, -22.94374742, -17.43261167,
       -21.01168899])&gt;
</pre></div>
</div>
</div>
</div>
<section id="earlystopping">
<h4><span class="section-number">3.2.2.3.1. </span>EarlyStopping<a class="headerlink" href="#earlystopping" title="Permalink to this heading">#</a></h4>
<p>Stop training when a monitored metric has stopped improving</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">callback</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">EarlyStopping</span><span class="p">(</span>
    <span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span>      <span class="c1"># chỉ số tracking</span>
    <span class="n">min_delta</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>        <span class="c1"># giá trị tối thiểu chênh lệch được tính là 1 lần improvement, nếu nhỏ hơn thì là no improvement </span>
    <span class="n">patience</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>         <span class="c1"># số epoch tối đa cho phép no improvement</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
    <span class="n">baseline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">restore_best_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1"># restore model về best weights</span>
    <span class="n">start_from_epoch</span><span class="o">=</span><span class="mi">100</span> <span class="c1"># number epochs chạy trước khi bắt đầu monitoring</span>
<span class="p">)</span>

<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span> <span class="mi">100</span><span class="p">,</span> 
          <span class="n">validation_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span> 
          <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">TqdmCallback</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">callback</span><span class="p">]</span> <span class="c1"># set = 1, chay qua terminal</span>
         <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="evaluate-model">
<h3><span class="section-number">3.2.2.4. </span>Evaluate model<a class="headerlink" href="#evaluate-model" title="Permalink to this heading">#</a></h3>
<section id="visualize-data">
<h4><span class="section-number">3.2.2.4.1. </span>visualize data<a class="headerlink" href="#visualize-data" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_train</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Training data&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_test</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Testing data&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x2bf1128f0&gt;
</pre></div>
</div>
<img alt="../../_images/ac5bcf54ae735608c305d36cec95793c3bdcb946f4350ff7a72f8fcf2c3bd400.png" src="../../_images/ac5bcf54ae735608c305d36cec95793c3bdcb946f4350ff7a72f8fcf2c3bd400.png" />
</div>
</div>
</section>
<section id="visualize-the-model">
<h4><span class="section-number">3.2.2.4.2. </span>Visualize the model<a class="headerlink" href="#visualize-the-model" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tensorflow.keras.utils</span> <span class="kn">import</span> <span class="n">plot_model</span>

<span class="n">plot_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">show_shapes</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>You must install pydot (`pip install pydot`) and install graphviz (see instructions at https://graphviz.gitlab.io/download/) for plot_model to work.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># list all data in history</span>
<span class="nb">print</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="c1"># summarize history for accuracy</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">])</span>
<span class="c1"># plt.plot(history.history[&#39;val_mae&#39;])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;model mae&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;mae&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># summarize history for loss</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
<span class="c1"># plt.plot(history.history[&#39;val_loss&#39;])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;model loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dict_keys([&#39;loss&#39;, &#39;mae&#39;])
</pre></div>
</div>
<img alt="../../_images/b13ac1e3f5fbe62219e6ccb80d2381f91c11e37f5901e61b7af3b65618ebd7da.png" src="../../_images/b13ac1e3f5fbe62219e6ccb80d2381f91c11e37f5901e61b7af3b65618ebd7da.png" />
<img alt="../../_images/fec32203cc18a0015b339415afa03bccb826c0b4847f21b4a993ee42957efba0.png" src="../../_images/fec32203cc18a0015b339415afa03bccb826c0b4847f21b4a993ee42957efba0.png" />
</div>
</div>
</section>
<section id="visualize-the-predictions">
<h4><span class="section-number">3.2.2.4.3. </span>Visualize the predictions<a class="headerlink" href="#visualize-the-predictions" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;sequential_13&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 layer1 (Dense)              (None, 4)                 12        
                                                                 
 prediction (Dense)          (None, 1)                 5         
                                                                 
=================================================================
Total params: 17
Trainable params: 17
Non-trainable params: 0
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make predictions</span>
<span class="n">y_preds</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">plot_predictions</span><span class="p">(</span><span class="n">train_data</span><span class="o">=</span><span class="n">X_train</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="n">train_labels</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span> 
                     <span class="n">test_data</span><span class="o">=</span><span class="n">X_test</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="n">test_labels</span><span class="o">=</span><span class="n">y_test</span><span class="p">,</span> 
                     <span class="n">predictions</span><span class="o">=</span><span class="n">y_preds</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Training data&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Testing data&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Predictions&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    
<span class="n">plot_predictions</span><span class="p">()</span>    
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>8/8 [==============================] - 0s 3ms/step
</pre></div>
</div>
<img alt="../../_images/8457389cc1dae238d7adf30021ed8965040acbc6eded02c519a3353c568b211a.png" src="../../_images/8457389cc1dae238d7adf30021ed8965040acbc6eded02c519a3353c568b211a.png" />
</div>
</div>
</section>
<section id="evaluate-prediction">
<h4><span class="section-number">3.2.2.4.4. </span>Evaluate prediction<a class="headerlink" href="#evaluate-prediction" title="Permalink to this heading">#</a></h4>
<p>Two of the main metrics used for regression problems are:</p>
<ul class="simple">
<li><p><strong>Mean absolute error (MAE)</strong> - the mean difference between each of the predictions.</p></li>
<li><p><strong>Mean squared error (MSE)</strong> - the squared mean difference between of the predictions (khuếch đại error lớn).</p></li>
<li><p><strong>Huber</strong> - combination ò MSE and MAE, so less sensitive to outliers than MSE</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># sử dụng model.evaluate() sẽ return loss với metrics đã được setup tại compile model</span>
<span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>8/8 [==============================] - 0s 5ms/step - loss: 0.3673 - mae: 0.3673
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0.3672896921634674, 0.3672896921634674]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># use another metrics</span>

<span class="c1"># Calculate the mean absolute error</span>
<span class="n">mae</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_true</span><span class="o">=</span><span class="n">y_test</span><span class="p">,</span> 
                                     <span class="n">y_pred</span><span class="o">=</span><span class="n">y_preds</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="c1"># need to remove all dim 1</span>
                                    <span class="p">)</span>
<span class="c1"># Calculate the MSE</span>
<span class="n">mse</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_true</span><span class="o">=</span><span class="n">y_test</span><span class="p">,</span>
                                    <span class="n">y_pred</span><span class="o">=</span><span class="n">y_preds</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>

<span class="n">mae</span><span class="p">,</span> <span class="n">mse</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&lt;tf.Tensor: shape=(), dtype=float32, numpy=0.3672897&gt;,
 &lt;tf.Tensor: shape=(), dtype=float32, numpy=0.21705633&gt;)
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="id4">
<h3><span class="section-number">3.2.2.5. </span>Tracking the experiments<a class="headerlink" href="#id4" title="Permalink to this heading">#</a></h3>
<p>Track quá trình training model</p>
<blockquote>
<div><p>📖 <strong>Resource:</strong> But as you build more models, you’ll want to look into using tools such as:</p>
</div></blockquote>
<ul class="simple">
<li><p><a class="reference external" href="https://tensorboard.dev/"><strong>TensorBoard</strong></a> - a component of the TensorFlow library to help track modelling experiments (we’ll see this later).</p></li>
<li><p><a class="reference external" href="https://www.wandb.com/"><strong>Weights &amp; Biases</strong></a> - a tool for tracking all kinds of machine learning experiments (the good news for Weights &amp; Biases is it plugs into TensorBoard).</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">wandb</span>
<span class="kn">from</span> <span class="nn">wandb.keras</span> <span class="kn">import</span> <span class="n">WandbMetricsLogger</span><span class="p">,</span> <span class="n">WandbModelCheckpoint</span>

<span class="c1"># Start a run, tracking hyperparameters</span>
<span class="n">wandb</span><span class="o">.</span><span class="n">init</span><span class="p">(</span>
    <span class="c1"># set the wandb project where this run will be logged</span>
    <span class="n">project</span><span class="o">=</span><span class="s2">&quot;tf_regression_learn&quot;</span><span class="p">,</span>

    <span class="c1"># track hyperparameters and run metadata with wandb.config</span>
    <span class="n">config</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;layer_1&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
        <span class="s2">&quot;activation_1&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;layer_2&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;activation_2&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;optimizer&quot;</span><span class="p">:</span> <span class="s2">&quot;sgd&quot;</span><span class="p">,</span>
        <span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="s2">&quot;mae&quot;</span><span class="p">,</span>
        <span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="s2">&quot;mae&quot;</span><span class="p">,</span>
        <span class="s2">&quot;epoch&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
        <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="mi">32</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="c1"># [optional] use wandb.config as your config</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">wandb</span><span class="o">.</span><span class="n">config</span>

<span class="c1"># build a model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">layer_1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">activation_1</span><span class="p">),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">layer_2</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">activation_2</span><span class="p">)</span>
    <span class="p">])</span>

<span class="c1"># compile the model</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">optimizer</span><span class="p">,</span>
              <span class="n">loss</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">loss</span><span class="p">,</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">metric</span><span class="p">]</span>
              <span class="p">)</span>

<span class="c1"># WandbMetricsLogger will log train and validation metrics to wandb</span>
<span class="c1"># WandbModelCheckpoint will upload model checkpoints to wandb</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span>
                    <span class="n">epochs</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span>
                    <span class="n">batch_size</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span>
                    <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span>
                      <span class="n">WandbMetricsLogger</span><span class="p">(</span><span class="n">log_freq</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>
                      <span class="n">WandbModelCheckpoint</span><span class="p">(</span><span class="s2">&quot;models&quot;</span><span class="p">)</span>
                    <span class="p">])</span>

<span class="c1"># [optional] finish the wandb run, necessary in notebooks</span>
<span class="n">wandb</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="clone-model">
<h3><span class="section-number">3.2.2.6. </span>Clone model<a class="headerlink" href="#clone-model" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Clone_model</span></code> giúp sharing những weight đã học được từ model cũ và cần thực hiện trainning trên dữ liệu mới</p></li>
<li><p><strong>Model sau khi được clone</strong> có thể gọi <code class="docutils literal notranslate"><span class="pre">compile</span></code> và <code class="docutils literal notranslate"><span class="pre">fit</span></code> cho dữ liệu mới</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clone_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">clone_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id5">
<h3><span class="section-number">3.2.2.7. </span>Save/load model<a class="headerlink" href="#id5" title="Permalink to this heading">#</a></h3>
<section id="the-savedmodel-format-default">
<h4><span class="section-number">3.2.2.7.1. </span>The SavedModel format (default)<a class="headerlink" href="#the-savedmodel-format-default" title="Permalink to this heading">#</a></h4>
<p>Có thể lưu các đối tượng tuỳ chọn của model mà ko cần load cả model back in, hoặc sửu dụng cho việc pretrain với các tham số được tối ưu</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># save</span>
<span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;models/model_1/SavedModel_format&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:tensorflow:Assets written to: models/model_1/SavedModel_format/assets
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="s1">&#39;models/model_1/SavedModel_format&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="h5-format">
<h4><span class="section-number">3.2.2.7.2. </span>H5 format<a class="headerlink" href="#h5-format" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># save</span>
<span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;models/model_1/h5_format/model.h5&quot;</span><span class="p">)</span> 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="s1">&#39;models/model_1/h5_format/model.h5&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="load-from-colab">
<h4><span class="section-number">3.2.2.7.3. </span>load from colab<a class="headerlink" href="#load-from-colab" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Download the model (or any file) from Google Colab</span>
<span class="kn">from</span> <span class="nn">google.colab</span> <span class="kn">import</span> <span class="n">files</span>
<span class="n">files</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s2">&quot;models/model_1/h5_format/model.h5&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="example-1">
<h2><span class="section-number">3.2.3. </span>Example 1<a class="headerlink" href="#example-1" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.compose</span> <span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">MinMaxScaler</span>

<span class="kn">from</span> <span class="nn">tqdm.keras</span> <span class="kn">import</span> <span class="n">TqdmCallback</span>
<span class="kn">from</span> <span class="nn">keras_tqdm</span> <span class="kn">import</span> <span class="n">TQDMNotebookCallback</span>

<span class="kn">from</span> <span class="nn">func</span> <span class="kn">import</span> <span class="n">ExplorerDF</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># dataset</span>
<span class="n">insurance</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;https://raw.githubusercontent.com/stedy/Machine-Learning-with-R-datasets/master/insurance.csv&quot;</span><span class="p">)</span>
<span class="n">insurance</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>age</th>
      <th>sex</th>
      <th>bmi</th>
      <th>children</th>
      <th>smoker</th>
      <th>region</th>
      <th>charges</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>19</td>
      <td>female</td>
      <td>27.900</td>
      <td>0</td>
      <td>yes</td>
      <td>southwest</td>
      <td>16884.92400</td>
    </tr>
    <tr>
      <th>1</th>
      <td>18</td>
      <td>male</td>
      <td>33.770</td>
      <td>1</td>
      <td>no</td>
      <td>southeast</td>
      <td>1725.55230</td>
    </tr>
    <tr>
      <th>2</th>
      <td>28</td>
      <td>male</td>
      <td>33.000</td>
      <td>3</td>
      <td>no</td>
      <td>southeast</td>
      <td>4449.46200</td>
    </tr>
    <tr>
      <th>3</th>
      <td>33</td>
      <td>male</td>
      <td>22.705</td>
      <td>0</td>
      <td>no</td>
      <td>northwest</td>
      <td>21984.47061</td>
    </tr>
    <tr>
      <th>4</th>
      <td>32</td>
      <td>male</td>
      <td>28.880</td>
      <td>0</td>
      <td>no</td>
      <td>northwest</td>
      <td>3866.85520</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ExplorerDF</span><span class="o">.</span><span class="n">exploring</span><span class="p">(</span><span class="n">insurance</span><span class="p">,</span> <span class="n">nsample</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Total 1338 records, 7 columns
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sub_type</th>
      <th>n_distinct</th>
      <th>pct_distinct</th>
      <th>n_miss</th>
      <th>pct_miss</th>
      <th>pct_coverage</th>
      <th>n_negative</th>
      <th>pct_negative</th>
      <th>n_zero</th>
      <th>pct_zero</th>
      <th>pct_outliers_rarelabels</th>
      <th>count</th>
      <th>mean</th>
      <th>std</th>
      <th>min</th>
      <th>25%</th>
      <th>50%</th>
      <th>75%</th>
      <th>max</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>age</th>
      <td>int64</td>
      <td>47</td>
      <td>3.51</td>
      <td>0</td>
      <td>0.0</td>
      <td>100.0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.00</td>
      <td>1338.0</td>
      <td>39.207025</td>
      <td>14.049960</td>
      <td>18.0000</td>
      <td>27.00000</td>
      <td>39.000</td>
      <td>51.000000</td>
      <td>64.00000</td>
    </tr>
    <tr>
      <th>sex</th>
      <td>object</td>
      <td>2</td>
      <td>0.15</td>
      <td>0</td>
      <td>0.0</td>
      <td>100.0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.00</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>bmi</th>
      <td>float64</td>
      <td>548</td>
      <td>40.96</td>
      <td>0</td>
      <td>0.0</td>
      <td>100.0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.00</td>
      <td>1338.0</td>
      <td>30.663397</td>
      <td>6.098187</td>
      <td>15.9600</td>
      <td>26.29625</td>
      <td>30.400</td>
      <td>34.693750</td>
      <td>53.13000</td>
    </tr>
    <tr>
      <th>children</th>
      <td>int64</td>
      <td>6</td>
      <td>0.45</td>
      <td>0</td>
      <td>0.0</td>
      <td>100.0</td>
      <td>0</td>
      <td>0.0</td>
      <td>574</td>
      <td>42.9</td>
      <td>3.21</td>
      <td>1338.0</td>
      <td>1.094918</td>
      <td>1.205493</td>
      <td>0.0000</td>
      <td>0.00000</td>
      <td>1.000</td>
      <td>2.000000</td>
      <td>5.00000</td>
    </tr>
    <tr>
      <th>smoker</th>
      <td>object</td>
      <td>2</td>
      <td>0.15</td>
      <td>0</td>
      <td>0.0</td>
      <td>100.0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.00</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>region</th>
      <td>object</td>
      <td>4</td>
      <td>0.30</td>
      <td>0</td>
      <td>0.0</td>
      <td>100.0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.00</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>charges</th>
      <td>float64</td>
      <td>1337</td>
      <td>99.93</td>
      <td>0</td>
      <td>0.0</td>
      <td>100.0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.00</td>
      <td>1338.0</td>
      <td>13270.422265</td>
      <td>12110.011237</td>
      <td>1121.8739</td>
      <td>4740.28715</td>
      <td>9382.033</td>
      <td>16639.912515</td>
      <td>63770.42801</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># train_val_split</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">insurance</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;charges&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">insurance</span><span class="p">[</span><span class="s1">&#39;charges&#39;</span><span class="p">],</span> <span class="n">test_size</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">)</span>

<span class="c1"># data preprocessing</span>
<span class="n">ohe</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="s1">&#39;if_binary&#39;</span><span class="p">,</span>
                    <span class="n">handle_unknown</span> <span class="o">=</span> <span class="s1">&#39;ignore&#39;</span><span class="p">,</span> 
                    <span class="n">sparse_output</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>


<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;ohe_trans&#39;</span><span class="p">,</span> <span class="n">ColumnTransformer</span><span class="p">([(</span><span class="s2">&quot;ohe&quot;</span><span class="p">,</span> <span class="n">ohe</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;smoker&quot;</span><span class="p">,</span> <span class="s2">&quot;region&quot;</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">])],</span> 
                      <span class="n">remainder</span> <span class="o">=</span> <span class="s1">&#39;passthrough&#39;</span><span class="p">,</span> 
                      <span class="n">verbose_feature_names_out</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">MinMaxScaler</span><span class="p">())]</span> <span class="c1"># thường sử dụng trong neural network</span>
<span class="p">)</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="n">transform</span><span class="o">=</span><span class="s2">&quot;pandas&quot;</span><span class="p">)</span>

<span class="n">X_train</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_val</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_val</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set random seed</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">callback</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">EarlyStopping</span><span class="p">(</span>
    <span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span>      <span class="c1"># chỉ số tracking</span>
    <span class="n">min_delta</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>        <span class="c1"># giá trị tối thiểu cho phép thay đổi ngược </span>
                        <span class="c1"># ( ví dụ với accuracy là mức giảm tối thiểu cho phép, </span>
                        <span class="c1"># hoặc với MAE thì là mức tăng tối thiểu cho phép)</span>
    <span class="n">patience</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>         <span class="c1"># số epoch tối đa cho phép no improvement</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
    <span class="n">baseline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">restore_best_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1"># restore model về best weights</span>
    <span class="n">start_from_epoch</span><span class="o">=</span><span class="mi">100</span> <span class="c1"># number epochs chạy trước khi bắt đầu monitoring</span>
<span class="p">)</span>

<span class="c1"># Build the model (3 layers, 100, 10, 1 units)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
  <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
  <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
  <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;prediction&#39;</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># Compile the model</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">mae</span><span class="p">,</span>
                          <span class="n">optimizer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">legacy</span><span class="o">.</span><span class="n">Adam</span><span class="p">(),</span>
                          <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">])</span>

<span class="c1"># Fit the model for 200 epochs (same as insurance_model_2)</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
          <span class="n">validation_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">),</span> 
          <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">TqdmCallback</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">callback</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># list all data in history</span>
<span class="nb">print</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="c1"># summarize history for accuracy</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">])</span>
<span class="c1"># plt.plot(history.history[&#39;val_mae&#39;])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;model mae&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;mae&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># summarize history for loss</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
<span class="c1"># plt.plot(history.history[&#39;val_loss&#39;])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;model loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dict_keys([&#39;loss&#39;, &#39;mae&#39;])
</pre></div>
</div>
<img alt="../../_images/a300a09d357178d6ce0e6277a7f283d95422f419f286f4a3e506aa649cbbbc44.png" src="../../_images/a300a09d357178d6ce0e6277a7f283d95422f419f286f4a3e506aa649cbbbc44.png" />
<img alt="../../_images/8a966ac209defd9ef3e0c6375bf7998becd6c2ddaf64ed40fdc16be190a88e32.png" src="../../_images/8a966ac209defd9ef3e0c6375bf7998becd6c2ddaf64ed40fdc16be190a88e32.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># evaluation</span>
<span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>9/9 [==============================] - 0s 6ms/step - loss: 3901.5857 - mae: 3901.5857
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[3901.585693359375, 3901.585693359375]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">y_val</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
<span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_val</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1219     7537.16390
975     16138.76205
887      5272.17580
1060     1981.58190
782      9386.16130
Name: charges, dtype: float64
1/1 [==============================] - 0s 151ms/step
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 7950.659 ],
       [32682.156 ],
       [ 6241.522 ],
       [ 2206.1704],
       [ 9767.73  ]], dtype=float32)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># save</span>
<span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;models/model_2&#39;</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;models/model_2/history.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_pi</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">,</span> <span class="n">file_pi</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:tensorflow:Assets written to: models/model_2/assets
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:tensorflow:Assets written to: models/model_2/assets
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="s1">&#39;models/model_3&#39;</span><span class="p">)</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;models/model_3/history.pkl&#39;</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">history</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

<span class="c1"># summarize history for accuracy</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_mae&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;model mae&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;mae&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># summarize history for loss</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;model loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/70d2a996182b8142de0a8aed540a90168d5ef9c9f2dd0e1618519e04abefd626.png" src="../../_images/70d2a996182b8142de0a8aed540a90168d5ef9c9f2dd0e1618519e04abefd626.png" />
<img alt="../../_images/f88c6c226e7d56b93e7fb6203e32a8fed3f783b60d10faeeac8d4c0a889414e6.png" src="../../_images/f88c6c226e7d56b93e7fb6203e32a8fed3f783b60d10faeeac8d4c0a889414e6.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">y_val</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
<span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_val</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1219     7537.16390
975     16138.76205
887      5272.17580
1060     1981.58190
782      9386.16130
Name: charges, dtype: float64
1/1 [==============================] - 0s 37ms/step
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 7912.9756],
       [35036.65  ],
       [ 6146.144 ],
       [ 2260.307 ],
       [ 9927.315 ]], dtype=float32)
</pre></div>
</div>
</div>
</div>
</section>
<section id="example-2">
<h2><span class="section-number">3.2.4. </span>Example 2<a class="headerlink" href="#example-2" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># dataset</span>
<span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">boston_housing</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading data from https://storage.googleapis.com/tensorflow/tf-keras-datasets/boston_housing.npz
57026/57026 [==============================] - 0s 1us/step
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span>
<span class="n">x_train</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span>
<span class="n">x_test</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(404, 13)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set seed</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">21</span><span class="p">)</span>

<span class="c1"># create model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">input_shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;swish&#39;</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;output&#39;</span><span class="p">))</span>

<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">mae</span><span class="p">,</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">legacy</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">),</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">mae</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">callback</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span> <span class="o">=</span> <span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="n">patience</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">min_delta</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">restore_best_weights</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">2</span> <span class="p">,</span><span class="n">epochs</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">callback</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/200
202/202 [==============================] - 2s 7ms/step - loss: 7.7570 - mean_absolute_error: 7.7570 - val_loss: 4.8585 - val_mean_absolute_error: 4.8585
Epoch 2/200
202/202 [==============================] - 1s 7ms/step - loss: 4.2773 - mean_absolute_error: 4.2773 - val_loss: 4.2457 - val_mean_absolute_error: 4.2457
Epoch 3/200
202/202 [==============================] - 1s 7ms/step - loss: 3.7205 - mean_absolute_error: 3.7205 - val_loss: 3.5694 - val_mean_absolute_error: 3.5694
Epoch 4/200
202/202 [==============================] - 1s 7ms/step - loss: 3.3973 - mean_absolute_error: 3.3973 - val_loss: 4.3369 - val_mean_absolute_error: 4.3369
Epoch 5/200
202/202 [==============================] - 1s 7ms/step - loss: 3.3369 - mean_absolute_error: 3.3369 - val_loss: 3.0901 - val_mean_absolute_error: 3.0901
Epoch 6/200
202/202 [==============================] - 1s 7ms/step - loss: 3.0443 - mean_absolute_error: 3.0443 - val_loss: 3.0270 - val_mean_absolute_error: 3.0270
Epoch 7/200
202/202 [==============================] - 1s 7ms/step - loss: 2.9658 - mean_absolute_error: 2.9658 - val_loss: 3.0070 - val_mean_absolute_error: 3.0070
Epoch 8/200
202/202 [==============================] - 1s 7ms/step - loss: 2.8488 - mean_absolute_error: 2.8488 - val_loss: 3.0352 - val_mean_absolute_error: 3.0352
Epoch 9/200
202/202 [==============================] - 1s 7ms/step - loss: 2.9113 - mean_absolute_error: 2.9113 - val_loss: 2.9796 - val_mean_absolute_error: 2.9796
Epoch 10/200
202/202 [==============================] - 1s 7ms/step - loss: 2.9046 - mean_absolute_error: 2.9046 - val_loss: 2.8424 - val_mean_absolute_error: 2.8424
Epoch 11/200
202/202 [==============================] - 2s 7ms/step - loss: 2.7280 - mean_absolute_error: 2.7280 - val_loss: 2.8790 - val_mean_absolute_error: 2.8790
Epoch 12/200
202/202 [==============================] - 1s 7ms/step - loss: 2.6784 - mean_absolute_error: 2.6784 - val_loss: 3.5815 - val_mean_absolute_error: 3.5815
Epoch 13/200
202/202 [==============================] - 1s 7ms/step - loss: 2.6889 - mean_absolute_error: 2.6889 - val_loss: 2.9003 - val_mean_absolute_error: 2.9003
Epoch 14/200
202/202 [==============================] - 1s 7ms/step - loss: 2.6485 - mean_absolute_error: 2.6485 - val_loss: 2.6909 - val_mean_absolute_error: 2.6909
Epoch 15/200
202/202 [==============================] - 1s 7ms/step - loss: 2.5921 - mean_absolute_error: 2.5921 - val_loss: 2.8721 - val_mean_absolute_error: 2.8721
Epoch 16/200
202/202 [==============================] - 1s 7ms/step - loss: 2.5680 - mean_absolute_error: 2.5680 - val_loss: 2.9849 - val_mean_absolute_error: 2.9849
Epoch 17/200
202/202 [==============================] - 1s 7ms/step - loss: 2.5518 - mean_absolute_error: 2.5518 - val_loss: 2.9609 - val_mean_absolute_error: 2.9609
Epoch 18/200
202/202 [==============================] - 1s 7ms/step - loss: 2.5835 - mean_absolute_error: 2.5835 - val_loss: 2.7655 - val_mean_absolute_error: 2.7655
Epoch 19/200
202/202 [==============================] - 1s 7ms/step - loss: 2.5841 - mean_absolute_error: 2.5841 - val_loss: 2.7187 - val_mean_absolute_error: 2.7187
Epoch 20/200
202/202 [==============================] - 1s 7ms/step - loss: 2.4829 - mean_absolute_error: 2.4829 - val_loss: 2.8768 - val_mean_absolute_error: 2.8768
Epoch 21/200
202/202 [==============================] - 1s 7ms/step - loss: 2.5825 - mean_absolute_error: 2.5825 - val_loss: 3.1216 - val_mean_absolute_error: 3.1216
Epoch 22/200
202/202 [==============================] - 1s 7ms/step - loss: 2.4211 - mean_absolute_error: 2.4211 - val_loss: 2.9262 - val_mean_absolute_error: 2.9262
Epoch 23/200
202/202 [==============================] - 1s 7ms/step - loss: 2.4739 - mean_absolute_error: 2.4739 - val_loss: 2.6912 - val_mean_absolute_error: 2.6912
Epoch 24/200
202/202 [==============================] - 1s 7ms/step - loss: 2.4339 - mean_absolute_error: 2.4339 - val_loss: 2.8440 - val_mean_absolute_error: 2.8440
Epoch 25/200
202/202 [==============================] - 1s 7ms/step - loss: 2.3676 - mean_absolute_error: 2.3676 - val_loss: 2.9142 - val_mean_absolute_error: 2.9142
Epoch 26/200
202/202 [==============================] - 1s 7ms/step - loss: 2.5163 - mean_absolute_error: 2.5163 - val_loss: 2.7001 - val_mean_absolute_error: 2.7001
Epoch 27/200
202/202 [==============================] - 1s 7ms/step - loss: 2.4116 - mean_absolute_error: 2.4116 - val_loss: 2.9882 - val_mean_absolute_error: 2.9882
Epoch 28/200
202/202 [==============================] - 2s 7ms/step - loss: 2.4895 - mean_absolute_error: 2.4895 - val_loss: 2.7897 - val_mean_absolute_error: 2.7897
Epoch 29/200
202/202 [==============================] - 1s 7ms/step - loss: 2.3720 - mean_absolute_error: 2.3720 - val_loss: 2.7369 - val_mean_absolute_error: 2.7369
Epoch 30/200
202/202 [==============================] - 1s 7ms/step - loss: 2.5456 - mean_absolute_error: 2.5456 - val_loss: 2.7269 - val_mean_absolute_error: 2.7269
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_test</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">y_test</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1/1 [==============================] - 0s 16ms/step
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([ 7.884963, 18.342295, 21.383883, 33.134712, 23.93147 , 20.444105,
        30.913712, 23.747288, 18.95533 , 20.735926], dtype=float32),
 array([ 7.2, 18.8, 19. , 27. , 22.2, 24.5, 31.2, 22.9, 20.5, 23.2]))
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="classification">
<h1><span class="section-number">3.3. </span>Classification<a class="headerlink" href="#classification" title="Permalink to this heading">#</a></h1>
<p><strong>1. Usage</strong> (predicting something is one thing or another)</p>
<ul class="simple">
<li><p><strong>binary classification</strong> : spam/not_spam, bad/good,…</p></li>
<li><p><strong>multi-class classification</strong> : a photo of dog, or cat, or any animals,…</p></li>
<li><p><strong>multi-label classification</strong> : objects in a photo are cats, dogs or both cats and dogs, (not a specific class)</p></li>
</ul>
<p><strong>2. Steps</strong></p>
<ul class="simple">
<li><p>Input shapes and output shapes</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">X</span></code>: features/data (inputs)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">y</span></code>: labels (outputs)</p>
<ul>
<li><p>“What class do the inputs belong to?”</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Creating custom data to view and fit</p></li>
<li><p>Steps in modelling for binary and mutliclass classification</p>
<ul>
<li><p>Creating a model</p></li>
<li><p>Compiling a model</p>
<ul>
<li><p>Defining a loss function</p></li>
<li><p>Setting up an optimizer</p>
<ul>
<li><p>Finding the best learning rate</p></li>
</ul>
</li>
<li><p>Creating evaluation metrics</p></li>
</ul>
</li>
<li><p>Fitting a model (getting it to find patterns in our data)</p></li>
<li><p>Improving a model</p></li>
</ul>
</li>
<li><p>The power of non-linearity</p></li>
<li><p>Evaluating classification models</p>
<ul>
<li><p>Visualizng the model (“visualize, visualize, visualize”)</p></li>
<li><p>Looking at training curves</p></li>
<li><p>Compare predictions to ground truth (using our evaluation metrics)</p></li>
</ul>
</li>
</ul>
<p><strong>3. Typically Architecture</strong></p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p><strong>Hyperparameter</strong></p></th>
<th class="head"><p><strong>Binary Classification</strong></p></th>
<th class="head"><p><strong>Multiclass classification</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Input layer shape</p></td>
<td><p>Same as number of features (e.g. 5 for age, sex, height, weight, smoking status in heart disease prediction)</p></td>
<td><p>Same as binary classification</p></td>
</tr>
<tr class="row-odd"><td><p>Hidden layer(s)</p></td>
<td><p>Problem specific, minimum = 1, maximum = unlimited</p></td>
<td><p>Same as binary classification</p></td>
</tr>
<tr class="row-even"><td><p>Neurons per hidden layer</p></td>
<td><p>Problem specific, generally 10 to 100</p></td>
<td><p>Same as binary classification</p></td>
</tr>
<tr class="row-odd"><td><p>Output layer shape</p></td>
<td><p>1 (one class or the other)</p></td>
<td><p>1 per class (e.g. 3 for food, person or dog photo)</p></td>
</tr>
<tr class="row-even"><td><p>Hidden activation</p></td>
<td><p>Usually <a class="reference external" href="https://www.kaggle.com/dansbecker/rectified-linear-units-relu-in-deep-learning">ReLU</a> (rectified linear unit)</p></td>
<td><p>Same as binary classification</p></td>
</tr>
<tr class="row-odd"><td><p>Output activation</p></td>
<td><p><a class="reference external" href="https://en.wikipedia.org/wiki/Sigmoid_function">Sigmoid</a></p></td>
<td><p><a class="reference external" href="https://en.wikipedia.org/wiki/Softmax_function">Softmax</a></p></td>
</tr>
<tr class="row-even"><td><p>Loss function</p></td>
<td><p><a class="reference external" href="https://en.wikipedia.org/wiki/Cross_entropy#Cross-entropy_loss_function_and_logistic_regression">Cross entropy</a> (<a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/keras/losses/BinaryCrossentropy"><code class="docutils literal notranslate"><span class="pre">tf.keras.losses.BinaryCrossentropy</span></code></a> in TensorFlow)</p></td>
<td><p>Cross entropy (<a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/keras/losses/CategoricalCrossentropy"><code class="docutils literal notranslate"><span class="pre">tf.keras.losses.CategoricalCrossentropy</span></code></a> in TensorFlow)</p></td>
</tr>
<tr class="row-odd"><td><p>Optimizer</p></td>
<td><p><a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/keras/optimizers/SGD">SGD</a> (stochastic gradient descent), <a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/keras/optimizers/Adam">Adam</a></p></td>
<td><p>Same as binary classification</p></td>
</tr>
</tbody>
</table>
<p><strong>4. Input and Output Shape</strong></p>
<p>(example for image classification)</p>
<ul class="simple">
<li><p>Input_shape = (batch_size, width, height, color_channels)</p></li>
</ul>
<blockquote>
<div><p>Ví dụ: thông thường batch_size = 32, với ảnh 224x224 RGB là input truyền vào cho model thì input_shape = (32, 224, 224, 3)</p>
</div></blockquote>
<ul class="simple">
<li><p>Output_shape:</p>
<ul>
<li><p>Với binary class thì output_shape = [1]</p></li>
<li><p>Với multi-class thì output_shape = [n_class]</p></li>
</ul>
</li>
</ul>
<p><strong>5. Classification evaluation methods</strong></p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p><strong>Metric name/Evaluation method</strong></p></th>
<th class="head"><p><strong>Defintion</strong></p></th>
<th class="head"><p><strong>Code</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Accuracy</p></td>
<td><p>trong số 100 predictions, Có bao nhiêu prediction mà model dự đoán đúng? E.g. 95% accuracy means it gets 95/100 predictions correct.</p></td>
<td><p><a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.metrics.accuracy_score.html"><code class="docutils literal notranslate"><span class="pre">sklearn.metrics.accuracy_score()</span></code></a> or <span class="xref myst"><code class="docutils literal notranslate"><span class="pre">tf.keras.metrics.Accuracy()</span></code></span></p></td>
</tr>
<tr class="row-odd"><td><p>Precision</p></td>
<td><p>Proportion of true positives over total number of samples. Higher precision leads to less false positives (model predicts 1 when it should’ve been 0).</p></td>
<td><p><a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.metrics.precision_score.html"><code class="docutils literal notranslate"><span class="pre">sklearn.metrics.precision_score()</span></code></a> or <span class="xref myst"><code class="docutils literal notranslate"><span class="pre">tf.keras.metrics.Precision()</span></code></span></p></td>
</tr>
<tr class="row-even"><td><p>Recall</p></td>
<td><p>Proportion of true positives over total number of true positives and false negatives (model predicts 0 when it should’ve been 1). Higher recall leads to less false negatives.</p></td>
<td><p><a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.metrics.recall_score.html"><code class="docutils literal notranslate"><span class="pre">sklearn.metrics.recall_score()</span></code></a> or <span class="xref myst"><code class="docutils literal notranslate"><span class="pre">tf.keras.metrics.Recall()</span></code></span></p></td>
</tr>
<tr class="row-odd"><td><p>F1-score</p></td>
<td><p>Combines precision and recall into one metric. 1 is best, 0 is worst.</p></td>
<td><p><a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.metrics.f1_score.html"><code class="docutils literal notranslate"><span class="pre">sklearn.metrics.f1_score()</span></code></a></p></td>
</tr>
<tr class="row-even"><td><p><a class="reference external" href="https://www.dataschool.io/simple-guide-to-confusion-matrix-terminology/">Confusion matrix</a></p></td>
<td><p>Compares the predicted values with the true values in a tabular way, if 100% correct, all values in the matrix will be top left to bottom right (diagnol line).</p></td>
<td><p>Custom function or <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.metrics.plot_confusion_matrix.html"><code class="docutils literal notranslate"><span class="pre">sklearn.metrics.plot_confusion_matrix()</span></code></a></p></td>
</tr>
<tr class="row-odd"><td><p>Classification report</p></td>
<td><p>Collection of some of the main classification metrics such as precision, recall and f1-score.</p></td>
<td><p><a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.metrics.classification_report.html"><code class="docutils literal notranslate"><span class="pre">sklearn.metrics.classification_report()</span></code></a></p></td>
</tr>
</tbody>
</table>
<section id="binary-classification">
<h2><span class="section-number">3.3.1. </span>Binary Classification<a class="headerlink" href="#binary-classification" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">make_circles</span>

<span class="c1"># Make 1000 examples</span>
<span class="n">n_samples</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="c1"># Create circles</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">make_circles</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> 
                    <span class="n">noise</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span> 
                    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># Visualize with a plot</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">RdYlBu</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.collections.PathCollection at 0x2855dbfd0&gt;
</pre></div>
</div>
<img alt="../../_images/0fdacd71fb8aef96311609ec1c3c9bb9a057c548d225665367ca5bd9ddbe4657.png" src="../../_images/0fdacd71fb8aef96311609ec1c3c9bb9a057c548d225665367ca5bd9ddbe4657.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="create-model">
<h3><span class="section-number">3.3.1.1. </span>Create model<a class="headerlink" href="#create-model" title="Permalink to this heading">#</a></h3>
<p>try: <a class="reference external" href="https://playground.tensorflow.org/">TensorFlow Playground</a> để nhìn how feature tác động đến việc phân loại và các layer visualize như thế nào ?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqdm.keras</span> <span class="kn">import</span> <span class="n">TqdmCallback</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set random seed</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">input_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">activation</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">activations</span><span class="o">.</span><span class="n">relu</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">activations</span><span class="o">.</span><span class="n">relu</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">BinaryCrossentropy</span><span class="p">(),</span>
             <span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">legacy</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">3e-4</span><span class="p">),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span>
             <span class="p">)</span>

<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span> <span class="mi">30</span><span class="p">,</span> 
                    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span>
                    <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">TqdmCallback</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "f08849efa97c4c71919e19081b948293", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># visualize the boundary</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">plot_decision_boundary</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="c1"># Define the axis boundaries of the plot and create a meshgrid</span>
    <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.1</span>
    <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.1</span>
    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
                       <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>

    <span class="c1"># Create X values (we&#39;re going to predict on all of these)</span>
    <span class="n">x_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">()]</span> <span class="c1"># stack 2D arrays together: https://numpy.org/devdocs/reference/generated/numpy.c_.html</span>

    <span class="c1"># Make predictions using the trained model</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_in</span><span class="p">)</span>

    <span class="c1"># Check for multi-class</span>
    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">output_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># checks the final dimension of the model&#39;s output shape, if this is &gt; (greater than) 1, it&#39;s multi-class </span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;doing multiclass classification...&quot;</span><span class="p">)</span>
        <span class="c1"># We have to reshape our predictions to get them ready for plotting</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;doing binary classifcation...&quot;</span><span class="p">)</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="c1"># Plot decision boundary</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">RdYlBu</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">RdYlBu</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">xx</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">yy</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">yy</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    
<span class="n">plot_decision_boundary</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>313/313 [==============================] - 1s 2ms/step
doing binary classifcation...
</pre></div>
</div>
<img alt="../../_images/c5bc5153f8b8c9afc7d9fe4160cbfe53557dd389d4b78ef4278d33e835a23855.png" src="../../_images/c5bc5153f8b8c9afc7d9fe4160cbfe53557dd389d4b78ef4278d33e835a23855.png" />
</div>
</div>
</section>
<section id="id6">
<h3><span class="section-number">3.3.1.2. </span>Improving model<a class="headerlink" href="#id6" title="Permalink to this heading">#</a></h3>
<section id="add-activation-function">
<h4><span class="section-number">3.3.1.2.1. </span>add activation function<a class="headerlink" href="#add-activation-function" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">input_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">activation</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">activations</span><span class="o">.</span><span class="n">relu</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">activations</span><span class="o">.</span><span class="n">relu</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">activations</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">))</span>

<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">BinaryCrossentropy</span><span class="p">(),</span>
             <span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">legacy</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">3e-4</span><span class="p">),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span>
             <span class="p">)</span>

<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span> <span class="mi">30</span><span class="p">,</span> 
                    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span>
                    <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">TqdmCallback</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "7dc544137d8c4bbabca6b3cc644e9a83", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_decision_boundary</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>313/313 [==============================] - 1s 2ms/step
doing binary classifcation...
</pre></div>
</div>
<img alt="../../_images/051e7e6d23d21945420432b00c36883e3c07d0d4a41bd7af6be2b29862cce1a2.png" src="../../_images/051e7e6d23d21945420432b00c36883e3c07d0d4a41bd7af6be2b29862cce1a2.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">secondary_y</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span><span class="s1">&#39;val_accuracy&#39;</span><span class="p">],</span> <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;epochs&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: xlabel=&#39;epochs&#39;&gt;
</pre></div>
</div>
<img alt="../../_images/fd2ebb1a2ae5c7bcecb86cee631d7083864d7fcc92fc768c931c512c13f7db76.png" src="../../_images/fd2ebb1a2ae5c7bcecb86cee631d7083864d7fcc92fc768c931c512c13f7db76.png" />
</div>
</div>
</section>
<section id="learning-rate-scheduler-callback">
<h4><span class="section-number">3.3.1.2.2. </span>learning rate scheduler callback<a class="headerlink" href="#learning-rate-scheduler-callback" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">input_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">activation</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">activations</span><span class="o">.</span><span class="n">relu</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">activations</span><span class="o">.</span><span class="n">relu</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">activations</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">))</span>

<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">BinaryCrossentropy</span><span class="p">(),</span>
             <span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">legacy</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">3e-4</span><span class="p">),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span>
             <span class="p">)</span>

<span class="c1"># Create a learning rate scheduler callback</span>
<span class="c1"># traverse a set of learning rate values starting from 1e-4, increasing by 10**(epoch/20) every epoch</span>
<span class="n">lr_scheduler</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">LearningRateScheduler</span><span class="p">(</span><span class="k">lambda</span> <span class="n">epoch</span><span class="p">:</span> <span class="mf">1e-4</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">epoch</span><span class="o">/</span><span class="mi">20</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="k">else</span> <span class="mf">1e-4</span><span class="p">)</span> 

<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span> <span class="mi">50</span><span class="p">,</span> 
                    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span>
                    <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">TqdmCallback</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">lr_scheduler</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "2a895f41899047ff8711eed077b7ec64", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Checkout the history</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">secondary_y</span> <span class="o">=</span> <span class="s1">&#39;lr&#39;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;epochs&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: xlabel=&#39;epochs&#39;&gt;
</pre></div>
</div>
<img alt="../../_images/ff1116e4482d52ad85e55659d423a3e5b706eb6fa6c2b481904f3d89fc0fc625.png" src="../../_images/ff1116e4482d52ad85e55659d423a3e5b706eb6fa6c2b481904f3d89fc0fc625.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the learning rate versus the loss</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">],</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;matplotlib.lines.Line2D at 0x29babd3f0&gt;]
</pre></div>
</div>
<img alt="../../_images/bc129cf5bad700de878a088599d20ffee76ba5cfc4f4cfd6b5bbfce8929dbd93.png" src="../../_images/bc129cf5bad700de878a088599d20ffee76ba5cfc4f4cfd6b5bbfce8929dbd93.png" />
</div>
</div>
<p>get lr = 1e-2</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">input_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">activation</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">activations</span><span class="o">.</span><span class="n">relu</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">activations</span><span class="o">.</span><span class="n">relu</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">activations</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">))</span>

<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">BinaryCrossentropy</span><span class="p">(),</span>
             <span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">legacy</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span>
             <span class="p">)</span>

<span class="n">callback</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span> <span class="o">=</span> <span class="s1">&#39;val_loss&#39;</span><span class="p">,</span> <span class="n">patience</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">min_delta</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">restore_best_weights</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span> <span class="mi">50</span><span class="p">,</span> 
                    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span>
                    <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">TqdmCallback</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">callback</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "8de3ef46b2a04e8797cb8a8d517538e3", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_decision_boundary</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>313/313 [==============================] - 1s 2ms/step
doing binary classifcation...
</pre></div>
</div>
<img alt="../../_images/c90c4ff6164c964319593291230dd652c42765e8a8dcdd24159b4d6264b0d8fe.png" src="../../_images/c90c4ff6164c964319593291230dd652c42765e8a8dcdd24159b4d6264b0d8fe.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">secondary_y</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span><span class="s1">&#39;val_accuracy&#39;</span><span class="p">],</span> <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;epochs&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: xlabel=&#39;epochs&#39;&gt;
</pre></div>
</div>
<img alt="../../_images/87d64ee94f178121bfd4907a20901e9e8b2fe7779d24a60380d32084556691a6.png" src="../../_images/87d64ee94f178121bfd4907a20901e9e8b2fe7779d24a60380d32084556691a6.png" />
</div>
</div>
</section>
<section id="use-polynomial-features">
<h4><span class="section-number">3.3.1.2.3. </span>Use Polynomial features<a class="headerlink" href="#use-polynomial-features" title="Permalink to this heading">#</a></h4>
<p>Biến đổi non-linear data</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">PolynomialFeatures</span>
<span class="n">poly</span> <span class="o">=</span> <span class="n">PolynomialFeatures</span><span class="p">(</span><span class="n">include_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">x_train_poly</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span>
<span class="n">x_test_poly</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">activations</span><span class="o">.</span><span class="n">relu</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">activations</span><span class="o">.</span><span class="n">relu</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">activations</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">))</span>

<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">BinaryCrossentropy</span><span class="p">(),</span>
             <span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">legacy</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span>
             <span class="p">)</span>

<span class="n">callback</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span> <span class="o">=</span> <span class="s1">&#39;val_loss&#39;</span><span class="p">,</span> <span class="n">patience</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">min_delta</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">restore_best_weights</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train_poly</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span> <span class="mi">50</span><span class="p">,</span> 
                    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_test_poly</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span>
                    <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">TqdmCallback</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">callback</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "138a96269b4645929004a748f8211331", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">secondary_y</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span><span class="s1">&#39;val_accuracy&#39;</span><span class="p">],</span> <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;epochs&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: xlabel=&#39;epochs&#39;&gt;
</pre></div>
</div>
<img alt="../../_images/d33bc375b0ca47cee9fd17770c024ca96eec16e31fd589c469b892e29a07c4dc.png" src="../../_images/d33bc375b0ca47cee9fd17770c024ca96eec16e31fd589c469b892e29a07c4dc.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># confusion matrix</span>
<span class="n">y_preds</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_test_poly</span><span class="p">)))</span>

<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span>
<span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_preds</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>7/7 [==============================] - 0s 3ms/step
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[100,   0],
       [  0, 100]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tensorflow.keras.utils</span> <span class="kn">import</span> <span class="n">plot_model</span>

<span class="n">plot_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">show_shapes</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/5e08a97b767355d1184011f2ee87126c78eb277c2e5a30d23c93699f960842e7.png" src="../../_images/5e08a97b767355d1184011f2ee87126c78eb277c2e5a30d23c93699f960842e7.png" />
</div>
</div>
</section>
</section>
</section>
<section id="multi-class-classification">
<h2><span class="section-number">3.3.2. </span>Multi-class classification<a class="headerlink" href="#multi-class-classification" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># datasets</span>
<span class="c1"># import tensorflow as tf</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.datasets</span> <span class="kn">import</span> <span class="n">fashion_mnist</span>

<span class="c1"># The data has already been sorted into training and test sets for us</span>
<span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">),</span> <span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">)</span> <span class="o">=</span> <span class="n">fashion_mnist</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading data from https://storage.googleapis.com/tensorflow/tf-keras-datasets/train-labels-idx1-ubyte.gz
29515/29515 [==============================] - 0s 1us/step
Downloading data from https://storage.googleapis.com/tensorflow/tf-keras-datasets/train-images-idx3-ubyte.gz
26421880/26421880 [==============================] - 3s 0us/step
Downloading data from https://storage.googleapis.com/tensorflow/tf-keras-datasets/t10k-labels-idx1-ubyte.gz
5148/5148 [==============================] - 0s 0us/step
Downloading data from https://storage.googleapis.com/tensorflow/tf-keras-datasets/t10k-images-idx3-ubyte.gz
4422102/4422102 [==============================] - 0s 0us/step
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">class_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;T-shirt/top&#39;</span><span class="p">,</span> <span class="s1">&#39;Trouser&#39;</span><span class="p">,</span> <span class="s1">&#39;Pullover&#39;</span><span class="p">,</span> <span class="s1">&#39;Dress&#39;</span><span class="p">,</span> <span class="s1">&#39;Coat&#39;</span><span class="p">,</span> 
               <span class="s1">&#39;Sandal&#39;</span><span class="p">,</span> <span class="s1">&#39;Shirt&#39;</span><span class="p">,</span> <span class="s1">&#39;Sneaker&#39;</span><span class="p">,</span> <span class="s1">&#39;Bag&#39;</span><span class="p">,</span> <span class="s1">&#39;Ankle boot&#39;</span><span class="p">]</span>

<span class="c1"># How many classes are there (this&#39;ll be our output shape)?</span>
<span class="nb">len</span><span class="p">(</span><span class="n">class_names</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">train_labels</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>((60000, 28, 28), (60000,))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">train_labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0, 1, 2, 3, 4, 5, 6, 7, 8, 9], dtype=uint8)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot a single example</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">train_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">binary</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.image.AxesImage at 0x2f0b5ad10&gt;
</pre></div>
</div>
<img alt="../../_images/3c9cd9a9c2ef689271d094d51a58da1e8f3e9582db91f6fc2f382d4322b05f4b.png" src="../../_images/3c9cd9a9c2ef689271d094d51a58da1e8f3e9582db91f6fc2f382d4322b05f4b.png" />
</div>
</div>
<section id="id7">
<h3><span class="section-number">3.3.2.1. </span>Create model<a class="headerlink" href="#id7" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Input</strong>: Khai báo tham số input_shape = 28x28 và <code class="docutils literal notranslate"><span class="pre">Flatten</span></code> thành vector, sau này trước khi đưa ảnh vào dự đoán cần chuẩn hoá về dạng 28x28 = 784</p></li>
<li><p><strong>Output</strong>:</p>
<ul>
<li><p>Output shape bằng với số class (số node = 10)</p></li>
<li><p>Hàm activation là hàm softmax để chuẩn hoá các giá trị dự đoán trong khoảng [0,1] và có tổng bằng 1, thể hiện bản chất xác suất</p></li>
</ul>
</li>
<li><p><strong>Loss</strong>:</p>
<ul>
<li><p>Nếu các class được encode dưới dạng integer (label encoding) thì sử dụng <code class="docutils literal notranslate"><span class="pre">tf.keras.losses.SparseCategoricalCrossentropy()</span></code></p></li>
<li><p>Nếu các class được encode dưới dạng one-hot thì sử dụng <code class="docutils literal notranslate"><span class="pre">tf.keras.losses.CategoricalCrossentropy()</span></code></p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set random seed</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># create model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(</span><span class="n">input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">),</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;input&#39;</span><span class="p">))</span> <span class="c1"># flatten thành vector 784</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;h1&#39;</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;h2&#39;</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;output&#39;</span><span class="p">))</span>

<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">SparseCategoricalCrossentropy</span><span class="p">(),</span>
             <span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">legacy</span><span class="o">.</span><span class="n">Adam</span><span class="p">(),</span>
             <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">])</span>

<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span> <span class="mi">20</span><span class="p">,</span> 
                    <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">TqdmCallback</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "c5ccb35583004625977c535ffb1bfe33", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Non-normalized Data&quot;</span><span class="p">,</span> <span class="n">secondary_y</span> <span class="o">=</span> <span class="s1">&#39;accuracy&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: title={&#39;center&#39;: &#39;Non-normalized Data&#39;}&gt;
</pre></div>
</div>
<img alt="../../_images/3ec3708b56ff0fbaa0d5f4994e4f442291cc24ab2d4d1ea4d8b3e88ca471604c.png" src="../../_images/3ec3708b56ff0fbaa0d5f4994e4f442291cc24ab2d4d1ea4d8b3e88ca471604c.png" />
</div>
</div>
</section>
<section id="id8">
<h3><span class="section-number">3.3.2.2. </span>Improving model<a class="headerlink" href="#id8" title="Permalink to this heading">#</a></h3>
<section id="normalize-data">
<h4><span class="section-number">3.3.2.2.1. </span>Normalize data<a class="headerlink" href="#normalize-data" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Divide train and test images by the maximum value (normalize it)</span>
<span class="n">train_data</span> <span class="o">=</span> <span class="n">train_data</span> <span class="o">/</span> <span class="mf">255.0</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">test_data</span> <span class="o">/</span> <span class="mf">255.0</span>

<span class="c1"># Check the min and max values of the training data</span>
<span class="n">train_data</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">train_data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(0.0, 1.0)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set random seed</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># create model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(</span><span class="n">input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">),</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;input&#39;</span><span class="p">))</span> <span class="c1"># flatten thành vector 784</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;h1&#39;</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;h2&#39;</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;output&#39;</span><span class="p">))</span>

<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">SparseCategoricalCrossentropy</span><span class="p">(),</span>
             <span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">legacy</span><span class="o">.</span><span class="n">Adam</span><span class="p">(),</span>
             <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">])</span>

<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span> <span class="mi">20</span><span class="p">,</span> 
                    <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">TqdmCallback</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "84213ca026b84118bc01023223e81824", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "", "version_major": 2, "version_minor": 0}</script></div>
</div>
</section>
<section id="id9">
<h4><span class="section-number">3.3.2.2.2. </span>learning rate scheduler callback<a class="headerlink" href="#id9" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(</span><span class="n">input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">),</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;input&#39;</span><span class="p">))</span> <span class="c1"># flatten thành vector 784</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;h1&#39;</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;h2&#39;</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;output&#39;</span><span class="p">))</span>

<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">SparseCategoricalCrossentropy</span><span class="p">(),</span>
             <span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">legacy</span><span class="o">.</span><span class="n">Adam</span><span class="p">(),</span>
             <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">])</span>

<span class="c1"># Create a learning rate scheduler callback</span>
<span class="c1"># traverse a set of learning rate values starting from 1e-4, increasing by 10**(epoch/20) every epoch</span>
<span class="n">lr_scheduler</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">LearningRateScheduler</span><span class="p">(</span><span class="k">lambda</span> <span class="n">epoch</span><span class="p">:</span> <span class="mf">1e-4</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">epoch</span><span class="o">/</span><span class="mi">20</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="k">else</span> <span class="mf">1e-4</span><span class="p">)</span> 

<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">TqdmCallback</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">lr_scheduler</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "2a895f41899047ff8711eed077b7ec64", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the learning rate versus the loss</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">],</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;matplotlib.lines.Line2D at 0x29babd3f0&gt;]
</pre></div>
</div>
<img alt="../../_images/bc129cf5bad700de878a088599d20ffee76ba5cfc4f4cfd6b5bbfce8929dbd93.png" src="../../_images/bc129cf5bad700de878a088599d20ffee76ba5cfc4f4cfd6b5bbfce8929dbd93.png" />
</div>
</div>
</section>
</section>
<section id="id10">
<h3><span class="section-number">3.3.2.3. </span>Evaluate model<a class="headerlink" href="#id10" title="Permalink to this heading">#</a></h3>
<section id="confusion-matrix">
<h4><span class="section-number">3.3.2.3.1. </span>confusion matrix<a class="headerlink" href="#confusion-matrix" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_preds</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">y_preds</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>313/313 [==============================] - 1s 2ms/step
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([9, 2, 1, ..., 8, 1, 5])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check out the non-prettified confusion matrix</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_true</span><span class="o">=</span><span class="n">test_labels</span><span class="p">,</span> <span class="n">y_pred</span><span class="o">=</span><span class="n">y_preds</span><span class="p">)</span>
<span class="n">cm</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[802,  10,  19,  53,   5,   0,  97,   0,  14,   0],
       [  0, 965,   5,  24,   5,   0,   1,   0,   0,   0],
       [ 19,   5, 751,   9, 166,   0,  48,   0,   2,   0],
       [ 34,  17,  19, 827,  51,   0,  44,   0,   6,   2],
       [  1,   2, 105,  21, 824,   0,  46,   0,   1,   0],
       [  0,   0,   0,   1,   0, 937,   0,  28,  12,  22],
       [140,   3, 151,  40, 151,   1, 502,   0,  12,   0],
       [  0,   0,   0,   1,   0,  41,   0, 908,   3,  47],
       [  3,   0,  17,  10,   3,   3,  20,   3, 941,   0],
       [  0,   0,   0,   1,   0,  16,   0,  35,   1, 947]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">scikitplot</span> <span class="k">as</span> <span class="nn">skplt</span>
<span class="n">skplt</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">plot_confusion_matrix</span><span class="p">(</span><span class="n">test_labels</span><span class="p">,</span> <span class="n">y_preds</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hide_counts</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: title={&#39;center&#39;: &#39;Normalized Confusion Matrix&#39;}, xlabel=&#39;Predicted label&#39;, ylabel=&#39;True label&#39;&gt;
</pre></div>
</div>
<img alt="../../_images/8ec4dd82ed1d74df6672ffb029bb8725f57dd06d27a563e6933b857eff61e0ab.png" src="../../_images/8ec4dd82ed1d74df6672ffb029bb8725f57dd06d27a563e6933b857eff61e0ab.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span>

<span class="c1"># Our function needs a different name to sklearn&#39;s plot_confusion_matrix</span>
<span class="k">def</span> <span class="nf">make_confusion_matrix</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">text_size</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span> 
    <span class="c1"># Create the confustion matrix</span>
    <span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">cm_norm</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">cm</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="c1"># normalize it</span>
    <span class="n">n_classes</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># find the number of classes we&#39;re dealing with</span>

    <span class="c1"># Plot the figure and make it pretty</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">matshow</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Blues</span><span class="p">)</span> <span class="c1"># colors will represent how &#39;correct&#39; a class is, darker == better</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cax</span><span class="p">)</span>

    <span class="c1"># Are there a list of classes?</span>
    <span class="k">if</span> <span class="n">classes</span><span class="p">:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">classes</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Label the axes</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Confusion Matrix&quot;</span><span class="p">,</span>
         <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Predicted label&quot;</span><span class="p">,</span>
         <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;True label&quot;</span><span class="p">,</span>
         <span class="n">xticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_classes</span><span class="p">),</span> <span class="c1"># create enough axis slots for each class</span>
         <span class="n">yticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_classes</span><span class="p">),</span> 
         <span class="n">xticklabels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="c1"># axes will labeled with class names (if they exist) or ints</span>
         <span class="n">yticklabels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>

    <span class="c1"># Make x-axis labels appear on bottom</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s2">&quot;bottom&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">tick_bottom</span><span class="p">()</span>

    <span class="c1"># Set the threshold for different colors</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">cm</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="mf">2.</span>

    <span class="c1"># Plot the text on each cell</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">range</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">cm_norm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">,</span>
                 <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                 <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span> <span class="k">if</span> <span class="n">cm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span> <span class="k">else</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span>
                 <span class="n">size</span><span class="o">=</span><span class="n">text_size</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make a prettier confusion matrix</span>
<span class="n">make_confusion_matrix</span><span class="p">(</span><span class="n">y_true</span><span class="o">=</span><span class="n">test_labels</span><span class="p">,</span> 
                      <span class="n">y_pred</span><span class="o">=</span><span class="n">y_preds</span><span class="p">,</span>
                      <span class="n">classes</span><span class="o">=</span><span class="n">class_names</span><span class="p">,</span>
                      <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
                      <span class="n">text_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/1f94b794752e9effc5d1e5e5134182a4e08dc16802d1984a58504d2117ff9dab.png" src="../../_images/1f94b794752e9effc5d1e5e5134182a4e08dc16802d1984a58504d2117ff9dab.png" />
</div>
</div>
</section>
<section id="plot-model">
<h4><span class="section-number">3.3.2.3.2. </span>plot model<a class="headerlink" href="#plot-model" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tensorflow.keras.utils</span> <span class="kn">import</span> <span class="n">plot_model</span>

<span class="c1"># See the inputs and outputs of each layer</span>
<span class="n">plot_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">show_shapes</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/141cf4e443eb8b915008ab061acaee8c182d7fc2a980d6b72d9ea3b2261e5322.png" src="../../_images/141cf4e443eb8b915008ab061acaee8c182d7fc2a980d6b72d9ea3b2261e5322.png" />
</div>
</div>
</section>
</section>
<section id="example">
<h3><span class="section-number">3.3.2.4. </span>Example<a class="headerlink" href="#example" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># datasets</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>

<span class="c1"># The data has already been sorted into training and test sets for us</span>
<span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">),</span> <span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">)</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">fashion_mnist</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.12.0
Downloading data from https://storage.googleapis.com/tensorflow/tf-keras-datasets/train-labels-idx1-ubyte.gz
29515/29515 [==============================] - 0s 0us/step
Downloading data from https://storage.googleapis.com/tensorflow/tf-keras-datasets/train-images-idx3-ubyte.gz
26421880/26421880 [==============================] - 0s 0us/step
Downloading data from https://storage.googleapis.com/tensorflow/tf-keras-datasets/t10k-labels-idx1-ubyte.gz
5148/5148 [==============================] - 0s 0us/step
Downloading data from https://storage.googleapis.com/tensorflow/tf-keras-datasets/t10k-images-idx3-ubyte.gz
4422102/4422102 [==============================] - 0s 0us/step
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># class name</span>
<span class="n">class_name</span>  <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;T-shirt/top&#39;</span><span class="p">,</span> <span class="s1">&#39;Trouser&#39;</span><span class="p">,</span> <span class="s1">&#39;Pullover&#39;</span><span class="p">,</span> <span class="s1">&#39;Dress&#39;</span><span class="p">,</span> <span class="s1">&#39;Coat&#39;</span><span class="p">,</span> 
               <span class="s1">&#39;Sandal&#39;</span><span class="p">,</span> <span class="s1">&#39;Shirt&#39;</span><span class="p">,</span> <span class="s1">&#39;Sneaker&#39;</span><span class="p">,</span> <span class="s1">&#39;Bag&#39;</span><span class="p">,</span> <span class="s1">&#39;Ankle boot&#39;</span><span class="p">]</span>

<span class="c1"># check balance data</span>
<span class="n">class_name_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span><span class="n">j</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="n">class_name</span><span class="p">)}</span>
<span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">train_labels</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">class_name_dict</span><span class="p">)</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: &gt;
</pre></div>
</div>
<img alt="../../_images/438f44c787b887523119afb8355bf7cb2dc9b0057cb83ae1414651c9b761bce6.png" src="../../_images/438f44c787b887523119afb8355bf7cb2dc9b0057cb83ae1414651c9b761bce6.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># preprocessing</span>

<span class="c1"># normalize data</span>
<span class="n">train_data</span> <span class="o">=</span> <span class="n">train_data</span> <span class="o">/</span> <span class="mf">255.0</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">test_data</span> <span class="o">/</span> <span class="mf">255.0</span>
<span class="n">train_data</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">train_data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(0.0, 1.0)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqdm.keras</span> <span class="kn">import</span> <span class="n">TqdmCallback</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mf">1e-2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.01
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set random seed</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># create model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(</span><span class="n">input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">),</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;input&#39;</span><span class="p">))</span> <span class="c1"># flatten thành vector 784</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;selu&#39;</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;h1&#39;</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;selu&#39;</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;h2&#39;</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;output&#39;</span><span class="p">))</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">decay_lr = initial_learning_rate * decay_rate ^ (step / decay_steps)</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">lr_schedule</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">schedules</span><span class="o">.</span><span class="n">ExponentialDecay</span><span class="p">(</span>
    <span class="n">initial_learning_rate</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span>
    <span class="n">decay_steps</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">decay_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">SparseCategoricalCrossentropy</span><span class="p">(),</span>
             <span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">legacy</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">0.005</span><span class="p">),</span>
             <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">])</span>

<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">),</span>
                    <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">TqdmCallback</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "e6d37e3808c44bcea70580fe09594a82", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># class name</span>
<span class="n">class_name</span>  <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;T-shirt/top&#39;</span><span class="p">,</span> <span class="s1">&#39;Trouser&#39;</span><span class="p">,</span> <span class="s1">&#39;Pullover&#39;</span><span class="p">,</span> <span class="s1">&#39;Dress&#39;</span><span class="p">,</span> <span class="s1">&#39;Coat&#39;</span><span class="p">,</span> 
               <span class="s1">&#39;Sandal&#39;</span><span class="p">,</span> <span class="s1">&#39;Shirt&#39;</span><span class="p">,</span> <span class="s1">&#39;Sneaker&#39;</span><span class="p">,</span> <span class="s1">&#39;Bag&#39;</span><span class="p">,</span> <span class="s1">&#39;Ankle boot&#39;</span><span class="p">]</span>

<span class="c1"># check balance data</span>
<span class="n">class_name_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span><span class="n">j</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="n">class_name</span><span class="p">)}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">nsample</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span> <span class="mi">7</span><span class="o">*</span><span class="n">nsample</span><span class="p">,</span><span class="mi">7</span> <span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: &gt;
</pre></div>
</div>
<img alt="../../_images/93d2d5c595a14e5306e3abfdba7b97f121d3faf8916e21ce69bebf1cccd01e3b.png" src="../../_images/93d2d5c595a14e5306e3abfdba7b97f121d3faf8916e21ce69bebf1cccd01e3b.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># random image prediction</span>
<span class="c1"># model</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="k">def</span> <span class="nf">random_image_prediction</span><span class="p">(</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">),</span> <span class="n">class_check</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">nsample</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">class_name</span> <span class="o">=</span> <span class="n">class_name</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">class_check</span> <span class="ow">in</span> <span class="n">class_name</span><span class="p">:</span>
        <span class="n">class_code</span> <span class="o">=</span> <span class="n">class_name</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">class_check</span><span class="p">)</span>
        <span class="n">class_labels</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="n">class_code</span><span class="p">]</span>
        <span class="n">class_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="n">class_code</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">class_labels</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">class_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
    <span class="n">len_class</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_labels</span><span class="p">)</span>
    <span class="n">ran_ind</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">len_class</span><span class="p">),</span> <span class="n">nsample</span><span class="p">)</span>
    <span class="n">sample_data</span><span class="p">,</span> <span class="n">sample_labels</span> <span class="o">=</span> <span class="p">(</span><span class="n">class_data</span><span class="p">[</span><span class="n">ran_ind</span><span class="p">],</span> <span class="n">class_labels</span><span class="p">[</span><span class="n">ran_ind</span><span class="p">])</span>
    
    <span class="n">preds</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">sample_data</span><span class="p">)</span>
    <span class="n">pred_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">class_name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">preds</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsample</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sample_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">binary</span><span class="p">)</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;green&quot;</span> <span class="k">if</span> <span class="n">pred_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">class_name</span><span class="p">[</span><span class="n">sample_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">else</span> <span class="s2">&quot;red&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Pred: </span><span class="si">{}</span><span class="s2"> </span><span class="si">{:2.0f}</span><span class="s2">% (True: </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pred_labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">100</span><span class="o">*</span><span class="n">preds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> 
                                                         <span class="n">class_name</span><span class="p">[</span><span class="n">sample_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]]),</span> 
                   <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">random_image_prediction</span><span class="p">(</span><span class="n">nsample</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1/1 [==============================] - 0s 76ms/step
</pre></div>
</div>
<img alt="../../_images/055643cfe95809791f0efef3bd3b8b3023ff443e523c2737b5cbb16537afbd26.png" src="../../_images/055643cfe95809791f0efef3bd3b8b3023ff443e523c2737b5cbb16537afbd26.png" />
<img alt="../../_images/63e47f7966e64fd4e4bdeb5a99aa495d37e58eb4ff887f9094b55c3816c9377a.png" src="../../_images/63e47f7966e64fd4e4bdeb5a99aa495d37e58eb4ff887f9094b55c3816c9377a.png" />
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./5_Deep_learning/learning_course"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="../../1_Process_Modelling/Split_notebooks/0_toc_dl.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">3. </span>Deep Learning Algorithms</p>
      </div>
    </a>
    <a class="right-next"
       href="2_ComputerVision_CNN.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">3.4. </span>Computer Vision and CNN</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">3.1. Fundamentals</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview-of-deeplearning">3.1.1. Overview of DeepLearning</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#nhung-loi-khi-huan-luyen-mang">3.1.1.1. Những lỗi khi huấn luyện mạng</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#khong-hieu-cach-hoat-dong">3.1.1.1.1. Không hiểu cách hoạt động</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#train-khong-dung-logic">3.1.1.1.2. Train không đúng logic</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kinh-nghiem-train-nn">3.1.1.2. Kinh nghiệm train NN</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#hieu-ro-data">3.1.1.2.1. Hiểu rõ data</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#thiet-lap-1-quy-trinh-xay-dung-va-danh-gia-model">3.1.1.2.2. Thiết lập 1 quy trình xây dựng và đánh giá model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#overfitting">3.1.1.2.3. Overfitting</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#regularization">3.1.1.2.4. Regularization</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#tune-model">3.1.1.2.5. Tune model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#tan-dung-het-kha-nang-co-the">3.1.1.2.6. Tận dụng hết khả năng có thể</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#good-practice">3.1.1.3. Good practice</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#training-a-nn">3.1.1.3.1. Training a NN</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#definitions">3.1.1.3.1.1. Definitions</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#finding-optimal-weights">3.1.1.3.1.2. Finding optimal weights</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#parameter-tuning">3.1.1.3.2. Parameter tuning</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#weights-initialization">3.1.1.3.2.1. Weights initialization</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#optimizing-convergence-by-learning-rate">3.1.1.3.2.2. Optimizing convergence by learning rate</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">3.1.1.3.3. Regularization</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#overfitting-small-batch">3.1.1.3.4. Overfitting small batch</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#gradient-checking">3.1.1.3.5. Gradient checking</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#gradient-descent-optimization">3.1.2. Gradient descent optimization</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gradient-descent">3.1.2.1. Gradient descent</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cac-loai-gradient-descent-gd">3.1.2.2. Các loại gradient descent (GD)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cac-phuong-phap-optimize-gd">3.1.2.3. Các phương pháp optimize GD</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#newton">3.1.2.3.1. Newton</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-rate-changes">3.1.2.3.2. Learning rate changes</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#momentum">3.1.2.3.3. Momentum</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#nestorov-accelerated-gradient-nag">3.1.2.3.4. Nestorov accelerated gradient (NAG)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#adagrad">3.1.2.3.5. Adagrad</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#rmsprop">3.1.2.3.6. RMSprop</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#ada-delta">3.1.2.3.7. Ada-delta</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#adam">3.1.2.3.8. Adam</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#naadam">3.1.2.3.9. NaAdam</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#loss-function">3.1.2.4. Loss Function</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#cross-entropy-loss">3.1.2.4.1. Cross Entropy Loss</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#focal-loss">3.1.2.4.2. Focal loss</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#get-started-with-tf">3.1.3. Get started with TF</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tensor">3.1.4. Tensor</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-tensor">3.1.4.1. create tensor</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#create-tensor-with-tf-constant">3.1.4.1.1. create tensor with <code class="docutils literal notranslate"><span class="pre">tf.constant</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#create-tensors-with-tf-variable">3.1.4.1.2. create tensors with <code class="docutils literal notranslate"><span class="pre">tf.Variable()</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#create-random-tensor">3.1.4.1.3. create random tensor</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#zero-one-tensor">3.1.4.1.4. zero/one tensor</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#tensor-from-numpy-array">3.1.4.1.5. tensor from numpy array</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#convert-to-numpy-array">3.1.4.1.6. convert to numpy array</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tensor-function">3.1.4.2. tensor function</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#info-ndim-rank-size-shape">3.1.4.2.1. info: ndim, rank, size, shape</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#indexing">3.1.4.2.2. indexing</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#shuffle">3.1.4.2.3. shuffle</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#expand-dim">3.1.4.2.4. expand dim</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#set-global-random-seed">3.1.4.2.5. set global random seed</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#reshape">3.1.4.2.6. reshape</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#transpose">3.1.4.2.7. transpose</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tensor-operations">3.1.4.3. tensor operations</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#change-datatype">3.1.4.3.1. Change datatype</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#basic-operation">3.1.4.3.2. Basic operation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#dot-product-multiplication">3.1.4.3.3. Dot product / multiplication</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#tf-matmul">3.1.4.3.3.1. tf.matmul</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#tf-tensordot">3.1.4.3.3.2. tf.tensordot</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#absolute">3.1.4.3.4. absolute</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#aggregation">3.1.4.3.5. aggregation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#map-function">3.1.4.3.6. map function</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#squeezing">3.1.4.3.7. squeezing</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#one-hot-encoding">3.1.4.3.8. one-hot encoding</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#square-square-root-log">3.1.4.3.9. square / square_root / log</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tf-function">3.1.4.4. @tf.function</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configs-and-tools">3.1.5. Configs and tools</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#training-vs-inference-mode">3.1.5.1. Training vs Inference Mode</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#use-mixed-precision">3.1.5.2. Use mixed_precision</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tf-profiler">3.1.5.3. TF Profiler</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#types-of-layers">3.1.6. Types of layers</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#basic">3.1.6.1. Basic</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#dense">3.1.6.1.1. Dense</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activation">3.1.6.1.2. Activation</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#unit-step">3.1.6.1.2.1. Unit step</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#linear">3.1.6.1.2.2. Linear</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#softmax">3.1.6.1.2.3. Softmax</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#sigmoid">3.1.6.1.2.4. Sigmoid</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#hyperbolic-tangent-tanh">3.1.6.1.2.5. Hyperbolic Tangent (tanh)</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#relu">3.1.6.1.2.6. ReLU</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#leaky-relu">3.1.6.1.2.7. Leaky ReLU</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#parametric-relu">3.1.6.1.2.8. Parametric ReLU</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#exponential-linear-unit-elu">3.1.6.1.2.9. Exponential Linear Unit (ELU)</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#scaled-exponential-linear-unit-selu">3.1.6.1.2.10. Scaled Exponential Linear Unit (SELU)</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#swish">3.1.6.1.2.11. Swish</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#input">3.1.6.1.3. Input</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#flatten">3.1.6.1.4. Flatten</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pooling">3.1.6.2. Pooling</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#max-average-pooling">3.1.6.2.1. Max/Average Pooling</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#global-max-average-pooling">3.1.6.2.2. Global Max/Average Pooling</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#convolution">3.1.6.3. Convolution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">3.1.6.4. Regularization</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#weight-regularization">3.1.6.4.1. Weight regularization</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#early-stopping">3.1.6.4.2. Early stopping</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#dropout">3.1.6.4.3. Dropout</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#batch-normalization">3.1.6.5. Batch Normalization</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-augmentation">3.1.7. Data Augmentation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#image-augmentation">3.1.7.1. Image Augmentation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#text-augmentation">3.1.7.2. Text Augmentation</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#back-translation">3.1.7.2.1. Back translation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#easy-data-augmentation">3.1.7.2.2. Easy Data Augmentation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-generation">3.1.8. Data Generation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#imagedatagenerator">3.1.8.1. ImageDataGenerator</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#image-dataset-from-directory">3.1.8.2. image_dataset_from_directory</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tf-data-dataset">3.1.8.3. tf.data.Dataset</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#load-data-from-tensorflow-datasets">3.1.8.3.1. load data from tensorflow datasets</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#load-data-from-local-images">3.1.8.3.2. load data from local images</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#tfrecords">3.1.8.3.3. TFRecords</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#writing-tfrecords">3.1.8.3.3.1. Writing TFRecords</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#reading-tfrecords">3.1.8.3.3.2. Reading TFRecords</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#tfrecords-with-tpu-optional">3.1.8.3.3.3. Tfrecords with TPU (optional)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modeling-sytax">3.1.9. Modeling sytax</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sequential-api">3.1.9.1. Sequential API</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#keras-function-api">3.1.9.2. Keras Function API</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#subclassing-keras-model">3.1.9.3. Subclassing keras.Model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-template">3.1.9.4. Model Template</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#callbacks">3.1.10. Callbacks</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#process-bar">3.1.10.1. Process bar</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#early-stop">3.1.10.2. Early stop</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#decay-learning-rate">3.1.10.3. Decay learning rate</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#modelcheckpoint">3.1.10.4. ModelCheckpoint</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#log-tensorboard">3.1.10.5. Log TensorBoard</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluation">3.1.11. Evaluation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tracking-the-experiments">3.1.12. Tracking the experiments</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#setup-tensorboard-callback">3.1.12.1. Setup tensorboard callback</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#view-real-time-tu-notebook">3.1.12.2. View real-time từ notebook</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#see-experiments-on-local">3.1.12.3. See experiments on local</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#uploading-experiments-to-tensorboard">3.1.12.4. Uploading experiments to TensorBoard</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#check-list-uploaded">3.1.12.5. Check list uploaded</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#deleting-experiments-from-tensorboard">3.1.12.6. Deleting experiments from TensorBoard</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prediction">3.1.13. Prediction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#save-load-model">3.1.14. Save/load model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#transfer-learning">3.1.15. Transfer learning</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#phan-loai-cac-pretrain-model">3.1.15.1. Phân loại các pretrain model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#workflow">3.1.15.2. Workflow</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tensorflow-hub">3.1.15.3. TensorFlow Hub</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#keras-applications">3.1.15.4. Keras applications</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#dataset">3.1.15.4.1. Dataset</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#data-augumentation">3.1.15.4.2. Data Augumentation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#train-model">3.1.15.4.3. Train model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#warm-up">3.1.15.4.4. Warm up</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#fine-tuning-model">3.1.15.4.5. Fine tuning model</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#helper-module">3.1.16. Helper module</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#regression">3.2. Regression</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#datasets">3.2.1. Datasets</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modeling">3.2.2. Modeling</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-model-by-sequential">3.2.2.1. Create model by Sequential</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#create-delay-build-pattern-model">3.2.2.1.1. create delay-build pattern model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#create-model-with-input-shape">3.2.2.1.2. create model with Input_shape</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">3.2.2.2. Prediction</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#improving-model">3.2.2.3. Improving model</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#earlystopping">3.2.2.3.1. EarlyStopping</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluate-model">3.2.2.4. Evaluate model</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-data">3.2.2.4.1. visualize data</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-the-model">3.2.2.4.2. Visualize the model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-the-predictions">3.2.2.4.3. Visualize the predictions</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluate-prediction">3.2.2.4.4. Evaluate prediction</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">3.2.2.5. Tracking the experiments</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#clone-model">3.2.2.6. Clone model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">3.2.2.7. Save/load model</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#the-savedmodel-format-default">3.2.2.7.1. The SavedModel format (default)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#h5-format">3.2.2.7.2. H5 format</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#load-from-colab">3.2.2.7.3. load from colab</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-1">3.2.3. Example 1</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-2">3.2.4. Example 2</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#classification">3.3. Classification</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#binary-classification">3.3.1. Binary Classification</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-model">3.3.1.1. Create model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">3.3.1.2. Improving model</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#add-activation-function">3.3.1.2.1. add activation function</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-rate-scheduler-callback">3.3.1.2.2. learning rate scheduler callback</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#use-polynomial-features">3.3.1.2.3. Use Polynomial features</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#multi-class-classification">3.3.2. Multi-class classification</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">3.3.2.1. Create model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">3.3.2.2. Improving model</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#normalize-data">3.3.2.2.1. Normalize data</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">3.3.2.2.2. learning rate scheduler callback</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">3.3.2.3. Evaluate model</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#confusion-matrix">3.3.2.3.1. confusion matrix</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-model">3.3.2.3.2. plot model</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example">3.3.2.4. Example</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Khổng Tiến Đạt
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>